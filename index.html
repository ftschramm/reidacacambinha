<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento - Mineração</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar h1 {
            color: white;
            font-size: 22px;
            margin-bottom: 30px;
            text-align: center;
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-content {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge-success {
            background: #d5f4e6;
            color: #27ae60;
        }

        .badge-warning {
            background: #fdeaa7;
            color: #f39c12;
        }

        .badge-danger {
            background: #fadbd8;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .resumo-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 10px;
        }
        
        .text-success { color: #27ae60 !important; }
        .text-warning { color: #f39c12 !important; }
        .text-danger { color: #e74c3c !important; }

        /* Estilos para Alertas Inteligentes */
        .alerta-inteligente {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }

        /* Sistema de Notificações Avançado */
        .notification-center {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000;
            overflow: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }

        .notification-center.active {
            transform: translateX(0);
        }

        .notification-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            z-index: 1500;
            transition: all 0.3s ease;
        }

        .notification-bell:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .notification-bell.has-notifications {
            animation: bellRing 2s infinite;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .notification-item.critical {
            border-left: 4px solid #f44336;
        }

        .notification-item.warning {
            border-left: 4px solid #ff9800;
        }

        .notification-item.success {
            border-left: 4px solid #4caf50;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .notification-message {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .notification-time {
            font-size: 11px;
            color: #95a5a6;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .notification-action {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-action.primary {
            background: #3498db;
            color: white;
        }

        .notification-action.success {
            background: #27ae60;
            color: white;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 15px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            max-width: 400px;
            z-index: 3000;
            transform: translateX(100%);
            animation: slideInToast 0.4s ease-out forwards;
        }

        .toast-notification.removing {
            animation: slideOutToast 0.3s ease-in forwards;
        }

        .toast-notification.critical {
            border-left: 5px solid #e74c3c;
        }

        .toast-notification.warning {
            border-left: 5px solid #f39c12;
        }

        .toast-notification.success {
            border-left: 5px solid #27ae60;
        }

        .toast-notification.info {
            border-left: 5px solid #3498db;
        }

        .toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .toast-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #95a5a6;
            padding: 0;
            width: 20px;
            height: 20px;
        }

        .toast-message {
            color: #7f8c8d;
            font-size: 14px;
        }

        @keyframes bellRing {
            0%, 50%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-10deg); }
            20%, 40% { transform: rotate(10deg); }
        }

        @keyframes slideInToast {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutToast {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .notification-settings {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .notification-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #3498db;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        .alerta-critico {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            border-left-color: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .alerta-aviso {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
            border-left-color: #f39c12;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .alerta-info {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
            color: white;
            border-left-color: #3498db;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .alerta-sucesso {
            background: linear-gradient(135deg, #66bb6a, #4caf50);
            color: white;
            border-left-color: #27ae60;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .insight-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
            position: relative;
        }

        .insight-item::before {
            content: "💡";
            position: absolute;
            left: -2px;
            top: 12px;
            background: #3498db;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .performance-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .performance-indicator:last-child {
            border-bottom: none;
        }

        .trend-up { color: #27ae60; }
        .trend-down { color: #e74c3c; }
        .trend-neutral { color: #7f8c8d; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h1>🚚 Rei da Caçambinha</h1>
        <button class="menu-item active" onclick="showPage('dashboard')">🏠 Dashboard</button>
        <button class="menu-item" onclick="showPage('produtos')">⛰️ Minérios</button>
        <button class="menu-item" onclick="showPage('clientes')">👥 Clientes</button>
        <button class="menu-item" onclick="showPage('vendas')">💰 Vendas</button>
        <button class="menu-item" onclick="showPage('veiculos')">🚛 Veículos</button>
        <button class="menu-item" onclick="showPage('despesas')">💸 Despesas</button>
        <button class="menu-item" onclick="showPage('credito')">💳 Crédito/Estoque</button>
        <button class="menu-item" onclick="showPage('relatorios')">📊 Relatórios</button>
        <button class="menu-item" onclick="showPage('cobrancas')">🔔 Cobranças</button>
        <button class="menu-item" onclick="showPage('configuracoes')">⚙️ Configurações</button>
        <button class="menu-item" onclick="backup()">💾 Backup</button>
        <button class="menu-item" onclick="limparTodosDados()" style="background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c;">🗑️ Limpar Dados</button>
    </div>

    <!-- Sistema de Notificações -->
    <button class="notification-bell" onclick="toggleNotificationCenter()" id="notificationBell">
        🔔
        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
    </button>

    <div class="notification-overlay" id="notificationOverlay" onclick="closeNotificationCenter()"></div>
    
    <div class="notification-center" id="notificationCenter">
        <div class="notification-header">
            <div>
                <h3 style="margin: 0;">🔔 Central de Notificações</h3>
                <small id="notificationCount">0 notificações</small>
            </div>
            <button onclick="closeNotificationCenter()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">×</button>
        </div>
        
        <div class="notification-list" id="notificationList">
            <!-- Notificações serão inseridas aqui -->
        </div>
        
        <div class="notification-settings">
            <div class="notification-toggle">
                <span style="font-size: 12px; color: #7f8c8d;">Push Notifications</span>
                <div class="toggle-switch" id="pushToggle" onclick="togglePushNotifications()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="notification-toggle">
                <span style="font-size: 12px; color: #7f8c8d;">Alertas Sonoros</span>
                <div class="toggle-switch active" id="soundToggle" onclick="toggleSoundNotifications()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button class="btn" style="flex: 1; font-size: 11px; padding: 6px;" onclick="markAllAsRead()">✅ Marcar todas como lidas</button>
                <button class="btn btn-danger" style="flex: 1; font-size: 11px; padding: 6px;" onclick="clearAllNotifications()">🗑️ Limpar todas</button>
            </div>
        </div>
    </div>

    <!-- Container para Toast Notifications -->
    <div id="toastContainer"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div id="dashboard" class="page active">
            <h1 class="page-title">📊 Dashboard - Rei da Caçambinha</h1>
            
            <!-- Alertas Inteligentes -->
            <div id="alertasInteligentes" style="margin-bottom: 25px;">
                <!-- Alertas serão inseridos aqui dinamicamente -->
            </div>
            
            <!-- KPIs Principais -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">⛰️</div>
                    <div class="stat-number" id="totalProdutos">0</div>
                    <div class="stat-label">Tipos de Minérios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-number" id="totalClientes">0</div>
                    <div class="stat-label">Clientes Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🚛</div>
                    <div class="stat-number" id="totalVeiculos">0</div>
                    <div class="stat-label">Veículos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-number" id="creditoTotal">R$ 100.000</div>
                    <div class="stat-label">Crédito Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📈</div>
                    <div class="stat-number" id="lucroMensal">R$ 0</div>
                    <div class="stat-label">Lucro Este Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-number" id="margemLucro">0%</div>
                    <div class="stat-label">Margem de Lucro</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚡</div>
                    <div class="stat-number" id="ticketMedio">R$ 0</div>
                    <div class="stat-label">Ticket Médio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📅</div>
                    <div class="stat-number" id="vendasMes">0</div>
                    <div class="stat-label">Vendas Este Mês</div>
                </div>
            </div>

            <!-- Analytics em Tempo Real -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div class="card">
                    <h3>📈 Performance Financeira</h3>
                    <canvas id="graficoPerformance" width="600" height="250" style="max-width: 100%;"></canvas>
                </div>
                <div class="card">
                    <h3>🎯 Indicadores de Performance</h3>
                    <div id="indicadoresPerformance">
                        <!-- Indicadores serão inseridos aqui -->
                    </div>
                </div>
            </div>

            <!-- Insights Inteligentes -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div class="card">
                    <h3>🧠 Insights Inteligentes</h3>
                    <div id="insightsInteligentes">
                        <!-- Insights serão gerados automaticamente -->
                    </div>
                </div>
                <div class="card">
                    <h3>🔔 Centro de Alertas</h3>
                    <div id="centroAlertas">
                        <!-- Alertas centralizados -->
                    </div>
                </div>
            </div>

            <!-- Resumo Operacional Expandido -->
            <div class="card">
                <h3>📋 Resumo Operacional Inteligente</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>💼 Operações</h4>
                        <p>✅ <strong>Sistema funcionando:</strong> Todos os módulos operacionais</p>
                        <p>⚖️ <strong>Estoque total:</strong> <span id="estoqueTotal">0 toneladas</span></p>
                        <p>🔧 <strong>Status:</strong> <span id="statusSistema">Sistema operacional</span></p>
                    </div>
                    <div>
                        <h4>💰 Financeiro</h4>
                        <p>💵 <strong>Receita hoje:</strong> <span id="receitaHoje">R$ 0,00</span></p>
                        <p>📊 <strong>Meta mensal:</strong> <span id="metaMensal">R$ 50.000,00</span></p>
                        <p>🎯 <strong>Progresso:</strong> <span id="progressoMeta">0%</span></p>
                    </div>
                    <div>
                        <h4>⚠️ Alertas Ativos</h4>
                        <div id="alertasResumo">
                            <!-- Resumo de alertas -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Minérios -->
        <div id="produtos" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 class="page-title">⛰️ Gestão de Minérios</h1>
                <button class="btn btn-success" onclick="showModal('modalProduto')">➕ Adicionar Minério</button>
            </div>

            <div class="card">
                <table class="table" id="tabelaProdutos">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Minério</th>
                            <th>Preço/Ton</th>
                            <th>Estoque (Ton)</th>
                            <th>Categoria</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Clientes -->
        <div id="clientes" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 class="page-title">👥 Gestão de Clientes</h1>
                <button class="btn btn-success" onclick="showModal('modalCliente')">➕ Adicionar Cliente</button>
            </div>

            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Total Compras</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaClientes">
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vendas -->
        <div id="vendas" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 class="page-title">💰 Gestão de Vendas</h1>
                <button class="btn btn-danger" onclick="showModal('modalVenda')">➕ Nova Venda</button>
            </div>

            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Data</th>
                            <th>Minério</th>
                            <th>Toneladas</th>
                            <th>Preço Custo</th>
                            <th>Valor Final</th>
                            <th>Lucro</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaVendas">
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Veículos -->
        <div id="veiculos" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 class="page-title">🚛 Gestão de Veículos</h1>
                <button class="btn btn-success" onclick="showModal('modalVeiculo')">➕ Adicionar Veículo</button>
            </div>

            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Modelo</th>
                            <th>Ano</th>
                            <th>Tara (Kg)</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaVeiculos">
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Despesas -->
        <div id="despesas" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h1 class="page-title">💸 Gestão de Despesas</h1>
                <button class="btn btn-warning" onclick="showModal('modalDespesa')">➕ Adicionar Despesa</button>
            </div>

            <div class="card" style="margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Filtrar por Veículo:</label>
                        <select id="filtroVeiculoDespesa">
                            <option>Todos os veículos</option>
                            <option>🏢 Empresa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Período:</label>
                        <select id="filtroPeriodoDespesa">
                            <option>Últimos 30 dias</option>
                            <option>Últimos 7 dias</option>
                            <option>Últimos 90 dias</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Veículo</th>
                            <th>Tipo</th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaDespesas">
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Crédito/Estoque -->
        <div id="credito" class="page">
            <h1 class="page-title">💳 Gestão de Crédito e Estoque</h1>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-number" id="creditoTotalSistema">R$ 100.000,00</div>
                    <div class="stat-label">Crédito Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📦</div>
                    <div class="stat-number" id="valorEstoque">R$ 0,00</div>
                    <div class="stat-label">Valor em Estoque</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💸</div>
                    <div class="stat-number" id="creditoDisponivel">R$ 100.000,00</div>
                    <div class="stat-label">Crédito Disponível</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚖️</div>
                    <div class="stat-number" id="totalToneladas">0 Ton</div>
                    <div class="stat-label">Total em Estoque</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <h3>💳 Movimentação de Crédito</h3>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="tipoMovimentacao">
                            <option>➕ Entrada de Crédito</option>
                            <option>➖ Saída de Crédito</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valor:</label>
                        <input type="number" step="0.01" placeholder="Ex: 50000.00" id="valorMovimentacao">
                    </div>
                    <div class="form-group">
                        <label>Descrição:</label>
                        <input type="text" placeholder="Ex: Compra de material" id="descricaoMovimentacao">
                    </div>
                    <button class="btn" onclick="registrarMovimentacao()">💾 Registrar</button>
                </div>

                <div class="card">
                    <h3>💰 Atualizar Preços</h3>
                    <div id="precosMinerios">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                    <button class="btn btn-success" onclick="atualizarPrecos()">🔄 Atualizar Preços</button>
                </div>
            </div>

            <div class="card">
                <h3>📋 Histórico de Movimentações</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Descrição</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaMovimentacoes">
                        <!-- Dados serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Relatórios -->
        <div id="relatorios" class="page">
            <h1 class="page-title">📊 Relatórios e Analytics Avançados</h1>

            <!-- Dashboard Financeiro -->
            <div class="card" style="margin-bottom: 25px;">
                <h3>💰 Dashboard Financeiro</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon">💵</div>
                        <div class="stat-number" id="receitaTotal">R$ 0,00</div>
                        <div class="stat-label">Receita Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📉</div>
                        <div class="stat-number" id="custoVendas">R$ 0,00</div>
                        <div class="stat-label">Custo das Vendas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💸</div>
                        <div class="stat-number" id="despesasTotal">R$ 0,00</div>
                        <div class="stat-label">Despesas Totais</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-number" id="lucroBruto">R$ 0,00</div>
                        <div class="stat-label">Lucro Bruto</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-number" id="lucroLiquido">R$ 0,00</div>
                        <div class="stat-label">Lucro Líquido</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-number" id="margemBruta">0%</div>
                        <div class="stat-label">Margem Bruta</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🔍</div>
                        <div class="stat-number" id="margemLiquida">0%</div>
                        <div class="stat-label">Margem Líquida</div>
                    </div>
                </div>
            </div>

            <!-- Filtros e Ações -->
            <div class="card" style="margin-bottom: 25px;">
                <h3>🔍 Filtros e Relatórios</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Cliente:</label>
                        <select id="filtroClienteRelatorio">
                            <option value="">Todos os clientes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Período:</label>
                        <select id="filtroPeriodoRelatorio">
                            <option>Último mês</option>
                            <option>Última semana</option>
                            <option>Últimos 3 meses</option>
                            <option>Últimos 6 meses</option>
                            <option>Último ano</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="tipoRelatorio">
                            <option>Lucros e Receitas</option>
                            <option>Análise de Custos</option>
                            <option>Performance por Cliente</option>
                            <option>Análise de Produtos</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <button class="btn" onclick="gerarRelatorioVendas()">📊 Gerar Relatório</button>
                    <button class="btn btn-success" onclick="imprimirRelatorio()">🖨️ Imprimir</button>
                    <button class="btn btn-warning" onclick="exportarCSV()">📁 Exportar CSV</button>
                </div>
            </div>

            <!-- Resumo Executivo -->
            <div class="card" style="margin-bottom: 25px;">
                <h3>📋 Resumo Executivo</h3>
                <div id="resumoExecutivo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <!-- Será preenchido dinamicamente -->
                </div>
            </div>

            <!-- Análises Detalhadas -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <div class="card">
                    <h3>🏆 Análise de Minérios por Lucro</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Minério</th>
                                <th>Ton Vendidas</th>
                                <th>Receita</th>
                                <th>Lucro</th>
                                <th>Margem</th>
                            </tr>
                        </thead>
                        <tbody id="topMinerios">
                            <!-- Será preenchido dinamicamente -->
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>👥 Análise de Clientes por Lucro</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Vendas</th>
                                <th>Receita</th>
                                <th>Lucro</th>
                                <th>Margem</th>
                                <th>Ticket Médio</th>
                            </tr>
                        </thead>
                        <tbody id="topClientes">
                            <!-- Será preenchido dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Análise de Despesas -->
            <div class="card" style="margin-bottom: 25px;">
                <h3>💸 Análise de Despesas por Categoria</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <strong>Total de Despesas: <span id="totalDespesasRelatorio">R$ 0,00</span></strong>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Quantidade</th>
                            <th>Valor Total</th>
                            <th>% do Total</th>
                        </tr>
                    </thead>
                    <tbody id="analiseDespesas">
                        <!-- Será preenchido dinamicamente -->
                    </tbody>
                </table>
            </div>

            <!-- Gráfico Financeiro Avançado -->
            <div class="card">
                <h3>📈 Análise Financeira Mensal</h3>
                <p style="color: #7f8c8d; margin-bottom: 15px;">
                    Evolução mensal da receita, custos e lucro nos últimos 6 meses
                </p>
                <canvas id="graficoVendas" width="800" height="300" style="max-width: 100%;"></canvas>
            </div>
        </div>

        <!-- Cobranças -->
        <div id="cobrancas" class="page">
            <h1 class="page-title">🔔 Gestão de Cobranças Avançada</h1>
            
            <!-- Dashboard de Cobranças -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-icon">⏰</div>
                    <div class="stat-number" id="vendasVencidas">0</div>
                    <div class="stat-label">Vendas Vencidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚠️</div>
                    <div class="stat-number" id="vendasVencendoHoje">0</div>
                    <div class="stat-label">Vencem Hoje</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📅</div>
                    <div class="stat-number" id="vendasProximas">0</div>
                    <div class="stat-label">Próximas (7 dias)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-number" id="valorPendente">R$ 0</div>
                    <div class="stat-label">Total Pendente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-number" id="clientesDevedores">0</div>
                    <div class="stat-label">Clientes Devedores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-number" id="ticketMedioPendente">R$ 0</div>
                    <div class="stat-label">Ticket Médio Pendente</div>
                </div>
            </div>

            <!-- Filtros e Controles -->
            <div class="card" style="margin-bottom: 25px;">
                <h3>🔍 Filtros e Ações</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Visualização:</label>
                        <select id="tipoVisualizacao" onchange="atualizarVisualizacaoCobrancas()">
                            <option value="cliente">Por Cliente</option>
                            <option value="cronologica">Cronológica</option>
                            <option value="valor">Por Valor</option>
                            <option value="atraso">Por Dias de Atraso</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status:</label>
                        <select id="filtroStatus" onchange="atualizarVisualizacaoCobrancas()">
                            <option value="todos">Todos</option>
                            <option value="vencidas">Vencidas</option>
                            <option value="vencendo">Vencendo Hoje</option>
                            <option value="proximas">Próximas (7 dias)</option>
                            <option value="criticas">Críticas (30+ dias)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cliente:</label>
                        <select id="filtroClienteCobranca" onchange="atualizarVisualizacaoCobrancas()">
                            <option value="">Todos os clientes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ações em Massa:</label>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-warning" onclick="enviarLembretesEmMassa()" style="flex: 1; font-size: 12px; padding: 8px;">📧 Lembrete</button>
                            <button class="btn btn-success" onclick="marcarMultiplasPagas()" style="flex: 1; font-size: 12px; padding: 8px;">✅ Marcar Pagas</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Conteúdo Dinâmico -->
            <div id="areaCobrancas">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>

            <!-- Modal de Detalhes do Cliente -->
            <div class="modal" id="modalDetalheCliente">
                <div class="modal-content" style="max-width: 900px;">
                    <h3 id="tituloDetalheCliente">Detalhes das Cobranças - Cliente</h3>
                    <div id="conteudoDetalheCliente">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-danger" onclick="hideModal('modalDetalheCliente')">Fechar</button>
                    </div>
                </div>
            </div>

            <!-- Modal de Histórico de Cobrança -->
            <div class="modal" id="modalHistoricoCobranca">
                <div class="modal-content" style="max-width: 700px;">
                    <h3>📋 Histórico de Cobrança</h3>
                    <div id="conteudoHistoricoCobranca">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-danger" onclick="hideModal('modalHistoricoCobranca')">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurações -->
        <div id="configuracoes" class="page">
            <h1 class="page-title">⚙️ Configurações do Sistema</h1>
            
            <div class="card">
                <h3>🏢 Dados da Empresa</h3>
                <div class="form-group">
                    <label>Nome da Empresa:</label>
                    <input type="text" id="nomeEmpresa" value="Rei da Caçambinha">
                </div>
                <div class="form-group">
                    <label>CNPJ:</label>
                    <input type="text" id="cnpjEmpresa" placeholder="00.000.000/0001-00">
                </div>
                <div class="form-group">
                    <label>Endereço:</label>
                    <input type="text" id="enderecoEmpresa" placeholder="Rua, número, bairro, cidade">
                </div>
                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="text" id="telefoneEmpresa" placeholder="(11) 99999-9999">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="emailEmpresa" placeholder="contato@empresa.com">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="card">
                    <h3>💰 Configurações Financeiras</h3>
                    <div class="form-group">
                        <label>Moeda:</label>
                        <select id="moedaSistema">
                            <option value="R$" selected>Real (R$)</option>
                            <option value="$">Dólar ($)</option>
                            <option value="€">Euro (€)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Margem de Lucro Padrão (%):</label>
                        <input type="number" step="0.1" id="margemLucro" value="30.0">
                    </div>
                    <div class="form-group">
                        <label>Desconto Máximo (%):</label>
                        <input type="number" step="0.1" id="descontoMaximo" value="10.0">
                    </div>
                </div>

                <div class="card">
                    <h3>🔔 Notificações e Alertas</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="alertaEstoqueBaixo" checked> 
                            Alertas de estoque baixo
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Limite mínimo de estoque:</label>
                        <input type="number" id="limiteEstoque" value="10">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="backupAutomatico" checked> 
                            Backup automático diário
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="notificacaoVendas" checked> 
                            Notificações de vendas
                        </label>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>🎨 Personalização da Interface</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Tema:</label>
                        <select id="temaSistema">
                            <option>Claro (Padrão)</option>
                            <option>Escuro</option>
                            <option>Automático</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cor Principal:</label>
                        <select id="corPrincipal">
                            <option value="#667eea">Azul Gradiente (Padrão)</option>
                            <option value="#2ecc71">Verde</option>
                            <option value="#e74c3c">Vermelho</option>
                            <option value="#f39c12">Laranja</option>
                            <option value="#9b59b6">Roxo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tamanho da Fonte:</label>
                        <select id="tamanhoFonte">
                            <option>Pequeno</option>
                            <option selected>Médio</option>
                            <option>Grande</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px;">
                <button class="btn btn-success" onclick="salvarConfiguracoes()">💾 Salvar Configurações</button>
                <button class="btn btn-warning" onclick="restaurarPadrao()">🔄 Restaurar Padrão</button>
                <button class="btn btn-danger" onclick="exportarConfiguracoes()">📤 Exportar Config</button>
            </div>
        </div>
    </div>

    <!-- Modais -->
    
    <!-- Modal Minério -->
    <div class="modal" id="modalProduto">
        <div class="modal-content">
            <h3>Adicionar Minério</h3>
            <div class="form-group">
                <label>Código:</label>
                <input type="text" placeholder="Ex: BR01" id="inputCodigo">
            </div>
            <div class="form-group">
                <label>Nome do Minério:</label>
                <input type="text" placeholder="Ex: Brita 1" id="inputNome">
            </div>
            <div class="form-group">
                <label>Preço por Tonelada:</label>
                <input type="number" step="0.01" placeholder="Ex: 61.00" id="inputPreco">
            </div>
            <div class="form-group">
                <label>Quantidade (Toneladas):</label>
                <input type="number" step="0.01" placeholder="Ex: 14.23" id="inputQuantidade">
            </div>
            <div class="form-group">
                <label>Categoria:</label>
                <select id="selectCategoria">
                    <option>Brita</option>
                    <option>Areia</option>
                    <option>Pedra</option>
                    <option>Cascalho</option>
                    <option>Rachão</option>
                </select>
            </div>
            <div class="grid-2">
                <button class="btn btn-success" onclick="adicionarMinerio()">Salvar</button>
                <button class="btn btn-danger" onclick="hideModal('modalProduto')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div class="modal" id="modalCliente">
        <div class="modal-content">
            <h3>Adicionar Cliente</h3>
            <div class="form-group">
                <label>Nome/Razão Social:</label>
                <input type="text" placeholder="Ex: Construtora ABC Ltda" id="inputClienteNome">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" placeholder="contato@empresa.com" id="inputClienteEmail">
            </div>
            <div class="form-group">
                <label>Telefone:</label>
                <input type="tel" placeholder="(11) 99999-9999" id="inputClienteTelefone">
            </div>
            <div class="form-group">
                <label>Endereço:</label>
                <input type="text" placeholder="Rua, número, bairro" id="inputClienteEndereco">
            </div>
            <div class="grid-2">
                <button class="btn btn-success" onclick="adicionarCliente()">Salvar</button>
                <button class="btn btn-danger" onclick="hideModal('modalCliente')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Veículo -->
    <div class="modal" id="modalVeiculo">
        <div class="modal-content">
            <h3>Adicionar Veículo</h3>
            <div class="form-group">
                <label>Placa:</label>
                <input type="text" placeholder="Ex: ABC-1234" id="inputVeiculoPlaca">
            </div>
            <div class="form-group">
                <label>Modelo:</label>
                <input type="text" placeholder="Ex: Mercedes-Benz Atego" id="inputVeiculoModelo">
            </div>
            <div class="form-group">
                <label>Ano:</label>
                <input type="number" min="1980" max="2030" placeholder="2020" id="inputVeiculoAno">
            </div>
            <div class="form-group">
                <label>Tara (Peso em Kg):</label>
                <input type="number" step="0.01" placeholder="Ex: 8500.00" id="inputVeiculoTara">
            </div>
            <div class="form-group">
                <label>Status:</label>
                <select id="selectVeiculoStatus">
                    <option>Ativo</option>
                    <option>Manutenção</option>
                    <option>Inativo</option>
                </select>
            </div>
            <div class="grid-2">
                <button class="btn btn-success" onclick="adicionarVeiculo()">Salvar</button>
                <button class="btn btn-danger" onclick="hideModal('modalVeiculo')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Venda -->
    <div class="modal" id="modalVenda">
        <div class="modal-content">
            <h3>Nova Venda</h3>
            <div class="form-group">
                <label>Cliente:</label>
                <select id="selectVendaCliente">
                    <option>Selecione um cliente...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Minério:</label>
                <select id="selectVendaMinerio">
                    <option>Selecione um minério...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quantidade (Toneladas):</label>
                <input type="number" step="0.01" placeholder="Ex: 25.50" id="inputVendaQuantidade">
            </div>
            <div class="form-group">
                <label>Valor Final da Venda:</label>
                <input type="number" step="0.01" placeholder="Ex: 3500.00" id="inputPrecoFinal">
            </div>
            <div class="form-group">
                <label>Método de Pagamento:</label>
                <select id="selectVendaPagamento">
                    <option>PIX</option>
                    <option>Transferência</option>
                    <option>Boleto</option>
                    <option>Cheque</option>
                    <option>Dinheiro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tipo de Venda:</label>
                <select id="selectTipoVenda" onchange="togglePrazoVenda()">
                    <option value="avista">À Vista</option>
                    <option value="prazo">À Prazo</option>
                </select>
            </div>
            <div class="form-group" id="grupoPrazo" style="display: none;">
                <label>Prazo de Pagamento (dias):</label>
                <select id="selectPrazoPagamento">
                    <option value="7">7 dias</option>
                    <option value="15">15 dias</option>
                    <option value="30">30 dias</option>
                    <option value="45">45 dias</option>
                    <option value="60">60 dias</option>
                    <option value="90">90 dias</option>
                </select>
            </div>
            <div class="form-group" id="grupoDataVencimento" style="display: none;">
                <label>Data de Vencimento:</label>
                <input type="date" id="dataVencimento" readonly style="background: #f8f9fa;">
            </div>
            <div class="form-group">
                <label>Preço de Custo: R$ <span id="precoCusto">0,00</span></label>
            </div>
            <div class="form-group">
                <label><strong>Lucro Estimado: R$ <span id="lucroVenda">0,00</span></strong></label>
            </div>
            <div class="grid-2">
                <button class="btn btn-success" onclick="finalizarVenda()">Finalizar Venda</button>
                <button class="btn btn-danger" onclick="hideModal('modalVenda')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Despesa -->
    <div class="modal" id="modalDespesa">
        <div class="modal-content">
            <h3>Adicionar Despesa</h3>
            <div class="form-group">
                <label>Veículo:</label>
                <select id="selectDespesaVeiculo">
                    <option>🏢 Despesa da Empresa</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tipo:</label>
                <select id="selectDespesaTipo">
                    <option>⛽ Combustível</option>
                    <option>🔧 Peças</option>
                    <option>🛠️ Manutenção</option>
                    <option>🛡️ Seguro</option>
                    <option>📄 Licenciamento</option>
                    <option>📋 Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label>Descrição:</label>
                <input type="text" placeholder="Ex: Troca de pneu traseiro" id="inputDespesaDescricao">
            </div>
            <div class="form-group">
                <label>Valor:</label>
                <input type="number" step="0.01" placeholder="Ex: 150.00" id="inputDespesaValor">
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="inputDespesaData">
            </div>
            <div class="grid-2">
                <button class="btn btn-success" onclick="adicionarDespesa()">Salvar</button>
                <button class="btn btn-danger" onclick="hideModal('modalDespesa')">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Sistema completo para mineração
        let currentPage = 'dashboard';
        let editandoIndice = -1;

        // Sistema de Notificações Avançado
        class NotificationSystem {
            constructor() {
                this.notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                this.settings = JSON.parse(localStorage.getItem('notificationSettings') || '{"push": false, "sound": true, "email": false}');
                this.isOpen = false;
                this.soundEnabled = this.settings.sound;
                this.pushEnabled = this.settings.push;
                
                this.initializePushNotifications();
                this.loadNotifications();
                this.updateBadge();
                
                // Verificar notificações periodicamente
                setInterval(() => this.checkForNewNotifications(), 30000); // A cada 30 segundos
            }

            async initializePushNotifications() {
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        this.pushEnabled = true;
                        this.settings.push = true;
                        this.saveSettings();
                        this.updateToggleStates();
                    }
                }
            }

            createNotification(type, title, message, actions = null, autoClose = true) {
                const notification = {
                    id: Date.now() + Math.random(),
                    type: type, // 'critical', 'warning', 'success', 'info'
                    title: title,
                    message: message,
                    timestamp: new Date().toISOString(),
                    read: false,
                    actions: actions
                };

                this.notifications.unshift(notification);
                this.saveNotifications();
                this.updateBadge();
                this.addToNotificationList(notification);
                
                // Mostrar toast notification
                this.showToast(notification, autoClose);
                
                // Push notification se habilitado
                if (this.pushEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: '/favicon.ico',
                        badge: '/favicon.ico',
                        tag: notification.id.toString()
                    });
                }
                
                // Som se habilitado
                if (this.soundEnabled) {
                    this.playNotificationSound(type);
                }
                
                // Animar sino
                this.animateBell();
                
                return notification.id;
            }

            showToast(notification, autoClose = true) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast-notification ${notification.type}`;
                toast.id = `toast-${notification.id}`;
                
                toast.innerHTML = `
                    <div class="toast-header">
                        <span class="toast-title">${notification.title}</span>
                        <button class="toast-close" onclick="notificationSystem.removeToast('${notification.id}')">×</button>
                    </div>
                    <div class="toast-message">${notification.message}</div>
                    ${notification.actions ? this.renderToastActions(notification.actions, notification.id) : ''}
                `;
                
                container.appendChild(toast);
                
                // Auto-close após 5 segundos (exceto críticas)
                if (autoClose && notification.type !== 'critical') {
                    setTimeout(() => {
                        this.removeToast(notification.id);
                    }, 5000);
                }
            }

            renderToastActions(actions, notificationId) {
                return `
                    <div style="margin-top: 10px; display: flex; gap: 8px;">
                        ${actions.map(action => `
                            <button class="notification-action ${action.type}" 
                                    onclick="${action.action}; notificationSystem.removeToast('${notificationId}')">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            removeToast(notificationId) {
                const toast = document.getElementById(`toast-${notificationId}`);
                if (toast) {
                    toast.classList.add('removing');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }

            playNotificationSound(type) {
                // Criar contexto de áudio e tocar som baseado no tipo
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Frequências diferentes para cada tipo
                const frequencies = {
                    critical: [800, 600, 800], // Emergência
                    warning: [600, 400],       // Aviso
                    success: [400, 600],       // Sucesso
                    info: [500]                // Informação
                };
                
                const freq = frequencies[type] || frequencies.info;
                
                oscillator.frequency.setValueAtTime(freq[0], audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // Para tipos com múltiplas frequências
                if (freq.length > 1) {
                    setTimeout(() => {
                        const oscillator2 = audioContext.createOscillator();
                        const gainNode2 = audioContext.createGain();
                        oscillator2.connect(gainNode2);
                        gainNode2.connect(audioContext.destination);
                        oscillator2.frequency.setValueAtTime(freq[1], audioContext.currentTime);
                        gainNode2.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator2.start();
                        oscillator2.stop(audioContext.currentTime + 0.3);
                    }, 200);
                }
            }

            animateBell() {
                const bell = document.getElementById('notificationBell');
                bell.classList.add('has-notifications');
                setTimeout(() => {
                    bell.classList.remove('has-notifications');
                }, 2000);
            }

            addToNotificationList(notification) {
                const list = document.getElementById('notificationList');
                const item = document.createElement('div');
                item.className = `notification-item ${notification.type} unread`;
                item.id = `notification-${notification.id}`;
                
                const timeAgo = this.getTimeAgo(new Date(notification.timestamp));
                
                item.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${timeAgo}</div>
                    ${notification.actions ? this.renderNotificationActions(notification.actions, notification.id) : ''}
                `;
                
                item.onclick = () => this.markAsRead(notification.id);
                
                list.insertBefore(item, list.firstChild);
            }

            renderNotificationActions(actions, notificationId) {
                return `
                    <div class="notification-actions">
                        ${actions.map(action => `
                            <button class="notification-action ${action.type}" 
                                    onclick="event.stopPropagation(); ${action.action}; notificationSystem.markAsRead('${notificationId}')">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            loadNotifications() {
                const list = document.getElementById('notificationList');
                list.innerHTML = '';
                
                if (this.notifications.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">Nenhuma notificação</div>';
                    return;
                }
                
                this.notifications.forEach(notification => {
                    this.addToNotificationList(notification);
                });
            }

            updateBadge() {
                const unreadCount = this.notifications.filter(n => !n.read).length;
                const badge = document.getElementById('notificationBadge');
                const countElement = document.getElementById('notificationCount');
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                if (countElement) {
                    countElement.textContent = `${this.notifications.length} notificações`;
                }
            }

            markAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id == notificationId);
                if (notification && !notification.read) {
                    notification.read = true;
                    this.saveNotifications();
                    this.updateBadge();
                    
                    const element = document.getElementById(`notification-${notificationId}`);
                    if (element) {
                        element.classList.remove('unread');
                    }
                }
            }

            markAllAsRead() {
                this.notifications.forEach(n => n.read = true);
                this.saveNotifications();
                this.updateBadge();
                
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('unread');
                });
            }

            clearAllNotifications() {
                if (confirm('Deseja limpar todas as notificações?')) {
                    this.notifications = [];
                    this.saveNotifications();
                    this.updateBadge();
                    this.loadNotifications();
                }
            }

            togglePushNotifications() {
                this.pushEnabled = !this.pushEnabled;
                this.settings.push = this.pushEnabled;
                this.saveSettings();
                this.updateToggleStates();
                
                if (this.pushEnabled && 'Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission !== 'granted') {
                            this.pushEnabled = false;
                            this.settings.push = false;
                            this.saveSettings();
                            this.updateToggleStates();
                        }
                    });
                }
            }

            toggleSoundNotifications() {
                this.soundEnabled = !this.soundEnabled;
                this.settings.sound = this.soundEnabled;
                this.saveSettings();
                this.updateToggleStates();
            }

            updateToggleStates() {
                const pushToggle = document.getElementById('pushToggle');
                const soundToggle = document.getElementById('soundToggle');
                
                if (pushToggle) {
                    pushToggle.classList.toggle('active', this.pushEnabled);
                }
                if (soundToggle) {
                    soundToggle.classList.toggle('active', this.soundEnabled);
                }
            }

            checkForNewNotifications() {
                // Verificar alertas automáticos baseados nos dados
                this.checkStockAlerts();
                this.checkPaymentAlerts();
                this.checkVehicleAlerts();
                this.checkPerformanceAlerts();
            }

            checkStockAlerts() {
                dados.minerios.forEach(minerio => {
                    const estoque = minerio.estoque || 0;
                    const limite = dados.configuracoes.limiteEstoque || 10;
                    
                    // Verificar se já existe notificação similar recente
                    const recentAlert = this.notifications.find(n => 
                        n.title.includes('Estoque Crítico') && 
                        n.message.includes(minerio.nome) &&
                        (Date.now() - new Date(n.timestamp).getTime()) < 24 * 60 * 60 * 1000 // 24 horas
                    );
                    
                    if (estoque <= 5 && !recentAlert) {
                        this.createNotification(
                            'critical',
                            '⚠️ Estoque Crítico',
                            `${minerio.nome}: apenas ${estoque.toFixed(1)} toneladas restantes!`,
                            [
                                { label: '📦 Ver Estoque', type: 'primary', action: "showPage('produtos')" },
                                { label: '📞 Encomendar', type: 'success', action: "alert('Função de encomenda em desenvolvimento')" }
                            ]
                        );
                    } else if (estoque <= limite && estoque > 5 && !recentAlert) {
                        this.createNotification(
                            'warning',
                            '📦 Estoque Baixo',
                            `${minerio.nome}: ${estoque.toFixed(1)} toneladas em estoque`,
                            [
                                { label: '👁️ Visualizar', type: 'primary', action: "showPage('produtos')" }
                            ]
                        );
                    }
                });
            }

            checkPaymentAlerts() {
                const hoje = new Date();
                dados.vendas.forEach(venda => {
                    if (venda.status !== 'Paga' && venda.dataVencimento) {
                        const vencimento = new Date(venda.dataVencimento);
                        const diffTime = vencimento - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        // Verificar se já existe notificação similar recente
                        const recentAlert = this.notifications.find(n => 
                            n.message.includes(venda.id) &&
                            (Date.now() - new Date(n.timestamp).getTime()) < 12 * 60 * 60 * 1000 // 12 horas
                        );
                        
                        if (diffDays === 0 && !recentAlert) {
                            this.createNotification(
                                'critical',
                                '💰 Cobrança Vence Hoje',
                                `Venda ${venda.id} - ${venda.cliente} - R$ ${venda.total.toFixed(2)}`,
                                [
                                    { label: '📞 Cobrar', type: 'primary', action: `enviarLembrete('${venda.id}')` },
                                    { label: '✅ Marcar Paga', type: 'success', action: `marcarComoPaga('${venda.id}')` }
                                ]
                            );
                        } else if (diffDays < 0 && Math.abs(diffDays) % 7 === 0 && !recentAlert) {
                            this.createNotification(
                                'critical',
                                '🔴 Pagamento Vencido',
                                `Venda ${venda.id} vencida há ${Math.abs(diffDays)} dias - ${venda.cliente}`,
                                [
                                    { label: '🚨 Cobrar Urgente', type: 'primary', action: `enviarLembrete('${venda.id}')` },
                                    { label: '📋 Ver Detalhes', type: 'info', action: "showPage('cobrancas')" }
                                ]
                            );
                        }
                    }
                });
            }

            checkVehicleAlerts() {
                dados.veiculos.forEach(veiculo => {
                    if (veiculo.status === 'Manutenção') {
                        const recentAlert = this.notifications.find(n => 
                            n.message.includes(veiculo.placa) &&
                            (Date.now() - new Date(n.timestamp).getTime()) < 24 * 60 * 60 * 1000
                        );
                        
                        if (!recentAlert) {
                            this.createNotification(
                                'warning',
                                '🔧 Veículo em Manutenção',
                                `${veiculo.placa} - ${veiculo.modelo} indisponível`,
                                [
                                    { label: '🚛 Ver Frota', type: 'primary', action: "showPage('veiculos')" }
                                ]
                            );
                        }
                    }
                });
            }

            checkPerformanceAlerts() {
                // Verificar margem de lucro baixa
                const vendasRecentes = dados.vendas.slice(-5);
                if (vendasRecentes.length >= 3) {
                    let margemMedia = 0;
                    vendasRecentes.forEach(venda => {
                        const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                        const custo = venda.quantidade * (minerio?.preco || 0);
                        const margem = venda.total > 0 ? ((venda.total - custo) / venda.total) * 100 : 0;
                        margemMedia += margem;
                    });
                    margemMedia /= vendasRecentes.length;
                    
                    if (margemMedia < 15) {
                        const recentAlert = this.notifications.find(n => 
                            n.title.includes('Margem de Lucro') &&
                            (Date.now() - new Date(n.timestamp).getTime()) < 24 * 60 * 60 * 1000
                        );
                        
                        if (!recentAlert) {
                            this.createNotification(
                                'warning',
                                '📉 Margem de Lucro Baixa',
                                `Margem média das últimas vendas: ${margemMedia.toFixed(1)}%`,
                                [
                                    { label: '📊 Ver Relatórios', type: 'primary', action: "showPage('relatorios')" },
                                    { label: '💰 Ajustar Preços', type: 'warning', action: "showPage('credito')" }
                                ]
                            );
                        }
                    }
                }
            }

            getTimeAgo(date) {
                const now = new Date();
                const diffTime = now - date;
                const diffMinutes = Math.floor(diffTime / (1000 * 60));
                const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffMinutes < 1) return 'Agora';
                if (diffMinutes < 60) return `${diffMinutes}m atrás`;
                if (diffHours < 24) return `${diffHours}h atrás`;
                if (diffDays < 7) return `${diffDays}d atrás`;
                return date.toLocaleDateString('pt-BR');
            }

            saveNotifications() {
                // Manter apenas as últimas 100 notificações
                if (this.notifications.length > 100) {
                    this.notifications = this.notifications.slice(0, 100);
                }
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            }

            saveSettings() {
                localStorage.setItem('notificationSettings', JSON.stringify(this.settings));
            }
        }

        // Instância global do sistema de notificações
        let notificationSystem;

        // Funções globais para controle das notificações
        function toggleNotificationCenter() {
            const center = document.getElementById('notificationCenter');
            const overlay = document.getElementById('notificationOverlay');
            
            if (notificationSystem.isOpen) {
                closeNotificationCenter();
            } else {
                center.classList.add('active');
                overlay.classList.add('active');
                notificationSystem.isOpen = true;
                notificationSystem.loadNotifications();
            }
        }

        function closeNotificationCenter() {
            const center = document.getElementById('notificationCenter');
            const overlay = document.getElementById('notificationOverlay');
            
            center.classList.remove('active');
            overlay.classList.remove('active');
            notificationSystem.isOpen = false;
        }

        function togglePushNotifications() {
            notificationSystem.togglePushNotifications();
        }

        function toggleSoundNotifications() {
            notificationSystem.toggleSoundNotifications();
        }

        function markAllAsRead() {
            notificationSystem.markAllAsRead();
        }

        function clearAllNotifications() {
            notificationSystem.clearAllNotifications();
        }

        // Sistema de dados com persistência local
        let dados = {
            minerios: [
                {
                    codigo: 'BR01',
                    nome: 'Brita 1',
                    preco: 61.00,
                    estoque: 150.5,
                    categoria: 'Brita'
                },
                {
                    codigo: 'AR01', 
                    nome: 'Areia Média',
                    preco: 45.00,
                    estoque: 320.75,
                    categoria: 'Areia'
                },
                {
                    codigo: 'CS01',
                    nome: 'Cascalho',
                    preco: 52.00,
                    estoque: 25.40,
                    categoria: 'Cascalho'
                }
            ],
            clientes: [
                {
                    id: 'C001',
                    nome: 'Construtora Silva Ltda',
                    email: 'obras@construtora-silva.com',
                    telefone: '(11) 99999-9999',
                    endereco: 'Rua das Obras, 123',
                    totalCompras: 8750.00
                },
                {
                    id: 'C002',
                    nome: 'Prefeitura Municipal',
                    email: 'compras@prefeitura.gov.br',
                    telefone: '(11) 88888-8888',
                    endereco: 'Av. Central, 456',
                    totalCompras: 15680.00
                },
                {
                    id: 'C003',
                    nome: 'Obras Públicas SP',
                    email: 'contato@obrassp.com.br',
                    telefone: '(11) 77777-7777',
                    endereco: 'Rod. SP-101, km 25',
                    totalCompras: 3250.00
                }
            ],
            veiculos: [
                {
                    placa: 'ABC-1234',
                    modelo: 'Mercedes-Benz Atego 1719',
                    ano: 2018,
                    tara: 8500.00,
                    status: 'Ativo'
                },
                {
                    placa: 'DEF-5678',
                    modelo: 'Volvo VM 270',
                    ano: 2020,
                    tara: 9200.00,
                    status: 'Ativo'
                },
                {
                    placa: 'GHI-9012',
                    modelo: 'Scania G 420',
                    ano: 2019,
                    tara: 8800.00,
                    status: 'Manutenção'
                }
            ],
            vendas: [
                {
                    id: 'V001',
                    cliente: 'Construtora Silva Ltda',
                    clienteId: 'C001',
                    data: '25/12/2024',
                    minerio: 'Brita 1',
                    minerioId: 'BR01',
                    quantidade: 61.5,
                    total: 3751.50,
                    status: 'Paga',
                    pagamento: 'PIX',
                    tipoVenda: 'avista',
                    dataVencimento: null
                },
                {
                    id: 'V002',
                    cliente: 'Prefeitura Municipal',
                    clienteId: 'C002',
                    data: '20/12/2024',
                    minerio: 'Areia Média',
                    minerioId: 'AR01',
                    quantidade: 126.2,
                    total: 5679.00,
                    status: 'Pendente',
                    pagamento: 'Boleto',
                    tipoVenda: 'prazo',
                    prazoPagamento: 30,
                    dataVencimento: '2025-01-19T00:00:00.000Z'
                },
                {
                    id: 'V003',
                    cliente: 'Obras Públicas SP',
                    clienteId: 'C003',
                    data: '15/12/2024',
                    minerio: 'Cascalho',
                    minerioId: 'CS01',
                    quantidade: 179.2,
                    total: 9318.40,
                    status: 'Pendente',
                    pagamento: 'Transferência',
                    tipoVenda: 'prazo',
                    prazoPagamento: 15,
                    dataVencimento: '2024-12-30T00:00:00.000Z'
                }
            ],
            despesas: [
                {
                    veiculo: 'ABC-1234 - Mercedes-Benz Atego 1719',
                    tipo: '⛽ Combustível',
                    descricao: 'Abastecimento completo',
                    valor: 450.00,
                    data: '24/12/2024'
                },
                {
                    veiculo: 'DEF-5678 - Volvo VM 270',
                    tipo: '🛠️ Manutenção',
                    descricao: 'Troca de óleo e filtros',
                    valor: 380.00,
                    data: '23/12/2024'
                }
            ],
            movimentacoes: [],
            creditoSistema: {
                creditoTotal: 100000.00,
                valorEmEstoque: 0,
                creditoDisponivel: 100000.00,
                totalToneladas: 0
            },
            configuracoes: {
                nomeEmpresa: 'Rei da Caçambinha',
                cnpj: '',
                endereco: '',
                telefone: '',
                email: '',
                moeda: 'R$',
                margemLucro: 30.0,
                descontoMaximo: 10.0,
                alertaEstoqueBaixo: true,
                limiteEstoque: 10,
                backupAutomatico: true,
                notificacaoVendas: true,
                tema: 'Claro (Padrão)',
                corPrincipal: '#667eea',
                tamanhoFonte: 'Médio'
            }
        };

        // Carregar dados do localStorage
        function carregarDados() {
            const dadosSalvos = localStorage.getItem('dadosMineracao');
            if (dadosSalvos) {
                try {
                    dados = JSON.parse(dadosSalvos);
                } catch (e) {
                    console.log('Erro ao carregar dados salvos, usando dados padrão');
                }
            }
        }

        // Salvar dados no localStorage
        function salvarDados() {
            localStorage.setItem('dadosMineracao', JSON.stringify(dados));
            console.log('✅ Dados salvos automaticamente');
        }

        function showPage(pageId) {
            // Esconder todas as páginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remover active de todos os botões do menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar página selecionada
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            // Marcar botão como ativo
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: encontrar o botão correspondente
                const botao = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                if (botao) {
                    botao.classList.add('active');
                }
            }
            
            currentPage = pageId;
            
            // Atualizar dados da página
            atualizarDashboard();
        }

        function showModal(modalId) {
            // Limpar formulários
            if (modalId === 'modalProduto') {
                document.getElementById('inputCodigo').value = '';
                document.getElementById('inputNome').value = '';
                document.getElementById('inputPreco').value = '';
                document.getElementById('inputQuantidade').value = '';
                document.getElementById('selectCategoria').value = 'Brita';
                editandoIndice = -1;
            } else if (modalId === 'modalCliente') {
                document.getElementById('inputClienteNome').value = '';
                document.getElementById('inputClienteEmail').value = '';
                document.getElementById('inputClienteTelefone').value = '';
                document.getElementById('inputClienteEndereco').value = '';
                editandoIndice = -1;
            } else if (modalId === 'modalVeiculo') {
                document.getElementById('inputVeiculoPlaca').value = '';
                document.getElementById('inputVeiculoModelo').value = '';
                document.getElementById('inputVeiculoAno').value = '';
                document.getElementById('inputVeiculoTara').value = '';
                document.getElementById('selectVeiculoStatus').value = 'Ativo';
                editandoIndice = -1;
            } else if (modalId === 'modalVenda') {
                atualizarSelectsVenda();
                document.getElementById('inputVendaQuantidade').value = '';
                document.getElementById('inputPrecoFinal').value = '';
                document.getElementById('selectTipoVenda').value = 'avista';
                document.getElementById('precoCusto').textContent = '0,00';
                document.getElementById('lucroVenda').textContent = '0,00';
                togglePrazoVenda();
            } else if (modalId === 'modalDespesa') {
                atualizarSelectsDespesa();
                document.getElementById('inputDespesaDescricao').value = '';
                document.getElementById('inputDespesaValor').value = '';
                document.getElementById('inputDespesaData').value = new Date().toISOString().split('T')[0];
            }
            
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function atualizarDashboard() {
            // KPIs básicos
            document.getElementById('totalProdutos').textContent = dados.minerios.length;
            document.getElementById('totalClientes').textContent = dados.clientes.length;
            document.getElementById('totalVeiculos').textContent = dados.veiculos.length;
            document.getElementById('creditoTotal').textContent = `R$ ${dados.creditoSistema.creditoTotal.toLocaleString('pt-BR')}`;
            
            // Calcular estoque total
            const estoqueTotal = dados.minerios.reduce((total, minerio) => total + (minerio.estoque || 0), 0);
            document.getElementById('estoqueTotal').textContent = `${estoqueTotal.toFixed(2)} toneladas`;
            
            // Analytics avançados
            if (currentPage === 'dashboard') {
                calcularAnalyticsAvancados();
                gerarAlertasInteligentes();
                atualizarInsightsInteligentes();
                desenharGraficoPerformance();
                atualizarIndicadoresPerformance();
                atualizarCentroAlertas();
            }
            
            // Atualizar tabelas conforme a página atual
            if (currentPage === 'produtos') {
                atualizarTabelaProdutos();
            } else if (currentPage === 'clientes') {
                atualizarTabelaClientes();
            } else if (currentPage === 'veiculos') {
                atualizarTabelaVeiculos();
            } else if (currentPage === 'vendas') {
                atualizarTabelaVendas();
            } else if (currentPage === 'despesas') {
                atualizarTabelaDespesas();
            } else if (currentPage === 'credito') {
                atualizarPaginaCredito();
            } else if (currentPage === 'relatorios') {
                atualizarRelatorios();
            } else if (currentPage === 'cobrancas') {
                atualizarPaginaCobrancas();
            } else if (currentPage === 'configuracoes') {
                carregarConfiguracoes();
            }
        }

        // ============= FUNÇÕES DE MINÉRIOS =============

        function atualizarTabelaProdutos() {
            const tbody = document.querySelector('#tabelaProdutos tbody');
            tbody.innerHTML = '';
            
            dados.minerios.forEach((minerio, index) => {
                const status = (minerio.estoque || 0) <= 10 ? '<span class="badge badge-danger">🔴 Baixo</span>' : '<span class="badge badge-success">🟢 Normal</span>';
                const preco = minerio.preco || 0;
                const estoque = minerio.estoque || 0;
                const row = `
                    <tr>
                        <td>${minerio.codigo || ''}</td>
                        <td>${minerio.nome || ''}</td>
                        <td>R$ ${preco.toFixed(2)}</td>
                        <td>${estoque.toFixed(2)}</td>
                        <td>🏔️ ${minerio.categoria || ''}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editarMinerio(${index})">✏️</button>
                            <button class="btn btn-danger" onclick="excluirMinerio(${index})">🗑️</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function adicionarMinerio() {
            const codigo = document.getElementById('inputCodigo').value;
            const nome = document.getElementById('inputNome').value;
            const preco = parseFloat(document.getElementById('inputPreco').value);
            const estoque = parseFloat(document.getElementById('inputQuantidade').value);
            const categoria = document.getElementById('selectCategoria').value;

            if (codigo && nome && !isNaN(preco) && !isNaN(estoque)) {
                const minerio = {
                    codigo: codigo,
                    nome: nome,
                    preco: preco,
                    estoque: estoque,
                    categoria: categoria
                };

                if (editandoIndice >= 0) {
                    dados.minerios[editandoIndice] = minerio;
                    editandoIndice = -1;
                } else {
                    dados.minerios.push(minerio);
                }
                
                salvarDados();
                hideModal('modalProduto');
                atualizarDashboard();
                alert('✅ Minério salvo com sucesso!');
            } else {
                alert('❌ Por favor, preencha todos os campos corretamente!');
            }
        }

        function editarMinerio(index) {
            const minerio = dados.minerios[index];
            document.getElementById('inputCodigo').value = minerio.codigo;
            document.getElementById('inputNome').value = minerio.nome;
            document.getElementById('inputPreco').value = minerio.preco;
            document.getElementById('inputQuantidade').value = minerio.estoque;
            document.getElementById('selectCategoria').value = minerio.categoria;
            
            editandoIndice = index;
            showModal('modalProduto');
        }

        function excluirMinerio(index) {
            const minerio = dados.minerios[index];
            if (confirm(`🗑️ Deseja realmente excluir o minério "${minerio.nome}"?`)) {
                dados.minerios.splice(index, 1);
                salvarDados();
                atualizarDashboard();
                alert('✅ Minério excluído com sucesso!');
            }
        }

        // ============= FUNÇÕES DE CLIENTES =============

        function atualizarTabelaClientes() {
            const tbody = document.querySelector('#tabelaClientes');
            tbody.innerHTML = '';
            
            dados.clientes.forEach((cliente, index) => {
                const row = `
                    <tr>
                        <td>${cliente.id}</td>
                        <td>${cliente.nome}</td>
                        <td>${cliente.email}</td>
                        <td>${cliente.telefone}</td>
                        <td>R$ ${(cliente.totalCompras || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editarCliente(${index})">✏️</button>
                            <button class="btn btn-danger" onclick="excluirCliente(${index})">🗑️</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function adicionarCliente() {
            const nome = document.getElementById('inputClienteNome').value;
            const email = document.getElementById('inputClienteEmail').value;
            const telefone = document.getElementById('inputClienteTelefone').value;
            const endereco = document.getElementById('inputClienteEndereco').value;

            if (nome && email && telefone) {
                const cliente = {
                    id: editandoIndice >= 0 ? dados.clientes[editandoIndice].id : 'C' + String(dados.clientes.length + 1).padStart(3, '0'),
                    nome: nome,
                    email: email,
                    telefone: telefone,
                    endereco: endereco,
                    totalCompras: editandoIndice >= 0 ? dados.clientes[editandoIndice].totalCompras : 0
                };

                if (editandoIndice >= 0) {
                    dados.clientes[editandoIndice] = cliente;
                    editandoIndice = -1;
                } else {
                    dados.clientes.push(cliente);
                }
                
                salvarDados();
                hideModal('modalCliente');
                atualizarDashboard();
                alert('✅ Cliente salvo com sucesso!');
            } else {
                alert('❌ Por favor, preencha nome, email e telefone!');
            }
        }

        function editarCliente(index) {
            const cliente = dados.clientes[index];
            document.getElementById('inputClienteNome').value = cliente.nome;
            document.getElementById('inputClienteEmail').value = cliente.email;
            document.getElementById('inputClienteTelefone').value = cliente.telefone;
            document.getElementById('inputClienteEndereco').value = cliente.endereco || '';
            
            editandoIndice = index;
            showModal('modalCliente');
        }

        function excluirCliente(index) {
            const cliente = dados.clientes[index];
            if (confirm(`🗑️ Deseja realmente excluir o cliente "${cliente.nome}"?`)) {
                dados.clientes.splice(index, 1);
                salvarDados();
                atualizarDashboard();
                alert('✅ Cliente excluído com sucesso!');
            }
        }

        // ============= FUNÇÕES DE VEÍCULOS =============

        function atualizarTabelaVeiculos() {
            const tbody = document.querySelector('#tabelaVeiculos');
            tbody.innerHTML = '';
            
            dados.veiculos.forEach((veiculo, index) => {
                const statusBadge = veiculo.status === 'Ativo' ? 
                    '<span class="badge badge-success">🟢 Ativo</span>' : 
                    veiculo.status === 'Manutenção' ? 
                    '<span class="badge badge-warning">🟡 Manutenção</span>' :
                    '<span class="badge badge-danger">🔴 Inativo</span>';
                
                const row = `
                    <tr>
                        <td>${veiculo.placa}</td>
                        <td>${veiculo.modelo}</td>
                        <td>${veiculo.ano}</td>
                        <td>${veiculo.tara.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editarVeiculo(${index})">✏️</button>
                            <button class="btn btn-danger" onclick="excluirVeiculo(${index})">🗑️</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function adicionarVeiculo() {
            const placa = document.getElementById('inputVeiculoPlaca').value;
            const modelo = document.getElementById('inputVeiculoModelo').value;
            const ano = parseInt(document.getElementById('inputVeiculoAno').value);
            const tara = parseFloat(document.getElementById('inputVeiculoTara').value);
            const status = document.getElementById('selectVeiculoStatus').value;

            if (placa && modelo && !isNaN(ano) && !isNaN(tara)) {
                const veiculo = {
                    placa: placa,
                    modelo: modelo,
                    ano: ano,
                    tara: tara,
                    status: status
                };

                if (editandoIndice >= 0) {
                    dados.veiculos[editandoIndice] = veiculo;
                    editandoIndice = -1;
                } else {
                    dados.veiculos.push(veiculo);
                }
                
                salvarDados();
                hideModal('modalVeiculo');
                atualizarDashboard();
                alert('✅ Veículo salvo com sucesso!');
            } else {
                alert('❌ Por favor, preencha todos os campos corretamente!');
            }
        }

        function editarVeiculo(index) {
            const veiculo = dados.veiculos[index];
            document.getElementById('inputVeiculoPlaca').value = veiculo.placa;
            document.getElementById('inputVeiculoModelo').value = veiculo.modelo;
            document.getElementById('inputVeiculoAno').value = veiculo.ano;
            document.getElementById('inputVeiculoTara').value = veiculo.tara;
            document.getElementById('selectVeiculoStatus').value = veiculo.status;
            
            editandoIndice = index;
            showModal('modalVeiculo');
        }

        function excluirVeiculo(index) {
            const veiculo = dados.veiculos[index];
            if (confirm(`🗑️ Deseja realmente excluir o veículo "${veiculo.placa} - ${veiculo.modelo}"?`)) {
                dados.veiculos.splice(index, 1);
                salvarDados();
                atualizarDashboard();
                alert('✅ Veículo excluído com sucesso!');
            }
        }

        // ============= FUNÇÕES DE VENDAS =============

        function atualizarTabelaVendas() {
            const tbody = document.querySelector('#tabelaVendas');
            tbody.innerHTML = '';
            
            dados.vendas.forEach((venda, index) => {
                const statusBadge = getStatusBadge(venda);
                const vencimentoDisplay = venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : 'À vista';
                const precoCusto = venda.precoCusto || (venda.quantidade * 50); // fallback para vendas antigas
                const lucro = venda.lucro || (venda.total - precoCusto);
                
                const row = `
                    <tr>
                        <td>${venda.id}</td>
                        <td>${venda.cliente}</td>
                        <td>${venda.data}</td>
                        <td>${venda.minerio}</td>
                        <td>${venda.quantidade.toFixed(2)}</td>
                        <td>R$ ${precoCusto.toFixed(2)}</td>
                        <td>R$ ${venda.total.toFixed(2)}</td>
                        <td style="color: ${lucro >= 0 ? '#27ae60' : '#e74c3c'};">R$ ${lucro.toFixed(2)}</td>
                        <td>${vencimentoDisplay}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function getStatusBadge(venda) {
            if (venda.status === 'Paga') {
                return '<span class="badge badge-success">✅ Paga</span>';
            }
            
            if (!venda.dataVencimento) {
                return '<span class="badge badge-success">✅ À vista</span>';
            }
            
            const hoje = new Date();
            const vencimento = new Date(venda.dataVencimento);
            const diffTime = vencimento - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return '<span class="badge badge-danger">🔴 Vencida</span>';
            } else if (diffDays === 0) {
                return '<span class="badge badge-warning">⚠️ Vence Hoje</span>';
            } else if (diffDays <= 3) {
                return '<span class="badge badge-warning">⏰ Vence em ' + diffDays + ' dias</span>';
            } else {
                return '<span class="badge badge-success">📅 Pendente</span>';
            }
        }

        function atualizarSelectsVenda() {
            const selectCliente = document.getElementById('selectVendaCliente');
            const selectMinerio = document.getElementById('selectVendaMinerio');
            
            selectCliente.innerHTML = '<option>Selecione um cliente...</option>';
            selectMinerio.innerHTML = '<option>Selecione um minério...</option>';
            
            dados.clientes.forEach(cliente => {
                selectCliente.innerHTML += `<option value="${cliente.id}">${cliente.id} - ${cliente.nome}</option>`;
            });
            
            dados.minerios.forEach(minerio => {
                const preco = minerio.preco || 0;
                selectMinerio.innerHTML += `<option value="${minerio.codigo}" data-preco="${preco}">${minerio.codigo} - ${minerio.nome} (R$ ${preco.toFixed(2)}/ton)</option>`;
            });
        }

        function atualizarSelectsDespesa() {
            const selectVeiculo = document.getElementById('selectDespesaVeiculo');
            selectVeiculo.innerHTML = '<option>🏢 Despesa da Empresa</option>';
            
            dados.veiculos.forEach(veiculo => {
                selectVeiculo.innerHTML += `<option>${veiculo.placa} - ${veiculo.modelo}</option>`;
            });
        }

        function finalizarVenda() {
            const clienteId = document.getElementById('selectVendaCliente').value;
            const minerioSelect = document.getElementById('selectVendaMinerio');
            const minerioId = minerioSelect.value;
            const quantidade = parseFloat(document.getElementById('inputVendaQuantidade').value);
            const precoFinal = parseFloat(document.getElementById('inputPrecoFinal').value);
            const pagamento = document.getElementById('selectVendaPagamento').value;
            const tipoVenda = document.getElementById('selectTipoVenda').value;

            if (clienteId !== 'Selecione um cliente...' && minerioId !== 'Selecione um minério...' && !isNaN(quantidade) && quantidade > 0 && !isNaN(precoFinal) && precoFinal > 0) {
                const cliente = dados.clientes.find(c => c.id === clienteId);
                const minerio = dados.minerios.find(m => m.codigo === minerioId);
                
                if (minerio && (minerio.estoque || 0) >= quantidade) {
                    const precoCusto = quantidade * (minerio.preco || 0);
                    const lucro = precoFinal - precoCusto;
                    let dataVencimento = null;
                    let status = 'Paga';
                    let prazoPagamento = 0;
                    
                    if (tipoVenda === 'prazo') {
                        prazoPagamento = parseInt(document.getElementById('selectPrazoPagamento').value);
                        const hoje = new Date();
                        dataVencimento = new Date(hoje.getTime() + (prazoPagamento * 24 * 60 * 60 * 1000));
                        status = 'Pendente';
                    }
                    
                    const venda = {
                        id: 'V' + String(dados.vendas.length + 1).padStart(3, '0'),
                        cliente: cliente.nome,
                        clienteId: clienteId,
                        minerioId: minerioId,
                        data: new Date().toLocaleDateString('pt-BR'),
                        minerio: minerio.nome,
                        quantidade: quantidade,
                        precoCusto: precoCusto,
                        total: precoFinal,
                        lucro: lucro,
                        status: status,
                        pagamento: pagamento,
                        tipoVenda: tipoVenda,
                        prazoPagamento: prazoPagamento,
                        dataVencimento: dataVencimento ? dataVencimento.toISOString() : null
                    };
                    
                    // Atualizar estoque
                    minerio.estoque = (minerio.estoque || 0) - quantidade;
                    
                    // Atualizar total de compras do cliente
                    cliente.totalCompras = (cliente.totalCompras || 0) + precoFinal;
                    
                    dados.vendas.push(venda);
                    salvarDados();
                    hideModal('modalVenda');
                    atualizarDashboard();
                    
                    // Notificar nova venda
                    if (typeof notificationSystem !== 'undefined' && notificationSystem && typeof notificationSystem.createNotification === 'function') {
                        notificationSystem.createNotification(
                            'success',
                            '💰 Nova Venda Registrada',
                            `Venda ${venda.id} - ${cliente.nome} - R$ ${precoFinal.toFixed(2)}`,
                            [
                                { label: '👁️ Ver Vendas', type: 'primary', action: "showPage('vendas')" }
                            ]
                        );
                    }
                    
                    // Verificar estoque crítico
                    if (minerio.estoque <= 5 && typeof notificationSystem !== 'undefined' && notificationSystem) {
                        setTimeout(() => {
                            notificationSystem.createNotification(
                                'critical',
                                '⚠️ Estoque Crítico',
                                `${minerio.nome}: apenas ${minerio.estoque.toFixed(1)} toneladas restantes!`,
                                [
                                    { label: '📦 Ver Estoque', type: 'primary', action: "showPage('produtos')" },
                                    { label: '📞 Encomendar', type: 'success', action: "alert('Função de encomenda em desenvolvimento')" }
                                ]
                            );
                        }, 1000);
                    }
                    
                    const margemLucro = ((lucro / precoFinal) * 100).toFixed(1);
                    const mensagem = tipoVenda === 'prazo' ? 
                        `✅ Venda realizada com sucesso!\nValor Final: R$ ${precoFinal.toFixed(2)}\nLucro: R$ ${lucro.toFixed(2)} (${margemLucro}%)\nVencimento: ${dataVencimento.toLocaleDateString('pt-BR')}` :
                        `✅ Venda realizada com sucesso!\nValor Final: R$ ${precoFinal.toFixed(2)}\nLucro: R$ ${lucro.toFixed(2)} (${margemLucro}%)\nPagamento: À vista`;
                    
                    alert(mensagem);
                } else {
                    alert('❌ Estoque insuficiente para esta venda!');
                }
            } else {
                alert('❌ Por favor, preencha todos os campos corretamente!');
            }
        }

        // Funções auxiliares para vendas
        function togglePrazoVenda() {
            const tipoVenda = document.getElementById('selectTipoVenda').value;
            const grupoPrazo = document.getElementById('grupoPrazo');
            const grupoDataVencimento = document.getElementById('grupoDataVencimento');
            
            if (tipoVenda === 'prazo') {
                grupoPrazo.style.display = 'block';
                grupoDataVencimento.style.display = 'block';
                calcularDataVencimento();
            } else {
                grupoPrazo.style.display = 'none';
                grupoDataVencimento.style.display = 'none';
            }
        }

        function calcularDataVencimento() {
            const selectPrazo = document.getElementById('selectPrazoPagamento');
            const dataVencimento = document.getElementById('dataVencimento');
            const prazo = parseInt(selectPrazo.value);
            
            if (prazo > 0) {
                const hoje = new Date();
                const vencimento = new Date(hoje.getTime() + (prazo * 24 * 60 * 60 * 1000));
                dataVencimento.value = vencimento.toISOString().split('T')[0];
            }
        }

        // Função para configurar eventos após carregamento
        function configurarEventosVenda() {
            const selectMinerio = document.getElementById('selectVendaMinerio');
            const inputQuantidade = document.getElementById('inputVendaQuantidade');
            const inputPrecoFinal = document.getElementById('inputPrecoFinal');
            const selectPrazo = document.getElementById('selectPrazoPagamento');
            
            if (!selectMinerio || !inputQuantidade || !inputPrecoFinal) {
                return; // Elementos ainda não existem
            }
            
            function calcularCustoELucro() {
                const minerioSelect = selectMinerio.selectedOptions[0];
                const precoCustoUnitario = parseFloat(minerioSelect?.dataset?.preco || 0);
                const quantidade = parseFloat(inputQuantidade.value || 0);
                const precoFinal = parseFloat(inputPrecoFinal.value || 0);
                
                const precoCustoTotal = precoCustoUnitario * quantidade;
                const lucro = precoFinal - precoCustoTotal;
                
                const precoCustoElement = document.getElementById('precoCusto');
                const lucroElement = document.getElementById('lucroVenda');
                
                if (precoCustoElement) {
                    precoCustoElement.textContent = precoCustoTotal.toFixed(2);
                }
                
                if (lucroElement) {
                    lucroElement.textContent = lucro.toFixed(2);
                    
                    // Colorir o lucro baseado no valor
                    if (lucro > 0) {
                        lucroElement.style.color = '#27ae60';
                    } else if (lucro < 0) {
                        lucroElement.style.color = '#e74c3c';
                    } else {
                        lucroElement.style.color = '#7f8c8d';
                    }
                }
            }
            
            selectMinerio.addEventListener('change', calcularCustoELucro);
            inputQuantidade.addEventListener('input', calcularCustoELucro);
            inputPrecoFinal.addEventListener('input', calcularCustoELucro);
            
            if (selectPrazo) {
                selectPrazo.addEventListener('change', calcularDataVencimento);
            }
        }

        // ============= FUNÇÕES DE DESPESAS =============

        function atualizarTabelaDespesas() {
            const tbody = document.querySelector('#tabelaDespesas');
            tbody.innerHTML = '';
            
            dados.despesas.forEach((despesa, index) => {
                const row = `
                    <tr>
                        <td>${despesa.data}</td>
                        <td>${despesa.veiculo}</td>
                        <td>${despesa.tipo}</td>
                        <td>${despesa.descricao}</td>
                        <td>R$ ${despesa.valor.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger" onclick="excluirDespesa(${index})">🗑️</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Atualizar filtro de veículos
            const selectVeiculo = document.getElementById('filtroVeiculoDespesa');
            selectVeiculo.innerHTML = '<option>Todos os veículos</option><option>🏢 Empresa</option>';
            dados.veiculos.forEach(veiculo => {
                selectVeiculo.innerHTML += `<option>${veiculo.placa} - ${veiculo.modelo}</option>`;
            });
        }

        function adicionarDespesa() {
            const veiculo = document.getElementById('selectDespesaVeiculo').value;
            const tipo = document.getElementById('selectDespesaTipo').value;
            const descricao = document.getElementById('inputDespesaDescricao').value;
            const valor = parseFloat(document.getElementById('inputDespesaValor').value);
            const data = document.getElementById('inputDespesaData').value || new Date().toISOString().split('T')[0];

            if (tipo && descricao && !isNaN(valor) && valor > 0) {
                const despesa = {
                    veiculo: veiculo,
                    tipo: tipo,
                    descricao: descricao,
                    valor: valor,
                    data: new Date(data).toLocaleDateString('pt-BR')
                };

                dados.despesas.push(despesa);
                salvarDados();
                hideModal('modalDespesa');
                atualizarDashboard();
                alert('✅ Despesa adicionada com sucesso!');
            } else {
                alert('❌ Por favor, preencha todos os campos corretamente!');
            }
        }

        function excluirDespesa(index) {
            if (confirm('🗑️ Deseja realmente excluir esta despesa?')) {
                dados.despesas.splice(index, 1);
                salvarDados();
                atualizarDashboard();
                alert('✅ Despesa excluída com sucesso!');
            }
        }

        // ============= FUNÇÕES DE CRÉDITO/ESTOQUE =============

        function atualizarPaginaCredito() {
            // Atualizar estatísticas
            const valorEstoque = dados.minerios.reduce((total, minerio) => {
                const preco = minerio.preco || 0;
                const estoque = minerio.estoque || 0;
                return total + (preco * estoque);
            }, 0);
            dados.creditoSistema.valorEmEstoque = valorEstoque;
            dados.creditoSistema.creditoDisponivel = dados.creditoSistema.creditoTotal - valorEstoque;
            dados.creditoSistema.totalToneladas = dados.minerios.reduce((total, minerio) => total + (minerio.estoque || 0), 0);

            document.getElementById('creditoTotalSistema').textContent = `R$ ${dados.creditoSistema.creditoTotal.toLocaleString('pt-BR')}`;
            document.getElementById('valorEstoque').textContent = `R$ ${valorEstoque.toLocaleString('pt-BR')}`;
            document.getElementById('creditoDisponivel').textContent = `R$ ${dados.creditoSistema.creditoDisponivel.toLocaleString('pt-BR')}`;
            document.getElementById('totalToneladas').textContent = `${dados.creditoSistema.totalToneladas.toFixed(2)} Ton`;

            // Atualizar campos de preços
            const precosMinerios = document.getElementById('precosMinerios');
            precosMinerios.innerHTML = '';
            
            dados.minerios.forEach((minerio, index) => {
                const preco = minerio.preco || 0;
                precosMinerios.innerHTML += `
                    <div class="form-group">
                        <label>${minerio.nome || ''}:</label>
                        <input type="number" step="0.01" value="${preco}" id="preco_${index}">
                    </div>
                `;
            });

            // Atualizar tabela de movimentações
            const tbody = document.querySelector('#tabelaMovimentacoes');
            tbody.innerHTML = '';
            
            dados.movimentacoes.forEach(movimentacao => {
                const row = `
                    <tr>
                        <td>${movimentacao.data}</td>
                        <td><span class="badge ${movimentacao.tipo === 'entrada' ? 'badge-success' : 'badge-danger'}">${movimentacao.tipo === 'entrada' ? '➕ Entrada' : '➖ Saída'}</span></td>
                        <td>R$ ${movimentacao.valor.toFixed(2)}</td>
                        <td>${movimentacao.descricao}</td>
                        <td>R$ ${movimentacao.saldo.toFixed(2)}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function registrarMovimentacao() {
            const tipo = document.getElementById('tipoMovimentacao').value.includes('Entrada') ? 'entrada' : 'saida';
            const valor = parseFloat(document.getElementById('valorMovimentacao').value);
            const descricao = document.getElementById('descricaoMovimentacao').value;

            if (!isNaN(valor) && valor > 0 && descricao) {
                const movimentacao = {
                    tipo: tipo,
                    valor: valor,
                    descricao: descricao,
                    data: new Date().toLocaleDateString('pt-BR'),
                    saldo: tipo === 'entrada' ? dados.creditoSistema.creditoTotal + valor : dados.creditoSistema.creditoTotal - valor
                };

                // Atualizar crédito
                if (tipo === 'entrada') {
                    dados.creditoSistema.creditoTotal += valor;
                } else {
                    dados.creditoSistema.creditoTotal -= valor;
                }

                dados.movimentacoes.push(movimentacao);
                
                // Limpar campos
                document.getElementById('valorMovimentacao').value = '';
                document.getElementById('descricaoMovimentacao').value = '';
                
                salvarDados();
                atualizarPaginaCredito();
                alert('✅ Movimentação registrada com sucesso!');
            } else {
                alert('❌ Por favor, preencha todos os campos corretamente!');
            }
        }

        function atualizarPrecos() {
            dados.minerios.forEach((minerio, index) => {
                const novoPreco = parseFloat(document.getElementById(`preco_${index}`).value);
                if (!isNaN(novoPreco) && novoPreco > 0) {
                    minerio.preco = novoPreco;
                }
            });
            
            salvarDados();
            atualizarPaginaCredito();
            alert('✅ Preços atualizados com sucesso!');
        }

        // ============= FUNÇÕES DE RELATÓRIOS AVANÇADOS =============

        function atualizarRelatorios() {
            // Atualizar filtro de clientes
            const filtroCliente = document.getElementById('filtroClienteRelatorio');
            filtroCliente.innerHTML = '<option value="">Todos os clientes</option>';
            dados.clientes.forEach(cliente => {
                filtroCliente.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
            });

            // Calcular dados financeiros
            calcularDashboardFinanceiro();
            
            // Atualizar análises
            atualizarAnaliseMinérios();
            atualizarAnaliseClientes();
            atualizarAnaliseDespesas();
            
            // Gerar resumo executivo
            gerarResumoExecutivo();
            
            // Desenhar gráfico avançado
            desenharGraficoFinanceiro();
        }

        function calcularDashboardFinanceiro() {
            // Calcular receita total
            const receitaTotal = dados.vendas.reduce((total, venda) => total + venda.total, 0);
            
            // Calcular custo total dos produtos vendidos
            let custoTotalVendas = 0;
            dados.vendas.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                if (minerio) {
                    const custoPorTonelada = minerio.preco || 0;
                    custoTotalVendas += venda.quantidade * custoPorTonelada;
                }
            });
            
            // Calcular despesas totais
            const despesasTotal = dados.despesas.reduce((total, despesa) => total + despesa.valor, 0);
            
            // Calcular lucro bruto e líquido
            const lucroBruto = receitaTotal - custoTotalVendas;
            const lucroLiquido = lucroBruto - despesasTotal;
            
            // Calcular margem de lucro
            const margemBruta = receitaTotal > 0 ? (lucroBruto / receitaTotal) * 100 : 0;
            const margemLiquida = receitaTotal > 0 ? (lucroLiquido / receitaTotal) * 100 : 0;
            
            // Atualizar dashboard financeiro
            document.getElementById('receitaTotal').textContent = `R$ ${receitaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('custoVendas').textContent = `R$ ${custoTotalVendas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('despesasTotal').textContent = `R$ ${despesasTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('lucroBruto').textContent = `R$ ${lucroBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('lucroLiquido').textContent = `R$ ${lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('margemBruta').textContent = `${margemBruta.toFixed(1)}%`;
            document.getElementById('margemLiquida').textContent = `${margemLiquida.toFixed(1)}%`;
            
            // Colorir valores baseado no resultado
            const elementoLucroLiquido = document.getElementById('lucroLiquido');
            const elementoMargemLiquida = document.getElementById('margemLiquida');
            
            if (lucroLiquido >= 0) {
                elementoLucroLiquido.style.color = '#27ae60';
                elementoMargemLiquida.style.color = '#27ae60';
            } else {
                elementoLucroLiquido.style.color = '#e74c3c';
                elementoMargemLiquida.style.color = '#e74c3c';
            }
        }

        function atualizarAnaliseMinérios() {
            const topMinerios = document.getElementById('topMinerios');
            topMinerios.innerHTML = '';
            
            // Calcular vendas e lucros por minério
            const analiseMinérios = {};
            
            dados.vendas.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                if (!analiseMinérios[venda.minerio]) {
                    analiseMinérios[venda.minerio] = {
                        nome: venda.minerio,
                        toneladas: 0,
                        receita: 0,
                        custo: 0,
                        lucro: 0,
                        margem: 0
                    };
                }
                
                const custoPorTonelada = minerio ? minerio.preco : 0;
                const custoVenda = venda.quantidade * custoPorTonelada;
                const lucroVenda = venda.total - custoVenda;
                
                analiseMinérios[venda.minerio].toneladas += venda.quantidade;
                analiseMinérios[venda.minerio].receita += venda.total;
                analiseMinérios[venda.minerio].custo += custoVenda;
                analiseMinérios[venda.minerio].lucro += lucroVenda;
            });
            
            // Calcular margem para cada minério
            Object.values(analiseMinérios).forEach(item => {
                item.margem = item.receita > 0 ? (item.lucro / item.receita) * 100 : 0;
            });
            
            // Ordenar por lucro e mostrar top 5
            const topLucros = Object.values(analiseMinérios)
                .sort((a, b) => b.lucro - a.lucro)
                .slice(0, 5);
            
            topLucros.forEach(item => {
                const margemClass = item.margem >= 20 ? 'text-success' : item.margem >= 10 ? 'text-warning' : 'text-danger';
                topMinerios.innerHTML += `
                    <tr>
                        <td>${item.nome}</td>
                        <td>${item.toneladas.toFixed(1)}</td>
                        <td>R$ ${item.receita.toFixed(2)}</td>
                        <td>R$ ${item.lucro.toFixed(2)}</td>
                        <td class="${margemClass}">${item.margem.toFixed(1)}%</td>
                    </tr>
                `;
            });
        }

        function atualizarAnaliseClientes() {
            const topClientes = document.getElementById('topClientes');
            topClientes.innerHTML = '';
            
            // Calcular análise detalhada por cliente
            const analiseClientes = {};
            
            dados.vendas.forEach(venda => {
                const cliente = dados.clientes.find(c => c.nome === venda.cliente);
                if (!analiseClientes[venda.cliente]) {
                    analiseClientes[venda.cliente] = {
                        nome: venda.cliente,
                        id: cliente ? cliente.id : 'N/A',
                        vendas: 0,
                        toneladas: 0,
                        receita: 0,
                        custo: 0,
                        lucro: 0,
                        margem: 0,
                        ticketMedio: 0
                    };
                }
                
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                const custoPorTonelada = minerio ? minerio.preco : 0;
                const custoVenda = venda.quantidade * custoPorTonelada;
                const lucroVenda = venda.total - custoVenda;
                
                analiseClientes[venda.cliente].vendas += 1;
                analiseClientes[venda.cliente].toneladas += venda.quantidade;
                analiseClientes[venda.cliente].receita += venda.total;
                analiseClientes[venda.cliente].custo += custoVenda;
                analiseClientes[venda.cliente].lucro += lucroVenda;
            });
            
            // Calcular métricas finais
            Object.values(analiseClientes).forEach(cliente => {
                cliente.margem = cliente.receita > 0 ? (cliente.lucro / cliente.receita) * 100 : 0;
                cliente.ticketMedio = cliente.vendas > 0 ? cliente.receita / cliente.vendas : 0;
            });
            
            // Ordenar por lucro
            const topLucrosClientes = Object.values(analiseClientes)
                .sort((a, b) => b.lucro - a.lucro)
                .slice(0, 5);
            
            topLucrosClientes.forEach(cliente => {
                const margemClass = cliente.margem >= 20 ? 'color: #27ae60' : cliente.margem >= 10 ? 'color: #f39c12' : 'color: #e74c3c';
                topClientes.innerHTML += `
                    <tr>
                        <td>${cliente.nome}</td>
                        <td>${cliente.vendas}</td>
                        <td>R$ ${cliente.receita.toFixed(2)}</td>
                        <td>R$ ${cliente.lucro.toFixed(2)}</td>
                        <td style="${margemClass}">${cliente.margem.toFixed(1)}%</td>
                        <td>R$ ${cliente.ticketMedio.toFixed(2)}</td>
                    </tr>
                `;
            });
        }

        function atualizarAnaliseDespesas() {
            const analiseDespesas = document.getElementById('analiseDespesas');
            analiseDespesas.innerHTML = '';
            
            // Agrupar despesas por tipo
            const despesasPorTipo = {};
            let totalDespesas = 0;
            
            dados.despesas.forEach(despesa => {
                const tipo = despesa.tipo.replace(/[🔧⛽🛠️🛡️📄📋]/g, '').trim();
                if (!despesasPorTipo[tipo]) {
                    despesasPorTipo[tipo] = {
                        tipo: tipo,
                        valor: 0,
                        quantidade: 0,
                        percentual: 0
                    };
                }
                despesasPorTipo[tipo].valor += despesa.valor;
                despesasPorTipo[tipo].quantidade += 1;
                totalDespesas += despesa.valor;
            });
            
            // Calcular percentuais
            Object.values(despesasPorTipo).forEach(item => {
                item.percentual = totalDespesas > 0 ? (item.valor / totalDespesas) * 100 : 0;
            });
            
            // Ordenar por valor
            const despesasOrdenadas = Object.values(despesasPorTipo)
                .sort((a, b) => b.valor - a.valor);
            
            despesasOrdenadas.forEach(item => {
                analiseDespesas.innerHTML += `
                    <tr>
                        <td>${item.tipo}</td>
                        <td>${item.quantidade}</td>
                        <td>R$ ${item.valor.toFixed(2)}</td>
                        <td>${item.percentual.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            // Atualizar total de despesas
            document.getElementById('totalDespesasRelatorio').textContent = `R$ ${totalDespesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function gerarResumoExecutivo() {
            const resumoExecutivo = document.getElementById('resumoExecutivo');
            
            const totalVendas = dados.vendas.length;
            const receitaTotal = dados.vendas.reduce((total, venda) => total + venda.total, 0);
            const ticketMedio = totalVendas > 0 ? receitaTotal / totalVendas : 0;
            
            // Calcular crescimento (simulado baseado em datas)
            const vendasUltimoMes = dados.vendas.filter(venda => {
                const dataVenda = new Date(venda.data.split('/').reverse().join('-'));
                const umMesAtras = new Date();
                umMesAtras.setMonth(umMesAtras.getMonth() - 1);
                return dataVenda >= umMesAtras;
            }).length;
            
            const crescimento = totalVendas > 0 ? ((vendasUltimoMes / totalVendas) * 100) : 0;
            
            // Produto mais vendido
            const vendasPorMinerio = {};
            dados.vendas.forEach(venda => {
                vendasPorMinerio[venda.minerio] = (vendasPorMinerio[venda.minerio] || 0) + venda.quantidade;
            });
            
            const produtoMaisVendido = Object.keys(vendasPorMinerio).reduce((a, b) => 
                vendasPorMinerio[a] > vendasPorMinerio[b] ? a : b, 'Nenhum');
            
            // Cliente mais lucrativo
            const lucrosPorCliente = {};
            dados.vendas.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                const custo = venda.quantidade * (minerio ? minerio.preco : 0);
                const lucro = venda.total - custo;
                lucrosPorCliente[venda.cliente] = (lucrosPorCliente[venda.cliente] || 0) + lucro;
            });
            
            const clienteMaisLucrativo = Object.keys(lucrosPorCliente).reduce((a, b) => 
                lucrosPorCliente[a] > lucrosPorCliente[b] ? a : b, 'Nenhum');
            
            resumoExecutivo.innerHTML = `
                <div class="resumo-item">
                    <strong>📊 Vendas Totais:</strong> ${totalVendas} vendas realizadas
                </div>
                <div class="resumo-item">
                    <strong>💰 Ticket Médio:</strong> R$ ${ticketMedio.toFixed(2)}
                </div>
                <div class="resumo-item">
                    <strong>📈 Crescimento Mensal:</strong> ${crescimento.toFixed(1)}% das vendas no último mês
                </div>
                <div class="resumo-item">
                    <strong>🥇 Produto Mais Vendido:</strong> ${produtoMaisVendido}
                </div>
                <div class="resumo-item">
                    <strong>👑 Cliente Mais Lucrativo:</strong> ${clienteMaisLucrativo}
                </div>
                <div class="resumo-item">
                    <strong>🚛 Frota Ativa:</strong> ${dados.veiculos.filter(v => v.status === 'Ativo').length} de ${dados.veiculos.length} veículos
                </div>
            `;
        }

        function desenharGraficoFinanceiro() {
            const canvas = document.getElementById('graficoVendas');
            const ctx = canvas.getContext('2d');
            
            // Limpar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calcular dados reais dos últimos 6 meses baseados nas vendas
            const hoje = new Date();
            const mesesData = [];
            const receitaData = [];
            const custoData = [];
            const lucroData = [];
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mesAno = data.toLocaleDateString('pt-BR', { month: 'short' });
                mesesData.push(mesAno);
                
                // Simular dados mensais baseados nas vendas reais
                const vendasMes = dados.vendas.filter(v => {
                    // Simulação: distribuir vendas pelos meses
                    return Math.random() > 0.5;
                });
                
                let receitaMes = 0;
                let custoMes = 0;
                
                vendasMes.forEach(venda => {
                    receitaMes += venda.total;
                    const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                    custoMes += venda.quantidade * (minerio ? minerio.preco : 0);
                });
                
                // Adicionar fator de variação para simular crescimento
                const fatorVariacao = 0.8 + (Math.random() * 0.4);
                receitaMes *= fatorVariacao;
                custoMes *= fatorVariacao;
                
                receitaData.push(receitaMes);
                custoData.push(custoMes);
                lucroData.push(receitaMes - custoMes);
            }
            
            const barWidth = 25;
            const maxValor = Math.max(...receitaData);
            const scale = maxValor > 0 ? 180 / maxValor : 1;
            
            ctx.font = '11px Arial';
            
            mesesData.forEach((mes, index) => {
                const x = 60 + index * 120;
                const baseY = 220;
                
                // Desenhar barra de receita
                const alturaReceita = receitaData[index] * scale;
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, baseY - alturaReceita, barWidth, alturaReceita);
                
                // Desenhar barra de custo
                const alturaCusto = custoData[index] * scale;
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(x + barWidth + 5, baseY - alturaCusto, barWidth, alturaCusto);
                
                // Desenhar barra de lucro
                const alturaLucro = lucroData[index] * scale;
                const corLucro = lucroData[index] >= 0 ? '#27ae60' : '#e74c3c';
                ctx.fillStyle = corLucro;
                ctx.fillRect(x + (barWidth + 5) * 2, baseY - alturaLucro, barWidth, alturaLucro);
                
                // Labels dos valores
                ctx.fillStyle = '#2c3e50';
                ctx.fillText(`R$ ${(receitaData[index]/1000).toFixed(0)}k`, x - 5, baseY - alturaReceita - 5);
                
                // Label do mês
                ctx.fillText(mes, x + 25, baseY + 15);
            });
            
            // Legenda
            ctx.fillStyle = '#3498db';
            ctx.fillRect(50, 250, 15, 10);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText('Receita', 70, 259);
            
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(130, 250, 15, 10);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText('Custo', 150, 259);
            
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(190, 250, 15, 10);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText('Lucro', 210, 259);
        }

        function gerarRelatorioVendas() {
            const clienteSelecionado = document.getElementById('filtroClienteRelatorio').value;
            const periodoSelecionado = document.getElementById('filtroPeriodoRelatorio').value;
            const tipoRelatorio = document.getElementById('tipoRelatorio').value;
            
            let dadosFiltrados = dados.vendas;
            
            // Filtrar por cliente se selecionado
            if (clienteSelecionado) {
                const cliente = dados.clientes.find(c => c.id === clienteSelecionado);
                if (cliente) {
                    dadosFiltrados = dadosFiltrados.filter(v => v.cliente === cliente.nome);
                }
            }
            
            // Gerar relatório detalhado
            let relatorio = `
                ===============================================
                    🚚 REI DA CAÇAMBINHA - RELATÓRIO DETALHADO
                ===============================================
                
                Tipo: ${tipoRelatorio}
                Período: ${periodoSelecionado}
                Cliente: ${clienteSelecionado ? dados.clientes.find(c => c.id === clienteSelecionado)?.nome : 'Todos'}
                Data de Geração: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}
                
                ===============================================
                💰 RESUMO FINANCEIRO
                ===============================================
            `;
            
            let receitaTotal = 0;
            let custoTotal = 0;
            let despesasTotal = dados.despesas.reduce((sum, d) => sum + d.valor, 0);
            
            dadosFiltrados.forEach(venda => {
                receitaTotal += venda.total;
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                custoTotal += venda.quantidade * (minerio ? minerio.preco : 0);
            });
            
            const lucroBruto = receitaTotal - custoTotal;
            const lucroLiquido = lucroBruto - despesasTotal;
            const margemBruta = receitaTotal > 0 ? (lucroBruto / receitaTotal) * 100 : 0;
            const margemLiquida = receitaTotal > 0 ? (lucroLiquido / receitaTotal) * 100 : 0;
            
            relatorio += `
                📊 Vendas Analisadas: ${dadosFiltrados.length}
                💵 Receita Total: R$ ${receitaTotal.toFixed(2)}
                📉 Custo das Vendas: R$ ${custoTotal.toFixed(2)}
                💸 Despesas Operacionais: R$ ${despesasTotal.toFixed(2)}
                📈 Lucro Bruto: R$ ${lucroBruto.toFixed(2)}
                🎯 Lucro Líquido: R$ ${lucroLiquido.toFixed(2)}
                📊 Margem Bruta: ${margemBruta.toFixed(2)}%
                🔍 Margem Líquida: ${margemLiquida.toFixed(2)}%
                
                ===============================================
                🏆 TOP PRODUTOS POR LUCRO
                ===============================================
            `;
            
            // Análise por produto
            const produtoLucro = {};
            dadosFiltrados.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                const custo = venda.quantidade * (minerio ? minerio.preco : 0);
                const lucro = venda.total - custo;
                
                if (!produtoLucro[venda.minerio]) {
                    produtoLucro[venda.minerio] = { lucro: 0, receita: 0, toneladas: 0 };
                }
                produtoLucro[venda.minerio].lucro += lucro;
                produtoLucro[venda.minerio].receita += venda.total;
                produtoLucro[venda.minerio].toneladas += venda.quantidade;
            });
            
            Object.entries(produtoLucro)
                .sort(([,a], [,b]) => b.lucro - a.lucro)
                .slice(0, 5)
                .forEach(([produto, dados], index) => {
                    const margem = dados.receita > 0 ? (dados.lucro / dados.receita) * 100 : 0;
                    relatorio += `
                ${index + 1}. ${produto}
                   • Toneladas: ${dados.toneladas.toFixed(2)}
                   • Receita: R$ ${dados.receita.toFixed(2)}
                   • Lucro: R$ ${dados.lucro.toFixed(2)}
                   • Margem: ${margem.toFixed(2)}%
                `;
                });
            
            relatorio += `
                
                ===============================================
                👥 TOP CLIENTES POR LUCRO
                ===============================================
            `;
            
            // Análise por cliente
            const clienteLucro = {};
            dadosFiltrados.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                const custo = venda.quantidade * (minerio ? minerio.preco : 0);
                const lucro = venda.total - custo;
                
                if (!clienteLucro[venda.cliente]) {
                    clienteLucro[venda.cliente] = { lucro: 0, receita: 0, vendas: 0 };
                }
                clienteLucro[venda.cliente].lucro += lucro;
                clienteLucro[venda.cliente].receita += venda.total;
                clienteLucro[venda.cliente].vendas += 1;
            });
            
            Object.entries(clienteLucro)
                .sort(([,a], [,b]) => b.lucro - a.lucro)
                .slice(0, 5)
                .forEach(([cliente, dados], index) => {
                    const margem = dados.receita > 0 ? (dados.lucro / dados.receita) * 100 : 0;
                    const ticketMedio = dados.vendas > 0 ? dados.receita / dados.vendas : 0;
                    relatorio += `
                ${index + 1}. ${cliente}
                   • Vendas: ${dados.vendas}
                   • Receita: R$ ${dados.receita.toFixed(2)}
                   • Lucro: R$ ${dados.lucro.toFixed(2)}
                   • Margem: ${margem.toFixed(2)}%
                   • Ticket Médio: R$ ${ticketMedio.toFixed(2)}
                `;
                });
            
            // Criar blob e fazer download
            const blob = new Blob([relatorio], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `relatorio_rei_da_cacambinha_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('📊 Relatório detalhado gerado e baixado com sucesso!');
        }

        function exportarCSV() {
            let csv = 'ID,Cliente,Data,Minerio,Quantidade,Valor Final,Custo,Lucro,Margem\n';
            
            dados.vendas.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                const custo = venda.quantidade * (minerio ? minerio.preco : 0);
                const lucro = venda.total - custo;
                const margem = venda.total > 0 ? (lucro / venda.total) * 100 : 0;
                
                csv += `${venda.id},"${venda.cliente}","${venda.data}","${venda.minerio}",${venda.quantidade},${venda.total},${custo.toFixed(2)},${lucro.toFixed(2)},${margem.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vendas_rei_da_cacambinha_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('📁 Dados exportados para CSV com sucesso!');
        }

        function imprimirRelatorio() {
            // Criar página de impressão com dados formatados
            const printWindow = window.open('', '_blank');
            const receitaTotal = dados.vendas.reduce((total, venda) => total + venda.total, 0);
            let custoTotal = 0;
            
            dados.vendas.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                custoTotal += venda.quantidade * (minerio ? minerio.preco : 0);
            });
            
            const despesasTotal = dados.despesas.reduce((total, despesa) => total + despesa.valor, 0);
            const lucroLiquido = receitaTotal - custoTotal - despesasTotal;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Relatório - Rei da Caçambinha</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .positive { color: green; }
                        .negative { color: red; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🚚 REI DA CAÇAMBINHA</h1>
                        <h2>Relatório Financeiro Detalhado</h2>
                        <p>Data: ${new Date().toLocaleDateString('pt-BR')} - ${new Date().toLocaleTimeString('pt-BR')}</p>
                    </div>
                    
                    <div class="summary">
                        <div class="card">
                            <h3>💰 Resumo Financeiro</h3>
                            <p><strong>Receita Total:</strong> R$ ${receitaTotal.toFixed(2)}</p>
                            <p><strong>Custo das Vendas:</strong> R$ ${custoTotal.toFixed(2)}</p>
                            <p><strong>Despesas Operacionais:</strong> R$ ${despesasTotal.toFixed(2)}</p>
                            <p><strong>Lucro Líquido:</strong> <span class="${lucroLiquido >= 0 ? 'positive' : 'negative'}">R$ ${lucroLiquido.toFixed(2)}</span></p>
                        </div>
                        
                        <div class="card">
                            <h3>📊 Indicadores</h3>
                            <p><strong>Total de Vendas:</strong> ${dados.vendas.length}</p>
                            <p><strong>Ticket Médio:</strong> R$ ${dados.vendas.length > 0 ? (receitaTotal / dados.vendas.length).toFixed(2) : '0,00'}</p>
                            <p><strong>Margem Líquida:</strong> ${receitaTotal > 0 ? ((lucroLiquido / receitaTotal) * 100).toFixed(2) : '0,00'}%</p>
                            <p><strong>Clientes Ativos:</strong> ${dados.clientes.length}</p>
                        </div>
                    </div>
                    
                    <h3>📋 Vendas Detalhadas</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Minério</th>
                                <th>Quantidade</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dados.vendas.map(venda => `
                                <tr>
                                    <td>${venda.id}</td>
                                    <td>${venda.cliente}</td>
                                    <td>${venda.data}</td>
                                    <td>${venda.minerio}</td>
                                    <td>${venda.quantidade.toFixed(2)} ton</td>
                                    <td>R$ ${venda.total.toFixed(2)}</td>
                                    <td>${venda.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // ============= FUNÇÕES DE CONFIGURAÇÕES =============

        function carregarConfiguracoes() {
            const config = dados.configuracoes;
            document.getElementById('nomeEmpresa').value = config.nomeEmpresa;
            document.getElementById('cnpjEmpresa').value = config.cnpj || '';
            document.getElementById('enderecoEmpresa').value = config.endereco || '';
            document.getElementById('telefoneEmpresa').value = config.telefone || '';
            document.getElementById('emailEmpresa').value = config.email || '';
            document.getElementById('moedaSistema').value = config.moeda;
            document.getElementById('margemLucro').value = config.margemLucro;
            document.getElementById('descontoMaximo').value = config.descontoMaximo;
            document.getElementById('alertaEstoqueBaixo').checked = config.alertaEstoqueBaixo;
            document.getElementById('limiteEstoque').value = config.limiteEstoque;
            document.getElementById('backupAutomatico').checked = config.backupAutomatico;
            document.getElementById('notificacaoVendas').checked = config.notificacaoVendas;
            document.getElementById('temaSistema').value = config.tema;
            document.getElementById('corPrincipal').value = config.corPrincipal;
            document.getElementById('tamanhoFonte').value = config.tamanhoFonte;
        }

        function salvarConfiguracoes() {
            dados.configuracoes.nomeEmpresa = document.getElementById('nomeEmpresa').value;
            dados.configuracoes.cnpj = document.getElementById('cnpjEmpresa').value;
            dados.configuracoes.endereco = document.getElementById('enderecoEmpresa').value;
            dados.configuracoes.telefone = document.getElementById('telefoneEmpresa').value;
            dados.configuracoes.email = document.getElementById('emailEmpresa').value;
            dados.configuracoes.moeda = document.getElementById('moedaSistema').value;
            dados.configuracoes.margemLucro = parseFloat(document.getElementById('margemLucro').value);
            dados.configuracoes.descontoMaximo = parseFloat(document.getElementById('descontoMaximo').value);
            dados.configuracoes.alertaEstoqueBaixo = document.getElementById('alertaEstoqueBaixo').checked;
            dados.configuracoes.limiteEstoque = parseInt(document.getElementById('limiteEstoque').value);
            dados.configuracoes.backupAutomatico = document.getElementById('backupAutomatico').checked;
            dados.configuracoes.notificacaoVendas = document.getElementById('notificacaoVendas').checked;
            dados.configuracoes.tema = document.getElementById('temaSistema').value;
            dados.configuracoes.corPrincipal = document.getElementById('corPrincipal').value;
            dados.configuracoes.tamanhoFonte = document.getElementById('tamanhoFonte').value;
            
            salvarDados();
            alert('✅ Configurações salvas com sucesso!');
        }

        function restaurarPadrao() {
            if (confirm('🔄 Deseja restaurar todas as configurações para o padrão?')) {
                dados.configuracoes = {
                    nomeEmpresa: 'Rei da Caçambinha',
                    cnpj: '',
                    endereco: '',
                    telefone: '',
                    email: '',
                    moeda: 'R$',
                    margemLucro: 30.0,
                    descontoMaximo: 10.0,
                    alertaEstoqueBaixo: true,
                    limiteEstoque: 10,
                    backupAutomatico: true,
                    notificacaoVendas: true,
                    tema: 'Claro (Padrão)',
                    corPrincipal: '#667eea',
                    tamanhoFonte: 'Médio'
                };
                
                salvarDados();
                carregarConfiguracoes();
                alert('✅ Configurações restauradas!');
            }
        }

        function exportarConfiguracoes() {
            const config = JSON.stringify(dados.configuracoes, null, 2);
            const blob = new Blob([config], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `configuracoes_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('✅ Configurações exportadas com sucesso!');
        }

        // ============= FUNÇÕES DE COBRANÇA =============

        function atualizarPaginaCobrancas() {
            const hoje = new Date();
            const vendasVencidas = [];
            const vendasVencendoHoje = [];
            const vendasProximas = [];
            let valorPendente = 0;
            const clientesComPendencias = new Set();

            dados.vendas.forEach(venda => {
                if (venda.status !== 'Paga') {
                    valorPendente += venda.total;
                    clientesComPendencias.add(venda.cliente);
                    
                    if (venda.dataVencimento) {
                        const vencimento = new Date(venda.dataVencimento);
                        const diffTime = vencimento - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays < 0) {
                            vendasVencidas.push({...venda, diasAtraso: Math.abs(diffDays)});
                        } else if (diffDays === 0) {
                            vendasVencendoHoje.push(venda);
                        } else if (diffDays <= 7) {
                            vendasProximas.push({...venda, diasRestantes: diffDays});
                        }
                    }
                }
            });

            // Atualizar estatísticas avançadas
            document.getElementById('vendasVencidas').textContent = vendasVencidas.length;
            document.getElementById('vendasVencendoHoje').textContent = vendasVencendoHoje.length;
            document.getElementById('vendasProximas').textContent = vendasProximas.length;
            document.getElementById('valorPendente').textContent = `R$ ${valorPendente.toLocaleString('pt-BR')}`;
            document.getElementById('clientesDevedores').textContent = clientesComPendencias.size;
            
            const ticketMedio = clientesComPendencias.size > 0 ? valorPendente / clientesComPendencias.size : 0;
            document.getElementById('ticketMedioPendente').textContent = `R$ ${ticketMedio.toFixed(2)}`;

            // Atualizar filtro de clientes
            const filtroCliente = document.getElementById('filtroClienteCobranca');
            filtroCliente.innerHTML = '<option value="">Todos os clientes</option>';
            dados.clientes.forEach(cliente => {
                if (clientesComPendencias.has(cliente.nome)) {
                    filtroCliente.innerHTML += `<option value="${cliente.nome}">${cliente.nome}</option>`;
                }
            });

            // Atualizar visualização
            atualizarVisualizacaoCobrancas();
        }

        function atualizarVisualizacaoCobrancas() {
            const tipoVisualizacao = document.getElementById('tipoVisualizacao').value;
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroCliente = document.getElementById('filtroClienteCobranca').value;
            const areaCobrancas = document.getElementById('areaCobrancas');

            // Filtrar vendas pendentes
            let vendasFiltradas = dados.vendas.filter(venda => venda.status !== 'Paga');

            // Aplicar filtro de cliente
            if (filtroCliente) {
                vendasFiltradas = vendasFiltradas.filter(venda => venda.cliente === filtroCliente);
            }

            // Aplicar filtro de status
            const hoje = new Date();
            if (filtroStatus !== 'todos') {
                vendasFiltradas = vendasFiltradas.filter(venda => {
                    if (!venda.dataVencimento) return false;
                    
                    const vencimento = new Date(venda.dataVencimento);
                    const diffTime = vencimento - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    switch (filtroStatus) {
                        case 'vencidas': return diffDays < 0;
                        case 'vencendo': return diffDays === 0;
                        case 'proximas': return diffDays > 0 && diffDays <= 7;
                        case 'criticas': return diffDays < -30;
                        default: return true;
                    }
                });
            }

            // Renderizar baseado no tipo de visualização
            switch (tipoVisualizacao) {
                case 'cliente':
                    renderizarPorCliente(vendasFiltradas, areaCobrancas);
                    break;
                case 'cronologica':
                    renderizarCronologica(vendasFiltradas, areaCobrancas);
                    break;
                case 'valor':
                    renderizarPorValor(vendasFiltradas, areaCobrancas);
                    break;
                case 'atraso':
                    renderizarPorAtraso(vendasFiltradas, areaCobrancas);
                    break;
            }
        }

        function renderizarPorCliente(vendas, container) {
            const clientesCobranca = {};
            
            vendas.forEach(venda => {
                if (!clientesCobranca[venda.cliente]) {
                    clientesCobranca[venda.cliente] = {
                        nome: venda.cliente,
                        vendas: [],
                        totalPendente: 0,
                        diasAtrasoMedio: 0,
                        vendaMaisAntiga: null
                    };
                }
                
                const hoje = new Date();
                const vencimento = venda.dataVencimento ? new Date(venda.dataVencimento) : hoje;
                const diasAtraso = Math.max(0, Math.ceil((hoje - vencimento) / (1000 * 60 * 60 * 24)));
                
                const vendaComInfo = {
                    ...venda,
                    diasAtraso: diasAtraso,
                    prioridade: diasAtraso > 30 ? 'alta' : diasAtraso > 7 ? 'media' : 'baixa'
                };
                
                clientesCobranca[venda.cliente].vendas.push(vendaComInfo);
                clientesCobranca[venda.cliente].totalPendente += venda.total;
                
                if (!clientesCobranca[venda.cliente].vendaMaisAntiga || 
                    diasAtraso > clientesCobranca[venda.cliente].vendaMaisAntiga.diasAtraso) {
                    clientesCobranca[venda.cliente].vendaMaisAntiga = vendaComInfo;
                }
            });

            // Calcular dias de atraso médio
            Object.values(clientesCobranca).forEach(cliente => {
                const totalDias = cliente.vendas.reduce((sum, v) => sum + v.diasAtraso, 0);
                cliente.diasAtrasoMedio = cliente.vendas.length > 0 ? totalDias / cliente.vendas.length : 0;
            });

            // Ordenar por prioridade (maior atraso primeiro)
            const clientesOrdenados = Object.values(clientesCobranca)
                .sort((a, b) => b.diasAtrasoMedio - a.diasAtrasoMedio);

            let html = '';
            
            clientesOrdenados.forEach(cliente => {
                const prioridadeClass = cliente.diasAtrasoMedio > 30 ? 'border-danger' : 
                                      cliente.diasAtrasoMedio > 7 ? 'border-warning' : 'border-success';
                
                const corPrioridade = cliente.diasAtrasoMedio > 30 ? '#e74c3c' : 
                                    cliente.diasAtrasoMedio > 7 ? '#f39c12' : '#27ae60';

                html += `
                    <div class="card" style="margin-bottom: 20px; border-left: 5px solid ${corPrioridade};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: #2c3e50;">👤 ${cliente.nome}</h3>
                                <div style="display: flex; gap: 20px; margin-top: 8px;">
                                    <span style="color: #7f8c8d;">💰 Total: <strong>R$ ${cliente.totalPendente.toFixed(2)}</strong></span>
                                    <span style="color: #7f8c8d;">📊 ${cliente.vendas.length} venda(s) pendente(s)</span>
                                    <span style="color: ${corPrioridade};">⏰ Atraso médio: <strong>${cliente.diasAtrasoMedio.toFixed(0)} dias</strong></span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-info" onclick="mostrarDetalhesCliente('${cliente.nome}')" style="font-size: 12px; padding: 8px 12px;">👁️ Detalhes</button>
                                <button class="btn btn-warning" onclick="enviarLembreteCliente('${cliente.nome}')" style="font-size: 12px; padding: 8px 12px;">📧 Lembrete</button>
                                <button class="btn btn-success" onclick="marcarTodasPagasCliente('${cliente.nome}')" style="font-size: 12px; padding: 8px 12px;">✅ Marcar Todas</button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table" style="margin: 0;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th><input type="checkbox" onchange="selecionarTodasVendasCliente('${cliente.nome}', this.checked)"></th>
                                        <th>ID</th>
                                        <th>Data Venda</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                cliente.vendas.forEach(venda => {
                    const statusColor = venda.prioridade === 'alta' ? '#e74c3c' : 
                                      venda.prioridade === 'media' ? '#f39c12' : '#27ae60';
                    const statusText = venda.diasAtraso > 0 ? `${venda.diasAtraso} dias atraso` : 'No prazo';
                    
                    html += `
                        <tr>
                            <td><input type="checkbox" class="checkbox-venda" data-venda-id="${venda.id}"></td>
                            <td>${venda.id}</td>
                            <td>${venda.data}</td>
                            <td>${venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : 'À vista'}</td>
                            <td>R$ ${venda.total.toFixed(2)}</td>
                            <td><span style="color: ${statusColor}; font-weight: bold;">${statusText}</span></td>
                            <td>
                                <button class="btn btn-success" onclick="marcarComoPaga('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">✅</button>
                                <button class="btn btn-warning" onclick="enviarLembrete('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📧</button>
                                <button class="btn btn-info" onclick="mostrarHistoricoCobranca('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📋</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <h3 style="color: #27ae60;">✅ Nenhuma cobrança pendente!</h3>
                        <p style="color: #7f8c8d;">Todas as vendas estão em dia ou foram quitadas.</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderizarCronologica(vendas, container) {
            const hoje = new Date();
            
            // Agrupar por dias de atraso/prazo
            const grupos = {
                criticas: [],
                vencidas: [],
                vencendoHoje: [],
                proximas: []
            };

            vendas.forEach(venda => {
                if (!venda.dataVencimento) return;
                
                const vencimento = new Date(venda.dataVencimento);
                const diffTime = vencimento - hoje;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < -30) {
                    grupos.criticas.push({...venda, diasAtraso: Math.abs(diffDays)});
                } else if (diffDays < 0) {
                    grupos.vencidas.push({...venda, diasAtraso: Math.abs(diffDays)});
                } else if (diffDays === 0) {
                    grupos.vencendoHoje.push(venda);
                } else if (diffDays <= 7) {
                    grupos.proximas.push({...venda, diasRestantes: diffDays});
                }
            });

            let html = '';

            // Situações críticas (30+ dias)
            if (grupos.criticas.length > 0) {
                html += criarGrupoCronologico('🚨 Situação Crítica (30+ dias)', grupos.criticas, '#e74c3c', true);
            }

            // Vencidas
            if (grupos.vencidas.length > 0) {
                html += criarGrupoCronologico('⏰ Vendas Vencidas', grupos.vencidas, '#e74c3c', true);
            }

            // Vencendo hoje
            if (grupos.vencendoHoje.length > 0) {
                html += criarGrupoCronologico('⚠️ Vencem Hoje', grupos.vencendoHoje, '#f39c12', false);
            }

            // Próximas
            if (grupos.proximas.length > 0) {
                html += criarGrupoCronologico('📅 Próximas (7 dias)', grupos.proximas, '#3498db', false);
            }

            if (html === '') {
                html = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <h3 style="color: #27ae60;">✅ Nenhuma cobrança pendente!</h3>
                        <p style="color: #7f8c8d;">Todas as vendas estão em dia ou foram quitadas.</p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function criarGrupoCronologico(titulo, vendas, cor, mostrarAtraso) {
            let html = `
                <div class="card" style="margin-bottom: 20px; border-left: 5px solid ${cor};">
                    <h3 style="color: ${cor}; margin-bottom: 15px;">${titulo} (${vendas.length})</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="selecionarTodasGrupo(this.checked, '${titulo}')"></th>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Vencimento</th>
                                ${mostrarAtraso ? '<th>Atraso</th>' : '<th>Restante</th>'}
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            vendas.forEach(venda => {
                const tempoInfo = mostrarAtraso ? 
                    `<span style="color: #e74c3c; font-weight: bold;">${venda.diasAtraso} dias</span>` :
                    `<span style="color: #3498db;">${venda.diasRestantes || 0} dias</span>`;

                html += `
                    <tr>
                        <td><input type="checkbox" class="checkbox-venda" data-venda-id="${venda.id}"></td>
                        <td>${venda.id}</td>
                        <td>${venda.cliente}</td>
                        <td>R$ ${venda.total.toFixed(2)}</td>
                        <td>${new Date(venda.dataVencimento).toLocaleDateString('pt-BR')}</td>
                        <td>${tempoInfo}</td>
                        <td>
                            <button class="btn btn-success" onclick="marcarComoPaga('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">✅</button>
                            <button class="btn btn-warning" onclick="enviarLembrete('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📧</button>
                            <button class="btn btn-info" onclick="mostrarHistoricoCobranca('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📋</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        function renderizarPorValor(vendas, container) {
            // Ordenar por valor decrescente
            const vendasOrdenadas = vendas.sort((a, b) => b.total - a.total);
            
            let html = `
                <div class="card">
                    <h3>💰 Cobranças Ordenadas por Valor</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="selecionarTodas(this.checked)"></th>
                                <th>Valor</th>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            vendasOrdenadas.forEach(venda => {
                const hoje = new Date();
                const vencimento = venda.dataVencimento ? new Date(venda.dataVencimento) : hoje;
                const diffDays = Math.ceil((hoje - vencimento) / (1000 * 60 * 60 * 24));
                const statusInfo = diffDays > 0 ? `${diffDays} dias atraso` : 'No prazo';
                const statusColor = diffDays > 30 ? '#e74c3c' : diffDays > 0 ? '#f39c12' : '#27ae60';

                html += `
                    <tr>
                        <td><input type="checkbox" class="checkbox-venda" data-venda-id="${venda.id}"></td>
                        <td><strong style="color: #2c3e50;">R$ ${venda.total.toFixed(2)}</strong></td>
                        <td>${venda.id}</td>
                        <td>${venda.cliente}</td>
                        <td>${venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : 'À vista'}</td>
                        <td><span style="color: ${statusColor}; font-weight: bold;">${statusInfo}</span></td>
                        <td>
                            <button class="btn btn-success" onclick="marcarComoPaga('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">✅</button>
                            <button class="btn btn-warning" onclick="enviarLembrete('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📧</button>
                            <button class="btn btn-info" onclick="mostrarHistoricoCobranca('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📋</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function renderizarPorAtraso(vendas, container) {
            const hoje = new Date();
            
            // Calcular atraso e ordenar
            const vendasComAtraso = vendas.map(venda => {
                const vencimento = venda.dataVencimento ? new Date(venda.dataVencimento) : hoje;
                const diasAtraso = Math.max(0, Math.ceil((hoje - vencimento) / (1000 * 60 * 60 * 24)));
                return {...venda, diasAtraso};
            }).sort((a, b) => b.diasAtraso - a.diasAtraso);

            let html = `
                <div class="card">
                    <h3>⏰ Cobranças Ordenadas por Atraso</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="selecionarTodas(this.checked)"></th>
                                <th>Atraso</th>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Vencimento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            vendasComAtraso.forEach(venda => {
                const prioridadeColor = venda.diasAtraso > 30 ? '#e74c3c' : 
                                      venda.diasAtraso > 7 ? '#f39c12' : '#27ae60';
                const prioridadeText = venda.diasAtraso > 30 ? 'CRÍTICO' : 
                                     venda.diasAtraso > 7 ? 'ALTO' : 'NORMAL';

                html += `
                    <tr>
                        <td><input type="checkbox" class="checkbox-venda" data-venda-id="${venda.id}"></td>
                        <td>
                            <span style="color: ${prioridadeColor}; font-weight: bold;">${venda.diasAtraso} dias</span>
                            <br><small style="color: ${prioridadeColor};">${prioridadeText}</small>
                        </td>
                        <td>${venda.id}</td>
                        <td>${venda.cliente}</td>
                        <td>R$ ${venda.total.toFixed(2)}</td>
                        <td>${venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : 'À vista'}</td>
                        <td>
                            <button class="btn btn-success" onclick="marcarComoPaga('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">✅</button>
                            <button class="btn btn-warning" onclick="enviarLembrete('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📧</button>
                            <button class="btn btn-info" onclick="mostrarHistoricoCobranca('${venda.id}')" style="font-size: 11px; padding: 4px 8px;">📋</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function marcarComoPaga(vendaId) {
            const venda = dados.vendas.find(v => v.id === vendaId);
            if (venda && confirm(`Marcar venda ${vendaId} como paga?`)) {
                venda.status = 'Paga';
                venda.dataPagamento = new Date().toISOString();
                
                // Registrar no histórico de cobrança
                if (!venda.historicoCobranca) {
                    venda.historicoCobranca = [];
                }
                venda.historicoCobranca.push({
                    data: new Date().toISOString(),
                    acao: 'pagamento',
                    observacao: 'Venda marcada como paga manualmente',
                    usuario: 'Sistema'
                });
                
                salvarDados();
                atualizarDashboard();
                
                // Notificar pagamento recebido
                if (typeof notificationSystem !== 'undefined' && notificationSystem && typeof notificationSystem.createNotification === 'function') {
                    notificationSystem.createNotification(
                        'success',
                        '✅ Pagamento Recebido',
                        `Venda ${venda.id} - ${venda.cliente} - R$ ${venda.total.toFixed(2)}`,
                        [
                            { label: '💰 Ver Cobranças', type: 'primary', action: "showPage('cobrancas')" }
                        ]
                    );
                }
                
                alert('✅ Venda marcada como paga!');
            }
        }

        function enviarLembrete(vendaId) {
            const venda = dados.vendas.find(v => v.id === vendaId);
            if (venda) {
                const cliente = dados.clientes.find(c => c.id === venda.clienteId);
                const hoje = new Date();
                const vencimento = venda.dataVencimento ? new Date(venda.dataVencimento) : hoje;
                const diasAtraso = Math.ceil((hoje - vencimento) / (1000 * 60 * 60 * 24));
                
                // Registrar lembrete no histórico
                if (!venda.historicoCobranca) {
                    venda.historicoCobranca = [];
                }
                venda.historicoCobranca.push({
                    data: new Date().toISOString(),
                    acao: 'lembrete',
                    observacao: `Lembrete de cobrança enviado - ${diasAtraso > 0 ? diasAtraso + ' dias de atraso' : 'vencimento próximo'}`,
                    usuario: 'Sistema'
                });
                
                salvarDados();
                
                const mensagem = `📧 Lembrete de cobrança enviado!\n\nCliente: ${venda.cliente}\nVenda: ${vendaId}\nValor: R$ ${venda.total.toFixed(2)}\nVencimento: ${new Date(venda.dataVencimento).toLocaleDateString('pt-BR')}\n${diasAtraso > 0 ? 'Atraso: ' + diasAtraso + ' dias' : 'Vence em breve'}`;
                
                alert(mensagem + '\n\n(Em um sistema real, seria enviado por email/SMS)');
            }
        }

        function mostrarDetalhesCliente(nomeCliente) {
            const vendas = dados.vendas.filter(v => v.cliente === nomeCliente && v.status !== 'Paga');
            const cliente = dados.clientes.find(c => c.nome === nomeCliente);
            
            if (!cliente) return;
            
            document.getElementById('tituloDetalheCliente').textContent = `Detalhes das Cobranças - ${nomeCliente}`;
            
            let totalPendente = 0;
            let totalAtraso = 0;
            let vendasCriticas = 0;
            
            const hoje = new Date();
            
            vendas.forEach(venda => {
                totalPendente += venda.total;
                if (venda.dataVencimento) {
                    const diasAtraso = Math.ceil((hoje - new Date(venda.dataVencimento)) / (1000 * 60 * 60 * 24));
                    if (diasAtraso > 0) {
                        totalAtraso += diasAtraso;
                        if (diasAtraso > 30) vendasCriticas++;
                    }
                }
            });
            
            const atrasoMedio = vendas.length > 0 ? totalAtraso / vendas.length : 0;
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">R$ ${totalPendente.toFixed(2)}</div>
                            <div style="color: #7f8c8d;">Total Pendente</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${atrasoMedio.toFixed(0)} dias</div>
                            <div style="color: #7f8c8d;">Atraso Médio</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${vendasCriticas}</div>
                            <div style="color: #7f8c8d;">Vendas Críticas</div>
                        </div>
                    </div>
                    
                    <h4>📞 Informações de Contato</h4>
                    <p><strong>Email:</strong> ${cliente.email}</p>
                    <p><strong>Telefone:</strong> ${cliente.telefone}</p>
                    <p><strong>Total de Compras:</strong> R$ ${cliente.totalCompras.toFixed(2)}</p>
                </div>
                
                <h4>📋 Vendas Pendentes</h4>
                <table class="table" style="margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data Venda</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Atraso</th>
                            <th>Último Contato</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            vendas.forEach(venda => {
                const vencimento = venda.dataVencimento ? new Date(venda.dataVencimento) : hoje;
                const diasAtraso = Math.max(0, Math.ceil((hoje - vencimento) / (1000 * 60 * 60 * 24)));
                const ultimoContato = venda.historicoCobranca && venda.historicoCobranca.length > 0 
                    ? new Date(venda.historicoCobranca[venda.historicoCobranca.length - 1].data).toLocaleDateString('pt-BR')
                    : 'Nenhum';
                
                const corAtraso = diasAtraso > 30 ? '#e74c3c' : diasAtraso > 7 ? '#f39c12' : '#27ae60';
                
                html += `
                    <tr>
                        <td>${venda.id}</td>
                        <td>${venda.data}</td>
                        <td>${venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : 'À vista'}</td>
                        <td>R$ ${venda.total.toFixed(2)}</td>
                        <td><span style="color: ${corAtraso}; font-weight: bold;">${diasAtraso} dias</span></td>
                        <td>${ultimoContato}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('conteudoDetalheCliente').innerHTML = html;
            showModal('modalDetalheCliente');
        }

        function mostrarHistoricoCobranca(vendaId) {
            const venda = dados.vendas.find(v => v.id === vendaId);
            if (!venda) return;
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <h4>Venda: ${venda.id}</h4>
                    <p><strong>Cliente:</strong> ${venda.cliente}</p>
                    <p><strong>Valor:</strong> R$ ${venda.total.toFixed(2)}</p>
                    <p><strong>Vencimento:</strong> ${venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : 'À vista'}</p>
                </div>
                
                <h4>📋 Histórico de Ações</h4>
            `;
            
            if (venda.historicoCobranca && venda.historicoCobranca.length > 0) {
                html += `
                    <table class="table" style="margin-top: 10px;">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Ação</th>
                                <th>Observação</th>
                                <th>Usuário</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                venda.historicoCobranca.slice().reverse().forEach(item => {
                    const icone = item.acao === 'lembrete' ? '📧' : item.acao === 'pagamento' ? '✅' : '📝';
                    
                    html += `
                        <tr>
                            <td>${new Date(item.data).toLocaleDateString('pt-BR')} ${new Date(item.data).toLocaleTimeString('pt-BR')}</td>
                            <td>${icone} ${item.acao.charAt(0).toUpperCase() + item.acao.slice(1)}</td>
                            <td>${item.observacao}</td>
                            <td>${item.usuario}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            } else {
                html += `<p style="text-align: center; color: #7f8c8d; padding: 20px;">Nenhuma ação registrada ainda.</p>`;
            }
            
            // Adicionar nova observação
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Adicionar Observação</h4>
                    <textarea id="novaObservacao" placeholder="Digite sua observação..." style="width: 100%; height: 80px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                    <button class="btn btn-success" onclick="adicionarObservacao('${vendaId}')">💾 Salvar Observação</button>
                </div>
            `;
            
            document.getElementById('conteudoHistoricoCobranca').innerHTML = html;
            showModal('modalHistoricoCobranca');
        }

        function adicionarObservacao(vendaId) {
            const observacao = document.getElementById('novaObservacao').value.trim();
            if (!observacao) {
                alert('Por favor, digite uma observação.');
                return;
            }
            
            const venda = dados.vendas.find(v => v.id === vendaId);
            if (!venda) return;
            
            if (!venda.historicoCobranca) {
                venda.historicoCobranca = [];
            }
            
            venda.historicoCobranca.push({
                data: new Date().toISOString(),
                acao: 'observacao',
                observacao: observacao,
                usuario: 'Usuário'
            });
            
            salvarDados();
            mostrarHistoricoCobranca(vendaId); // Recarregar modal
            alert('✅ Observação adicionada com sucesso!');
        }

        function enviarLembreteCliente(nomeCliente) {
            const vendas = dados.vendas.filter(v => v.cliente === nomeCliente && v.status !== 'Paga');
            
            vendas.forEach(venda => {
                if (!venda.historicoCobranca) {
                    venda.historicoCobranca = [];
                }
                venda.historicoCobranca.push({
                    data: new Date().toISOString(),
                    acao: 'lembrete',
                    observacao: 'Lembrete enviado em massa para o cliente',
                    usuario: 'Sistema'
                });
            });
            
            salvarDados();
            alert(`📧 Lembrete enviado para ${nomeCliente} sobre ${vendas.length} venda(s) pendente(s)!`);
        }

        function marcarTodasPagasCliente(nomeCliente) {
            const vendas = dados.vendas.filter(v => v.cliente === nomeCliente && v.status !== 'Paga');
            
            if (vendas.length === 0) return;
            
            if (confirm(`Marcar todas as ${vendas.length} venda(s) de ${nomeCliente} como pagas?`)) {
                vendas.forEach(venda => {
                    venda.status = 'Paga';
                    venda.dataPagamento = new Date().toISOString();
                    
                    if (!venda.historicoCobranca) {
                        venda.historicoCobranca = [];
                    }
                    venda.historicoCobranca.push({
                        data: new Date().toISOString(),
                        acao: 'pagamento',
                        observacao: 'Marcado como pago em massa',
                        usuario: 'Sistema'
                    });
                });
                
                salvarDados();
                atualizarDashboard();
                alert(`✅ Todas as vendas de ${nomeCliente} foram marcadas como pagas!`);
            }
        }

        function enviarLembretesEmMassa() {
            const checkboxes = document.querySelectorAll('.checkbox-venda:checked');
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma venda para enviar lembretes.');
                return;
            }
            
            if (confirm(`Enviar lembrete para ${checkboxes.length} venda(s) selecionada(s)?`)) {
                checkboxes.forEach(checkbox => {
                    const vendaId = checkbox.getAttribute('data-venda-id');
                    enviarLembrete(vendaId);
                });
                
                // Desmarcar todas
                checkboxes.forEach(checkbox => checkbox.checked = false);
                
                alert(`📧 Lembretes enviados para ${checkboxes.length} venda(s)!`);
            }
        }

        function marcarMultiplasPagas() {
            const checkboxes = document.querySelectorAll('.checkbox-venda:checked');
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma venda para marcar como paga.');
                return;
            }
            
            if (confirm(`Marcar ${checkboxes.length} venda(s) selecionada(s) como pagas?`)) {
                checkboxes.forEach(checkbox => {
                    const vendaId = checkbox.getAttribute('data-venda-id');
                    const venda = dados.vendas.find(v => v.id === vendaId);
                    if (venda) {
                        venda.status = 'Paga';
                        venda.dataPagamento = new Date().toISOString();
                        
                        if (!venda.historicoCobranca) {
                            venda.historicoCobranca = [];
                        }
                        venda.historicoCobranca.push({
                            data: new Date().toISOString(),
                            acao: 'pagamento',
                            observacao: 'Marcado como pago em lote',
                            usuario: 'Sistema'
                        });
                    }
                });
                
                salvarDados();
                atualizarDashboard();
                alert(`✅ ${checkboxes.length} venda(s) marcadas como pagas!`);
            }
        }

        function selecionarTodasVendasCliente(nomeCliente, selecionar) {
            const checkboxes = document.querySelectorAll('.checkbox-venda');
            checkboxes.forEach(checkbox => {
                const vendaId = checkbox.getAttribute('data-venda-id');
                const venda = dados.vendas.find(v => v.id === vendaId);
                if (venda && venda.cliente === nomeCliente) {
                    checkbox.checked = selecionar;
                }
            });
        }

        function selecionarTodas(selecionar) {
            const checkboxes = document.querySelectorAll('.checkbox-venda');
            checkboxes.forEach(checkbox => checkbox.checked = selecionar);
        }

        function verificarAlertasCobranca() {
            const hoje = new Date();
            const alertas = [];
            
            dados.vendas.forEach(venda => {
                if (venda.status !== 'Paga' && venda.dataVencimento) {
                    const vencimento = new Date(venda.dataVencimento);
                    const diffTime = vencimento - hoje;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 0) {
                        alertas.push({
                            tipo: diffDays < 0 ? 'vencida' : 'venceHoje',
                            venda: venda,
                            dias: Math.abs(diffDays)
                        });
                    } else if (diffDays <= 3) {
                        alertas.push({
                            tipo: 'proxima',
                            venda: venda,
                            dias: diffDays
                        });
                    }
                }
            });

            // Verificar se o elemento existe antes de tentar acessá-lo
            const alertasContainer = document.getElementById('alertasCobranca');
            if (alertasContainer && alertas.length > 0) {
                let htmlAlertas = '<div style="margin-top: 10px; padding: 10px; border-left: 4px solid #e74c3c; background: #fdf2f2;"><strong>🔔 Alertas de Cobrança:</strong><br>';
                
                alertas.forEach(alerta => {
                    if (alerta.tipo === 'vencida') {
                        htmlAlertas += `<span style="color: #e74c3c;">• Venda ${alerta.venda.id} vencida há ${alerta.dias} dias - ${alerta.venda.cliente}</span><br>`;
                    } else if (alerta.tipo === 'venceHoje') {
                        htmlAlertas += `<span style="color: #f39c12;">• Venda ${alerta.venda.id} vence HOJE - ${alerta.venda.cliente}</span><br>`;
                    } else if (alerta.tipo === 'proxima') {
                        htmlAlertas += `<span style="color: #f39c12;">• Venda ${alerta.venda.id} vence em ${alerta.dias} dias - ${alerta.venda.cliente}</span><br>`;
                    }
                });
                
                htmlAlertas += '</div>';
                alertasContainer.innerHTML = htmlAlertas;
            } else if (alertasContainer) {
                alertasContainer.innerHTML = '';
            }
        }

        // ============= FUNÇÕES AUXILIARES =============

        function backup() {
            const dadosBackup = {
                timestamp: new Date().toISOString(),
                sistema: 'Mineração Pro',
                versao: '3.0',
                dados: dados
            };
            
            const dataStr = JSON.stringify(dadosBackup, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_mineracao_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            alert('✅ Backup realizado com sucesso!\n📁 Arquivo: backup_mineracao_' + new Date().toISOString().split('T')[0] + '.json');
        }

        function limparTodosDados() {
            if (confirm('⚠️ ATENÇÃO: Esta ação irá apagar TODOS os dados do sistema!\n\nDeseja realmente continuar?')) {
                if (confirm('🔴 CONFIRMAÇÃO FINAL: Todos os minérios, clientes, veículos e vendas serão perdidos!\n\nTem certeza absoluta?')) {
                    dados = {
                        minerios: [],
                        clientes: [],
                        veiculos: [],
                        vendas: [],
                        despesas: [],
                        movimentacoes: [],
                        creditoSistema: {
                            creditoTotal: 100000.00,
                            valorEmEstoque: 0,
                            creditoDisponivel: 100000.00,
                            totalToneladas: 0
                        },
                        configuracoes: {
                            nomeEmpresa: 'Mineradora São João Ltda',
                            cnpj: '',
                            endereco: '',
                            telefone: '',
                            email: '',
                            moeda: 'R$',
                            margemLucro: 30.0,
                            descontoMaximo: 10.0,
                            alertaEstoqueBaixo: true,
                            limiteEstoque: 10,
                            backupAutomatico: true,
                            notificacaoVendas: true,
                            tema: 'Claro (Padrão)',
                            corPrincipal: '#667eea',
                            tamanhoFonte: 'Médio'
                        }
                    };
                    
                    salvarDados();
                    atualizarDashboard();
                    alert('✅ Todos os dados foram limpos! Sistema resetado.');
                }
            }
        }

        // Fechar modal ao clicar fora
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // ============= ANALYTICS AVANÇADOS =============

        function calcularAnalyticsAvancados() {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            // Vendas do mês atual
            const vendasMes = dados.vendas.filter(venda => {
                const dataVenda = new Date(venda.data.split('/').reverse().join('-'));
                return dataVenda >= inicioMes;
            });
            
            // Cálculos financeiros
            let receitaMensal = 0;
            let custoMensal = 0;
            let receitaHoje = 0;
            
            vendasMes.forEach(venda => {
                receitaMensal += venda.total;
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                custoMensal += venda.quantidade * (minerio?.preco || 0);
                
                // Receita de hoje
                const dataVenda = new Date(venda.data.split('/').reverse().join('-'));
                if (dataVenda.toDateString() === hoje.toDateString()) {
                    receitaHoje += venda.total;
                }
            });
            
            const lucroMensal = receitaMensal - custoMensal;
            const margemLucro = receitaMensal > 0 ? (lucroMensal / receitaMensal) * 100 : 0;
            const ticketMedio = vendasMes.length > 0 ? receitaMensal / vendasMes.length : 0;
            
            // Meta mensal (simulada baseada no histórico)
            const metaMensal = 50000;
            const progressoMeta = (receitaMensal / metaMensal) * 100;
            
            // Atualizar KPIs (verificar se elementos existem)
            const elementoLucroMensal = document.getElementById('lucroMensal');
            const elementoMargemLucro = document.getElementById('margemLucro');
            const elementoTicketMedio = document.getElementById('ticketMedio');
            const elementoVendasMes = document.getElementById('vendasMes');
            const elementoReceitaHoje = document.getElementById('receitaHoje');
            const elementoMetaMensal = document.getElementById('metaMensal');
            const elementoProgressoMeta = document.getElementById('progressoMeta');

            if (elementoLucroMensal) elementoLucroMensal.textContent = `R$ ${lucroMensal.toLocaleString('pt-BR')}`;
            if (elementoMargemLucro) elementoMargemLucro.textContent = `${margemLucro.toFixed(1)}%`;
            if (elementoTicketMedio) elementoTicketMedio.textContent = `R$ ${ticketMedio.toFixed(2)}`;
            if (elementoVendasMes) elementoVendasMes.textContent = vendasMes.length;
            if (elementoReceitaHoje) elementoReceitaHoje.textContent = `R$ ${receitaHoje.toFixed(2)}`;
            if (elementoMetaMensal) elementoMetaMensal.textContent = `R$ ${metaMensal.toLocaleString('pt-BR')}`;
            if (elementoProgressoMeta) elementoProgressoMeta.textContent = `${progressoMeta.toFixed(1)}%`;
            
            // Colorir baseado na performance
            if (elementoLucroMensal) {
                if (lucroMensal > 0) {
                    elementoLucroMensal.style.color = '#27ae60';
                } else {
                    elementoLucroMensal.style.color = '#e74c3c';
                }
            }
            
            if (elementoMargemLucro) {
                if (margemLucro >= 30) {
                    elementoMargemLucro.style.color = '#27ae60';
                } else if (margemLucro >= 15) {
                    elementoMargemLucro.style.color = '#f39c12';
                } else {
                    elementoMargemLucro.style.color = '#e74c3c';
                }
            }
        }

        function gerarAlertasInteligentes() {
            const alertas = [];
            const hoje = new Date();
            
            // 1. Verificar estoque crítico
            dados.minerios.forEach(minerio => {
                if ((minerio.estoque || 0) <= 5) {
                    alertas.push({
                        tipo: 'critico',
                        icone: '⚠️',
                        titulo: 'Estoque Crítico',
                        mensagem: `${minerio.nome}: apenas ${(minerio.estoque || 0).toFixed(1)} toneladas em estoque`,
                        acao: () => showPage('produtos')
                    });
                } else if ((minerio.estoque || 0) <= 15) {
                    alertas.push({
                        tipo: 'aviso',
                        icone: '📦',
                        titulo: 'Estoque Baixo',
                        mensagem: `${minerio.nome}: ${(minerio.estoque || 0).toFixed(1)} toneladas restantes`,
                        acao: () => showPage('produtos')
                    });
                }
            });
            
            // 2. Verificar vendas vencidas
            const vendasVencidas = dados.vendas.filter(venda => {
                if (venda.status === 'Paga' || !venda.dataVencimento) return false;
                const vencimento = new Date(venda.dataVencimento);
                return vencimento < hoje;
            });
            
            if (vendasVencidas.length > 0) {
                const valorTotal = vendasVencidas.reduce((sum, v) => sum + v.total, 0);
                alertas.push({
                    tipo: 'critico',
                    icone: '💰',
                    titulo: 'Cobranças Vencidas',
                    mensagem: `${vendasVencidas.length} venda(s) vencida(s) - R$ ${valorTotal.toFixed(2)}`,
                    acao: () => showPage('cobrancas')
                });
            }
            
            // 3. Verificar performance da margem
            const vendasRecentes = dados.vendas.slice(-5);
            if (vendasRecentes.length > 0) {
                let margemMedia = 0;
                vendasRecentes.forEach(venda => {
                    const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                    const custo = venda.quantidade * (minerio?.preco || 0);
                    const margem = venda.total > 0 ? ((venda.total - custo) / venda.total) * 100 : 0;
                    margemMedia += margem;
                });
                margemMedia /= vendasRecentes.length;
                
                if (margemMedia < 15) {
                    alertas.push({
                        tipo: 'aviso',
                        icone: '📉',
                        titulo: 'Margem Baixa',
                        mensagem: `Margem média das últimas vendas: ${margemMedia.toFixed(1)}%`,
                        acao: () => showPage('relatorios')
                    });
                }
            }
            
            // 4. Verificar veículos em manutenção
            const veiculosManutencao = dados.veiculos.filter(v => v.status === 'Manutenção');
            if (veiculosManutencao.length > 0) {
                alertas.push({
                    tipo: 'info',
                    icone: '🔧',
                    titulo: 'Veículos em Manutenção',
                    mensagem: `${veiculosManutencao.length} veículo(s) em manutenção`,
                    acao: () => showPage('veiculos')
                });
            }
            
            // Alerta de oportunidades removido conforme solicitação
            
            // Renderizar alertas
            const container = document.getElementById('alertasInteligentes');
            if (container) {
                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="alerta-inteligente alerta-sucesso">
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 24px; margin-right: 15px;">✅</span>
                                <div>
                                    <strong>Sistema Operacional</strong><br>
                                    <small>Nenhum alerta crítico detectado</small>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = alertas.map(alerta => `
                        <div class="alerta-inteligente alerta-${alerta.tipo}" onclick="${alerta.acao ? alerta.acao.name + '()' : ''}" style="cursor: ${alerta.acao ? 'pointer' : 'default'};">
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 24px; margin-right: 15px;">${alerta.icone}</span>
                                <div>
                                    <strong>${alerta.titulo}</strong><br>
                                    <small>${alerta.mensagem}</small>
                                </div>
                            </div>
                            ${alerta.acao ? '<span style="font-size: 18px;">👆</span>' : ''}
                        </div>
                    `).join('');
                }
            }
        }

        function atualizarInsightsInteligentes() {
            const insights = [];
            const hoje = new Date(); // Definir a variável hoje
            
            // Análise de tendências
            if (dados.vendas.length >= 3) {
                const ultimasVendas = dados.vendas.slice(-3);
                const receitas = ultimasVendas.map(v => v.total);
                const tendencia = receitas[2] > receitas[1] && receitas[1] > receitas[0] ? 'alta' : 
                                receitas[2] < receitas[1] && receitas[1] < receitas[0] ? 'baixa' : 'estável';
                
                if (tendencia === 'alta') {
                    insights.push('📈 Tendência positiva: Suas últimas vendas mostram crescimento consistente');
                } else if (tendencia === 'baixa') {
                    insights.push('📉 Atenção: Detectada tendência de queda nas vendas recentes');
                } else {
                    insights.push('📊 Vendas estáveis: Performance consistente nas últimas transações');
                }
            }
            
            // Produto mais lucrativo
            const produtoLucros = {};
            dados.vendas.forEach(venda => {
                const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                const custo = venda.quantidade * (minerio?.preco || 0);
                const lucro = venda.total - custo;
                
                if (!produtoLucros[venda.minerio]) {
                    produtoLucros[venda.minerio] = { lucro: 0, vendas: 0 };
                }
                produtoLucros[venda.minerio].lucro += lucro;
                produtoLucros[venda.minerio].vendas += 1;
            });
            
            const melhorProduto = Object.entries(produtoLucros)
                .sort(([,a], [,b]) => b.lucro - a.lucro)[0];
            
            if (melhorProduto) {
                insights.push(`🏆 Produto mais lucrativo: ${melhorProduto[0]} (R$ ${melhorProduto[1].lucro.toFixed(2)} em lucros)`);
            }
            
            // Análise de cliente
            const clienteVendas = {};
            dados.vendas.forEach(venda => {
                clienteVendas[venda.cliente] = (clienteVendas[venda.cliente] || 0) + venda.total;
            });
            
            const melhorCliente = Object.entries(clienteVendas)
                .sort(([,a], [,b]) => b - a)[0];
            
            if (melhorCliente) {
                insights.push(`👑 Melhor cliente: ${melhorCliente[0]} (R$ ${melhorCliente[1].toFixed(2)} em compras)`);
            }
            
            // Análise de clientes inativos
            const clientesInativos = dados.clientes.filter(cliente => {
                const ultimaCompra = dados.vendas
                    .filter(v => v.cliente === cliente.nome)
                    .sort((a, b) => new Date(b.data.split('/').reverse().join('-')) - new Date(a.data.split('/').reverse().join('-')))[0];
                
                if (!ultimaCompra) return true;
                
                const dataUltimaCompra = new Date(ultimaCompra.data.split('/').reverse().join('-'));
                const diasSemComprar = (hoje - dataUltimaCompra) / (1000 * 60 * 60 * 24);
                return diasSemComprar > 30;
            });
            
            if (clientesInativos.length > 0) {
                insights.push(`👥 Clientes inativos: ${clientesInativos.length} cliente(s) sem comprar há mais de 30 dias`);
            }
            
            // Renderizar insights - verificar se elemento existe
            const container = document.getElementById('insightsInteligentes');
            if (container) {
                if (insights.length === 0) {
                    container.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Colete mais dados para gerar insights inteligentes</p>';
                } else {
                    container.innerHTML = insights.map(insight => `
                        <div class="insight-item" style="padding-left: 25px;">
                            ${insight}
                        </div>
                    `).join('');
                }
            }
        }

        function desenharGraficoPerformance() {
            const canvas = document.getElementById('graficoPerformance');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Simular dados dos últimos 7 dias
            const hoje = new Date();
            const dias = [];
            const receitas = [];
            const lucros = [];
            
            for (let i = 6; i >= 0; i--) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() - i);
                dias.push(data.toLocaleDateString('pt-BR', { weekday: 'short' }));
                
                // Simular dados baseados nas vendas reais
                const vendasDia = dados.vendas.filter(v => Math.random() > 0.7); // Simular distribuição
                let receitaDia = 0;
                let lucroDia = 0;
                
                vendasDia.forEach(venda => {
                    const fator = 0.5 + Math.random() * 0.5; // Variação
                    receitaDia += venda.total * fator;
                    
                    const minerio = dados.minerios.find(m => m.nome === venda.minerio);
                    const custo = venda.quantidade * (minerio?.preco || 0) * fator;
                    lucroDia += (venda.total * fator) - custo;
                });
                
                receitas.push(receitaDia);
                lucros.push(lucroDia);
            }
            
            const maxReceita = Math.max(...receitas, 1000);
            const scale = 180 / maxReceita;
            const barWidth = 60;
            const spacing = 80;
            
            ctx.font = '12px Arial';
            
            // Desenhar barras
            dias.forEach((dia, index) => {
                const x = 50 + index * spacing;
                const baseY = 200;
                
                // Barra de receita
                const alturaReceita = receitas[index] * scale;
                ctx.fillStyle = '#3498db';
                ctx.fillRect(x, baseY - alturaReceita, barWidth * 0.4, alturaReceita);
                
                // Barra de lucro
                const alturaLucro = Math.max(0, lucros[index] * scale);
                ctx.fillStyle = lucros[index] >= 0 ? '#27ae60' : '#e74c3c';
                ctx.fillRect(x + barWidth * 0.5, baseY - alturaLucro, barWidth * 0.4, alturaLucro);
                
                // Labels
                ctx.fillStyle = '#2c3e50';
                ctx.fillText(dia, x + 10, baseY + 20);
                
                if (receitas[index] > 0) {
                    ctx.fillText(`R$ ${(receitas[index]/1000).toFixed(1)}k`, x - 5, baseY - alturaReceita - 5);
                }
            });
            
            // Legenda
            ctx.fillStyle = '#3498db';
            ctx.fillRect(50, 230, 15, 10);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText('Receita', 70, 239);
            
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(130, 230, 15, 10);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText('Lucro', 150, 239);
        }

        function atualizarIndicadoresPerformance() {
            const indicadores = [
                { nome: 'Taxa de Conversão', valor: '85%', tendencia: 'up', cor: '#27ae60' },
                { nome: 'Tempo Médio Cobrança', valor: '12 dias', tendencia: 'down', cor: '#27ae60' },
                { nome: 'ROI Médio', valor: '45%', tendencia: 'up', cor: '#27ae60' },
                { nome: 'Satisfação Cliente', valor: '4.2/5', tendencia: 'neutral', cor: '#f39c12' },
                { nome: 'Eficiência Entrega', valor: '92%', tendencia: 'up', cor: '#27ae60' }
            ];
            
            const container = document.getElementById('indicadoresPerformance');
            if (container) {
                container.innerHTML = indicadores.map(ind => {
                    const iconeTendencia = ind.tendencia === 'up' ? '📈' : 
                                         ind.tendencia === 'down' ? '📉' : '➡️';
                    return `
                        <div class="performance-indicator">
                            <div>
                                <strong>${ind.nome}</strong><br>
                                <span style="color: ${ind.cor};">${ind.valor}</span>
                            </div>
                            <span class="trend-${ind.tendencia}">${iconeTendencia}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function atualizarCentroAlertas() {
            const alertasAtivos = [];
            
            // Verificar alertas de estoque
            const estoquesBaixos = dados.minerios.filter(m => (m.estoque || 0) <= 10);
            if (estoquesBaixos.length > 0) {
                alertasAtivos.push(`📦 ${estoquesBaixos.length} produto(s) com estoque baixo`);
            }
            
            // Verificar alertas de cobrança
            const hoje = new Date();
            const cobrancasVencidas = dados.vendas.filter(v => {
                if (v.status === 'Paga' || !v.dataVencimento) return false;
                return new Date(v.dataVencimento) < hoje;
            });
            
            if (cobrancasVencidas.length > 0) {
                alertasAtivos.push(`💰 ${cobrancasVencidas.length} cobrança(s) vencida(s)`);
            }
            
            // Verificar alertas de veículos
            const veiculosProblema = dados.veiculos.filter(v => v.status !== 'Ativo');
            if (veiculosProblema.length > 0) {
                alertasAtivos.push(`🚛 ${veiculosProblema.length} veículo(s) indisponível(eis)`);
            }
            
            const container = document.getElementById('centroAlertas');
            if (container) {
                if (alertasAtivos.length === 0) {
                    container.innerHTML = '<p style="color: #27ae60; text-align: center;">✅ Nenhum alerta ativo</p>';
                } else {
                    container.innerHTML = alertasAtivos.map(alerta => `
                        <div style="padding: 8px; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 8px; border-radius: 4px;">
                            ${alerta}
                        </div>
                    `).join('');
                }
            }
            
            // Atualizar resumo de alertas
            const resumoContainer = document.getElementById('alertasResumo');
            if (resumoContainer) {
                if (alertasAtivos.length === 0) {
                    resumoContainer.innerHTML = '<span style="color: #27ae60;">✅ Nenhum alerta</span>';
                } else {
                    resumoContainer.innerHTML = `<span style="color: #f39c12;">⚠️ ${alertasAtivos.length} alerta(s) ativo(s)</span>`;
                }
            }
        }

        // Função para atualizar analytics em tempo real
        function atualizarAnalyticsTempoReal() {
            if (currentPage === 'dashboard') {
                calcularAnalyticsAvancados();
                gerarAlertasInteligentes();
                atualizarInsightsInteligentes();
                atualizarIndicadoresPerformance();
                atualizarCentroAlertas();
            }
        }

        // Funções auxiliares para integração com notificações
        function notifyStockCritical(minerio) {
            notificationSystem.createNotification(
                'critical',
                '⚠️ Estoque Crítico',
                `${minerio.nome}: apenas ${(minerio.estoque || 0).toFixed(1)} toneladas restantes!`,
                [
                    { label: '📦 Ver Estoque', type: 'primary', action: "showPage('produtos')" },
                    { label: '📞 Encomendar', type: 'success', action: "alert('Função de encomenda em desenvolvimento')" }
                ]
            );
        }

        function notifyNewSale(venda) {
            notificationSystem.createNotification(
                'success',
                '💰 Nova Venda Registrada',
                `Venda ${venda.id} - ${venda.cliente} - R$ ${venda.total.toFixed(2)}`,
                [
                    { label: '👁️ Ver Vendas', type: 'primary', action: "showPage('vendas')" }
                ],
                true
            );
        }

        function notifyPaymentReceived(venda) {
            notificationSystem.createNotification(
                'success',
                '✅ Pagamento Recebido',
                `Venda ${venda.id} - ${venda.cliente} - R$ ${venda.total.toFixed(2)}`,
                [
                    { label: '💰 Ver Cobranças', type: 'primary', action: "showPage('cobrancas')" }
                ]
            );
        }

        function notifyVehicleUpdate(veiculo, oldStatus, newStatus) {
            const icon = newStatus === 'Ativo' ? '✅' : newStatus === 'Manutenção' ? '🔧' : '❌';
            notificationSystem.createNotification(
                newStatus === 'Ativo' ? 'success' : 'warning',
                `${icon} Status do Veículo Alterado`,
                `${veiculo.placa} - ${veiculo.modelo}: ${oldStatus} → ${newStatus}`,
                [
                    { label: '🚛 Ver Frota', type: 'primary', action: "showPage('veiculos')" }
                ]
            );
        }

        // Integração com notificações (sem quebrar as funções originais)
        function notifyAfterSale(venda) {
            notifyNewSale(venda);
        }

        function notifyAfterPayment(venda) {
            notifyPaymentReceived(venda);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            try {
                carregarDados();
                
                // Inicializar sistema de notificações
                notificationSystem = new NotificationSystem();
                
                // Configurar eventos de vendas
                setTimeout(configurarEventosVenda, 500);
                
                // Atualizar dashboard inicial
                atualizarDashboard();
                
                // Verificar alertas de cobrança
                verificarAlertasCobranca();
                
                // Notificação de boas-vindas
                setTimeout(() => {
                    if (notificationSystem && typeof notificationSystem.createNotification === 'function') {
                        notificationSystem.createNotification(
                            'info',
                            '🚚 Bem-vindo ao Rei da Caçambinha!',
                            'Sistema de notificações ativo. Configure suas preferências na central de notificações.',
                            [
                                { label: '⚙️ Configurar', type: 'primary', action: 'toggleNotificationCenter()' }
                            ]
                        );
                    }
                }, 2000);
                
                // Sistema de alertas e analytics em tempo real
                setInterval(() => {
                    try {
                        atualizarAnalyticsTempoReal();
                    } catch (e) {
                        console.log('Erro nos analytics:', e);
                    }
                }, 30000);
                
                setInterval(() => {
                    try {
                        verificarAlertasCobranca();
                    } catch (e) {
                        console.log('Erro nos alertas de cobrança:', e);
                    }
                }, 5 * 60 * 1000);
                
                console.log('🚀 Sistema Rei da Caçambinha iniciado com sucesso!');
                console.log('📊 Versão 4.0 - Sistema de Notificações Avançado');
                console.log('🚚 Gerencie minérios, veículos, vendas e cobranças!');
                console.log('💰 Sistema com cálculo de lucro e insights inteligentes');
                console.log('🔔 Sistema de notificações push, sonoras e em tempo real ativo!');
                console.log('📱 Suporte a notificações do navegador habilitado');
                
            } catch (error) {
                console.error('Erro na inicialização:', error);
                alert('Erro ao inicializar o sistema. Verifique o console para mais detalhes.');
            }
        });
    </script>
</body>
</html>