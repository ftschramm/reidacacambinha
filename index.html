<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão - Rei da Caçambinha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Flatpickr CSS e JS para calendario -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDLpp2RHH30GfOB8wDYBlihwheWBopTSLA",
            authDomain: "rei2-3a051.firebaseapp.com",
            databaseURL: "https://rei2-3a051-default-rtdb.firebaseio.com",
            projectId: "rei2-3a051",
            storageBucket: "rei2-3a051.firebasestorage.app",
            messagingSenderId: "1045275645464",
            appId: "1:1045275645464:web:c655bc720e406d42d4d56d",
            measurementId: "G-EQP0BYJRV9"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        // Variáveis globais para Firebase
        window.firebaseDB = database;
        window.firebaseAuth = auth;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        
        // Monitor de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('✅ Usuário autenticado:', user.email);
                window.firebaseConnected = true;
                window.firebaseUser = user;
                
                // Atualizar indicador
                if (typeof updateSyncIndicator === 'function') {
                    updateSyncIndicator();
                }
                
                // Tentar carregar dados do Firebase ao conectar
                if (typeof window.loadFromFirebase === 'function') {
                    window.loadFromFirebase();
                }
            } else {
                console.log('❌ Usuário não autenticado');
                window.firebaseConnected = false;
                window.firebaseUser = null;
                
                // Atualizar indicador
                if (typeof updateSyncIndicator === 'function') {
                    updateSyncIndicator();
                }
            }
        });
    </script>
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Rei da Caçambinha&quot;,&quot;short_name&quot;:&quot;ReiCaçambinha&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;theme_color&quot;:&quot;#1f2937&quot;}">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --primary-yellow: #FFC107;
            --primary-blue: #2196F3;
            --primary-green: #4CAF50;
            --primary-white: #FFFFFF;
            --dark-blue: #1565C0;
            --light-yellow: #FFF9C4;
            --light-blue: #E3F2FD;
            --light-green: #E8F5E8;
            --text-dark: #1A1A1A;
            --text-light: #666666;
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 8px;
        }
        .sidebar-item:hover {
            background: linear-gradient(135deg, var(--light-blue), var(--light-yellow));
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
        }
        .sidebar-item.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-yellow));
            color: white;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
        }
        .sidebar-item.active:hover {
            transform: translateX(0px);
        }
        
        .quick-action-btn {
            padding: 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }
        
        .content-section {
            animation: fadeIn 0.5s ease-in-out;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* SIDEBAR COLLAPSED STATE */
        .sidebar.collapsed {
            width: 80px !important;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed .sidebar-brand {
            text-align: center;
        }
        
        .sidebar.collapsed .sidebar-brand h1,
        .sidebar.collapsed .sidebar-brand p,
        .sidebar.collapsed .sidebar-brand .mt-2 {
            display: none;
        }
        
        .sidebar.collapsed .menu-toggle {
            margin-left: auto;
            margin-right: auto;
        }
        
        .sidebar.collapsed .sidebar-item div:last-child {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-item {
            justify-content: center;
            padding: 12px 8px;
        }
        
        .sidebar.collapsed .sidebar-item .w-10 {
            width: 2rem !important;
            height: 2rem !important;
            font-size: 1rem !important;
            margin-right: 0 !important;
        }
        
        .main-content.sidebar-collapsed {
            margin-left: 80px !important;
            width: calc(100% - 80px) !important;
            transition: all 0.3s ease;
        }
        
        /* Large Mobile/Tablet styles (até 1024px) */
        @media (max-width: 1024px) {
            /* Mobile header visible */
            .mobile-header {
                display: flex !important;
                position: sticky;
                top: 0;
                z-index: 999;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            /* Force sidebar to be mobile-style */
            .sidebar {
                position: fixed !important;
                left: 0;
                top: 0;
                transform: translateX(-100%);
                z-index: 1000;
                width: 320px !important;
                height: 100vh;
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: 320px !important;
                transform: translateX(-100%);
            }
            
            .sidebar.collapsed.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                min-height: 100vh;
            }
            
            .main-content.sidebar-collapsed {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            /* Content adjustments */
            .content-section {
                padding: 1rem !important;
                min-height: calc(100vh - 80px);
                overflow-x: auto;
            }
            
        /* Standard Mobile styles (até 768px) */
        @media (max-width: 768px) {
            .metric-card {
                margin-bottom: 1rem;
            }
            
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .grid.grid-cols-2 {
                grid-template-columns: 1fr 1fr !important;
            }
            
            .grid.grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
            
            .grid.grid-cols-4 {
                grid-template-columns: 1fr 1fr !important;
            }
            
            table {
                font-size: 14px;
            }
            
            .chart-container {
                height: 250px !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
            
            .text-2xl {
                font-size: 1.25rem !important;
            }
            
            .p-6 {
                padding: 1rem !important;
            }
            
            .space-x-4 > * + * {
                margin-left: 0.5rem !important;
            }
            
            /* Responsive tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-container table {
                min-width: 100%;
                white-space: nowrap;
            }
            
            /* Better button spacing on mobile */
            .flex.gap-2 {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .flex.gap-4 {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            

            
            /* Modal improvements */
            .fixed.inset-0 .bg-white {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
                overflow-y: auto;
                border-radius: 12px;
            }
            
            /* Table improvements */
            .table-container {
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                background: white;
                margin: 1rem 0;
            }
            
            /* Better spacing */
            .space-y-4 > * + * {
                margin-top: 1rem !important;
            }
            
            /* Card improvements */
            .bg-white {
                border-radius: 12px !important;
            }
        }
        
        /* Overlay for mobile sidebar */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .mobile-overlay.active {
            display: block !important;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-vencida { color: #dc2626; font-weight: bold; }
        .status-vence-logo { color: #dc2626; font-weight: bold; }
        .status-atencao { color: #d97706; font-weight: bold; }
        .status-valida { color: #059669; font-weight: bold; }
        
        .metric-card {
            background: linear-gradient(135deg, var(--primary-white) 0%, #f8f9fa 100%);
            border: 1px solid rgba(33, 150, 243, 0.1);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .section-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-yellow));
            color: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(33, 150, 243, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-green));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(33, 150, 243, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--primary-yellow), #FF9800);
            border: none;
            border-radius: 12px;
            color: var(--text-dark);
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(255, 193, 7, 0.4);
        }
        
        .table-modern {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .table-modern thead {
            background: linear-gradient(135deg, var(--dark-blue), var(--primary-blue));
            color: white;
        }
        .table-modern tbody tr:hover {
            background: var(--light-blue);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-ativo {
            background: var(--light-green);
            color: var(--primary-green);
        }
        .status-vencida-badge {
            background: #FFEBEE;
            color: #C62828;
        }
        .status-atencao-badge {
            background: #FFF8E1;
            color: #F57C00;
        }
        .status-valida-badge {
            background: var(--light-green);
            color: var(--primary-green);
        }
        
        /* Otimizações Mobile */
        @media (max-width: 768px) {
            .sidebar-item {
                padding: 1rem 1.5rem;
            }
            .sidebar-item span {
                font-size: 0.875rem;
            }
            .content-section {
                padding: 1rem;
            }
            .grid {
                gap: 1rem;
            }
            .text-3xl {
                font-size: 1.5rem;
            }
            .text-2xl {
                font-size: 1.25rem;
            }
            .modal {
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            .w-96 {
                width: 100%;
                max-width: 100%;
            }
            
            /* Tabelas responsivas com scroll horizontal */
            .table-modern table {
                min-width: 900px;
            }
            
            /* Botões menores para mobile */
            .table-mobile-btn {
                padding: 3px 6px !important;
                font-size: 10px !important;
                border-radius: 4px !important;
                margin: 1px !important;
                white-space: nowrap;
            }
            
            /* Coluna de ações fixada à direita */
            .table-modern th:last-child,
            .table-modern td:last-child {
                position: sticky;
                right: 0;
                background: white;
                box-shadow: -3px 0 8px rgba(0,0,0,0.15);
                z-index: 2;
                min-width: 140px;
            }
            
            /* Header da coluna de ações */
            .table-modern thead th:last-child {
                background: linear-gradient(135deg, var(--dark-blue), var(--primary-blue));
                z-index: 3;
            }
            
            /* Primeira coluna também pode ser fixada se necessário */
            .table-modern th:first-child,
            .table-modern td:first-child {
                min-width: 180px;
            }
            
            /* Headers menores em mobile */
            .section-header h2 {
                font-size: 1.5rem !important;
            }
            
            /* Botões do header menores */
            .section-header .btn-primary,
            .section-header .btn-secondary {
                padding: 8px 12px !important;
                font-size: 12px !important;
            }
            
            /* Espaçamento entre botões */
            .section-header .flex.gap-3 {
                gap: 8px !important;
            }
        }
        
        /* Telas muito pequenas */
        @media (max-width: 640px) {
            .hide-small-mobile {
                display: none !important;
            }
            
            .table-modern table {
                min-width: 700px;
            }
            
            .table-modern th:last-child,
            .table-modern td:last-child {
                min-width: 120px;
            }
        }
        
        /* PWA Support */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Touch Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .sidebar-item {
                min-height: 44px;
            }
            button {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }
            input, select, textarea {
                min-height: 44px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }
        
        /* Animações para o indicador de sincronização */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Hover do indicador de sincronização */
        #syncIndicator:hover {
            transform: scale(1.05);
            cursor: pointer;
        }
        
        /* Animação para timer de alerta */
        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .animate-shrink {
            animation: shrink 10s linear forwards;
        }
        
        /* Estilo do modal de alerta crítico */
        #alertaCriticoModal {
            backdrop-filter: blur(8px);
        }
        
        #alertaCriticoContent {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Indicador de Status de Sincronização -->
    <div id="syncIndicator" class="fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-white rounded-full shadow-lg border px-3 py-2 text-sm transition-all duration-300">
        <div id="syncDot" class="w-3 h-3 rounded-full bg-gray-400 transition-all duration-300"></div>
        <span id="syncText" class="text-gray-600 font-medium">Verificando...</span>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="toggleMobileSidebar()"></div>
    
    <!-- Mobile Header -->
    <div class="mobile-header bg-white shadow-lg px-4 py-3 flex items-center justify-between" style="display: none;">
        <h1 class="text-xl font-bold text-gray-800">Rei da Caçambinha</h1>
        <button onclick="toggleMobileSidebar()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 bg-gradient-to-b from-white to-gray-50 shadow-xl overflow-y-auto border-r border-blue-100">
            <div class="sidebar-brand p-6 border-b border-blue-100 relative">
                <div class="text-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-yellow-400 rounded-xl flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3">
                        RC
                    </div>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-blue-600 to-yellow-600 bg-clip-text text-transparent">REI DA CAÇAMBINHA</h1>
                    <p class="text-xs text-gray-500 mt-1">Transportadora de Minérios</p>
                    <div class="mt-2 px-3 py-1 bg-gradient-to-r from-green-100 to-yellow-100 text-green-700 text-xs font-semibold rounded-full">
                        Sistema v3.0
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="menu-toggle absolute top-4 right-4 p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>
            
            <nav class="mt-4 px-2">
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('dashboard')" data-section="dashboard">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white mr-3">
                        📊
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Dashboard</span>
                        <div class="text-xs text-gray-500">Visão geral</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('minerios')" data-section="minerios">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center text-white mr-3">
                        ⛏️
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Minérios</span>
                        <div class="text-xs text-gray-500">Materiais</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('clientes')" data-section="clientes">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center text-white mr-3">
                        👥
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Clientes</span>
                        <div class="text-xs text-gray-500">Empresas</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('vendas')" data-section="vendas">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white mr-3">
                        💰
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Vendas</span>
                        <div class="text-xs text-gray-500">Transações</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('veiculos')" data-section="veiculos">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-teal-600 rounded-xl flex items-center justify-center text-white mr-3">
                        🚚
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Veículos</span>
                        <div class="text-xs text-gray-500">Frota</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('motoristas')" data-section="motoristas">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center text-white mr-3">
                        👨‍✈️
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Motoristas</span>
                        <div class="text-xs text-gray-500">Equipe</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('estoque')" data-section="estoque">
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center text-white mr-3">
                        📦
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Estoque</span>
                        <div class="text-xs text-gray-500">Controle</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('despesas')" data-section="despesas">
                    <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center text-white mr-3">
                        💸
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Despesas</span>
                        <div class="text-xs text-gray-500">Gastos</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('financeiro')" data-section="financeiro">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-xl flex items-center justify-center text-white mr-3">
                        💳
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Financeiro</span>
                        <div class="text-xs text-gray-500">Análises</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('cobranca')" data-section="cobranca">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center text-white mr-3">
                        📋
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Cobranças</span>
                        <div class="text-xs text-gray-500">Pendências</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('relatorios')" data-section="relatorios">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white mr-3">
                        📈
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Relatórios</span>
                        <div class="text-xs text-gray-500">Dados</div>
                    </div>
                </div>
                
                <div class="sidebar-item px-4 py-3 cursor-pointer flex items-center" onclick="showSection('config')" data-section="config">
                    <div class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center text-white mr-3">
                        ⚙️
                    </div>
                    <div>
                        <span class="font-semibold text-gray-800">Config</span>
                        <div class="text-xs text-gray-500">Sistema</div>
                    </div>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-1 overflow-y-auto w-full">
            <div id="content" class="content-section p-3 lg:p-6 w-full overflow-x-hidden">
                <!-- Conteúdo será carregado aqui -->
            </div>
        </div>
    </div>

    <!-- Modal para Minérios -->
    <div id="minerioModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4" id="minerioModalTitle">Adicionar Minério</h3>
            <form id="minerioForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minério</label>
                    <input type="text" id="minerioTipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Densidade (t/m³)</label>
                    <input type="number" step="0.1" id="minerioDensidade" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Custo por tonelada (R$)</label>
                    <input type="number" step="0.01" id="minerioPreco" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <select id="minerioCategoria" required class="w-full px-3 py-2 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="metalico">Metálico</option>
                        <option value="nao-metalico">Não-Metálico</option>
                        <option value="energetico">Energético</option>
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Salvar
                    </button>
                    <button type="button" onclick="closeMinerioModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Clientes -->
    <div id="clienteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4" id="clienteModalTitle">Adicionar Cliente</h3>
            <form id="clienteForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label>
                    <input type="text" id="clienteEmpresa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                    <input type="text" id="clienteCnpj" placeholder="00.000.000/0000-00" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="text" id="clienteTelefone" placeholder="(00) 00000-0000" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bairro/Cidade</label>
                    <input type="text" id="clienteBairro" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Distância (km)</label>
                    <input type="number" step="0.1" id="clienteDistancia" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">🛣️ Número de Pedágios</label>
                    <input type="number" min="0" id="clientePedagios" placeholder="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <div class="text-xs text-gray-500 mt-1">Quantidade de pedágios até o cliente (ida e volta)</div>
                </div>
                
                <!-- Seção de Preços de Minério -->
                <div class="mb-6 border-t pt-4">
                    <h4 class="text-md font-medium text-gray-800 mb-3 flex items-center">
                        <span class="text-lg mr-2">💎</span>
                        Preços Específicos de Minério
                    </h4>
                    <div class="text-xs text-gray-500 mb-3">
                        Configure preços específicos para este cliente (opcional)
                    </div>
                    <div id="precosClienteContainer" class="space-y-3">
                        <!-- Os preços serão inseridos dinamicamente aqui -->
                    </div>
                    <button type="button" onclick="adicionarPrecoMinerio()" class="mt-2 text-sm bg-green-100 hover:bg-green-200 text-green-700 py-1 px-3 rounded-lg transition duration-200">
                        + Adicionar Preço
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Salvar
                    </button>
                    <button type="button" onclick="closeClienteModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Motoristas -->
    <div id="motoristaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4" id="motoristaModalTitle">Adicionar Motorista</h3>
            <form id="motoristaForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input type="text" id="motoristaNome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                    <input type="text" id="motoristaCpf" placeholder="000.000.000-00" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="text" id="motoristaTelefone" placeholder="(00) 00000-0000" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria CNH</label>
                    <select id="motoristaCnh" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="A">A - Motocicleta</option>
                        <option value="B">B - Carro</option>
                        <option value="C">C - Caminhão pequeno</option>
                        <option value="D">D - Ônibus</option>
                        <option value="E">E - Caminhão com reboque</option>
                        <option value="AB">AB - A + B</option>
                        <option value="AC">AC - A + C</option>
                        <option value="AD">AD - A + D</option>
                        <option value="AE">AE - A + E</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Vencimento CNH</label>
                    <input type="date" id="motoristaVencimentoCnh" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Vencimento Exame Toxicológico</label>
                    <input type="date" id="motoristaVencimentoToxicologico" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Salvar
                    </button>
                    <button type="button" onclick="closeMotoristaModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Veículos -->
    <div id="veiculoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4" id="veiculoModalTitle">Adicionar Veículo</h3>
            <form id="veiculoForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Placa</label>
                    <input type="text" id="veiculoPlaca" placeholder="ABC-1234" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                    <input type="text" id="veiculoModelo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tara (kg)</label>
                    <input type="number" id="veiculoTara" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">⛽ Consumo (km/litro)</label>
                    <input type="number" id="veiculoConsumo" step="0.1" min="0.1" placeholder="Ex: 3.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <div class="text-xs text-gray-500 mt-1">Quantos kilômetros o veículo faz com 1 litro de combustível</div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Motorista Vinculado</label>
                    <select id="veiculoMotorista" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Nenhum motorista</option>
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Salvar
                    </button>
                    <button type="button" onclick="closeVeiculoModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Configuração de Margem Global -->
    <div id="margemGlobalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gradient-to-br from-green-900 to-blue-900 rounded-xl p-8 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <span class="text-3xl mr-3">⚙️</span>
                    Parâmetros Globais de Margem
                </h3>
                <button onclick="closeMargemGlobalModal()" class="text-white hover:text-gray-300 text-2xl">✕</button>
            </div>
            
            <form id="margemGlobalForm">
                <div class="space-y-6">
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <div class="text-green-200 text-sm mb-4">Configure a margem de lucro padrão aplicada quando o cliente não tem preço específico:</div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-green-200 mb-2">Margem de Lucro Padrão (%)</label>
                            <input type="number" id="margemPadrao" step="0.1" min="0" max="500" 
                                   class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-green-400" 
                                   placeholder="Ex: 30.0">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-green-200 mb-2">Margem Mínima (%)</label>
                            <input type="number" id="margemMinima" step="0.1" min="0" max="100" 
                                   class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-green-400" 
                                   placeholder="Ex: 10.0">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-green-200 mb-2">Margem Máxima (%)</label>
                            <input type="number" id="margemMaxima" step="0.1" min="0" max="1000" 
                                   class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-green-400" 
                                   placeholder="Ex: 100.0">
                        </div>
                        
                        <div class="text-xs text-green-300 bg-green-800/30 p-3 rounded-lg">
                            <strong>💡 Exemplo:</strong><br>
                            • Margem Padrão 30% = Preço Final = Custo × 1.30<br>
                            • Custo R$ 100/m³ → Preço R$ 130/m³<br>
                            • Esta configuração se aplica apenas quando o cliente não tem preço específico
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg transition duration-200 font-medium">
                        💾 Salvar Configurações
                    </button>
                    <button type="button" onclick="closeMargemGlobalModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Orçamento -->
    <div id="orcamentoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-gradient-to-br from-blue-900 to-indigo-900 rounded-xl p-6 w-full max-w-2xl mx-auto my-4 max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-white flex items-center">
                    <span class="text-4xl mr-3">📄</span>
                    Gerar Orçamento
                </h3>
                <button onclick="closeOrcamentoModal()" class="text-white hover:text-gray-300 text-2xl">✕</button>
            </div>
            
            <form id="orcamentoForm" onsubmit="event.preventDefault(); gerarOrcamento();">
                <div class="space-y-6">
                    <!-- Cliente -->
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <label class="block text-white font-medium mb-2">💼 Cliente *</label>
                        <select id="orcamentoCliente" required class="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione o cliente...</option>
                        </select>
                    </div>
                    
                    <!-- Minério -->
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <label class="block text-white font-medium mb-2">⛰️ Minério *</label>
                        <select id="orcamentoMinerio" required class="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione o minério...</option>
                        </select>
                    </div>
                    
                    <!-- Quantidade -->
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <label class="block text-white font-medium mb-2">⚖️ Quantidade (toneladas) *</label>
                        <input type="number" id="orcamentoQuantidade" step="0.1" min="0.1" required 
                               class="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500"
                               placeholder="Digite a quantidade em toneladas">
                    </div>
                    
                    <!-- Observações -->
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <label class="block text-white font-medium mb-2">📝 Observações</label>
                        <textarea id="orcamentoObservacoes" rows="3" 
                                  class="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-blue-500"
                                  placeholder="Informações adicionais (opcional)"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" onclick="closeOrcamentoModal()" 
                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                        <span>💾</span>
                        <span>Gerar PDF</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Configuração de Valores -->
    <div id="configValoresModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-orange-900 to-red-900 rounded-xl p-6 w-full max-w-lg mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center">
                    <span class="text-3xl mr-3">⚙️</span>
                    Configuração de Valores
                </h3>
                <button onclick="closeConfigValoresModal()" class="text-white hover:text-gray-300 text-2xl">✕</button>
            </div>
            
            <form id="configValoresForm" onsubmit="event.preventDefault(); salvarConfigValores();">
                <div class="space-y-6">
                    <!-- Valor do Pedágio -->
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <label class="block text-white font-medium mb-2">🛣️ Valor Atual do Pedágio (R$)</label>
                        <input type="number" id="valorPedagio" step="0.01" min="0" 
                               class="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-orange-500"
                               placeholder="Ex: 12.50">
                        <div class="text-xs text-orange-200 mt-1">Valor por passagem no pedágio</div>
                    </div>
                    
                    <!-- Preço do Diesel -->
                    <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                        <label class="block text-white font-medium mb-2">⛽ Preço do Diesel (R$/litro)</label>
                        <input type="number" id="precoDiesel" step="0.01" min="0" 
                               class="w-full px-3 py-2 bg-white/90 border border-gray-300 rounded-lg text-black focus:ring-2 focus:ring-orange-500"
                               placeholder="Ex: 5.89">
                        <div class="text-xs text-orange-200 mt-1">Preço por litro do diesel</div>
                    </div>
                    
                    <!-- Informações Adicionais -->
                    <div class="bg-orange-800/30 rounded-lg p-3 border border-orange-500/50">
                        <div class="text-orange-200 text-sm">
                            <div class="flex items-center mb-2">
                                <span class="mr-2">📊</span>
                                <strong>Para que servem esses valores?</strong>
                            </div>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Cálculo automático de custos operacionais</li>
                                <li>Estimativas de despesas por entrega</li>
                                <li>Relatórios de margem de lucro</li>
                                <li>Análise de viabilidade de rotas</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeConfigValoresModal()" 
                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2">
                        <span>💾</span>
                        <span>Salvar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Vendas -->
    <div id="vendaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-gradient-to-br from-purple-900 to-pink-900 rounded-xl p-6 w-full max-w-6xl mx-auto my-4 max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-white flex items-center">
                    <span class="text-4xl mr-3">💎</span>
                    Nova Venda Premium
                </h3>
                <div class="flex items-center gap-3">
                    <button onclick="openMargemGlobalModal()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded-lg font-medium text-sm transition duration-200 flex items-center gap-2">
                        ⚙️ Margem Global
                    </button>
                    <button onclick="closeVendaModal()" class="text-white hover:text-gray-300 text-2xl">✕</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Formulário -->
                <div class="space-y-4">
                    <form id="vendaForm">
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Material</label>
                            <select id="vendaMaterial" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                                <option value="">⛏️ Selecione o material...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Cliente</label>
                            <select id="vendaCliente" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                                <option value="">👥 Selecione o cliente...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Veículo</label>
                            <select id="vendaVeiculo" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                                <option value="">🚚 Selecione o veículo...</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-purple-200 mb-1">Peso Pedreira (t)</label>
                                <input type="number" step="0.1" id="vendaPesoPedreira" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400" placeholder="Custo">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-purple-200 mb-1">Peso Cliente (t)</label>
                                <input type="number" step="0.1" id="vendaPesoCliente" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400" placeholder="Venda">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Preço para Cliente (R$/m³)</label>
                            <input type="number" step="0.01" id="vendaPrecoClienteM3" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400" placeholder="Preço por m³">
                            <div id="precoOrigemInfo" class="text-xs text-purple-200 mt-1 hidden">
                                <!-- Informação sobre a origem do preço será exibida aqui -->
                            </div>
                        </div>
                        
                        <div class="mb-3 bg-white/10 rounded-lg p-3 border border-white/20">
                            <div class="text-purple-200 text-xs mb-2">Valores Calculados:</div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between text-white">
                                    <span>Vol. Pedreira:</span>
                                    <span id="volumePedreiraCalc">0,00 m³</span>
                                </div>
                                <div class="flex justify-between text-white">
                                    <span>Vol. Cliente:</span>
                                    <span id="volumeClienteCalc">0,00 m³</span>
                                </div>
                                <div class="flex justify-between text-white">
                                    <span>Custo Total:</span>
                                    <span id="custoTotalCalc">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between text-white">
                                    <span>Valor Venda:</span>
                                    <span id="valorVendaCalc">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Forma de Pagamento</label>
                            <select id="vendaPagamento" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                                <option value="">💳 Selecione...</option>
                                <option value="pix">📱 PIX</option>
                                <option value="dinheiro">💵 Dinheiro</option>
                                <option value="cheque">📝 Cheque</option>
                                <option value="a_prazo">⏰ A Prazo</option>
                            </select>
                        </div>
                        
                        <div id="prazoDias" class="mb-3 hidden">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Prazo (dias)</label>
                            <input type="number" id="vendaPrazoDias" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">🛣️ Pedágios na Entrega</label>
                            <select id="vendaPedagios" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                                <option value="0">🙅 Não</option>
                                <option value="1">🛣️ 1 Pedágio</option>
                                <option value="2">🛣️ 2 Pedágios</option>
                                <option value="3">🛣️ 3 Pedágios</option>
                                <option value="4">🛣️ 4 Pedágios</option>
                            </select>
                            <div class="text-xs text-purple-200 mt-1">Selecione quantos pedágios foram pagos nesta entrega</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-purple-200 mb-1">📅 Data da Venda</label>
                            <input type="date" id="vendaData" required class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400">
                            <div class="text-xs text-purple-200 mt-1">Data em que a venda foi realizada (padrão: hoje)</div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-purple-200 mb-1">Observações</label>
                            <textarea id="vendaObservacoes" rows="2" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-black text-sm focus:ring-2 focus:ring-yellow-400"></textarea>
                        </div>
                    </form>
                </div>
                
                <!-- Preview da Venda -->
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <h4 class="text-lg font-bold text-white mb-3 flex items-center">
                        <span class="text-xl mr-2">📊</span>
                        Preview da Venda
                    </h4>
                    
                    <div id="vendaPreview" class="space-y-3">
                        <div class="bg-white/5 rounded-lg p-3">
                            <div class="text-purple-200 text-xs">Valor da Venda</div>
                            <div id="previewValorVenda" class="text-xl font-bold text-yellow-300">R$ 0,00</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white/5 rounded-lg p-3">
                                <div class="text-red-200 text-xs">Custo Material</div>
                                <div id="previewCustoMaterial" class="text-sm font-semibold text-red-300">R$ 0,00</div>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3">
                                <div class="text-purple-200 text-xs">Lucro Bruto</div>
                                <div id="previewLucroBruto" class="text-sm font-bold text-green-300">R$ 0,00</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white/5 rounded-lg p-3">
                                <div class="text-orange-200 text-xs">Custo Pedágios</div>
                                <div id="previewCustoPedagios" class="text-sm font-semibold text-orange-300">R$ 0,00</div>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3">
                                <div class="text-yellow-200 text-xs">Custo Diesel</div>
                                <div id="previewCustoDiesel" class="text-sm font-semibold text-yellow-300">R$ 0,00</div>
                            </div>
                        </div>
                        
                        <div class="bg-white/5 rounded-lg p-3">
                            <div class="text-blue-200 text-xs">Lucro Líquido (Bruto - Pedágios - Diesel)</div>
                            <div id="previewLucroLiquido" class="text-lg font-bold text-blue-300">R$ 0,00</div>
                        </div>
                        
                        <div class="bg-white/5 rounded-lg p-3">
                            <div class="text-purple-200 text-xs">Margem de Lucro</div>
                            <div id="previewMargem" class="text-lg font-bold text-blue-300">0%</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white/5 rounded-lg p-3">
                                <div class="text-purple-200 text-xs">Cliente</div>
                                <div id="previewCliente" class="text-sm text-white font-medium">-</div>
                            </div>
                            <div class="bg-white/5 rounded-lg p-3">
                                <div class="text-purple-200 text-xs">Veículo</div>
                                <div id="previewVeiculo" class="text-sm text-white font-medium">-</div>
                            </div>
                        </div>
                        
                        <div class="bg-white/5 rounded-lg p-3">
                            <div class="text-yellow-200 text-xs">Data da Venda</div>
                            <div id="previewDataVenda" class="text-sm text-white font-medium">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button type="submit" form="vendaForm" class="flex-1 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200">
                    🚀 Confirmar Venda
                </button>
                <button type="button" onclick="closeVendaModal()" class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 px-4 rounded-lg transition duration-200">
                    ❌ Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Estoque -->
    <div id="estoqueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4">Adicionar Crédito ao Estoque</h3>
            <form id="estoqueForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                    <input type="number" step="0.01" id="estoqueValor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="estoqueObservacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Adicionar
                    </button>
                    <button type="button" onclick="closeEstoqueModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Despesas -->
    <div id="despesaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4" id="despesaModalTitle">Adicionar Despesa</h3>
            <form id="despesaForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Despesa</label>
                    <select id="despesaTipo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="combustivel">🛢️ Combustível</option>
                        <option value="manutencao">🔧 Manutenção</option>
                        <option value="pecas">⚙️ Peças</option>
                        <option value="pneus">🛞 Pneus</option>
                        <option value="seguro">🛡️ Seguro</option>
                        <option value="ipva">📋 IPVA</option>
                        <option value="multa">🚨 Multa</option>
                        <option value="pedagio">💰 Pedágio</option>
                        <option value="lavagem">🧽 Lavagem</option>
                        <option value="estacionamento">🅿️ Estacionamento</option>
                        <option value="outros">📝 Outros</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Veículo (opcional)</label>
                    <select id="despesaVeiculo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Despesa geral</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                    <input type="number" step="0.01" id="despesaValor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="despesaObservacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Salvar
                    </button>
                    <button type="button" onclick="closeDespesaModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Cobranças -->
    <div id="cobrancaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4">Adicionar Pagamento</h3>
            <form id="cobrancaForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <select id="cobrancaCliente" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o cliente...</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Pago (R$)</label>
                    <input type="number" step="0.01" id="cobrancaValor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="cobrancaObservacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Processar Pagamento
                    </button>
                    <button type="button" onclick="closeCobrancaModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Alertas Críticos -->
    <div id="alertaCriticoModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[100]">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95" id="alertaCriticoContent">
            <!-- Conteúdo será inserido dinamicamente -->
        </div>
    </div>

    <!-- Modal para Configurar Alerta de Estoque -->
    <div id="estoqueAlertaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-90% mx-4">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <span class="text-xl mr-2">⚠️</span>
                Configurar Alerta de Estoque
            </h3>
            <form id="estoqueAlertaForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Mínimo de Estoque (R$)</label>
                    <input type="number" step="0.01" id="estoqueMinimo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                    <div class="text-xs text-gray-500 mt-1">
                        Valor atual: R$ <span id="estoqueAtualInfo">${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Alerta</label>
                    <select id="tipoAlerta" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                        <option value="critico">🔴 Crítico - Estoque muito baixo</option>
                        <option value="atencao" selected>🟡 Atenção - Reabastecer em breve</option>
                        <option value="informativo">🟢 Informativo - Apenas notificar</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="alertaObservacoes" rows="3" placeholder="Ex: Reabastecer antes do fim do mês..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"></textarea>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <div class="flex items-start">
                        <span class="text-yellow-600 mr-2">💡</span>
                        <div class="text-sm text-yellow-800">
                            <strong>Dica:</strong> Recomendamos manter o estoque acima de R$ 15.000 para operação normal.
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        💾 Salvar Configuração
                    </button>
                    <button type="button" onclick="closeEstoqueAlertaModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition duration-200">
                        ❌ Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tela de Login Segura -->
    <div id="secureLoginScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 99999;">
        <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 60px; margin-bottom: 15px;">🛡️</div>
                <h1 style="font-size: 28px; font-weight: bold; color: #1f2937; margin-bottom: 8px;">Rei da Caçambinha</h1>
                <p style="color: #6b7280;">Sistema de Gestão Seguro</p>
            </div>
            
            <div id="loginFormContainer">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        ✉️ Email
                    </label>
                    <input 
                        type="email" 
                        id="secureLoginEmail" 
                        placeholder="seu.email@exemplo.com"
                        style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 16px;"
                        onkeypress="if(event.key==='Enter') document.getElementById('secureLoginPassword').focus()"
                    />
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">
                        🔒 Senha
                    </label>
                    <input 
                        type="password" 
                        id="secureLoginPassword" 
                        placeholder="Digite sua senha"
                        style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 16px;"
                        onkeypress="if(event.key==='Enter') attemptSecureLogin()"
                    />
                </div>
                
                <button 
                    onclick="attemptSecureLogin()" 
                    id="secureLoginButton"
                    style="width: 100%; background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; font-weight: bold; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s;"
                    onmouseover="this.style.transform='scale(1.02)'"
                    onmouseout="this.style.transform='scale(1)'"
                >
                    ➡️ Entrar no Sistema
                </button>
                
                <div id="secureLoginError" style="display: none; margin-top: 20px; padding: 12px; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; color: #991b1b; font-size: 14px;">
                    <strong>❌ Erro:</strong>
                    <span id="secureLoginErrorMessage">Email ou senha incorretos!</span>
                </div>
                
                <div style="margin-top: 25px; padding: 15px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; font-size: 13px; color: #1e40af;">
                    <strong>🔒 Sistema Protegido</strong><br>
                    Este sistema utiliza Firebase Authentication para garantir segurança total dos seus dados.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SISTEMA DE LOGIN SEGURO =====
        
        // Função de login com Firebase Authentication
        async function attemptSecureLogin() {
            const email = document.getElementById('secureLoginEmail').value.trim();
            const password = document.getElementById('secureLoginPassword').value;
            const errorDiv = document.getElementById('secureLoginError');
            const errorMsg = document.getElementById('secureLoginErrorMessage');
            const loginButton = document.getElementById('secureLoginButton');
            
            // Validar campos
            if (!email || !password) {
                errorMsg.textContent = 'Por favor, preencha email e senha!';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Desabilitar botão
            loginButton.disabled = true;
            loginButton.innerHTML = '⏳ Entrando...';
            loginButton.style.opacity = '0.7';
            
            try {
                // Fazer login no Firebase
                const auth = window.firebaseAuth;
                const signIn = window.firebaseSignInWithEmailAndPassword;
                
                await signIn(auth, email, password);
                
                // Sucesso - a tela será ocultada pelo onAuthStateChanged
                console.log('✅ Login bem-sucedido!');
                
                // Ocultar tela de login com animação
                const loginScreen = document.getElementById('secureLoginScreen');
                loginScreen.style.transition = 'opacity 0.5s';
                loginScreen.style.opacity = '0';
                
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error('❌ Erro no login:', error);
                
                // Restaurar botão
                loginButton.disabled = false;
                loginButton.innerHTML = '➡️ Entrar no Sistema';
                loginButton.style.opacity = '1';
                
                // Mostrar erro amigável
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMsg.textContent = 'Usuário não encontrado!';
                        break;
                    case 'auth/wrong-password':
                        errorMsg.textContent = 'Senha incorreta!';
                        break;
                    case 'auth/invalid-email':
                        errorMsg.textContent = 'Email inválido!';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg.textContent = 'Muitas tentativas. Aguarde alguns minutos.';
                        break;
                    case 'auth/network-request-failed':
                        errorMsg.textContent = 'Erro de conexão. Verifique sua internet.';
                        break;
                    default:
                        errorMsg.textContent = 'Erro ao fazer login. Tente novamente.';
                }
                
                errorDiv.style.display = 'block';
                
                // Limpar senha
                document.getElementById('secureLoginPassword').value = '';
            }
        }
        
        // Função de logout
        window.secureLogout = async function() {
            if (confirm('🚪 Deseja realmente sair do sistema?')) {
                try {
                    const auth = window.firebaseAuth;
                    const signOutFunc = window.firebaseSignOut;
                    
                    await signOutFunc(auth);
                    
                    // Mostrar tela de login novamente
                    document.getElementById('secureLoginScreen').style.display = 'flex';
                    document.getElementById('secureLoginScreen').style.opacity = '1';
                    
                    // Limpar campos
                    document.getElementById('secureLoginEmail').value = '';
                    document.getElementById('secureLoginPassword').value = '';
                    document.getElementById('secureLoginError').style.display = 'none';
                    
                    console.log('🚪 Logout realizado');
                    
                } catch (error) {
                    console.error('❌ Erro no logout:', error);
                    alert('Erro ao fazer logout');
                }
            }
        };
        
        // ===== FIM DO SISTEMA DE LOGIN SEGURO =====
        
        // Tratamento global de erros
        window.addEventListener('error', function(event) {
            console.error('Erro global capturado:', event.error);
            // Não propagar erros de scripts externos (CORS)
            if (event.filename && event.filename.includes('http')) {
                event.preventDefault();
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Promise rejeitada não tratada:', event.reason);
            // Não mostrar erro na UI para promises rejeitadas
            event.preventDefault();
        });
        
        // Variáveis de controle do Firebase
        let firebaseConnected = false;
        let syncInProgress = false;
        let lastSyncTime = null;
        
        // Dados do sistema
        let sistemData = JSON.parse(localStorage.getItem('reiDaCacambinha')) || {
            vendas: [],
            clientes: [],
            minerios: [],
            motoristas: [],
            veiculos: [],
            estoque: { saldo: 0, movimentacoes: [] },
            despesas: [],
            cobrancas: [],
            configuracoes: {
                estoqueMinimo: 10000,
                tipoAlerta: 'atencao',
                alertaObservacoes: '',
                alertas: {
                    cnhVencimento: { ativo: true, diasAntecedencia: 30 },
                    toxicologicoVencimento: { ativo: true, diasAntecedencia: 30 },
                    chequeVencimento: { ativo: true, diasAntecedencia: 7 },
                    vendaVencida: { ativo: true, diasAntecedencia: 0 },
                    estoqueMinimo: { ativo: true, valor: 10000 },
                    vendasPendentes: { ativo: true, quantidade: 5 },
                    despesasAltas: { ativo: true, valor: 5000 },
                    clienteInadimplente: { ativo: true, diasAtraso: 15 }
                }
            },
            lastUpdated: new Date().toISOString(),
            syncStatus: 'local'
        };

        // Inicializar dados de exemplo se não existirem
        if (sistemData.minerios.length === 0) {
            sistemData.minerios = [
                { tipo: "Brita 5/8", densidade: 1.5, preco: 91.50, categoria: "nao-metalico" },
                { tipo: "Ferro", densidade: 7.8, preco: 3510.00, categoria: "metalico" }
            ];
        }

        if (sistemData.clientes.length === 0) {
            sistemData.clientes = [
                {
                    empresa: "Construtora ABC",
                    cnpj: "12.345.678/0001-90",
                    telefone: "(11) 99999-1234",
                    bairro: "Centro, São Paulo",
                    distancia: 15.5,
                    dataCadastro: new Date().toISOString(),
                    status: "ativo"
                }
            ];
        }

        if (sistemData.motoristas.length === 0) {
            sistemData.motoristas = [
                {
                    nome: "João Silva",
                    cpf: "123.456.789-00",
                    telefone: "(11) 99999-1234",
                    cnh: "E",
                    vencimentoCnh: "2026-07-02",
                    vencimentoToxicologico: "2026-07-02",
                    status: "ativo",
                    dataCadastro: new Date().toISOString()
                }
            ];
        }

        if (sistemData.veiculos.length === 0) {
            sistemData.veiculos = [
                {
                    placa: "ABC-1234",
                    modelo: "Volvo FH 540",
                    tara: 8500,
                    motoristaVinculado: "João Silva",
                    status: "disponivel",
                    dataCadastro: new Date().toISOString()
                }
            ];
        }

        // Seções do sistema
        const sections = {
            dashboard: function() {
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const inicioHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                
                // Filtros de período
                const periodo = document.getElementById('filtroPeriodoDashboard')?.value || '30';
                const dataLimite = new Date();
                dataLimite.setDate(dataLimite.getDate() - parseInt(periodo));
                
                // Cálculos com filtro de período
                const vendasPeriodo = sistemData.vendas.filter(v => new Date(v.data) >= dataLimite);
                const vendasMes = sistemData.vendas.filter(v => new Date(v.data) >= inicioMes);
                const vendasHoje = sistemData.vendas.filter(v => new Date(v.data) >= inicioHoje);
                const despesasPeriodo = sistemData.despesas.filter(d => new Date(d.data) >= dataLimite);
                
                const receitaPeriodo = vendasPeriodo.reduce((total, v) => total + v.valor, 0);
                const receitaMes = vendasMes.reduce((total, v) => total + v.valor, 0);
                const receitaHoje = vendasHoje.reduce((total, v) => total + v.valor, 0);
                const despesaPeriodo = despesasPeriodo.reduce((total, d) => total + d.valor, 0);
                const lucroPeriodo = receitaPeriodo - despesaPeriodo;
                const margemLucro = receitaPeriodo > 0 ? (lucroPeriodo / receitaPeriodo) * 100 : 0;
                
                // Pagamentos em aberto
                const pagamentosAberto = sistemData.vendas.filter(v => v.status !== 'Pago').length;
                const valorAberto = sistemData.vendas.filter(v => v.status !== 'Pago').reduce((total, v) => total + v.valor, 0);
                
                const estoqueToneladas = calcularEstoqueToneladas();
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">📊 Dashboard Executivo</h2>
                                <p class="text-blue-100 mt-2">Visão geral do desempenho da empresa</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-white">Período:</label>
                                    <select id="filtroPeriodoDashboard" class="px-3 py-1 rounded-lg border border-white/20 bg-white/10 text-white" onchange="showSection('dashboard')">
                                        <option value="7" ${periodo === '7' ? 'selected' : ''}>7 dias</option>
                                        <option value="30" ${periodo === '30' ? 'selected' : ''}>30 dias</option>
                                        <option value="60" ${periodo === '60' ? 'selected' : ''}>60 dias</option>
                                        <option value="90" ${periodo === '90' ? 'selected' : ''}>90 dias</option>
                                        <option value="365" ${periodo === '365' ? 'selected' : ''}>1 ano</option>
                                    </select>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-blue-100">Última atualização</div>
                                    <div class="font-semibold">${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botões de Atalho -->
                    <div class="mb-8">
                        <div class="flex items-center mb-4">
                            <div class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center text-white mr-3">🚀</div>
                            <h3 class="text-lg font-semibold text-gray-800">Ações Rápidas</h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Botão Nova Venda -->
                            <button class="quick-action-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700" onclick="showSection('vendas'); setTimeout(() => openVendaModal(), 100);">
                                <div class="flex flex-col items-center space-y-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-white">Nova Venda</span>
                                </div>
                            </button>
                            
                            <!-- Botão Orçamento -->
                            <button class="quick-action-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700" onclick="showOrcamentoModal()">
                                <div class="flex flex-col items-center space-y-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 002 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-white">Orçamento</span>
                                </div>
                            </button>
                            
                            <!-- Botão Nova Despesa -->
                            <button class="quick-action-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700" onclick="showSection('despesas'); setTimeout(() => openDespesaModal(), 100);">
                                <div class="flex flex-col items-center space-y-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-white">Nova Despesa</span>
                                </div>
                            </button>
                            
                            <!-- Botão Pagamentos -->
                            <button class="quick-action-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700" onclick="showSection('pagamentos'); setTimeout(() => openCobrancaModal(), 100);">
                                <div class="flex flex-col items-center space-y-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 0h10a2 2 0 002-2v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-white">Registrar Pagamento</span>
                                </div>
                            </button>
                            
                            <!-- Botão Estoque -->
                            <button class="quick-action-btn bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700" onclick="showSection('estoque')">
                                <div class="flex flex-col items-center space-y-2">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                    <span class="text-sm font-medium text-white">Estoque</span>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas Principais -->  
                    <div class="mb-8">
                        <div class="flex items-center mb-6">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-yellow-400 rounded-lg flex items-center justify-center text-white mr-3">💹</div>
                            <h3 class="text-2xl font-bold text-gray-800">Métricas do Período (${periodo} dias)</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        💰
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-green-600">PERÍODO</div>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Vendas Período</h4>
                                <p class="text-3xl font-bold text-gray-900">R$ ${receitaPeriodo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <div class="mt-3 flex items-center text-sm text-green-600">
                                    <span class="mr-1">📊</span>
                                    ${vendasPeriodo.length} transações
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        📅
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-blue-600">MÊS</div>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Vendas do Mês</h4>
                                <p class="text-3xl font-bold text-gray-900">R$ ${receitaMes.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <div class="mt-3 flex items-center text-sm text-blue-600">
                                    <span class="mr-1">📈</span>
                                    ${vendasMes.length} vendas
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center text-white text-xl">
                                        ☀️
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-yellow-600">HOJE</div>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Vendas de Hoje</h4>
                                <p class="text-3xl font-bold text-gray-900">R$ ${receitaHoje.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <div class="mt-3 flex items-center text-sm text-yellow-600">
                                    <span class="mr-1">⭐</span>
                                    ${vendasHoje.length} vendas
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        ⏳
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold ${pagamentosAberto > 0 ? 'text-red-600' : 'text-green-600'}">${pagamentosAberto > 0 ? 'PENDENTE' : 'OK'}</div>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Pagamentos Aberto</h4>
                                <p class="text-3xl font-bold ${pagamentosAberto > 0 ? 'text-red-600' : 'text-green-600'}">${pagamentosAberto}</p>
                                <div class="mt-3 flex items-center text-sm ${pagamentosAberto > 0 ? 'text-red-600' : 'text-green-600'}">
                                    <span class="mr-1">${pagamentosAberto > 0 ? '⚠️' : '✅'}</span>
                                    R$ ${valorAberto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        ${lucroPeriodo >= 0 ? '📈' : '📉'}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold ${lucroPeriodo >= 0 ? 'text-green-600' : 'text-red-600'}">${margemLucro.toFixed(1)}%</div>
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Lucro Período</h4>
                                <p class="text-3xl font-bold ${lucroPeriodo >= 0 ? 'text-green-600' : 'text-red-600'}">R$ ${lucroPeriodo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                <div class="mt-3 flex items-center text-sm ${lucroPeriodo >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    <span class="mr-1">${lucroPeriodo >= 0 ? '✅' : '⚠️'}</span>
                                    ${lucroPeriodo >= 0 ? 'Rentável' : 'Prejuízo'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div class="mb-8">
                        <div class="flex items-center mb-6">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center text-white mr-3">📈</div>
                            <h3 class="text-2xl font-bold text-gray-800">Análise Gráfica</h3>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                                    <span class="mr-2">📊</span>
                                    Vendas vs Despesas (${periodo} dias)
                                </h4>
                                <div class="h-64" id="vendas-despesas-chart"></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h4 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                                    <span class="mr-2">⛏️</span>
                                    Vendas por Material (${periodo} dias)
                                </h4>
                                <div class="h-64" id="vendas-material-chart"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumo Operacional -->
                    <div class="mb-8">
                        <div class="flex items-center mb-6">
                            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-blue-500 rounded-lg flex items-center justify-center text-white mr-3">🚛</div>
                            <h3 class="text-2xl font-bold text-gray-800">Resumo Operacional</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        🧾
                                    </div>
                                    <div class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">
                                        TOTAL
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Vendas Total</h4>
                                <p class="text-3xl font-bold text-gray-900">${sistemData.vendas.length}</p>
                                <div class="mt-3 flex items-center text-sm text-blue-600">
                                    <span class="mr-1">📊</span>
                                    Transações registradas
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        👥
                                    </div>
                                    <div class="px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
                                        ATIVOS
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Clientes</h4>
                                <p class="text-3xl font-bold text-gray-900">${sistemData.clientes.length}</p>
                                <div class="mt-3 flex items-center text-sm text-green-600">
                                    <span class="mr-1">🏢</span>
                                    Empresas cadastradas
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center text-white text-xl">
                                        👨‍✈️
                                    </div>
                                    <div class="px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full">
                                        EQUIPE
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Motoristas</h4>
                                <p class="text-3xl font-bold text-gray-900">${sistemData.motoristas.length}</p>
                                <div class="mt-3 flex items-center text-sm text-orange-600">
                                    <span class="mr-1">🚗</span>
                                    Profissionais habilitados
                                </div>
                            </div>
                            
                            <div class="metric-card p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-600 to-teal-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        🚚
                                    </div>
                                    <div class="px-3 py-1 bg-teal-100 text-teal-700 text-xs font-semibold rounded-full">
                                        FROTA
                                    </div>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-1">Veículos</h4>
                                <p class="text-3xl font-bold text-gray-900">${sistemData.veiculos.length}</p>
                                <div class="mt-3 flex items-center text-sm text-teal-600">
                                    <span class="mr-1">🔧</span>
                                    Unidades operacionais
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estoque -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">📦</span>
                            Controle de Estoque
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold">Estoque Total (R$)</h4>
                                        <p class="text-3xl font-bold">R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                        <p class="text-sm opacity-90 mt-1">${sistemData.estoque.saldo >= 10000 ? '✅ Saldo adequado' : '⚠️ Saldo baixo'}</p>
                                    </div>
                                    <span class="text-4xl">💰</span>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold">Estoque Brita 5/8 (aprox.)</h4>
                                        <p class="text-3xl font-bold">${estoqueToneladas.toFixed(1)} t</p>
                                        <p class="text-sm opacity-90 mt-1">Baseado em R$ 91,50/t</p>
                                    </div>
                                    <span class="text-4xl">⛏️</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vendas Recentes e Alertas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <span class="text-xl mr-2">🕒</span>
                                Vendas Recentes
                            </h3>
                            <div class="space-y-2">
                                ${getVendasRecentes()}
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <span class="text-xl mr-2">⚠️</span>
                                Alertas e Status
                            </h3>
                            <div class="space-y-3">
                                ${getAlertas()}
                            </div>
                        </div>
                    </div>
                </div>`;
            },

            minerios: function() {
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">⛏️ Gestão de Minérios</h2>
                                <p class="text-blue-100 mt-2">Cadastro e controle de materiais e preços</p>
                            </div>
                            <button onclick="openMinerioModal()" class="btn-secondary flex items-center gap-2">
                                <span>➕</span> Novo Minério
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas dos Minérios -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    ⛏️
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Minérios</h4>
                            <p class="text-3xl font-bold text-gray-900">${sistemData.minerios.length}</p>
                            <div class="mt-3 flex items-center text-sm text-yellow-600">
                                <span class="mr-1">📋</span>
                                Tipos cadastrados
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    💰
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Preço Médio</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${sistemData.minerios.length > 0 ? (sistemData.minerios.reduce((sum, m) => sum + m.preco, 0) / sistemData.minerios.length).toFixed(0) : '0'}</p>
                            <div class="mt-3 flex items-center text-sm text-green-600">
                                <span class="mr-1">📊</span>
                                Por m³
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🏭
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Metálicos</h4>
                            <p class="text-3xl font-bold text-gray-900">${sistemData.minerios.filter(m => m.categoria === 'metalico').length}</p>
                            <div class="mt-3 flex items-center text-sm text-blue-600">
                                <span class="mr-1">⚙️</span>
                                Materiais industriais
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🏗️
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Não-Metálicos</h4>
                            <p class="text-3xl font-bold text-gray-900">${sistemData.minerios.filter(m => m.categoria === 'nao-metalico').length}</p>
                            <div class="mt-3 flex items-center text-sm text-purple-600">
                                <span class="mr-1">🧱</span>
                                Construção civil
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-modern">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-4 text-left text-white font-semibold">MATERIAL</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">DENSIDADE</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CUSTO/T</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CUSTO/M³</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CATEGORIA</th>
                                    <th class="px-6 py-4 text-center text-white font-semibold">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getMineriosTable()}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            clientes: function() {
                const clientesPorRegiao = {
                    total: sistemData.clientes.length,
                    distanciaMedia: sistemData.clientes.length > 0 ? 
                        (sistemData.clientes.reduce((sum, c) => sum + c.distancia, 0) / sistemData.clientes.length).toFixed(1) : 0,
                    maisProximo: sistemData.clientes.length > 0 ? 
                        Math.min(...sistemData.clientes.map(c => c.distancia)) : 0,
                    maisDistante: sistemData.clientes.length > 0 ? 
                        Math.max(...sistemData.clientes.map(c => c.distancia)) : 0
                };
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">👥 Gestão de Clientes</h2>
                                <p class="text-blue-100 mt-2">Cadastro e controle de empresas parceiras</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="atualizarTodosPrecosClientes()" class="btn-primary flex items-center gap-2 text-sm">
                                    <span>🔄</span> Atualizar Preços
                                </button>
                                <button onclick="openClienteModal()" class="btn-secondary flex items-center gap-2">
                                    <span>➕</span> Novo Cliente
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métricas dos Clientes -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    👥
                                </div>
                                <div class="px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
                                    ATIVO
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Clientes</h4>
                            <p class="text-3xl font-bold text-gray-900">${clientesPorRegiao.total}</p>
                            <div class="mt-3 flex items-center text-sm text-green-600">
                                <span class="mr-1">🏢</span>
                                Empresas parceiras
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    📍
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Distância Média</h4>
                            <p class="text-3xl font-bold text-gray-900">${clientesPorRegiao.distanciaMedia} km</p>
                            <div class="mt-3 flex items-center text-sm text-blue-600">
                                <span class="mr-1">🚚</span>
                                Raio de atendimento
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center text-white text-xl">
                                    🎯
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Mais Próximo</h4>
                            <p class="text-3xl font-bold text-gray-900">${clientesPorRegiao.maisProximo} km</p>
                            <div class="mt-3 flex items-center text-sm text-emerald-600">
                                <span class="mr-1">⚡</span>
                                Entrega rápida
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🗺️
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Mais Distante</h4>
                            <p class="text-3xl font-bold text-gray-900">${clientesPorRegiao.maisDistante} km</p>
                            <div class="mt-3 flex items-center text-sm text-orange-600">
                                <span class="mr-1">🛣️</span>
                                Maior alcance
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-modern">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-4 text-left text-white font-semibold">EMPRESA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CNPJ</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CONTATO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">LOCALIZAÇÃO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">DISTÂNCIA</th>
                                    <th class="px-6 py-4 text-center text-white font-semibold">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getClientesTable()}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            vendas: function() {
                return `<div class="bg-gradient-to-br from-purple-900 via-pink-800 to-rose-900 rounded-xl shadow-2xl p-8 text-white">
                    <!-- Header Moderno -->
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-white to-purple-200 bg-clip-text text-transparent flex items-center">
                                <span class="text-5xl mr-4">💎</span>
                                Vendas Premium
                            </h2>
                            <p class="text-purple-200 mt-2 text-lg">Centro de controle de vendas avançado</p>
                        </div>
                        <button onclick="openVendaModal()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-gray-900 font-bold px-6 py-3 rounded-xl flex items-center gap-3 shadow-lg transform hover:scale-105 transition-all duration-200">
                            <span class="text-xl">🚀</span> Nova Venda
                        </button>
                    </div>
                    
                    <!-- Filtros Avançados -->
                    <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="relative">
                            <input type="text" id="vendaSearch" placeholder="🔍 Buscar cliente, material..." class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-purple-200 focus:ring-2 focus:ring-yellow-400 focus:border-transparent backdrop-blur-sm">
                        </div>
                        <select id="vendaFilterPagamento" class="px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-yellow-400 focus:border-transparent backdrop-blur-sm">
                            <option value="">💳 Todas as formas</option>
                            <option value="pix">📱 PIX</option>
                            <option value="dinheiro">💵 Dinheiro</option>
                            <option value="cheque">📝 Cheque</option>
                            <option value="a_prazo">⏰ A Prazo</option>
                        </select>
                        <select id="vendaFilterPeriodo" class="px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:ring-2 focus:ring-yellow-400 focus:border-transparent backdrop-blur-sm">
                            <option value="">📅 Todos os períodos</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                            <option value="ano">Este ano</option>
                        </select>
                    </div>
                    
                    <!-- Métricas de Performance -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                            <div class="text-center">
                                <div class="text-2xl mb-2">🎯</div>
                                <div class="text-2xl font-bold">${sistemData.vendas.length}</div>
                                <div class="text-sm text-purple-200">Total Vendas</div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                            <div class="text-center">
                                <div class="text-2xl mb-2">💰</div>
                                <div class="text-xl font-bold">R$ ${getTotalReceita().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                <div class="text-sm text-purple-200">Receita Total</div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                            <div class="text-center">
                                <div class="text-2xl mb-2">📊</div>
                                <div class="text-xl font-bold">R$ ${getTicketMedio().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                <div class="text-sm text-purple-200">Ticket Médio</div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                            <div class="text-center">
                                <div class="text-2xl mb-2">⚖️</div>
                                <div class="text-xl font-bold">${getTotalQuantidade().toFixed(1)} t</div>
                                <div class="text-sm text-purple-200">Peso Total</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela Premium -->
                    <div class="bg-white/5 backdrop-blur-sm rounded-xl border border-white/20 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-white/10 backdrop-blur-sm">
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Data</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Cliente</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Material</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Qtd</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Valor</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">L/KM</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Pagto</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold text-white border-b border-white/20">Status</th>
                                        <th class="px-6 py-4 text-center text-sm font-semibold text-white border-b border-white/20">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="vendasTableBody">
                                    ${getVendasTablePremium()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            },

            veiculos: function() {
                const veiculosPorStatus = {
                    total: sistemData.veiculos.length,
                    disponivel: sistemData.veiculos.filter(v => v.status === 'disponivel').length,
                    emUso: sistemData.veiculos.filter(v => v.status === 'em_uso').length,
                    comMotorista: sistemData.veiculos.filter(v => v.motoristaVinculado).length
                };
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">🚚 Gestão de Veículos</h2>
                                <p class="text-blue-100 mt-2">Controle da frota e manutenção</p>
                            </div>
                            <button onclick="openVeiculoModal()" class="btn-secondary flex items-center gap-2">
                                <span>➕</span> Novo Veículo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas dos Veículos -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-600 to-teal-600 rounded-xl flex items-center justify-center text-white text-xl">
                                    🚚
                                </div>
                                <div class="px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
                                    FROTA
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Veículos</h4>
                            <p class="text-3xl font-bold text-gray-900">${veiculosPorStatus.total}</p>
                            <div class="mt-3 flex items-center text-sm text-green-600">
                                <span class="mr-1">🔧</span>
                                Unidades da frota
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center text-white text-xl">
                                    ✅
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Disponíveis</h4>
                            <p class="text-3xl font-bold text-gray-900">${veiculosPorStatus.disponivel}</p>
                            <div class="mt-3 flex items-center text-sm text-emerald-600">
                                <span class="mr-1">🟢</span>
                                Prontos para uso
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🚛
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Em Operação</h4>
                            <p class="text-3xl font-bold text-gray-900">${veiculosPorStatus.emUso}</p>
                            <div class="mt-3 flex items-center text-sm text-blue-600">
                                <span class="mr-1">🔄</span>
                                Atualmente trabalhando
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    👨‍✈️
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Com Motorista</h4>
                            <p class="text-3xl font-bold text-gray-900">${veiculosPorStatus.comMotorista}</p>
                            <div class="mt-3 flex items-center text-sm text-purple-600">
                                <span class="mr-1">🤝</span>
                                Motoristas vinculados
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-modern">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-4 text-left text-white font-semibold">VEÍCULO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">MODELO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">TARA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CONSUMO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">MOTORISTA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">STATUS</th>
                                    <th class="px-6 py-4 text-center text-white font-semibold">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getVeiculosTable()}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            motoristas: function() {
                const motoristasPorStatus = {
                    ativo: sistemData.motoristas.filter(m => m.status === 'ativo').length,
                    cnhA: sistemData.motoristas.filter(m => m.cnh.includes('A')).length,
                    cnhDE: sistemData.motoristas.filter(m => m.cnh.includes('D') || m.cnh.includes('E')).length
                };
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">👨‍✈️ Gestão de Motoristas</h2>
                                <p class="text-blue-100 mt-2">Cadastro e controle da equipe de motoristas</p>
                            </div>
                            <button onclick="openMotoristaModal()" class="btn-secondary flex items-center gap-2">
                                <span>➕</span> Novo Motorista
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas dos Motoristas -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    👨‍✈️
                                </div>
                                <div class="px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
                                    ATIVOS
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Motoristas</h4>
                            <p class="text-3xl font-bold text-gray-900">${sistemData.motoristas.length}</p>
                            <div class="mt-3 flex items-center text-sm text-orange-600">
                                <span class="mr-1">🚗</span>
                                Profissionais cadastrados
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    ✅
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Ativos</h4>
                            <p class="text-3xl font-bold text-gray-900">${motoristasPorStatus.ativo}</p>
                            <div class="mt-3 flex items-center text-sm text-green-600">
                                <span class="mr-1">👍</span>
                                Disponíveis para trabalho
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🏍️
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Com CNH A</h4>
                            <p class="text-3xl font-bold text-gray-900">${motoristasPorStatus.cnhA}</p>
                            <div class="mt-3 flex items-center text-sm text-purple-600">
                                <span class="mr-1">🛵</span>
                                Motocicletas
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🚚
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Com CNH D/E</h4>
                            <p class="text-3xl font-bold text-gray-900">${motoristasPorStatus.cnhDE}</p>
                            <div class="mt-3 flex items-center text-sm text-red-600">
                                <span class="mr-1">🚛</span>
                                Caminhões e ônibus
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-modern">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-4 text-left text-white font-semibold">MOTORISTA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CPF</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">TELEFONE</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CNH</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">VENCIMENTO CNH</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">TOXICOLÓGICO</th>
                                    <th class="px-6 py-4 text-center text-white font-semibold">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getMotoristasTable()}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            estoque: function() {
                const giroEstoque = sistemData.estoque.saldo > 0 ? 
                    (getTotalDebitos() / sistemData.estoque.saldo * 100).toFixed(1) : 0;
                const movimentacaoMedia = sistemData.estoque.movimentacoes.length > 0 ?
                    (sistemData.estoque.movimentacoes.reduce((sum, m) => sum + m.valor, 0) / sistemData.estoque.movimentacoes.length).toFixed(0) : 0;
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">📦 Controle de Estoque</h2>
                                <p class="text-blue-100 mt-2">Gestão financeira baseada em valor monetário</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="openEstoqueModal()" class="btn-secondary flex items-center gap-2">
                                    <span>💰</span> Adicionar Crédito
                                </button>
                                <button onclick="openEstoqueAlertaModal()" class="btn-primary flex items-center gap-2">
                                    <span>⚠️</span> Config. Alerta
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métricas do Estoque -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    💰
                                </div>
                                <div class="px-3 py-1 ${sistemData.estoque.saldo >= (sistemData.configuracoes.estoqueMinimo || 10000) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} text-xs font-semibold rounded-full">
                                    ${sistemData.estoque.saldo >= (sistemData.configuracoes.estoqueMinimo || 10000) ? 'ADEQUADO' : 'BAIXO'}
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Saldo Atual</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm ${sistemData.estoque.saldo >= (sistemData.configuracoes.estoqueMinimo || 10000) ? 'text-green-600' : 'text-red-600'}">
                                <span class="mr-1">${sistemData.estoque.saldo >= (sistemData.configuracoes.estoqueMinimo || 10000) ? '✅' : '⚠️'}</span>
                                ${sistemData.estoque.saldo >= (sistemData.configuracoes.estoqueMinimo || 10000) ? 'Saldo adequado' : 'Abaixo do mínimo configurado'}
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    📈
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Créditos</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getTotalCreditos().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-green-600">
                                <span class="mr-1">💵</span>
                                Entradas no estoque
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    📉
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Débitos</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getTotalDebitos().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-red-600">
                                <span class="mr-1">🛒</span>
                                Saídas por vendas
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🔄
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Giro do Estoque</h4>
                            <p class="text-3xl font-bold text-gray-900">${giroEstoque}%</p>
                            <div class="mt-3 flex items-center text-sm text-purple-600">
                                <span class="mr-1">📊</span>
                                Rotatividade do capital
                            </div>
                        </div>
                    </div>
                    
                    <!-- Histórico Moderno -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <span class="w-8 h-8 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-lg flex items-center justify-center text-white mr-3">📋</span>
                                    Histórico de Movimentações
                                </h3>
                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                                        Créditos
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                                        Débitos
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-modern !rounded-none">
                            <table class="w-full">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-4 text-left text-white font-semibold">DATA</th>
                                        <th class="px-6 py-4 text-left text-white font-semibold">TIPO</th>
                                        <th class="px-6 py-4 text-left text-white font-semibold">VALOR</th>
                                        <th class="px-6 py-4 text-left text-white font-semibold">SALDO ANTERIOR</th>
                                        <th class="px-6 py-4 text-left text-white font-semibold">SALDO NOVO</th>
                                        <th class="px-6 py-4 text-left text-white font-semibold">OBSERVAÇÕES</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${getEstoqueMovimentacoes()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            },

            despesas: function() {
                const despesasPorCategoria = {
                    operacional: getDespesasPorCategoria(['combustivel', 'pedagio', 'lavagem', 'estacionamento']),
                    manutencao: getDespesasPorCategoria(['manutencao', 'pecas', 'pneus']),
                    administrativa: getDespesasPorCategoria(['seguro', 'ipva']),
                    outros: getDespesasPorCategoria(['multa', 'outros'])
                };
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">💸 Gestão de Despesas</h2>
                                <p class="text-blue-100 mt-2">Controle completo de gastos operacionais</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="openDespesaModal()" class="btn-secondary flex items-center gap-2">
                                    <span>➕</span> Nova Despesa
                                </button>
                                <button onclick="openConfigValoresModal()" class="btn-secondary flex items-center gap-2 bg-orange-600 hover:bg-orange-700">
                                    <span>⚙️</span> Config Valores
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métricas das Despesas -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    💸
                                </div>
                                <div class="px-3 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">
                                    TOTAL
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Total Despesas</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getTotalDespesas().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-red-600">
                                <span class="mr-1">📊</span>
                                Gastos acumulados
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    📅
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Este Mês</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getDespesasMes().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-orange-600">
                                <span class="mr-1">📈</span>
                                Período atual
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    ⛽
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Combustível</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getDespesasPorTipo('combustivel').toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-yellow-600">
                                <span class="mr-1">🛢️</span>
                                Maior custo operacional
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🔧
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Manutenção</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getDespesasPorTipo('manutencao').toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-purple-600">
                                <span class="mr-1">⚙️</span>
                                Conservação da frota
                            </div>
                        </div>
                    </div>
                    
                    <!-- Valores Configurados -->
                    <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl p-6 mb-8 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold flex items-center">
                                <span class="mr-3">⚙️</span>
                                Valores de Referência
                            </h3>
                            <button onclick="openConfigValoresModal()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors">
                                ✏️ Editar
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                                <div class="flex items-center mb-2">
                                    <span class="text-2xl mr-3">🛣️</span>
                                    <div>
                                        <h4 class="font-semibold">Pedágio</h4>
                                        <p class="text-sm opacity-90">Valor por passagem</p>
                                    </div>
                                </div>
                                <p class="text-2xl font-bold">
                                    ${sistemData.configuracoes?.valores?.pedagio ? 
                                        `R$ ${sistemData.configuracoes.valores.pedagio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                                        'Não configurado'}
                                </p>
                                ${sistemData.configuracoes?.valores?.dataAtualizacao ? 
                                    `<p class="text-xs opacity-75 mt-1">Última atualização: ${new Date(sistemData.configuracoes.valores.dataAtualizacao).toLocaleDateString('pt-BR')}</p>` : 
                                    ''}
                            </div>
                            
                            <div class="bg-white/10 rounded-lg p-4 border border-white/20">
                                <div class="flex items-center mb-2">
                                    <span class="text-2xl mr-3">⛽</span>
                                    <div>
                                        <h4 class="font-semibold">Diesel</h4>
                                        <p class="text-sm opacity-90">Preço por litro</p>
                                    </div>
                                </div>
                                <p class="text-2xl font-bold">
                                    ${sistemData.configuracoes?.valores?.diesel ? 
                                        `R$ ${sistemData.configuracoes.valores.diesel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                                        'Não configurado'}
                                </p>
                                ${sistemData.configuracoes?.valores?.dataAtualizacao ? 
                                    `<p class="text-xs opacity-75 mt-1">Última atualização: ${new Date(sistemData.configuracoes.valores.dataAtualizacao).toLocaleDateString('pt-BR')}</p>` : 
                                    ''}
                            </div>
                        </div>
                        
                        ${!sistemData.configuracoes?.valores?.pedagio || !sistemData.configuracoes?.valores?.diesel ? 
                            `<div class="mt-4 p-3 bg-yellow-500/20 rounded-lg border border-yellow-400/30">
                                <div class="flex items-center text-yellow-100">
                                    <span class="mr-2">⚠️</span>
                                    <span class="text-sm">Configure os valores para obter cálculos mais precisos de custos operacionais.</span>
                                </div>
                            </div>` : 
                            ''}
                    </div>
                    
                    <!-- Distribuição por Categoria -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white rounded-xl p-4 border border-yellow-200">
                            <h4 class="font-semibold text-yellow-800 mb-2">🚛 Operacional</h4>
                            <p class="text-2xl font-bold text-yellow-600">R$ ${despesasPorCategoria.operacional.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 border border-purple-200">
                            <h4 class="font-semibold text-purple-800 mb-2">🔧 Manutenção</h4>
                            <p class="text-2xl font-bold text-purple-600">R$ ${despesasPorCategoria.manutencao.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">📋 Administrativa</h4>
                            <p class="text-2xl font-bold text-blue-600">R$ ${despesasPorCategoria.administrativa.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 border border-gray-200">
                            <h4 class="font-semibold text-gray-800 mb-2">📝 Outros</h4>
                            <p class="text-2xl font-bold text-gray-600">R$ ${despesasPorCategoria.outros.toLocaleString('pt-BR')}</p>
                        </div>
                    </div>
                    
                    <div class="table-modern">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-4 text-left text-white font-semibold">DATA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CATEGORIA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">VEÍCULO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">VALOR</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">OBSERVAÇÕES</th>
                                    <th class="px-6 py-4 text-center text-white font-semibold">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getDespesasTable()}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            financeiro: function() {
                return `<div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <span class="text-3xl mr-3">💳</span>
                            Central Financeira
                        </h2>
                        <div class="flex gap-2">
                            <select id="filtroPeriodo" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30" selected>Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="365">Último ano</option>
                            </select>
                            <button onclick="atualizarFinanceiro()" class="bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-4 py-2 rounded-lg">
                                🔄 Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <div id="financeiroContent">
                        ${getFinanceiroContent()}
                    </div>
                </div>`;
            },

            cobranca: function() {
                const taxaInadimplencia = sistemData.vendas.length > 0 ? 
                    ((getQuantidadeAtrasado() / sistemData.vendas.filter(v => v.tipoPagamento === 'a_prazo').length) * 100).toFixed(1) : 0;
                const tempoMedioRecebimento = 15; // Placeholder - seria calculado baseado nos pagamentos
                
                return `<div class="p-6">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold">📋 Gestão de Cobranças</h2>
                                <p class="text-blue-100 mt-2">Controle de recebimentos e pendências financeiras</p>
                            </div>
                            <button onclick="openCobrancaModal()" class="btn-secondary flex items-center gap-2">
                                <span>💰</span> Registrar Pagamento
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas de Cobrança -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    ⏰
                                </div>
                                <div class="px-3 py-1 ${getQuantidadePendente() > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} text-xs font-semibold rounded-full">
                                    ${getQuantidadePendente() > 0 ? 'PENDENTE' : 'OK'}
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">A Receber</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getTotalPendente().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-red-600">
                                <span class="mr-1">📊</span>
                                ${getQuantidadePendente()} vendas pendentes
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    ✅
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Recebido</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getTotalRecebido().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-green-600">
                                <span class="mr-1">📈</span>
                                Neste mês
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    🚨
                                </div>
                                <div class="px-3 py-1 ${getQuantidadeAtrasado() > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} text-xs font-semibold rounded-full">
                                    ${getQuantidadeAtrasado() > 0 ? 'AÇÃO' : 'OK'}
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Em Atraso</h4>
                            <p class="text-3xl font-bold text-gray-900">R$ ${getTotalAtrasado().toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                            <div class="mt-3 flex items-center text-sm text-orange-600">
                                <span class="mr-1">⚠️</span>
                                ${getQuantidadeAtrasado()} vendas atrasadas
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    📊
                                </div>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-700 mb-1">Inadimplência</h4>
                            <p class="text-3xl font-bold text-gray-900">${taxaInadimplencia}%</p>
                            <div class="mt-3 flex items-center text-sm text-purple-600">
                                <span class="mr-1">📈</span>
                                Taxa atual
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-green-800">💚 Em Dia</h4>
                                    <p class="text-2xl font-bold text-green-600">${sistemData.vendas.filter(v => v.pago).length}</p>
                                </div>
                                <div class="text-3xl">✅</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border border-yellow-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-yellow-800">⏳ A Vencer</h4>
                                    <p class="text-2xl font-bold text-yellow-600">${getQuantidadeAVencer()}</p>
                                </div>
                                <div class="text-3xl">⏰</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-red-100 to-pink-100 border border-red-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-semibold text-red-800">⚠️ Vencidas</h4>
                                    <p class="text-2xl font-bold text-red-600">${getQuantidadeAtrasado()}</p>
                                </div>
                                <div class="text-3xl">🚨</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-modern">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-4 text-left text-white font-semibold">CLIENTE</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">DATA VENDA</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">VENCIMENTO</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">VALOR</th>
                                    <th class="px-6 py-4 text-left text-white font-semibold">STATUS</th>
                                    <th class="px-6 py-4 text-center text-white font-semibold">AÇÕES</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${getCobrancasTable()}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            },

            relatorios: function() {
                return `<div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="text-3xl mr-3">📈</span>
                        Relatórios Gerenciais
                    </h2>
                    
                    <!-- Filtro de Período com Calendário -->
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <span class="text-xl mr-2">📅</span>
                            Filtro de Período
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Seletor de Tipo de Período -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Período:</label>
                                <select id="tipoPeridoRelatorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="toggleCalendarioRelatorio()">
                                    <option value="todos">📈 Todos os períodos</option>
                                    <option value="hoje">📅 Hoje</option>
                                    <option value="semana">📊 Esta semana</option>
                                    <option value="mes">📆 Este mês</option>
                                    <option value="trimestre">📋 Este trimestre</option>
                                    <option value="ano">📄 Este ano</option>
                                    <option value="calendario">🗓️ Selecionar período</option>
                                </select>
                            </div>
                            
                            <!-- Seletor de Calendário -->
                            <div id="calendarioContainer" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Período Personalizado:</label>
                                <input type="text" id="calendarioRelatorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Selecione o período" readonly>
                            </div>
                            
                            <!-- Botão Aplicar Filtro -->
                            <div class="flex items-end">
                                <button onclick="aplicarFiltroRelatorio()" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                                    <span class="mr-2">🔍</span>
                                    Aplicar Filtro
                                </button>
                            </div>
                        </div>
                        
                        <!-- Período Atual Selecionado -->
                        <div id="periodoAtualRelatorio" class="mt-3 text-sm text-gray-600 bg-white px-3 py-2 rounded border">
                            📊 Período atual: Todos os períodos
                        </div>
                    </div>
                    
                    <!-- Área de Relatórios -->
                    <div id="relatoriosContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg p-6 text-white hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Relatório de Vendas</h3>
                                    <p class="text-sm opacity-90">Análise completa das vendas</p>
                                </div>
                                <span class="text-3xl">📊</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="gerarRelatorioVendas()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    👁️ Visualizar
                                </button>
                                <button onclick="imprimirRelatorioVendas()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    📄 PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg p-6 text-white hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Relatório Financeiro</h3>
                                    <p class="text-sm opacity-90">DRE e fluxo de caixa</p>
                                </div>
                                <span class="text-3xl">💰</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="gerarRelatorioFinanceiro()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    👁️ Visualizar
                                </button>
                                <button onclick="imprimirRelatorioFinanceiro()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    📄 PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg p-6 text-white hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Relatório de Clientes</h3>
                                    <p class="text-sm opacity-90">Análise de clientes</p>
                                </div>
                                <span class="text-3xl">👥</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="gerarRelatorioClientes()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    👁️ Visualizar
                                </button>
                                <button onclick="imprimirRelatorioClientes()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    📄 PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-lg p-6 text-white hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Relatório de Despesas</h3>
                                    <p class="text-sm opacity-90">Análise de custos</p>
                                </div>
                                <span class="text-3xl">💸</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="gerarRelatorioDespesas()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    👁️ Visualizar
                                </button>
                                <button onclick="imprimirRelatorioDespesas()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    📄 PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-lg p-6 text-white hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Relatório de Estoque</h3>
                                    <p class="text-sm opacity-90">Movimentações do estoque</p>
                                </div>
                                <span class="text-3xl">📦</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="gerarRelatorioEstoque()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    👁️ Visualizar
                                </button>
                                <button onclick="imprimirRelatorioEstoque()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    📄 PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg p-6 text-white hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold">Relatório Completo</h3>
                                    <p class="text-sm opacity-90">Todos os dados</p>
                                </div>
                                <span class="text-3xl">📋</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="gerarRelatorioCompleto()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    👁️ Visualizar
                                </button>
                                <button onclick="imprimirRelatorioCompleto()" class="flex-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded text-sm font-semibold transition-all">
                                    📄 PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="relatorioContent" class="bg-gray-50 rounded-lg p-6">
                        <div class="text-center text-gray-500">
                            <div class="text-6xl mb-4">📈</div>
                            <h3 class="text-xl font-semibold mb-2">Selecione um relatório</h3>
                            <p>Clique em um dos cartões acima para gerar o relatório desejado</p>
                        </div>
                    </div>
                </div>`;
            },

            config: function() {
                const connectivityStatus = getConnectivityStatus();
                
                // Inicializar estado do cloud service quando a seção for carregada
                setTimeout(() => {
                    try {
                        if (cloudService && typeof window.toggleCloudService === 'function') {
                            window.toggleCloudService(cloudService);
                        }
                    } catch (error) {
                        console.log('Erro ao inicializar cloud service na seção:', error);
                    }
                }, 100);
                
                return `<div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            <span class="text-3xl mr-3">⚙️</span>
                            Configurações do Sistema
                        </h2>
                        <div class="flex items-center gap-3">
                            <div class="${connectivityStatus.color} font-semibold">
                                ${connectivityStatus.message}
                            </div>
                            ${window.firebaseConnected ? `
                                <button onclick="forceSyncData()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
                                    🔄 Sincronizar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Configurações de Alertas -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <span class="text-xl mr-2">🚨</span>
                            Configurações de Alertas
                        </h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${getConfiguracoesAlertas()}
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button onclick="salvarConfiguracoesAlertas()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                                    💾 Salvar Configurações
                                </button>
                                <button onclick="testarAlertas()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm">
                                    🧪 Testar Alertas
                                </button>
                                <button onclick="verificarAlertasAgora()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                                    🔍 Verificar Agora
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Backup na Nuvem -->
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-6 mb-6 border-2 border-blue-200">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <span class="text-2xl mr-2">☁️</span>
                            Backup Automático na Nuvem
                        </h3>
                        
                        <!-- Status de Conexão -->
                        <div id="cloudConnectionStatus" class="mb-4 p-4 bg-white rounded-lg shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-gray-700">Status da Conta:</div>
                                    <div id="cloudAccountInfo" class="text-sm text-gray-500 mt-1">
                                        Nenhuma conta conectada
                                    </div>
                                </div>
                                <div id="cloudStatusDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            </div>
                        </div>
                        
                        <!-- Escolha do Serviço -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            <!-- Google Drive -->
                            <div id="googleDriveCard" class="bg-white p-4 rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-all cursor-pointer" onclick="toggleCloudService('google')">
                                <div class="flex items-center gap-3">
                                    <div class="text-3xl">🟦</div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-800">Google Drive</div>
                                        <div class="text-xs text-gray-500">15 GB grátis</div>
                                    </div>
                                    <div id="googleCheckmark" class="hidden text-2xl text-green-500">✅</div>
                                </div>
                            </div>
                            
                            <!-- OneDrive -->
                            <div id="oneDriveCard" class="bg-white p-4 rounded-lg border-2 border-gray-200 hover:border-blue-600 transition-all cursor-pointer" onclick="toggleCloudService('onedrive')">
                                <div class="flex items-center gap-3">
                                    <div class="text-3xl">🟦</div>
                                    <div class="flex-1">
                                        <div class="font-semibold text-gray-800">OneDrive</div>
                                        <div class="text-xs text-gray-500">5 GB grátis</div>
                                    </div>
                                    <div id="onedriveCheckmark" class="hidden text-2xl text-green-500">✅</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botões de Ação -->
                        <div class="space-y-3">
                            <!-- Botão de Login -->
                            <div id="loginSection" class="">
                                <!-- Campo de Email (opcional) -->
                                <div class="mb-3">
                                    <label for="cloudEmail" class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center gap-2">
                                            <span>✉️</span>
                                            <span>Email da Conta (opcional)</span>
                                        </span>
                                    </label>
                                    <input 
                                        type="email" 
                                        id="cloudEmail" 
                                        placeholder="seu.email@gmail.com" 
                                        value="${localStorage.getItem('preferredCloudEmail') || ''}" 
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-all"
                                        onchange="localStorage.setItem('preferredCloudEmail', this.value)"
                                    />
                                    <p class="text-xs text-gray-500 mt-1">
                                        <span class="font-medium">💡 Dica:</span> Digite o email da conta Google que deseja usar. O sistema vai abrir o login já com esse email preenchido.
                                    </p>
                                </div>
                                
                                <button onclick="loginToCloud(event)" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 shadow-lg transition-all">
                                    <span>🔑</span> Conectar Conta na Nuvem
                                </button>
                                <p class="text-xs text-gray-500 mt-2 text-center">Selecione Google Drive ou OneDrive acima</p>
                            </div>
                            
                            <!-- Botões de Backup (aparecem após login) -->
                            <div id="backupActions" class="hidden space-y-2">
                                <button onclick="backupToCloud()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 shadow-md transition-all">
                                    <span>☁️</span> Fazer Backup na Nuvem
                                </button>
                                <button onclick="restoreFromCloud()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 shadow-md transition-all">
                                    <span>📝</span> Restaurar Backup da Nuvem
                                </button>
                                <button onclick="viewCloudBackups()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                                    <span>📁</span> Ver Meus Backups
                                </button>
                                <button onclick="disconnectCloud()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                                    <span>🚪</span> Desconectar Conta
                                </button>
                            </div>
                        </div>
                        
                        <!-- Status do Backup -->
                        <div id="backupStatus" class="mt-4 text-sm">
                            <!-- Status será exibido aqui -->
                        </div>
                        
                        <!-- Último Backup -->
                        <div id="lastBackupInfo" class="mt-4 p-3 bg-white rounded-lg hidden">
                            <div class="text-xs text-gray-500 mb-1">Último backup:</div>
                            <div id="lastBackupDate" class="text-sm font-medium text-gray-700">-</div>
                        </div>
                        
                        <!-- Informações -->
                        <div class="mt-4 p-4 bg-white bg-opacity-60 rounded-lg border border-blue-200">
                            <div class="text-blue-800 text-sm space-y-2">
                                <div>
                                    <strong>🔒 Segurança:</strong> Seus dados são criptografados e salvos diretamente na sua conta pessoal do Google Drive. 
                                    <strong>Apenas você</strong> tem acesso aos seus backups.
                                </div>
                                <div class="text-xs text-gray-600 mt-2 pt-2 border-t border-blue-200">
                                    <strong>👉 Dicas:</strong>
                                    <ul class="list-disc list-inside mt-1 space-y-1">
                                        <li>Use Google Chrome ou Edge para melhor compatibilidade</li>
                                        <li>Permita popups quando solicitado</li>
                                        <li>Autorize as permissões do aplicativo</li>
                                        <li>OneDrive disponível em breve (use Google Drive)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Backup Manual (sempre disponível) -->
                        <div class="mt-4 pt-4 border-t border-gray-300">
                            <div class="text-sm text-gray-600 mb-2 font-medium flex items-center gap-2">
                                <span>💾</span>
                                <span>Backup Manual (sem conta):</span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Use esta opção se não quiser conectar uma conta na nuvem</p>
                            <div class="flex gap-2">
                                <button onclick="downloadLocalBackup()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center gap-1 transition-all">
                                    <span>⬇️</span> Baixar Arquivo
                                </button>
                                <button onclick="uploadLocalBackup()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm flex items-center justify-center gap-1 transition-all">
                                    <span>⬆️</span> Restaurar de Arquivo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status de Sincronização -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <span class="text-xl mr-2">☁️</span>
                            Status de Sincronização Firebase
                        </h3>
                        <div id="syncStatus" class="mb-3">
                            <div class="flex items-center gap-2 text-sm ${connectivityStatus.color}">
                                <span>${connectivityStatus.message}</span>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div>Firebase: ${window.firebaseConnected ? '✅ Conectado' : '❌ Desconectado'}</div>
                            <div>Última sincronização: ${lastSyncTime ? new Date(lastSyncTime).toLocaleString('pt-BR') : 'Nunca'}</div>
                            <div>Última atualização: ${sistemData.lastUpdated ? new Date(sistemData.lastUpdated).toLocaleString('pt-BR') : 'Desconhecida'}</div>
                        </div>
                        ${window.firebaseConnected ? `
                            <div class="flex gap-2 mt-4 flex-wrap">
                                <button onclick="saveToFirebase()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm">
                                    ☁️ Enviar para Servidor
                                </button>
                                <button onclick="loadFromFirebase()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm">
                                    📥 Baixar do Servidor
                                </button>
                                <button onclick="resetFirebaseData()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">
                                    🗑️ Limpar Servidor
                                </button>
                            </div>
                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="text-blue-800 text-sm">
                                    <strong>💡 Dica:</strong> Os dados são sincronizados automaticamente entre seus dispositivos. 
                                    Use "Enviar para Servidor" para forçar o upload dos dados locais.
                                </div>
                            </div>
                        ` : `
                            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="text-yellow-800 text-sm">
                                    <strong>⚠️ Firebase Desconectado</strong><br>
                                    Os dados estão sendo salvos apenas localmente. Recarregue a página para tentar reconectar ao servidor.
                                </div>
                            </div>
                        `}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <span class="text-xl mr-2">🏢</span>
                                    Dados da Empresa
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label>
                                        <input type="text" value="Rei da Caçambinha" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ</label>
                                        <input type="text" placeholder="00.000.000/0000-00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                        <input type="text" placeholder="(00) 00000-0000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                                        <textarea rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <span class="text-xl mr-2">🔧</span>
                                    Configurações Gerais
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-700">Backup Automático</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" checked class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-700">Alertas de Vencimento</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" checked class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-700">Modo Escuro</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <span class="text-xl mr-2">💾</span>
                                    Dados do Sistema
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span>Versão:</span>
                                        <span class="font-semibold">v3.0 Pro</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Total de vendas:</span>
                                        <span class="font-semibold">${sistemData.vendas.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Total de clientes:</span>
                                        <span class="font-semibold">${sistemData.clientes.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Espaço usado:</span>
                                        <span class="font-semibold">${(JSON.stringify(sistemData).length / 1024).toFixed(2)} KB</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Último backup:</span>
                                        <span class="font-semibold">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 flex items-center">
                                    <span class="text-xl mr-2">🔄</span>
                                    Ações do Sistema
                                </h3>
                                <div class="space-y-3">
                                    <button onclick="exportarDados()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                        📤 Exportar Dados
                                    </button>
                                    <button onclick="importarDados()" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                        📥 Importar Dados
                                    </button>
                                    <button onclick="limparDados()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                        🗑️ Limpar Todos os Dados
                                    </button>
                                    <button onclick="resetarSistema()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                        🔄 Resetar Sistema
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        };

        // Funções para menu mobile
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const menuIcon = document.getElementById('menu-icon');
            
            if (sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === '') {
                sidebar.style.transform = 'translateX(-100%)';
                menuIcon.textContent = '☰';
                document.body.style.overflow = 'auto';
            } else {
                sidebar.style.transform = 'translateX(0px)';
                menuIcon.textContent = '✕';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const menuIcon = document.getElementById('menu-icon');
            sidebar.style.transform = 'translateX(-100%)';
            menuIcon.textContent = '☰';
            document.body.style.overflow = 'auto';
        }
        
        // Desktop sidebar toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleButton = document.querySelector('.menu-toggle svg');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
                // Rotacionar ícone para esquerda
                toggleButton.style.transform = 'rotate(0deg)';
                toggleButton.style.transition = 'transform 0.3s ease';
            } else {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                // Rotacionar ícone para direita
                toggleButton.style.transform = 'rotate(180deg)';
                toggleButton.style.transition = 'transform 0.3s ease';
            }
        }
        
        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            if (sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }
        
        // Função para mostrar seção
        function showSection(sectionName) {
            const content = document.getElementById('content');
            if (typeof sections[sectionName] === 'function') {
                content.innerHTML = sections[sectionName]();
            } else {
                content.innerHTML = sections[sectionName] || '<div class="bg-white rounded-xl shadow-lg p-6"><h3 class="text-lg font-semibold mb-4">Seção não encontrada</h3></div>';
            }
            
            // Destacar item ativo na sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Encontrar e destacar o item clicado
            const clickedItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // Inicializar funcionalidades específicas da seção
            initSectionFunctions(sectionName);
        }

        // ===== SISTEMA DE ALERTAS CRÍTICOS =====
        
        let alertasExibidos = new Set(); // Para evitar alertas duplicados
        let ultimaVerificacaoAlertas = null;
        
        // Verificar alertas críticos automaticamente
        function verificarAlertasCriticos() {
            if (!sistemData.configuracoes?.alertas) return;
            
            const alertas = [];
            const config = sistemData.configuracoes.alertas;
            const hoje = new Date();
            
            // 1. CNH Vencendo
            if (config.cnhVencimento?.ativo) {
                const cnhVencendo = sistemData.motoristas.filter(m => {
                    if (!m.vencimentoCnh) return false;
                    const vencimento = new Date(m.vencimentoCnh);
                    const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                    return diasParaVencimento <= config.cnhVencimento.diasAntecedencia && diasParaVencimento >= 0;
                });
                
                if (cnhVencendo.length > 0) {
                    alertas.push({
                        tipo: 'critico',
                        titulo: '🚨 CNH Vencendo',
                        mensagem: `${cnhVencendo.length} motorista(s) com CNH vencendo em breve`,
                        detalhes: cnhVencendo.map(m => `• ${m.nome} - Vence em ${Math.ceil((new Date(m.vencimentoCnh) - hoje) / (1000 * 60 * 60 * 24))} dias`),
                        acao: 'showSection("motoristas")',
                        icone: '🆔',
                        cor: 'red'
                    });
                }
            }
            
            // 2. Exame Toxicológico Vencendo
            if (config.toxicologicoVencimento?.ativo) {
                const toxicologicoVencendo = sistemData.motoristas.filter(m => {
                    if (!m.vencimentoToxicologico) return false;
                    const vencimento = new Date(m.vencimentoToxicologico);
                    const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                    return diasParaVencimento <= config.toxicologicoVencimento.diasAntecedencia && diasParaVencimento >= 0;
                });
                
                if (toxicologicoVencendo.length > 0) {
                    alertas.push({
                        tipo: 'atencao',
                        titulo: '⚠️ Exame Toxicológico Vencendo',
                        mensagem: `${toxicologicoVencendo.length} motorista(s) com exame vencendo`,
                        detalhes: toxicologicoVencendo.map(m => `• ${m.nome} - Vence em ${Math.ceil((new Date(m.vencimentoToxicologico) - hoje) / (1000 * 60 * 60 * 24))} dias`),
                        acao: 'showSection("motoristas")',
                        icone: '🧪',
                        cor: 'yellow'
                    });
                }
            }
            
            // 3. Vendas com Cheque Vencendo
            if (config.chequeVencimento?.ativo) {
                const chequesVencendo = sistemData.vendas.filter(v => {
                    if (v.tipoPagamento !== 'cheque' || v.pago || !v.dataVencimento) return false;
                    const vencimento = new Date(v.dataVencimento);
                    const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                    return diasParaVencimento <= config.chequeVencimento.diasAntecedencia && diasParaVencimento >= 0;
                });
                
                if (chequesVencendo.length > 0) {
                    const valorTotal = chequesVencendo.reduce((total, v) => total + v.valor, 0);
                    alertas.push({
                        tipo: 'atencao',
                        titulo: '📝 Cheques Vencendo',
                        mensagem: `${chequesVencendo.length} cheque(s) vencendo - R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        detalhes: chequesVencendo.map(v => `• ${v.cliente} - R$ ${v.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} - Vence em ${Math.ceil((new Date(v.dataVencimento) - hoje) / (1000 * 60 * 60 * 24))} dias`),
                        acao: 'showSection("cobranca")',
                        icone: '💰',
                        cor: 'orange'
                    });
                }
            }
            
            // 4. Vendas Vencidas
            if (config.vendaVencida?.ativo) {
                const vendasVencidas = sistemData.vendas.filter(v => {
                    if (v.pago || !v.dataVencimento) return false;
                    return new Date(v.dataVencimento) < hoje;
                });
                
                if (vendasVencidas.length > 0) {
                    const valorTotal = vendasVencidas.reduce((total, v) => total + v.valor, 0);
                    alertas.push({
                        tipo: 'critico',
                        titulo: '🚨 Vendas Vencidas',
                        mensagem: `${vendasVencidas.length} venda(s) vencida(s) - R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        detalhes: vendasVencidas.slice(0, 5).map(v => {
                            const diasAtraso = Math.floor((hoje - new Date(v.dataVencimento)) / (1000 * 60 * 60 * 24));
                            return `• ${v.cliente} - R$ ${v.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} - ${diasAtraso} dias de atraso`;
                        }),
                        acao: 'showSection("cobranca")',
                        icone: '💸',
                        cor: 'red'
                    });
                }
            }
            
            // 5. Estoque Mínimo
            if (config.estoqueMinimo?.ativo && sistemData.estoque.saldo < config.estoqueMinimo.valor) {
                const percentual = ((sistemData.estoque.saldo / config.estoqueMinimo.valor) * 100).toFixed(1);
                alertas.push({
                    tipo: 'critico',
                    titulo: '📦 Estoque Crítico',
                    mensagem: `Estoque abaixo do mínimo (${percentual}% do ideal)`,
                    detalhes: [
                        `• Saldo atual: R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        `• Mínimo configurado: R$ ${config.estoqueMinimo.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        `• Diferença: R$ ${(config.estoqueMinimo.valor - sistemData.estoque.saldo).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                    ],
                    acao: 'showSection("estoque")',
                    icone: '⚠️',
                    cor: 'red'
                });
            }
            
            // 6. Muitas Vendas Pendentes
            if (config.vendasPendentes?.ativo) {
                const vendasPendentes = sistemData.vendas.filter(v => v.tipoPagamento === 'a_prazo' && !v.pago).length;
                if (vendasPendentes >= config.vendasPendentes.quantidade) {
                    const valorPendente = sistemData.vendas
                        .filter(v => v.tipoPagamento === 'a_prazo' && !v.pago)
                        .reduce((total, v) => total + v.valor, 0);
                    
                    alertas.push({
                        tipo: 'atencao',
                        titulo: '⏰ Muitas Vendas Pendentes',
                        mensagem: `${vendasPendentes} vendas aguardando pagamento`,
                        detalhes: [
                            `• Valor total pendente: R$ ${valorPendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                            `• Limite configurado: ${config.vendasPendentes.quantidade} vendas`
                        ],
                        acao: 'showSection("cobranca")',
                        icone: '📋',
                        cor: 'yellow'
                    });
                }
            }
            
            // 7. Despesas Altas no Mês
            if (config.despesasAltas?.ativo) {
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const despesasMes = sistemData.despesas
                    .filter(d => new Date(d.data) >= inicioMes)
                    .reduce((total, d) => total + d.valor, 0);
                
                if (despesasMes >= config.despesasAltas.valor) {
                    alertas.push({
                        tipo: 'atencao',
                        titulo: '💸 Despesas Elevadas',
                        mensagem: `Despesas do mês: R$ ${despesasMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        detalhes: [
                            `• Valor atual: R$ ${despesasMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                            `• Limite configurado: R$ ${config.despesasAltas.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                        ],
                        acao: 'showSection("despesas")',
                        icone: '📊',
                        cor: 'orange'
                    });
                }
            }
            
            // 8. Cliente Inadimplente
            if (config.clienteInadimplente?.ativo) {
                const clientesInadimplentes = {};
                sistemData.vendas
                    .filter(v => v.tipoPagamento === 'a_prazo' && !v.pago && v.dataVencimento)
                    .forEach(v => {
                        const diasAtraso = Math.floor((hoje - new Date(v.dataVencimento)) / (1000 * 60 * 60 * 24));
                        if (diasAtraso >= config.clienteInadimplente.diasAtraso) {
                            if (!clientesInadimplentes[v.cliente]) {
                                clientesInadimplentes[v.cliente] = { valor: 0, vendas: 0, maiorAtraso: 0 };
                            }
                            clientesInadimplentes[v.cliente].valor += v.valor;
                            clientesInadimplentes[v.cliente].vendas += 1;
                            clientesInadimplentes[v.cliente].maiorAtraso = Math.max(clientesInadimplentes[v.cliente].maiorAtraso, diasAtraso);
                        }
                    });
                
                const totalInadimplentes = Object.keys(clientesInadimplentes).length;
                if (totalInadimplentes > 0) {
                    const valorTotal = Object.values(clientesInadimplentes).reduce((total, c) => total + c.valor, 0);
                    alertas.push({
                        tipo: 'critico',
                        titulo: '🚨 Clientes Inadimplentes',
                        mensagem: `${totalInadimplentes} cliente(s) em atraso - R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        detalhes: Object.entries(clientesInadimplentes).slice(0, 5).map(([cliente, dados]) => 
                            `• ${cliente} - R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} - ${dados.maiorAtraso} dias`
                        ),
                        acao: 'showSection("cobranca")',
                        icone: '⚠️',
                        cor: 'red'
                    });
                }
            }
            
            // Exibir alertas se houver algum
            if (alertas.length > 0) {
                exibirAlertasCriticos(alertas);
            }
            
            ultimaVerificacaoAlertas = new Date().toISOString();
        }
        
        // Exibir alertas críticos em popup
        function exibirAlertasCriticos(alertas) {
            // Filtrar alertas já exibidos (para evitar spam)
            const alertasNovos = alertas.filter(alerta => {
                const id = `${alerta.tipo}-${alerta.titulo}`;
                return !alertasExibidos.has(id);
            });
            
            if (alertasNovos.length === 0) return;
            
            // Marcar como exibidos
            alertasNovos.forEach(alerta => {
                const id = `${alerta.tipo}-${alerta.titulo}`;
                alertasExibidos.add(id);
            });
            
            // Priorizar alertas críticos
            alertasNovos.sort((a, b) => {
                const prioridade = { 'critico': 3, 'atencao': 2, 'info': 1 };
                return (prioridade[b.tipo] || 0) - (prioridade[a.tipo] || 0);
            });
            
            // Exibir o primeiro alerta (mais crítico)
            const alerta = alertasNovos[0];
            mostrarPopupAlerta(alerta);
            
            // Se houver mais alertas, agendar para exibir após um delay
            if (alertasNovos.length > 1) {
                setTimeout(() => {
                    exibirAlertasCriticos(alertasNovos.slice(1));
                }, 8000); // 8 segundos entre alertas
            }
        }
        
        // Mostrar popup de alerta
        function mostrarPopupAlerta(alerta) {
            const modal = document.getElementById('alertaCriticoModal');
            const content = document.getElementById('alertaCriticoContent');
            
            const coresConfig = {
                'red': { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800', button: 'bg-red-500 hover:bg-red-600' },
                'yellow': { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800', button: 'bg-yellow-500 hover:bg-yellow-600' },
                'orange': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-800', button: 'bg-orange-500 hover:bg-orange-600' },
                'blue': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800', button: 'bg-blue-500 hover:bg-blue-600' }
            };
            
            const cores = coresConfig[alerta.cor] || coresConfig['blue'];
            
            content.innerHTML = `
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 ${cores.bg} ${cores.border} border-2 rounded-full flex items-center justify-center text-2xl mr-3">
                                ${alerta.icone}
                            </div>
                            <div>
                                <h3 class="text-lg font-bold ${cores.text}">${alerta.titulo}</h3>
                                <p class="text-sm ${cores.text} opacity-80">${alerta.mensagem}</p>
                            </div>
                        </div>
                        <button onclick="fecharAlertaCritico()" class="text-gray-400 hover:text-gray-600 text-xl">
                            ✕
                        </button>
                    </div>
                    
                    <!-- Detalhes -->
                    ${alerta.detalhes && alerta.detalhes.length > 0 ? `
                        <div class="${cores.bg} ${cores.border} border rounded-lg p-3 mb-4">
                            <div class="text-sm ${cores.text} space-y-1">
                                ${alerta.detalhes.map(detalhe => `<div>${detalhe}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Ações -->
                    <div class="flex gap-3">
                        <button onclick="${alerta.acao}; fecharAlertaCritico();" class="flex-1 ${cores.button} text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                            🔍 Ver Detalhes
                        </button>
                        <button onclick="fecharAlertaCritico()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-semibold transition-colors">
                            ✕ Fechar
                        </button>
                    </div>
                    
                    <!-- Timer visual -->
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-1">
                            <div class="bg-gray-400 h-1 rounded-full animate-shrink" style="animation: shrink 10s linear forwards;"></div>
                        </div>
                        <div class="text-xs text-gray-500 text-center mt-1">Este alerta se fechará automaticamente em 10 segundos</div>
                    </div>
                </div>
            `;
            
            // Mostrar modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Auto-fechar após 10 segundos
            setTimeout(() => {
                if (!modal.classList.contains('hidden')) {
                    fecharAlertaCritico();
                }
            }, 10000);
            
            // Animação de entrada
            setTimeout(() => {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 50);
        }
        
        // Fechar popup de alerta
        window.fecharAlertaCritico = function() {
            const modal = document.getElementById('alertaCriticoModal');
            const content = document.getElementById('alertaCriticoContent');
            
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        };
        
        // Verificar alertas agora (botão manual)
        window.verificarAlertasAgora = function() {
            alertasExibidos.clear(); // Limpar cache para permitir reexibição
            verificarAlertasCriticos();
            showNotification('🔍 Verificação de alertas executada!', 'info');
        };
        
        // Testar sistema de alertas
        window.testarAlertas = function() {
            const alertasTeste = [
                {
                    tipo: 'critico',
                    titulo: '🧪 Teste de Alerta Crítico',
                    mensagem: 'Este é um teste do sistema de alertas',
                    detalhes: ['• Função de teste executada com sucesso', '• Sistema operacional'],
                    acao: 'console.log("Teste executado")',
                    icone: '🔬',
                    cor: 'blue'
                }
            ];
            
            exibirAlertasCriticos(alertasTeste);
        };
        
        // Configurações de alertas
        function getConfiguracoesAlertas() {
            const config = sistemData.configuracoes?.alertas || {};
            
            return `
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">🆔 CNH Vencendo</div>
                            <div class="text-sm text-gray-600">Alertar quando CNH estiver próxima do vencimento</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="cnhDias" value="${config.cnhVencimento?.diasAntecedencia || 30}" class="w-16 px-2 py-1 border rounded text-sm" min="1" max="365">
                            <span class="text-xs text-gray-500">dias</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="cnhAtivo" ${config.cnhVencimento?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">🧪 Exame Toxicológico</div>
                            <div class="text-sm text-gray-600">Alertar sobre vencimento de exames</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="toxicologicoDias" value="${config.toxicologicoVencimento?.diasAntecedencia || 30}" class="w-16 px-2 py-1 border rounded text-sm" min="1" max="365">
                            <span class="text-xs text-gray-500">dias</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toxicologicoAtivo" ${config.toxicologicoVencimento?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">📝 Cheques Vencendo</div>
                            <div class="text-sm text-gray-600">Alertar sobre cheques próximos do vencimento</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="chequeDias" value="${config.chequeVencimento?.diasAntecedencia || 7}" class="w-16 px-2 py-1 border rounded text-sm" min="0" max="30">
                            <span class="text-xs text-gray-500">dias</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="chequeAtivo" ${config.chequeVencimento?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">🚨 Vendas Vencidas</div>
                            <div class="text-sm text-gray-600">Alertar sobre vendas com prazo vencido</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">Imediato</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="vendaVencidaAtivo" ${config.vendaVencida?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">📦 Estoque Mínimo</div>
                            <div class="text-sm text-gray-600">Alertar quando estoque estiver baixo</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">R$</span>
                            <input type="number" id="estoqueValor" value="${config.estoqueMinimo?.valor || 10000}" class="w-20 px-2 py-1 border rounded text-sm" min="0" step="1000">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="estoqueAtivo" ${config.estoqueMinimo?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">⏰ Vendas Pendentes</div>
                            <div class="text-sm text-gray-600">Alertar quando há muitas vendas pendentes</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="vendasPendentesQtd" value="${config.vendasPendentes?.quantidade || 5}" class="w-16 px-2 py-1 border rounded text-sm" min="1" max="50">
                            <span class="text-xs text-gray-500">vendas</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="vendasPendentesAtivo" ${config.vendasPendentes?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">💸 Despesas Elevadas</div>
                            <div class="text-sm text-gray-600">Alertar sobre despesas altas no mês</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">R$</span>
                            <input type="number" id="despesasValor" value="${config.despesasAltas?.valor || 5000}" class="w-20 px-2 py-1 border rounded text-sm" min="0" step="1000">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="despesasAtivo" ${config.despesasAltas?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border">
                        <div>
                            <div class="font-medium text-gray-800">⚠️ Clientes Inadimplentes</div>
                            <div class="text-sm text-gray-600">Alertar sobre clientes em atraso</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" id="inadimplenteDias" value="${config.clienteInadimplente?.diasAtraso || 15}" class="w-16 px-2 py-1 border rounded text-sm" min="1" max="365">
                            <span class="text-xs text-gray-500">dias</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="inadimplenteAtivo" ${config.clienteInadimplente?.ativo !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Salvar configurações de alertas
        window.salvarConfiguracoesAlertas = function() {
            if (!sistemData.configuracoes) sistemData.configuracoes = {};
            if (!sistemData.configuracoes.alertas) sistemData.configuracoes.alertas = {};
            
            const alertas = sistemData.configuracoes.alertas;
            
            // Coletar configurações dos campos
            alertas.cnhVencimento = {
                ativo: document.getElementById('cnhAtivo').checked,
                diasAntecedencia: parseInt(document.getElementById('cnhDias').value) || 30
            };
            
            alertas.toxicologicoVencimento = {
                ativo: document.getElementById('toxicologicoAtivo').checked,
                diasAntecedencia: parseInt(document.getElementById('toxicologicoDias').value) || 30
            };
            
            alertas.chequeVencimento = {
                ativo: document.getElementById('chequeAtivo').checked,
                diasAntecedencia: parseInt(document.getElementById('chequeDias').value) || 7
            };
            
            alertas.vendaVencida = {
                ativo: document.getElementById('vendaVencidaAtivo').checked,
                diasAntecedencia: 0
            };
            
            alertas.estoqueMinimo = {
                ativo: document.getElementById('estoqueAtivo').checked,
                valor: parseFloat(document.getElementById('estoqueValor').value) || 10000
            };
            
            alertas.vendasPendentes = {
                ativo: document.getElementById('vendasPendentesAtivo').checked,
                quantidade: parseInt(document.getElementById('vendasPendentesQtd').value) || 5
            };
            
            alertas.despesasAltas = {
                ativo: document.getElementById('despesasAtivo').checked,
                valor: parseFloat(document.getElementById('despesasValor').value) || 5000
            };
            
            alertas.clienteInadimplente = {
                ativo: document.getElementById('inadimplenteAtivo').checked,
                diasAtraso: parseInt(document.getElementById('inadimplenteDias').value) || 15
            };
            
            saveData();
            showNotification('💾 Configurações de alertas salvas com sucesso!', 'success');
        };

        // Funções específicas para cada seção
        function initSectionFunctions(sectionName) {
            if (sectionName === 'vendas') {
                // Event listeners para filtros de vendas
                document.getElementById('vendaSearch').addEventListener('input', filterVendas);
                document.getElementById('vendaFilterPagamento').addEventListener('change', filterVendas);
            }
            
            if (sectionName === 'financeiro') {
                document.getElementById('filtroPeriodo').addEventListener('change', atualizarFinanceiro);
                setTimeout(() => {
                    renderFinanceiroCharts();
                }, 100);
            }
            
            if (sectionName === 'dashboard') {
                setTimeout(() => {
                    renderDashboardCharts();
                }, 100);
            }
            
            if (sectionName === 'relatorios') {
                // Inicializar calendário para relatórios
                setTimeout(() => {
                    initCalendarioRelatorios();
                }, 100);
            }
        }

        // Tornar showSection global
        window.showSection = showSection;
        
        // ===== FUNÇÕES PARA CALENDÁRIO DE RELATÓRIOS =====
        
        let calendarioRelatorios = null;
        let dataInicioRelatorio = null;
        let dataFimRelatorio = null;
        
        // Inicializar calendário para relatórios
        function initCalendarioRelatorios() {
            const calendarioInput = document.getElementById('calendarioRelatorio');
            if (calendarioInput && typeof flatpickr !== 'undefined') {
                calendarioRelatorios = flatpickr(calendarioInput, {
                    mode: 'range',
                    dateFormat: 'd/m/Y',
                    locale: 'pt',
                    enableTime: false,
                    placeholder: 'Selecione o período',
                    onChange: function(selectedDates) {
                        if (selectedDates.length === 2) {
                            dataInicioRelatorio = selectedDates[0];
                            dataFimRelatorio = selectedDates[1];
                            
                            // Atualizar exibição do período
                            const inicio = selectedDates[0].toLocaleDateString('pt-BR');
                            const fim = selectedDates[1].toLocaleDateString('pt-BR');
                            
                            document.getElementById('periodoAtualRelatorio').innerHTML = 
                                `📅 Período selecionado: ${inicio} até ${fim}`;
                        }
                    }
                });
            }
        }
        
        // Alternar exibição do calendário
        function toggleCalendarioRelatorio() {
            const tipoPerido = document.getElementById('tipoPeridoRelatorio').value;
            const calendarioContainer = document.getElementById('calendarioContainer');
            
            if (tipoPerido === 'calendario') {
                calendarioContainer.classList.remove('hidden');
            } else {
                calendarioContainer.classList.add('hidden');
                // Resetar seleção do calendário
                if (calendarioRelatorios) {
                    calendarioRelatorios.clear();
                }
                dataInicioRelatorio = null;
                dataFimRelatorio = null;
                
                // Atualizar exibição do período
                atualizarTextoPeriodoRelatorio(tipoPerido);
            }
        }
        
        // Atualizar texto do período atual
        function atualizarTextoPeriodoRelatorio(tipoPerido) {
            let textoPeriodo = '';
            
            switch (tipoPerido) {
                case 'todos': textoPeriodo = 'Todos os períodos'; break;
                case 'hoje': textoPeriodo = 'Hoje'; break;
                case 'semana': textoPeriodo = 'Esta semana'; break;
                case 'mes': textoPeriodo = 'Este mês'; break;
                case 'trimestre': textoPeriodo = 'Este trimestre'; break;
                case 'ano': textoPeriodo = 'Este ano'; break;
                case 'calendario': textoPeriodo = 'Período personalizado'; break;
            }
            
            document.getElementById('periodoAtualRelatorio').innerHTML = 
                `📊 Período atual: ${textoPeriodo}`;
        }
        
        // Aplicar filtro de período
        function aplicarFiltroRelatorio() {
            const tipoPerido = document.getElementById('tipoPeridoRelatorio').value;
            
            if (tipoPerido === 'calendario' && (!dataInicioRelatorio || !dataFimRelatorio)) {
                showNotification('⚠️ Selecione um período válido no calendário', 'warning');
                return;
            }
            
            // Salvar filtro aplicado
            window.filtroRelatorioAtual = {
                tipo: tipoPerido,
                dataInicio: dataInicioRelatorio,
                dataFim: dataFimRelatorio
            };
            
            showNotification('✓ Filtro de período aplicado com sucesso!', 'success');
            
            // Atualizar texto do período
            if (tipoPerido !== 'calendario') {
                atualizarTextoPeriodoRelatorio(tipoPerido);
            }
        }
        
        // Obter datas do filtro aplicado
        function getDatasFiltroRelatorio() {
            const filtro = window.filtroRelatorioAtual || { tipo: 'todos' };
            const hoje = new Date();
            
            switch (filtro.tipo) {
                case 'hoje':
                    const inicioHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                    const fimHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);
                    return { inicio: inicioHoje, fim: fimHoje };
                    
                case 'semana':
                    const inicioSemana = new Date(hoje);
                    inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                    inicioSemana.setHours(0, 0, 0, 0);
                    const fimSemana = new Date(inicioSemana);
                    fimSemana.setDate(inicioSemana.getDate() + 6);
                    fimSemana.setHours(23, 59, 59);
                    return { inicio: inicioSemana, fim: fimSemana };
                    
                case 'mes':
                    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0, 23, 59, 59);
                    return { inicio: inicioMes, fim: fimMes };
                    
                case 'trimestre':
                    const trimestreAtual = Math.floor(hoje.getMonth() / 3);
                    const inicioTrimestre = new Date(hoje.getFullYear(), trimestreAtual * 3, 1);
                    const fimTrimestre = new Date(hoje.getFullYear(), (trimestreAtual + 1) * 3, 0, 23, 59, 59);
                    return { inicio: inicioTrimestre, fim: fimTrimestre };
                    
                case 'ano':
                    const inicioAno = new Date(hoje.getFullYear(), 0, 1);
                    const fimAno = new Date(hoje.getFullYear(), 11, 31, 23, 59, 59);
                    return { inicio: inicioAno, fim: fimAno };
                    
                case 'calendario':
                    if (filtro.dataInicio && filtro.dataFim) {
                        const inicio = new Date(filtro.dataInicio);
                        inicio.setHours(0, 0, 0, 0);
                        const fim = new Date(filtro.dataFim);
                        fim.setHours(23, 59, 59);
                        return { inicio, fim };
                    }
                    break;
                    
                default: // 'todos'
                    return null;
            }
        }
        
        // Filtrar dados por período
        function filtrarDadosPorPeriodo(dados, campoData = 'data') {
            const datas = getDatasFiltroRelatorio();
            
            if (!datas) {
                return dados; // Retorna todos os dados se não há filtro
            }
            
            return dados.filter(item => {
                const dataItem = new Date(item[campoData]);
                return dataItem >= datas.inicio && dataItem <= datas.fim;
            });
        }
        
        // Funções auxiliares para relatórios filtrados
        function getVendasPorMaterialFiltradas(vendasFiltradas) {
            const materiais = {};
            
            vendasFiltradas.forEach(venda => {
                const material = venda.material || venda.minerio || 'Não especificado';
                if (!materiais[material]) {
                    materiais[material] = { quantidade: 0, valor: 0 };
                }
                materiais[material].quantidade += venda.quantidade || venda.pesoCliente || 0;
                materiais[material].valor += venda.valor;
            });
            
            if (Object.keys(materiais).length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhuma venda encontrada no período selecionado</p>';
            }
            
            return Object.entries(materiais)
                .sort((a, b) => b[1].valor - a[1].valor)
                .map(([material, dados]) => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <div>
                            <span class="font-medium">${material}</span>
                            <div class="text-sm text-gray-600">${dados.quantidade.toFixed(1)} toneladas</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                `).join('');
        }
        
        function getDetalheVendasFiltradas(vendasFiltradas) {
            if (vendasFiltradas.length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhuma venda encontrada no período selecionado</p>';
            }
            
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${vendasFiltradas
                                .sort((a, b) => new Date(b.data) - new Date(a.data))
                                .slice(0, 50) // Limitar a 50 registros para performance
                                .map(venda => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ${new Date(venda.data).toLocaleDateString('pt-BR')}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${venda.cliente}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${venda.material || venda.minerio || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(venda.quantidade || venda.pesoCliente || 0).toFixed(1)}t</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                venda.tipoPagamento === 'pix' ? 'bg-blue-100 text-blue-800' :
                                                venda.tipoPagamento === 'dinheiro' ? 'bg-green-100 text-green-800' :
                                                venda.tipoPagamento === 'cheque' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }">
                                                ${venda.tipoPagamento === 'pix' ? '📱 PIX' :
                                                  venda.tipoPagamento === 'dinheiro' ? '💵 Dinheiro' :
                                                  venda.tipoPagamento === 'cheque' ? '📝 Cheque' :
                                                  '⏰ A Prazo'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                    ${vendasFiltradas.length > 50 ? 
                        `<p class="text-sm text-gray-500 text-center mt-4">Exibindo 50 de ${vendasFiltradas.length} vendas. Use filtros mais específicos para refinar os resultados.</p>` 
                        : ''}
                </div>
            `;
        }
        
        // Tornar funções globais
        window.toggleCalendarioRelatorio = toggleCalendarioRelatorio;
        window.aplicarFiltroRelatorio = aplicarFiltroRelatorio;
        window.filtrarDadosPorPeriodo = filtrarDadosPorPeriodo;
        window.getDatasFiltroRelatorio = getDatasFiltroRelatorio;
        window.getVendasPorMaterialFiltradas = getVendasPorMaterialFiltradas;
        window.getDetalheVendasFiltradas = getDetalheVendasFiltradas;

        // ===== FUNÇÕES AUXILIARES =====

        // Dashboard
        function getVendasHoje() {
            const hoje = new Date().toDateString();
            return sistemData.vendas.filter(v => {
                const vendaData = new Date(v.data).toDateString();
                return hoje === vendaData;
            }).length;
        }

        function calcularEstoqueToneladas() {
            // Calcula estoque aproximado de brita 5/8 baseado no valor em estoque
            const precoBrita = 91.50; // R$ por tonelada
            return sistemData.estoque.saldo / precoBrita;
        }

        function getAlertas() {
            let alertas = [];
            
            // Verificar vencimentos de CNH
            const alertasCnh = sistemData.motoristas.filter(m => {
                const vencimento = new Date(m.vencimentoCnh);
                const hoje = new Date();
                const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                return diasParaVencimento <= 30;
            }).length;
            
            if (alertasCnh > 0) {
                alertas.push(`<div class="flex justify-between items-center p-2 bg-yellow-100 rounded border-l-4 border-yellow-500">
                    <span class="text-yellow-800">⚠️ ${alertasCnh} CNH(s) vencendo em 30 dias</span>
                </div>`);
            }
            
            // Verificar estoque baixo
            const estoqueMinimo = sistemData.configuracoes.estoqueMinimo || 10000;
            const tipoAlerta = sistemData.configuracoes.tipoAlerta || 'atencao';
            
            if (sistemData.estoque.saldo < estoqueMinimo) {
                const alertaConfig = {
                    'critico': { cor: 'red', icone: '🔴', titulo: 'CRÍTICO' },
                    'atencao': { cor: 'yellow', icone: '🟡', titulo: 'ATENÇÃO' },
                    'informativo': { cor: 'blue', icone: '🟢', titulo: 'INFO' }
                };
                
                const config = alertaConfig[tipoAlerta];
                alertas.push(`<div class="flex justify-between items-center p-2 bg-${config.cor}-100 rounded border-l-4 border-${config.cor}-500">
                    <span class="text-${config.cor}-800">${config.icone} ${config.titulo}: Estoque abaixo do mínimo - R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})} / R$ ${estoqueMinimo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                </div>`);
            }
            
            // Verificar vendas a prazo vencidas
            const vendasVencidas = sistemData.vendas.filter(v => {
                if (v.tipoPagamento === 'a_prazo' && v.dataVencimento && !v.pago) {
                    return new Date(v.dataVencimento) < new Date();
                }
                return false;
            }).length;
            
            if (vendasVencidas > 0) {
                alertas.push(`<div class="flex justify-between items-center p-2 bg-red-100 rounded border-l-4 border-red-500">
                    <span class="text-red-800">💸 ${vendasVencidas} vendas vencidas</span>
                </div>`);
            }
            
            if (alertas.length === 0) {
                alertas.push(`<div class="flex justify-between items-center p-2 bg-green-100 rounded border-l-4 border-green-500">
                    <span class="text-green-800">✅ Sistema funcionando normalmente</span>
                </div>`);
            }
            
            return alertas.join('');
        }

        function getVendasRecentes() {
            const recentes = sistemData.vendas.slice(-5).reverse();
            if (recentes.length === 0) {
                return '<p class="text-gray-600">Nenhuma venda registrada.</p>';
            }
            
            return recentes.map(venda => {
                // Calcular lucro por quilômetro - buscar distância do cliente
                const lucroVenda = venda.valor - (venda.custo || 0);
                const cliente = sistemData.clientes.find(c => c.empresa === venda.cliente);
                const distanciaKm = cliente ? cliente.distancia || 0 : 0;
                const lucroPorKm = distanciaKm > 0 ? lucroVenda / distanciaKm : 0;
                
                const lucroKmClass = lucroPorKm > 5 ? 'text-green-600' : 
                                   lucroPorKm > 2 ? 'text-yellow-600' : 'text-red-600';
                                   
                const lucroKmDisplay = distanciaKm > 0 ? 
                    `L/KM: R$ ${lucroPorKm.toFixed(2)}` : 
                    'L/KM: N/A';
                
                return `<div class="flex justify-between items-center p-3 bg-white rounded border hover:shadow-md transition-shadow">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${venda.cliente}</div>
                        <div class="flex items-center space-x-4 mt-1">
                            <span class="text-xs font-semibold ${lucroKmClass} bg-gray-100 px-2 py-1 rounded">
                                💰 ${lucroKmDisplay}
                            </span>
                            <span class="text-xs text-gray-500">
                                📍 ${distanciaKm > 0 ? distanciaKm + 'km' : 'Dist. não definida'}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-green-600 font-bold">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div class="text-xs text-gray-500">${new Date(venda.data).toLocaleDateString('pt-BR')}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // Minérios
        function getMineriosTable() {
            if (sistemData.minerios.length === 0) {
                return `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">⛏️</div>
                        <div class="font-semibold mb-2">Nenhum minério cadastrado</div>
                        <div class="text-sm">Clique em "Novo Minério" para começar</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.minerios.map((minerio, index) => {
                // Calcular custo por m³: custo/t * densidade
                const custoM3 = minerio.preco * minerio.densidade;
                
                return `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center text-white mr-3">
                                ⛏️
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">${minerio.tipo}</div>
                                <div class="text-sm text-gray-500">${getCategoriaLabel(minerio.categoria)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${minerio.densidade.toLocaleString()}</div>
                        <div class="text-sm text-gray-500">t/m³</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-green-600 text-lg">R$ ${minerio.preco.toFixed(2)}</div>
                        <div class="text-sm text-gray-500">por tonelada</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-blue-600 text-lg">R$ ${custoM3.toFixed(2)}</div>
                        <div class="text-sm text-gray-500">por m³</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getCategoriaClass(minerio.categoria)}">
                            ${getCategoriaIcon(minerio.categoria)} ${getCategoriaLabel(minerio.categoria)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="editMinerio(${index})" class="btn-primary !py-2 !px-3 text-sm">
                                ✏️ Editar
                            </button>
                            <button onclick="deleteMinerio(${index})" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm transition-all duration-200">
                                🗑️ Excluir
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }
        
        function getCategoriaClass(categoria) {
            const classes = {
                'metalico': 'bg-blue-100 text-blue-800',
                'nao-metalico': 'bg-green-100 text-green-800',
                'energetico': 'bg-yellow-100 text-yellow-800'
            };
            return classes[categoria] || 'bg-gray-100 text-gray-800';
        }
        
        function getCategoriaIcon(categoria) {
            const icons = {
                'metalico': '🏭',
                'nao-metalico': '🏗️',
                'energetico': '⚡'
            };
            return icons[categoria] || '📦';
        }

        function getCategoriaLabel(categoria) {
            const labels = {
                'metalico': 'Metálico',
                'nao-metalico': 'Não-Metálico',
                'energetico': 'Energético'
            };
            return labels[categoria] || categoria;
        }

        // Clientes
        function getClientesTable() {
            if (sistemData.clientes.length === 0) {
                return `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">👥</div>
                        <div class="font-semibold mb-2">Nenhum cliente cadastrado</div>
                        <div class="text-sm">Clique em "Novo Cliente" para começar</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.clientes.map((cliente, index) => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-500 rounded-lg flex items-center justify-center text-white mr-3">
                                ${cliente.empresa.substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">${cliente.empresa}</div>
                                <div class="text-sm text-gray-500">${cliente.status || 'Ativo'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-mono text-gray-900">${cliente.cnpj}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-gray-900">${cliente.telefone}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <span class="text-blue-600 mr-1">📍</span>
                            <span class="text-gray-900">${cliente.bairro}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getDistanciaClass(cliente.distancia)}">
                            🚚 ${cliente.distancia} km
                        </span>
                        ${cliente.pedagios ? 
                            `<div class="text-xs text-orange-600 mt-1">🛣️ ${cliente.pedagios} pedágio(s)</div>` : 
                            ''}
                        ${cliente.precosEspecificos && Object.keys(cliente.precosEspecificos).length > 0 ? 
                            `<div class="text-xs text-gray-500 mt-1">💎 ${Object.keys(cliente.precosEspecificos).length} preço(s) específico(s)</div>` : 
                            ''}
                    </td>
                    <td class="px-2 py-2 text-center">
                        <div class="flex flex-col space-y-1 md:flex-row md:items-center md:justify-center md:space-y-0 md:space-x-1">
                            <button onclick="editCliente(${index})" class="btn-primary table-mobile-btn md:!py-1 md:!px-2 md:text-xs">
                                ✏️ Editar
                            </button>
                            ${cliente.precosEspecificos && Object.keys(cliente.precosEspecificos).length > 0 ? 
                                `<button onclick="atualizarPrecosCliente(${index})" class="bg-blue-500 hover:bg-blue-600 text-white table-mobile-btn md:py-1 md:px-2 md:rounded md:text-xs transition-all duration-200">
                                    🔄 Preços
                                </button>` : 
                                ''}
                            <button onclick="deleteCliente(${index})" class="bg-red-500 hover:bg-red-600 text-white table-mobile-btn md:py-1 md:px-2 md:rounded md:text-xs transition-all duration-200">
                                🗑️ Excluir
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function getDistanciaClass(distancia) {
            if (distancia <= 20) return 'bg-green-100 text-green-800';
            if (distancia <= 50) return 'bg-yellow-100 text-yellow-800';
            return 'bg-orange-100 text-orange-800';
        }

        // Motoristas
        function getMotoristasTable() {
            if (sistemData.motoristas.length === 0) {
                return `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">👨‍✈️</div>
                        <div class="font-semibold mb-2">Nenhum motorista cadastrado</div>
                        <div class="text-sm">Clique em "Novo Motorista" para começar</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.motoristas.map((motorista, index) => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-yellow-500 rounded-full flex items-center justify-center text-white mr-3">
                                ${motorista.nome.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">${motorista.nome}</div>
                                <div class="text-sm text-gray-500">${motorista.status || 'Ativo'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-mono text-gray-900">${motorista.cpf}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-gray-900">${motorista.telefone}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getCnhClass(motorista.cnh)}">
                            ${getCnhIcon(motorista.cnh)} ${motorista.cnh}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getVencimentoClass(motorista.vencimentoCnh)}">
                            ${formatDateWithStatus(motorista.vencimentoCnh)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getVencimentoClass(motorista.vencimentoToxicologico)}">
                            ${formatDateWithStatus(motorista.vencimentoToxicologico)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="editMotorista(${index})" class="btn-primary !py-2 !px-3 text-sm">
                                ✏️ Editar
                            </button>
                            <button onclick="deleteMotorista(${index})" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm transition-all duration-200">
                                🗑️ Excluir
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function getCnhClass(cnh) {
            if (cnh.includes('E') || cnh.includes('D')) return 'bg-green-100 text-green-800';
            if (cnh.includes('C')) return 'bg-blue-100 text-blue-800';
            if (cnh.includes('B')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-purple-100 text-purple-800';
        }
        
        function getCnhIcon(cnh) {
            if (cnh.includes('E')) return '🚛';
            if (cnh.includes('D')) return '🚌';
            if (cnh.includes('C')) return '🚚';
            if (cnh.includes('B')) return '🚗';
            if (cnh.includes('A')) return '🏍️';
            return '📄';
        }
        
        function getVencimentoClass(dataVencimento) {
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);
            const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
            
            if (diasParaVencimento < 0) return 'status-vencida-badge';
            if (diasParaVencimento <= 30) return 'status-atencao-badge';
            return 'status-valida-badge';
        }

        // Veículos
        function getVeiculosTable() {
            if (sistemData.veiculos.length === 0) {
                return `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">🚚</div>
                        <div class="font-semibold mb-2">Nenhum veículo cadastrado</div>
                        <div class="text-sm">Clique em "Novo Veículo" para começar</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.veiculos.map((veiculo, index) => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-teal-600 rounded-lg flex items-center justify-center text-white mr-3">
                                🚚
                            </div>
                            <div>
                                <div class="font-mono font-bold text-gray-900">${veiculo.placa}</div>
                                <div class="text-sm text-gray-500">Placa</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${veiculo.modelo}</div>
                        <div class="text-sm text-gray-500">Caminhão</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-blue-600">${veiculo.tara.toLocaleString()} kg</div>
                        <div class="text-sm text-gray-500">Peso vazio</div>
                    </td>
                    <td class="px-6 py-4">
                        ${veiculo.consumo ? 
                            `<div class="font-bold text-green-600">${veiculo.consumo.toLocaleString('pt-BR', {minimumFractionDigits: 1})} km/L</div>
                             <div class="text-sm text-gray-500">⛽ Consumo</div>` :
                            `<span class="text-gray-400 italic">Não informado</span>`
                        }
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                ${veiculo.motoristaVinculado ? 
                                    `<div class="font-semibold text-gray-900">${veiculo.motoristaVinculado}</div>
                                     <div class="text-sm text-gray-500">Motorista atual</div>` :
                                    `<span class="text-gray-400 italic">Sem motorista</span>`
                                }
                            </div>
                            <button onclick="changeMotorista(${index})" class="btn-secondary !py-1 !px-2 text-xs">
                                🔄
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getStatusVeiculoClass(veiculo.status)}">
                            ${getStatusVeiculoIcon(veiculo.status)} ${getStatusVeiculoLabel(veiculo.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="editVeiculo(${index})" class="btn-primary !py-2 !px-3 text-sm">
                                ✏️ Editar
                            </button>
                            <button onclick="deleteVeiculo(${index})" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm transition-all duration-200">
                                🗑️ Excluir
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function getStatusVeiculoIcon(status) {
            const icons = {
                'disponivel': '✅',
                'em_uso': '🔄',
                'manutencao': '🔧',
                'inativo': '⏸️'
            };
            return icons[status] || '❓';
        }

        // Vendas
        function getVendasTable() {
            if (sistemData.vendas.length === 0) {
                return `<tr><td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                    Nenhuma venda registrada. Clique em "Nova Venda" para começar.
                </td></tr>`;
            }
            
            return sistemData.vendas.map((venda, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-300 px-4 py-2">${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                    <td class="border border-gray-300 px-4 py-2">${venda.cliente}</td>
                    <td class="border border-gray-300 px-4 py-2 hide-small-mobile">${venda.material}</td>
                    <td class="border border-gray-300 px-4 py-2">${venda.quantidade} t</td>
                    <td class="border border-gray-300 px-4 py-2 font-semibold text-green-600">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="border border-gray-300 px-4 py-2 hide-small-mobile">${getPagamentoLabel(venda.tipoPagamento)}</td>
                    <td class="border border-gray-300 px-4 py-2 font-mono text-sm hide-small-mobile">${venda.veiculo}</td>
                    <td class="border border-gray-300 px-2 py-2 text-center">
                        <div class="flex gap-1 justify-center">
                            <button onclick="editVenda(${index})" class="bg-blue-500 hover:bg-blue-600 text-white table-mobile-btn md:px-2 md:py-1 md:rounded md:text-xs transition-all duration-200">
                                ✏️ Editar
                            </button>
                            <button onclick="deleteVenda(${index})" class="bg-red-500 hover:bg-red-600 text-white table-mobile-btn md:px-2 md:py-1 md:rounded md:text-xs transition-all duration-200">
                                🗑️ Excluir
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getTotalReceita() {
            return sistemData.vendas.reduce((total, venda) => total + venda.valor, 0);
        }

        function getTicketMedio() {
            if (sistemData.vendas.length === 0) return 0;
            return getTotalReceita() / sistemData.vendas.length;
        }

        function getTotalQuantidade() {
            return sistemData.vendas.reduce((total, venda) => total + venda.quantidade, 0);
        }

        function getVendasTablePremium() {
            if (sistemData.vendas.length === 0) {
                return `<tr><td colspan="9" class="px-6 py-8 text-center text-purple-200">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-2">💎</div>
                        <div>Nenhuma venda registrada ainda</div>
                        <div class="text-sm opacity-75">Clique em "Nova Venda" para começar</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.vendas.map((venda, index) => {
                const statusClass = getStatusPagamento(venda);
                const statusText = getStatusPagamentoText(venda);
                
                // Calcular lucro por quilômetro - buscar distância do cliente
                const lucroVenda = venda.valor - (venda.custo || 0); // Lucro = Valor da venda - Custo
                const cliente = sistemData.clientes.find(c => c.empresa === venda.cliente);
                const distanciaKm = cliente ? cliente.distancia || 0 : 0;
                const lucroPorKm = distanciaKm > 0 ? lucroVenda / distanciaKm : 0;
                
                const lucroKmClass = lucroPorKm > 5 ? 'text-green-300' : 
                                   lucroPorKm > 2 ? 'text-yellow-300' : 'text-red-300';
                                   
                const lucroKmDisplay = distanciaKm > 0 ? 
                    `R$ ${lucroPorKm.toFixed(2)}` : 
                    '<span class="text-gray-400 text-xs">N/A</span>';
                
                return `<tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 border-b border-white/10">${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                    <td class="px-6 py-4 border-b border-white/10">${venda.cliente}</td>
                    <td class="px-6 py-4 border-b border-white/10">${venda.material}</td>
                    <td class="px-6 py-4 border-b border-white/10">${venda.quantidade} t</td>
                    <td class="px-6 py-4 border-b border-white/10 font-bold text-yellow-300">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 border-b border-white/10 font-bold ${lucroKmClass}" title="Lucro: R$ ${lucroVenda.toFixed(2)} / Distância: ${distanciaKm}km">${lucroKmDisplay}</td>
                    <td class="px-6 py-4 border-b border-white/10">${getPagamentoIcon(venda.tipoPagamento)}</td>
                    <td class="px-6 py-4 border-b border-white/10">
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 border-b border-white/10 text-center">
                        <div class="flex gap-2 justify-center">
                            <button onclick="editVenda(${index})" class="bg-blue-500/20 hover:bg-blue-500/40 text-blue-300 px-3 py-1 rounded-lg text-xs transition-colors">
                                ✏️ Editar
                            </button>
                            <button onclick="deleteVenda(${index})" class="bg-red-500/20 hover:bg-red-500/40 text-red-300 px-3 py-1 rounded-lg text-xs transition-colors">
                                🗑️ Excluir
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function getStatusPagamento(venda) {
            if (venda.pago) return 'bg-green-500/30 text-green-300';
            if (venda.tipoPagamento === 'a_prazo') {
                if (venda.dataVencimento && new Date(venda.dataVencimento) < new Date()) {
                    return 'bg-red-500/30 text-red-300';
                }
                return 'bg-yellow-500/30 text-yellow-300';
            }
            return 'bg-green-500/30 text-green-300';
        }

        function getStatusPagamentoText(venda) {
            if (venda.pago) return '✅ Pago';
            if (venda.tipoPagamento === 'a_prazo') {
                if (venda.dataVencimento && new Date(venda.dataVencimento) < new Date()) {
                    return '🚨 Vencido';
                }
                return '⏰ Pendente';
            }
            return '✅ Pago';
        }

        function getPagamentoIcon(tipo) {
            const icons = {
                'pix': '📱 PIX',
                'dinheiro': '💵 Dinheiro',
                'cheque': '📝 Cheque',
                'a_prazo': '⏰ A Prazo'
            };
            return icons[tipo] || tipo;
        }

        // Estoque
        function getTotalCreditos() {
            return sistemData.estoque.movimentacoes
                .filter(mov => mov.tipo === 'credito')
                .reduce((total, mov) => total + mov.valor, 0);
        }

        function getTotalDebitos() {
            return sistemData.estoque.movimentacoes
                .filter(mov => mov.tipo === 'debito')
                .reduce((total, mov) => total + mov.valor, 0);
        }

        function getEstoqueMovimentacoes() {
            if (sistemData.estoque.movimentacoes.length === 0) {
                return `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">📦</div>
                        <div class="font-semibold mb-2">Nenhuma movimentação registrada</div>
                        <div class="text-sm">Comece adicionando créditos ao estoque</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.estoque.movimentacoes.slice().reverse().map(mov => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${new Date(mov.data).toLocaleDateString('pt-BR')}</div>
                        <div class="text-sm text-gray-500">${new Date(mov.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${mov.tipo === 'credito' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${mov.tipo === 'credito' ? '📈 Crédito' : '📉 Débito'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-lg ${mov.tipo === 'credito' ? 'text-green-600' : 'text-red-600'}">
                            ${mov.tipo === 'credito' ? '+' : '-'} R$ ${mov.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-700">R$ ${mov.saldoAnterior.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-blue-600">R$ ${mov.saldoNovo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-gray-700">${mov.observacoes}</div>
                        <div class="text-xs text-gray-500 mt-1">Origem: ${getOrigemLabel(mov.origem)}</div>
                    </td>
                </tr>
            `).join('');
        }
        
        function getOrigemLabel(origem) {
            const origens = {
                'credito_manual': 'Adição manual',
                'venda': 'Saída por venda',
                'exclusao_venda': 'Devolução por exclusão'
            };
            return origens[origem] || origem;
        }

        // Despesas
        function getTotalDespesas() {
            return sistemData.despesas.reduce((total, despesa) => total + despesa.valor, 0);
        }

        function getDespesasMes() {
            const agora = new Date();
            const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
            
            return sistemData.despesas
                .filter(despesa => new Date(despesa.data) >= inicioMes)
                .reduce((total, despesa) => total + despesa.valor, 0);
        }

        function getDespesasPorTipo(tipo) {
            return sistemData.despesas
                .filter(despesa => despesa.tipo === tipo)
                .reduce((total, despesa) => total + despesa.valor, 0);
        }

        function getDespesasTable() {
            if (sistemData.despesas.length === 0) {
                return `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">💸</div>
                        <div class="font-semibold mb-2">Nenhuma despesa registrada</div>
                        <div class="text-sm">Clique em "Nova Despesa" para começar</div>
                    </div>
                </td></tr>`;
            }
            
            return sistemData.despesas.slice().reverse().map((despesa, index) => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${new Date(despesa.data).toLocaleDateString('pt-BR')}</div>
                        <div class="text-sm text-gray-500">${new Date(despesa.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${getTipoDespesaClass(despesa.tipo)}">
                            ${getTipoLabel(despesa.tipo)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        ${despesa.veiculo ? 
                            `<div class="flex items-center">
                                <span class="text-green-600 mr-1">🚚</span>
                                <span class="font-mono text-gray-900">${despesa.veiculo}</span>
                            </div>` :
                            `<span class="text-gray-400 italic flex items-center">
                                <span class="mr-1">🏢</span>
                                Despesa geral
                            </span>`
                        }
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-red-600 text-lg">R$ ${despesa.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-gray-700">${despesa.observacoes || 'Sem observações'}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteDespesa(${sistemData.despesas.length - 1 - index})" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm transition-all duration-200">
                            🗑️ Excluir
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function getTipoDespesaClass(tipo) {
            const classes = {
                'combustivel': 'bg-yellow-100 text-yellow-800',
                'manutencao': 'bg-purple-100 text-purple-800',
                'pecas': 'bg-indigo-100 text-indigo-800',
                'pneus': 'bg-orange-100 text-orange-800',
                'seguro': 'bg-blue-100 text-blue-800',
                'ipva': 'bg-green-100 text-green-800',
                'multa': 'bg-red-100 text-red-800',
                'pedagio': 'bg-cyan-100 text-cyan-800',
                'lavagem': 'bg-teal-100 text-teal-800',
                'estacionamento': 'bg-gray-100 text-gray-800',
                'outros': 'bg-pink-100 text-pink-800'
            };
            return classes[tipo] || 'bg-gray-100 text-gray-800';
        }
        
        function getDespesasPorCategoria(tipos) {
            return sistemData.despesas
                .filter(despesa => tipos.includes(despesa.tipo))
                .reduce((total, despesa) => total + despesa.valor, 0);
        }

        function getTipoLabel(tipo) {
            const tipos = {
                'combustivel': '🛢️ Combustível',
                'manutencao': '🔧 Manutenção',
                'pecas': '⚙️ Peças',
                'pneus': '🛞 Pneus',
                'seguro': '🛡️ Seguro',
                'ipva': '📋 IPVA',
                'multa': '🚨 Multa',
                'pedagio': '💰 Pedágio',
                'lavagem': '🧽 Lavagem',
                'estacionamento': '🅿️ Estacionamento',
                'outros': '📝 Outros'
            };
            return tipos[tipo] || tipo;
        }

        // Financeiro
        function getFinanceiroContent() {
            const dias = parseInt(document.getElementById('filtroPeriodo')?.value || 30);
            const dataLimite = new Date();
            dataLimite.setDate(dataLimite.getDate() - dias);
            
            const vendasFiltradas = sistemData.vendas.filter(v => new Date(v.data) >= dataLimite);
            const despesasFiltradas = sistemData.despesas.filter(d => new Date(d.data) >= dataLimite);
            
            const receitas = vendasFiltradas.reduce((total, v) => total + v.valor, 0);
            const despesas = despesasFiltradas.reduce((total, d) => total + d.valor, 0);
            const custoMateriais = vendasFiltradas.reduce((total, v) => {
                const minerio = sistemData.minerios.find(m => m.tipo === v.material);
                return total + (minerio ? minerio.preco * v.quantidade : 0);
            }, 0);
            
            const lucroLiquido = receitas - despesas - custoMateriais;
            const margemLucro = receitas > 0 ? (lucroLiquido / receitas) * 100 : 0;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Receitas</h3>
                        <p class="text-3xl font-bold">R$ ${receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        <p class="text-sm opacity-90 mt-2">${vendasFiltradas.length} vendas</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Despesas</h3>
                        <p class="text-3xl font-bold">R$ ${despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        <p class="text-sm opacity-90 mt-2">${despesasFiltradas.length} lançamentos</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Lucro Líquido</h3>
                        <p class="text-3xl font-bold">R$ ${lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        <p class="text-sm opacity-90 mt-2">${lucroLiquido >= 0 ? '📈 Positivo' : '📉 Negativo'}</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Margem</h3>
                        <p class="text-3xl font-bold">${margemLucro.toFixed(1)}%</p>
                        <p class="text-sm opacity-90 mt-2">${margemLucro >= 20 ? '✅ Boa' : margemLucro >= 10 ? '⚠️ Razoável' : '❌ Baixa'}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">📊 Gráfico de Receitas vs Despesas</h3>
                        <canvas id="chartReceitas" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">🥧 Distribuição de Despesas</h3>
                        <canvas id="chartDespesas" width="400" height="200"></canvas>
                    </div>
                </div>
            `;
        }

        function renderFinanceiroCharts() {
            // Gráfico de Receitas vs Despesas
            const ctxReceitas = document.getElementById('chartReceitas');
            if (ctxReceitas) {
                new Chart(ctxReceitas, {
                    type: 'line',
                    data: {
                        labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
                        datasets: [{
                            label: 'Receitas',
                            data: [12000, 19000, 15000, 22000],
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.1
                        }, {
                            label: 'Despesas',
                            data: [8000, 12000, 10000, 14000],
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Gráfico de Distribuição de Despesas
            const ctxDespesas = document.getElementById('chartDespesas');
            if (ctxDespesas) {
                new Chart(ctxDespesas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Combustível', 'Manutenção', 'IPVA/Seguro', 'Outros'],
                        datasets: [{
                            data: [40, 30, 20, 10],
                            backgroundColor: [
                                'rgb(245, 158, 11)',
                                'rgb(139, 69, 19)',
                                'rgb(59, 130, 246)',
                                'rgb(156, 163, 175)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            }
        }
        
        // Gráficos da Dashboard
        function renderDashboardCharts() {
            // Obter período selecionado
            const periodo = parseInt(document.getElementById('filtroPeriodoDashboard')?.value || 30);
            const dataLimite = new Date();
            dataLimite.setDate(dataLimite.getDate() - periodo);
            
            // Filtrar dados
            const vendasPeriodo = sistemData.vendas.filter(v => new Date(v.data) >= dataLimite);
            const despesasPeriodo = sistemData.despesas.filter(d => new Date(d.data) >= dataLimite);
            
            // Gráfico Vendas vs Despesas
            const ctxVendasDespesas = document.getElementById('vendas-despesas-chart');
            if (ctxVendasDespesas) {
                // Agrupar por semanas
                const semanas = [];
                const vendasPorSemana = [];
                const despesasPorSemana = [];
                
                for (let i = periodo; i >= 0; i -= 7) {
                    const fimSemana = new Date();
                    const inicioSemana = new Date();
                    fimSemana.setDate(fimSemana.getDate() - i);
                    inicioSemana.setDate(inicioSemana.getDate() - i - 7);
                    
                    semanas.push(`Sem ${Math.floor((periodo - i) / 7) + 1}`);
                    
                    const vendasSemana = vendasPeriodo
                        .filter(v => new Date(v.data) >= inicioSemana && new Date(v.data) < fimSemana)
                        .reduce((total, v) => total + v.valor, 0);
                    
                    const despesasSemana = despesasPeriodo
                        .filter(d => new Date(d.data) >= inicioSemana && new Date(d.data) < fimSemana)
                        .reduce((total, d) => total + d.valor, 0);
                    
                    vendasPorSemana.push(vendasSemana);
                    despesasPorSemana.push(despesasSemana);
                }
                
                new Chart(ctxVendasDespesas, {
                    type: 'bar',
                    data: {
                        labels: semanas,
                        datasets: [{
                            label: 'Vendas',
                            data: vendasPorSemana,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 2
                        }, {
                            label: 'Despesas',
                            data: despesasPorSemana,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Vendas vs Despesas'
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico Vendas por Material
            const ctxMateriais = document.getElementById('vendas-material-chart');
            if (ctxMateriais) {
                // Agrupar vendas por material
                const materiaisMap = {};
                vendasPeriodo.forEach(venda => {
                    if (materiaisMap[venda.material]) {
                        materiaisMap[venda.material] += venda.valor;
                    } else {
                        materiaisMap[venda.material] = venda.valor;
                    }
                });
                
                const materiais = Object.keys(materiaisMap);
                const valores = Object.values(materiaisMap);
                const cores = [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(20, 184, 166, 0.8)',
                    'rgba(251, 113, 133, 0.8)',
                    'rgba(156, 163, 175, 0.8)'
                ];
                
                new Chart(ctxMateriais, {
                    type: 'doughnut',
                    data: {
                        labels: materiais.map(m => m || 'Não especificado'),
                        datasets: [{
                            data: valores,
                            backgroundColor: cores.slice(0, materiais.length),
                            borderColor: cores.slice(0, materiais.length).map(c => c.replace('0.8', '1')),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribuição por Material'
                            },
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': R$ ' + value.toLocaleString('pt-BR') + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funções de Cobranças
        function getTotalPendente() {
            return sistemData.vendas
                .filter(v => v.tipoPagamento === 'a_prazo' && !v.pago)
                .reduce((total, v) => total + v.valor, 0);
        }

        function getQuantidadePendente() {
            return sistemData.vendas
                .filter(v => v.tipoPagamento === 'a_prazo' && !v.pago)
                .length;
        }

        function getTotalRecebido() {
            const inicioMes = new Date();
            inicioMes.setDate(1);
            
            return sistemData.vendas
                .filter(v => v.pago && new Date(v.dataPagamento || v.data) >= inicioMes)
                .reduce((total, v) => total + v.valor, 0);
        }

        function getTotalAtrasado() {
            return sistemData.vendas
                .filter(v => {
                    if (v.tipoPagamento === 'a_prazo' && !v.pago && v.dataVencimento) {
                        return new Date(v.dataVencimento) < new Date();
                    }
                    return false;
                })
                .reduce((total, v) => total + v.valor, 0);
        }

        function getQuantidadeAtrasado() {
            return sistemData.vendas
                .filter(v => {
                    if (v.tipoPagamento === 'a_prazo' && !v.pago && v.dataVencimento) {
                        return new Date(v.dataVencimento) < new Date();
                    }
                    return false;
                })
                .length;
        }

        function getCobrancasTable() {
            const vendasPendentes = sistemData.vendas.filter(v => 
                v.tipoPagamento === 'a_prazo' && !v.pago
            );
            
            if (vendasPendentes.length === 0) {
                return `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="text-4xl mb-3">✅</div>
                        <div class="font-semibold mb-2">Nenhuma cobrança pendente</div>
                        <div class="text-sm">Todos os pagamentos estão em dia!</div>
                    </div>
                </td></tr>`;
            }
            
            return vendasPendentes.map((venda, index) => {
                const isVencida = venda.dataVencimento && new Date(venda.dataVencimento) < new Date();
                const diasAtraso = venda.dataVencimento ? 
                    Math.floor((new Date() - new Date(venda.dataVencimento)) / (1000 * 60 * 60 * 24)) : 0;
                
                return `<tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center text-white mr-3">
                                ${venda.cliente.substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">${venda.cliente}</div>
                                <div class="text-sm text-gray-500">Cliente</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${new Date(venda.data).toLocaleDateString('pt-BR')}</div>
                        <div class="text-sm text-gray-500">Data da venda</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-900">${venda.dataVencimento ? new Date(venda.dataVencimento).toLocaleDateString('pt-BR') : '-'}</div>
                        ${isVencida && diasAtraso > 0 ? 
                            `<div class="text-sm text-red-600">${diasAtraso} dias de atraso</div>` :
                            `<div class="text-sm text-gray-500">Prazo de pagamento</div>`
                        }
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-green-600 text-lg">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        <div class="text-sm text-gray-500">Valor total</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${isVencida ? 'status-vencida-badge' : 'status-atencao-badge'}">
                            ${isVencida ? '🚨 Vencida' : '⏰ Pendente'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="marcarComoPago(${sistemData.vendas.indexOf(venda)})" class="btn-primary !py-2 !px-3 text-sm">
                            ✅ Marcar Pago
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function getQuantidadeAVencer() {
            const proximos30Dias = new Date();
            proximos30Dias.setDate(proximos30Dias.getDate() + 30);
            
            return sistemData.vendas.filter(v => {
                if (v.tipoPagamento === 'a_prazo' && !v.pago && v.dataVencimento) {
                    const vencimento = new Date(v.dataVencimento);
                    const hoje = new Date();
                    return vencimento > hoje && vencimento <= proximos30Dias;
                }
                return false;
            }).length;
        }

        function atualizarFinanceiro() {
            const content = document.getElementById('financeiroContent');
            if (content) {
                content.innerHTML = getFinanceiroContent();
                setTimeout(() => renderFinanceiroCharts(), 100);
            }
        }

        // Funções de utilitários
        function getStatusClass(dataVencimento) {
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);
            const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
            
            if (diasParaVencimento < 0) return 'status-vencida';
            if (diasParaVencimento <= 30) return 'status-vence-logo';
            if (diasParaVencimento <= 90) return 'status-atencao';
            return 'status-valida';
        }

        function formatDateWithStatus(dataVencimento) {
            const data = new Date(dataVencimento).toLocaleDateString('pt-BR');
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);
            const diasParaVencimento = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
            
            if (diasParaVencimento < 0) return `${data} (VENCIDA)`;
            if (diasParaVencimento <= 30) return `${data} (${diasParaVencimento}d)`;
            if (diasParaVencimento <= 90) return `${data} (${diasParaVencimento}d)`;
            return data;
        }

        function getStatusVeiculoClass(status) {
            const classes = {
                'disponivel': 'bg-green-100 text-green-800',
                'em_uso': 'bg-blue-100 text-blue-800',
                'manutencao': 'bg-yellow-100 text-yellow-800',
                'inativo': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusVeiculoLabel(status) {
            const labels = {
                'disponivel': 'Disponível',
                'em_uso': 'Em Uso',
                'manutencao': 'Manutenção',
                'inativo': 'Inativo'
            };
            return labels[status] || status;
        }

        function getPagamentoLabel(tipo) {
            const labels = {
                'pix': 'PIX',
                'dinheiro': 'Dinheiro',
                'cheque': 'Cheque',
                'a_prazo': 'A Prazo'
            };
            return labels[tipo] || tipo;
        }

        // ===== MODAIS E FORMULÁRIOS =====

        // Modal Minérios
        window.openMinerioModal = function() {
            document.getElementById('minerioModal').classList.remove('hidden');
            document.getElementById('minerioModal').classList.add('flex');
            document.getElementById('minerioModalTitle').textContent = 'Adicionar Minério';
            document.getElementById('minerioForm').reset();
            delete document.getElementById('minerioForm').dataset.editing;
        };

        window.closeMinerioModal = function() {
            document.getElementById('minerioModal').classList.add('hidden');
            document.getElementById('minerioModal').classList.remove('flex');
        };

        window.editMinerio = function(index) {
            const minerio = sistemData.minerios[index];
            
            // Abrir modal sem resetar
            document.getElementById('minerioModal').classList.remove('hidden');
            document.getElementById('minerioModal').classList.add('flex');
            document.getElementById('minerioModalTitle').textContent = 'Editar Minério';
            document.getElementById('minerioForm').dataset.editing = index;
            
            // Preencher os campos
            document.getElementById('minerioTipo').value = minerio.tipo;
            document.getElementById('minerioDensidade').value = minerio.densidade;
            document.getElementById('minerioPreco').value = minerio.preco;
            document.getElementById('minerioCategoria').value = minerio.categoria;
        };

        window.deleteMinerio = function(index) {
            if (confirm('Tem certeza que deseja excluir este minério?')) {
                sistemData.minerios.splice(index, 1);
                saveData();
                showSection('minerios');
                showNotification('🗑️ Minério excluído com sucesso!', 'success');
            }
        };

        // Modal Clientes
        window.openClienteModal = function() {
            document.getElementById('clienteModal').classList.remove('hidden');
            document.getElementById('clienteModal').classList.add('flex');
            document.getElementById('clienteModalTitle').textContent = 'Adicionar Cliente';
            document.getElementById('clienteForm').reset();
            delete document.getElementById('clienteForm').dataset.editing;
            
            // Limpar preços específicos para novo cliente
            document.getElementById('precosClienteContainer').innerHTML = '';
        };

        window.closeClienteModal = function() {
            document.getElementById('clienteModal').classList.add('hidden');
            document.getElementById('clienteModal').classList.remove('flex');
        };

        window.editCliente = function(index) {
            const cliente = sistemData.clientes[index];
            
            // Abrir o modal primeiro (sem resetar)
            document.getElementById('clienteModal').classList.remove('hidden');
            document.getElementById('clienteModal').classList.add('flex');
            
            // Configurar para edição
            document.getElementById('clienteModalTitle').textContent = 'Editar Cliente';
            document.getElementById('clienteForm').dataset.editing = index;
            
            // Preencher os campos com os dados do cliente
            document.getElementById('clienteEmpresa').value = cliente.empresa;
            document.getElementById('clienteCnpj').value = cliente.cnpj;
            document.getElementById('clienteTelefone').value = cliente.telefone;
            document.getElementById('clienteBairro').value = cliente.bairro;
            document.getElementById('clienteDistancia').value = cliente.distancia;
            document.getElementById('clientePedagios').value = cliente.pedagios || 0;
            
            // Carregar preços específicos
            carregarPrecosCliente(cliente.precosEspecificos || {});
        };

        window.deleteCliente = function(index) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                sistemData.clientes.splice(index, 1);
                saveData();
                showSection('clientes');
                showNotification('🗑️ Cliente excluído com sucesso!', 'success');
            }
        };
        
        window.atualizarTodosPrecosClientes = function() {
            if (!confirm('Esta ação irá atualizar os preços de todos os clientes baseado nos custos atuais dos minérios + 30% de margem.\n\nDeseja continuar?')) {
                return;
            }
            
            let clientesAtualizados = 0;
            let precosAtualizados = 0;
            
            sistemData.clientes.forEach((cliente, clienteIndex) => {
                if (cliente.precosEspecificos && Object.keys(cliente.precosEspecificos).length > 0) {
                    let clienteAlterado = false;
                    
                    Object.keys(cliente.precosEspecificos).forEach(tipoMinerio => {
                        const minerio = sistemData.minerios.find(m => m.tipo === tipoMinerio);
                        if (minerio) {
                            const precoAtual = cliente.precosEspecificos[tipoMinerio];
                            
                            // Calcular novo preço com 30% de margem
                            const novoPrecoT = minerio.preco * 1.3;
                            
                            // Se é um objeto (formato novo)
                            if (typeof precoAtual === 'object' && precoAtual.unidade) {
                                if (precoAtual.unidade === 't') {
                                    // Atualizar preço em R$/t
                                    cliente.precosEspecificos[tipoMinerio].preco = novoPrecoT;
                                } else {
                                    // Atualizar preço em R$/m³
                                    const novoPrecoM3 = novoPrecoT * minerio.densidade;
                                    cliente.precosEspecificos[tipoMinerio].preco = novoPrecoM3;
                                }
                            } else {
                                // Formato antigo (assume R$/t)
                                cliente.precosEspecificos[tipoMinerio] = novoPrecoT;
                            }
                            
                            clienteAlterado = true;
                            precosAtualizados++;
                        }
                    });
                    
                    if (clienteAlterado) {
                        clientesAtualizados++;
                    }
                }
            });
            
            if (clientesAtualizados > 0) {
                saveData();
                showSection('clientes');
                showNotification(`🔄 Atualização concluída!\n${clientesAtualizados} cliente(s) e ${precosAtualizados} preço(s) atualizados`, 'success');
            } else {
                showNotification('ℹ️ Nenhum cliente com preços específicos encontrado', 'info');
            }
        };
        
        window.atualizarPrecosCliente = function(clienteIndex) {
            const cliente = sistemData.clientes[clienteIndex];
            
            if (!cliente.precosEspecificos || Object.keys(cliente.precosEspecificos).length === 0) {
                showNotification('ℹ️ Este cliente não possui preços específicos', 'info');
                return;
            }
            
            const nomeCliente = cliente.empresa;
            const quantidadePrecos = Object.keys(cliente.precosEspecificos).length;
            
            if (!confirm(`Atualizar ${quantidadePrecos} preço(s) específico(s) do cliente "${nomeCliente}"?\n\nOs preços serão baseados nos custos atuais + 30% de margem.`)) {
                return;
            }
            
            let precosAtualizados = 0;
            
            Object.keys(cliente.precosEspecificos).forEach(tipoMinerio => {
                const minerio = sistemData.minerios.find(m => m.tipo === tipoMinerio);
                if (minerio) {
                    const precoAtual = cliente.precosEspecificos[tipoMinerio];
                    
                    // Calcular novo preço com 30% de margem
                    const novoPrecoT = minerio.preco * 1.3;
                    
                    // Se é um objeto (formato novo)
                    if (typeof precoAtual === 'object' && precoAtual.unidade) {
                        if (precoAtual.unidade === 't') {
                            // Atualizar preço em R$/t
                            cliente.precosEspecificos[tipoMinerio].preco = novoPrecoT;
                        } else {
                            // Atualizar preço em R$/m³
                            const novoPrecoM3 = novoPrecoT * minerio.densidade;
                            cliente.precosEspecificos[tipoMinerio].preco = novoPrecoM3;
                        }
                    } else {
                        // Formato antigo (assume R$/t)
                        cliente.precosEspecificos[tipoMinerio] = novoPrecoT;
                    }
                    
                    precosAtualizados++;
                }
            });
            
            if (precosAtualizados > 0) {
                saveData();
                showSection('clientes');
                showNotification(`🔄 Preços do cliente "${nomeCliente}" atualizados!\n${precosAtualizados} preço(s) atualizado(s)`, 'success');
            }
        };
        
        // Funções para preços de minério por cliente
        window.adicionarPrecoMinerio = function() {
            const container = document.getElementById('precosClienteContainer');
            const index = container.children.length;
            
            const precoDiv = document.createElement('div');
            precoDiv.className = 'flex gap-2 items-center p-3 bg-gray-50 rounded-lg';
            precoDiv.innerHTML = `
                <select class="flex-1 px-2 py-1 text-sm text-black border border-gray-300 rounded" data-field="tipo">
                    <option value="">Selecione o minério...</option>
                    ${sistemData.minerios.map(m => `<option value="${m.tipo}">${m.tipo}</option>`).join('')}
                </select>
                <input type="number" step="0.01" placeholder="Preço (R$)" class="w-24 px-2 py-1 text-sm text-black border border-gray-300 rounded" data-field="preco">
                <select class="w-16 px-2 py-1 text-sm text-black border border-gray-300 rounded" data-field="unidade">
                    <option value="t">R$/t</option>
                    <option value="m3">R$/m³</option>
                </select>
                <button type="button" onclick="removerPrecoMinerio(this)" class="text-red-500 hover:text-red-700 text-sm px-2 py-1">
                    🗑️
                </button>
            `;
            
            container.appendChild(precoDiv);
        };
        
        window.removerPrecoMinerio = function(button) {
            button.parentElement.remove();
        };
        
        window.carregarPrecosCliente = function(precosEspecificos) {
            const container = document.getElementById('precosClienteContainer');
            container.innerHTML = '';
            
            if (precosEspecificos && Object.keys(precosEspecificos).length > 0) {
                Object.entries(precosEspecificos).forEach(([tipo, dados]) => {
                    adicionarPrecoMinerio();
                    const ultimoItem = container.lastElementChild;
                    ultimoItem.querySelector('[data-field="tipo"]').value = tipo;
                    
                    // Se dados é um número (formato antigo), assume R$/t
                    if (typeof dados === 'number') {
                        ultimoItem.querySelector('[data-field="preco"]').value = dados;
                        ultimoItem.querySelector('[data-field="unidade"]').value = 't';
                    } else {
                        // Formato novo com unidade
                        ultimoItem.querySelector('[data-field="preco"]').value = dados.preco || dados;
                        ultimoItem.querySelector('[data-field="unidade"]').value = dados.unidade || 't';
                    }
                });
            }
        };
        
        window.coletarPrecosCliente = function() {
            const container = document.getElementById('precosClienteContainer');
            const precos = {};
            
            Array.from(container.children).forEach(div => {
                const tipo = div.querySelector('[data-field="tipo"]').value;
                const preco = parseFloat(div.querySelector('[data-field="preco"]').value);
                const unidade = div.querySelector('[data-field="unidade"]').value;
                
                if (tipo && !isNaN(preco) && preco > 0) {
                    precos[tipo] = {
                        preco: preco,
                        unidade: unidade
                    };
                }
            });
            
            return precos;
        };

        // Modal Motoristas
        window.openMotoristaModal = function() {
            document.getElementById('motoristaModal').classList.remove('hidden');
            document.getElementById('motoristaModal').classList.add('flex');
            document.getElementById('motoristaModalTitle').textContent = 'Adicionar Motorista';
            document.getElementById('motoristaForm').reset();
            delete document.getElementById('motoristaForm').dataset.editing;
        };

        window.closeMotoristaModal = function() {
            document.getElementById('motoristaModal').classList.add('hidden');
            document.getElementById('motoristaModal').classList.remove('flex');
        };

        window.editMotorista = function(index) {
            const motorista = sistemData.motoristas[index];
            
            document.getElementById('motoristaNome').value = motorista.nome;
            document.getElementById('motoristaCpf').value = motorista.cpf;
            document.getElementById('motoristaTelefone').value = motorista.telefone;
            document.getElementById('motoristaCnh').value = motorista.cnh;
            document.getElementById('motoristaVencimentoCnh').value = motorista.vencimentoCnh;
            document.getElementById('motoristaVencimentoToxicologico').value = motorista.vencimentoToxicologico;
            
            document.getElementById('motoristaModalTitle').textContent = 'Editar Motorista';
            document.getElementById('motoristaForm').dataset.editing = index;
            
            openMotoristaModal();
        };

        window.deleteMotorista = function(index) {
            if (confirm('Tem certeza que deseja excluir este motorista?')) {
                sistemData.motoristas.splice(index, 1);
                saveData();
                showSection('motoristas');
                showNotification('🗑️ Motorista excluído com sucesso!', 'success');
            }
        };

        // Modal Veículos
        window.openVeiculoModal = function() {
            const motoristaSelect = document.getElementById('veiculoMotorista');
            motoristaSelect.innerHTML = '<option value="">Nenhum motorista</option>';
            
            sistemData.motoristas.forEach(motorista => {
                const option = document.createElement('option');
                option.value = motorista.nome;
                option.textContent = motorista.nome;
                motoristaSelect.appendChild(option);
            });
            
            document.getElementById('veiculoModal').classList.remove('hidden');
            document.getElementById('veiculoModal').classList.add('flex');
            document.getElementById('veiculoModalTitle').textContent = 'Adicionar Veículo';
            document.getElementById('veiculoForm').reset();
            delete document.getElementById('veiculoForm').dataset.editing;
        };

        window.closeVeiculoModal = function() {
            document.getElementById('veiculoModal').classList.add('hidden');
            document.getElementById('veiculoModal').classList.remove('flex');
        };

        window.editVeiculo = function(index) {
            const veiculo = sistemData.veiculos[index];
            
            // Primeiro abrir o modal para carregar as opções
            openVeiculoModal();
            
            // Depois preencher os campos
            setTimeout(() => {
                document.getElementById('veiculoPlaca').value = veiculo.placa;
                document.getElementById('veiculoModelo').value = veiculo.modelo;
                document.getElementById('veiculoTara').value = veiculo.tara;
                document.getElementById('veiculoConsumo').value = veiculo.consumo || '';
                document.getElementById('veiculoMotorista').value = veiculo.motoristaVinculado || '';
                
                document.getElementById('veiculoModalTitle').textContent = 'Editar Veículo';
                document.getElementById('veiculoForm').dataset.editing = index;
            }, 100);
        };

        window.deleteVeiculo = function(index) {
            if (confirm('Tem certeza que deseja excluir este veículo?')) {
                sistemData.veiculos.splice(index, 1);
                saveData();
                showSection('veiculos');
                showNotification('🗑️ Veículo excluído com sucesso!', 'success');
            }
        };

        window.changeMotorista = function(index) {
            const veiculo = sistemData.veiculos[index];
            const novoMotorista = prompt('Digite o nome do novo motorista (ou deixe vazio para remover):', veiculo.motoristaVinculado || '');
            
            if (novoMotorista !== null) {
                if (novoMotorista.trim() === '') {
                    veiculo.motoristaVinculado = null;
                } else {
                    const motoristaExiste = sistemData.motoristas.find(m => m.nome === novoMotorista.trim());
                    if (motoristaExiste) {
                        veiculo.motoristaVinculado = novoMotorista.trim();
                    } else {
                        alert('Motorista não encontrado!');
                        return;
                    }
                }
                
                saveData();
                showSection('veiculos');
                showNotification('🔄 Motorista atualizado com sucesso!', 'success');
            }
        };

        // Modal Vendas
        window.openVendaModal = function() {
            // Preencher dropdowns
            const clienteSelect = document.getElementById('vendaCliente');
            const materialSelect = document.getElementById('vendaMaterial');
            const veiculoSelect = document.getElementById('vendaVeiculo');
            
            clienteSelect.innerHTML = '<option value="">Selecione o cliente...</option>';
            materialSelect.innerHTML = '<option value="">Selecione o material...</option>';
            veiculoSelect.innerHTML = '<option value="">Selecione o veículo...</option>';
            
            sistemData.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.empresa;
                option.textContent = cliente.empresa;
                clienteSelect.appendChild(option);
            });
            
            sistemData.minerios.forEach(minerio => {
                const option = document.createElement('option');
                option.value = minerio.tipo;
                option.textContent = `${minerio.tipo} - R$ ${minerio.preco.toFixed(2)}/t`;
                materialSelect.appendChild(option);
            });
            
            sistemData.veiculos.forEach(veiculo => {
                const option = document.createElement('option');
                option.value = veiculo.placa;
                option.textContent = `${veiculo.placa} - ${veiculo.modelo}`;
                option.dataset.motorista = veiculo.motoristaVinculado || '';
                veiculoSelect.appendChild(option);
            });
            
            document.getElementById('vendaModal').classList.remove('hidden');
            document.getElementById('vendaModal').classList.add('flex');
            document.getElementById('vendaForm').reset();
            
            // Pré-selecionar data de hoje
            const hoje = new Date();
            const dataFormatada = hoje.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            document.getElementById('vendaData').value = dataFormatada;
        };

        window.closeVendaModal = function() {
            // Limpar estado de edição
            const form = document.getElementById('vendaForm');
            if (form.dataset.editing !== undefined) {
                delete form.dataset.editing;
                
                // Restaurar título original
                document.querySelector('#vendaModal h3').innerHTML = `
                    <span class="text-4xl mr-3">💎</span>
                    Nova Venda Premium
                `;
                
                // Restaurar texto do botão
                document.querySelector('#vendaModal button[type="submit"]').innerHTML = '🚀 Confirmar Venda';
            }
            
            document.getElementById('vendaModal').classList.add('hidden');
            document.getElementById('vendaModal').classList.remove('flex');
        };

        window.deleteVenda = function(index) {
            if (confirm('Tem certeza que deseja excluir esta venda?')) {
                const venda = sistemData.vendas[index];
                
                // Devolver valor ao estoque
                const minerio = sistemData.minerios.find(m => m.tipo === venda.material);
                if (minerio) {
                    const custoMaterial = minerio.preco * venda.quantidade;
                    adicionarMovimentacaoEstoque('credito', custoMaterial, sistemData.estoque.saldo, `Devolução por exclusão de venda - ${venda.cliente}`, 'exclusao_venda');
                }
                
                sistemData.vendas.splice(index, 1);
                saveData();
                showSection('vendas');
                showNotification('🗑️ Venda excluída e valor devolvido ao estoque!', 'success');
            }
        };
        
        window.editVenda = function(index) {
            const venda = sistemData.vendas[index];
            
            // Preencher dropdowns primeiro
            const clienteSelect = document.getElementById('vendaCliente');
            const materialSelect = document.getElementById('vendaMaterial');
            const veiculoSelect = document.getElementById('vendaVeiculo');
            
            clienteSelect.innerHTML = '<option value="">Selecione o cliente...</option>';
            materialSelect.innerHTML = '<option value="">Selecione o material...</option>';
            veiculoSelect.innerHTML = '<option value="">Selecione o veículo...</option>';
            
            sistemData.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.empresa;
                option.textContent = cliente.empresa;
                if (cliente.empresa === venda.cliente) option.selected = true;
                clienteSelect.appendChild(option);
            });
            
            sistemData.minerios.forEach(minerio => {
                const option = document.createElement('option');
                option.value = minerio.tipo;
                option.textContent = `${minerio.tipo} - R$ ${minerio.preco.toFixed(2)}/t`;
                if (minerio.tipo === venda.material) option.selected = true;
                materialSelect.appendChild(option);
            });
            
            sistemData.veiculos.forEach(veiculo => {
                const option = document.createElement('option');
                option.value = veiculo.placa;
                option.textContent = `${veiculo.placa} - ${veiculo.modelo}`;
                option.dataset.motorista = veiculo.motoristaVinculado || '';
                if (veiculo.placa === venda.veiculo) option.selected = true;
                veiculoSelect.appendChild(option);
            });
            
            // Preencher campos com dados da venda
            document.getElementById('vendaPesoPedreira').value = venda.pesoPedreira || '';
            document.getElementById('vendaPesoCliente').value = venda.pesoCliente || venda.quantidade || '';
            document.getElementById('vendaPrecoClienteM3').value = venda.precoClienteM3 || '';
            document.getElementById('vendaPagamento').value = venda.tipoPagamento || '';
            document.getElementById('vendaPrazoDias').value = venda.prazoDias || '';
            document.getElementById('vendaPedagios').value = venda.pedagios || '0';
            document.getElementById('vendaObservacoes').value = venda.observacoes || '';
            
            // Preencher data da venda
            if (venda.data) {
                const dataVenda = new Date(venda.data);
                const dataFormatada = dataVenda.toISOString().split('T')[0];
                document.getElementById('vendaData').value = dataFormatada;
            }
            
            // Mostrar campo de prazo se necessário
            if (venda.tipoPagamento === 'a_prazo') {
                document.getElementById('prazoDias').classList.remove('hidden');
            }
            
            // Marcar o formulário como edição
            const form = document.getElementById('vendaForm');
            form.dataset.editing = index;
            
            // Mudar título do modal
            document.querySelector('#vendaModal h3').innerHTML = `
                <span class="text-4xl mr-3">✏️</span>
                Editar Venda
            `;
            
            // Mudar texto do botão
            document.querySelector('#vendaModal button[type="submit"]').innerHTML = '💾 Salvar Alterações';
            
            // Abrir modal
            document.getElementById('vendaModal').classList.remove('hidden');
            document.getElementById('vendaModal').classList.add('flex');
            
            // Atualizar preview com dados carregados
            setTimeout(() => {
                if (typeof window.updateVendaCalculos === 'function') {
                    window.updateVendaCalculos();
                }
                if (typeof updateVendaPreview === 'function') {
                    updateVendaPreview();
                }
            }, 100);
        };

        // Modal Margem Global
        window.openMargemGlobalModal = function() {
            // Carregar valores atuais das configurações
            const configuracoes = sistemData.configuracoes || {};
            const margemConfig = configuracoes.margem || {
                padrao: 30.0,
                minima: 10.0,
                maxima: 100.0
            };
            
            document.getElementById('margemPadrao').value = margemConfig.padrao || 30.0;
            document.getElementById('margemMinima').value = margemConfig.minima || 10.0;
            document.getElementById('margemMaxima').value = margemConfig.maxima || 100.0;
            
            document.getElementById('margemGlobalModal').classList.remove('hidden');
            document.getElementById('margemGlobalModal').classList.add('flex');
        };

        window.closeMargemGlobalModal = function() {
            document.getElementById('margemGlobalModal').classList.add('hidden');
            document.getElementById('margemGlobalModal').classList.remove('flex');
        };

        // Modal Estoque
        window.openEstoqueModal = function() {
            document.getElementById('estoqueModal').classList.remove('hidden');
            document.getElementById('estoqueModal').classList.add('flex');
            document.getElementById('estoqueForm').reset();
        };

        window.closeEstoqueModal = function() {
            document.getElementById('estoqueModal').classList.add('hidden');
            document.getElementById('estoqueModal').classList.remove('flex');
        };

        // Modal Configuração de Alerta de Estoque
        window.openEstoqueAlertaModal = function() {
            // Preencher com valores atuais
            document.getElementById('estoqueMinimo').value = sistemData.configuracoes.estoqueMinimo || 10000;
            document.getElementById('tipoAlerta').value = sistemData.configuracoes.tipoAlerta || 'atencao';
            document.getElementById('alertaObservacoes').value = sistemData.configuracoes.alertaObservacoes || '';
            document.getElementById('estoqueAtualInfo').textContent = sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            
            document.getElementById('estoqueAlertaModal').classList.remove('hidden');
            document.getElementById('estoqueAlertaModal').classList.add('flex');
        };

        window.closeEstoqueAlertaModal = function() {
            document.getElementById('estoqueAlertaModal').classList.add('hidden');
            document.getElementById('estoqueAlertaModal').classList.remove('flex');
        };

        // Modal Despesas
        window.openDespesaModal = function() {
            const veiculoSelect = document.getElementById('despesaVeiculo');
            veiculoSelect.innerHTML = '<option value="">Despesa geral</option>';
            
            sistemData.veiculos.forEach(veiculo => {
                const option = document.createElement('option');
                option.value = veiculo.placa;
                option.textContent = `${veiculo.placa} - ${veiculo.modelo}`;
                veiculoSelect.appendChild(option);
            });
            
            document.getElementById('despesaModal').classList.remove('hidden');
            document.getElementById('despesaModal').classList.add('flex');
            document.getElementById('despesaModalTitle').textContent = 'Adicionar Despesa';
            document.getElementById('despesaForm').reset();
            delete document.getElementById('despesaForm').dataset.editing;
        };

        window.closeDespesaModal = function() {
            document.getElementById('despesaModal').classList.add('hidden');
            document.getElementById('despesaModal').classList.remove('flex');
        };

        window.deleteDespesa = function(index) {
            if (confirm('Tem certeza que deseja excluir esta despesa?')) {
                sistemData.despesas.splice(index, 1);
                saveData();
                showSection('despesas');
                showNotification('🗑️ Despesa excluída com sucesso!', 'success');
            }
        };

        // ===== FUNÇÕES DE CÁLCULO DE VENDAS (GLOBAL) =====
        
        // Função para atualizar cálculos automáticos de vendas
        window.updateVendaCalculos = function() {
            const materialSelect = document.getElementById('vendaMaterial');
            const pesoPedreira = parseFloat(document.getElementById('vendaPesoPedreira').value) || 0;
            const pesoCliente = parseFloat(document.getElementById('vendaPesoCliente').value) || 0;
            const precoClienteM3 = parseFloat(document.getElementById('vendaPrecoClienteM3').value) || 0;
            
            let volumeCliente = 0;
            
            if (materialSelect && materialSelect.value) {
                const minerio = sistemData.minerios.find(m => m.tipo === materialSelect.value);
                if (minerio) {
                    // Calcular volume pedreira (peso pedreira / densidade)
                    if (pesoPedreira > 0) {
                        const volumePedreira = pesoPedreira / minerio.densidade;
                        const volumeEl = document.getElementById('volumePedreiraCalc');
                        if (volumeEl) volumeEl.textContent = `${volumePedreira.toFixed(2)} m³`;
                    } else {
                        const volumeEl = document.getElementById('volumePedreiraCalc');
                        if (volumeEl) volumeEl.textContent = `0,00 m³`;
                    }
                    
                    // Calcular custo total (peso pedreira * custo/t)
                    if (pesoPedreira > 0) {
                        const custoTotal = pesoPedreira * minerio.preco;
                        const custoEl = document.getElementById('custoTotalCalc');
                        if (custoEl) custoEl.textContent = `R$ ${custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    } else {
                        const custoEl = document.getElementById('custoTotalCalc');
                        if (custoEl) custoEl.textContent = `R$ 0,00`;
                    }
                    
                    // Calcular volume cliente (peso cliente / densidade)
                    if (pesoCliente > 0) {
                        volumeCliente = pesoCliente / minerio.densidade;
                        const volumeClienteEl = document.getElementById('volumeClienteCalc');
                        if (volumeClienteEl) volumeClienteEl.textContent = `${volumeCliente.toFixed(2)} m³`;
                    } else {
                        const volumeClienteEl = document.getElementById('volumeClienteCalc');
                        if (volumeClienteEl) volumeClienteEl.textContent = `0,00 m³`;
                    }
                }
            }
            
            // Calcular valor de venda (volume * preço/m³)
            if (volumeCliente > 0 && precoClienteM3 > 0) {
                const valorVenda = volumeCliente * precoClienteM3;
                const valorVendaEl = document.getElementById('valorVendaCalc');
                if (valorVendaEl) valorVendaEl.textContent = `R$ ${valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            if (typeof updateVendaPreview === 'function') {
                updateVendaPreview();
            }
        };

        // ===== EVENT LISTENERS DOS FORMULÁRIOS =====

        document.addEventListener('DOMContentLoaded', function() {
            // Form Minérios
            document.getElementById('minerioForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const tipo = document.getElementById('minerioTipo').value;
                const densidade = parseFloat(document.getElementById('minerioDensidade').value);
                const preco = parseFloat(document.getElementById('minerioPreco').value);
                const categoria = document.getElementById('minerioCategoria').value;
                
                const novoMinerio = { tipo, densidade, preco, categoria };
                
                if (this.dataset.editing !== undefined) {
                    sistemData.minerios[parseInt(this.dataset.editing)] = novoMinerio;
                } else {
                    sistemData.minerios.push(novoMinerio);
                }
                
                saveData();
                showSection('minerios');
                closeMinerioModal();
                showNotification('✅ Minério salvo com sucesso!', 'success');
            });

            // Form Clientes
            document.getElementById('clienteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const empresa = document.getElementById('clienteEmpresa').value;
                const cnpj = document.getElementById('clienteCnpj').value;
                const telefone = document.getElementById('clienteTelefone').value;
                const bairro = document.getElementById('clienteBairro').value;
                const distancia = parseFloat(document.getElementById('clienteDistancia').value);
                const pedagios = parseInt(document.getElementById('clientePedagios').value) || 0;
                
                // Coletar preços específicos
                const precosEspecificos = coletarPrecosCliente();
                
                if (this.dataset.editing !== undefined) {
                    // Editando cliente existente
                    const clienteIndex = parseInt(this.dataset.editing);
                    const clienteExistente = sistemData.clientes[clienteIndex];
                    
                    sistemData.clientes[clienteIndex] = {
                        ...clienteExistente, // Preserva dados originais
                        empresa,
                        cnpj,
                        telefone,
                        bairro,
                        distancia,
                        pedagios,
                        precosEspecificos
                        // Não atualiza dataCadastro nem status
                    };
                } else {
                    // Criando novo cliente
                    const novoCliente = {
                        empresa,
                        cnpj,
                        telefone,
                        bairro,
                        distancia,
                        pedagios,
                        precosEspecificos,
                        dataCadastro: new Date().toISOString(),
                        status: 'ativo'
                    };
                    sistemData.clientes.push(novoCliente);
                }
                
                saveData();
                showSection('clientes');
                closeClienteModal();
                showNotification('✅ Cliente salvo com sucesso!', 'success');
            });

            // Form Motoristas
            document.getElementById('motoristaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nome = document.getElementById('motoristaNome').value;
                const cpf = document.getElementById('motoristaCpf').value;
                const telefone = document.getElementById('motoristaTelefone').value;
                const cnh = document.getElementById('motoristaCnh').value;
                const vencimentoCnh = document.getElementById('motoristaVencimentoCnh').value;
                const vencimentoToxicologico = document.getElementById('motoristaVencimentoToxicologico').value;
                
                const novoMotorista = {
                    nome,
                    cpf,
                    telefone,
                    cnh,
                    vencimentoCnh,
                    vencimentoToxicologico,
                    status: 'ativo',
                    dataCadastro: new Date().toISOString()
                };
                
                if (this.dataset.editing !== undefined) {
                    sistemData.motoristas[parseInt(this.dataset.editing)] = { ...sistemData.motoristas[parseInt(this.dataset.editing)], ...novoMotorista };
                } else {
                    sistemData.motoristas.push(novoMotorista);
                }
                
                saveData();
                showSection('motoristas');
                closeMotoristaModal();
                showNotification('✅ Motorista salvo com sucesso!', 'success');
            });

            // Form Veículos
            document.getElementById('veiculoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const placa = document.getElementById('veiculoPlaca').value.toUpperCase();
                const modelo = document.getElementById('veiculoModelo').value;
                const tara = parseInt(document.getElementById('veiculoTara').value);
                const consumo = parseFloat(document.getElementById('veiculoConsumo').value) || null;
                const motoristaVinculado = document.getElementById('veiculoMotorista').value || null;
                
                const novoVeiculo = {
                    placa,
                    modelo,
                    tara,
                    consumo,
                    motoristaVinculado,
                    status: 'disponivel',
                    dataCadastro: new Date().toISOString()
                };
                
                if (this.dataset.editing !== undefined) {
                    sistemData.veiculos[parseInt(this.dataset.editing)] = { ...sistemData.veiculos[parseInt(this.dataset.editing)], ...novoVeiculo };
                } else {
                    sistemData.veiculos.push(novoVeiculo);
                }
                
                saveData();
                showSection('veiculos');
                closeVeiculoModal();
                showNotification('✅ Veículo salvo com sucesso!', 'success');
            });

            // Form Vendas
            document.getElementById('vendaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const cliente = document.getElementById('vendaCliente').value;
                const material = document.getElementById('vendaMaterial').value;
                const veiculo = document.getElementById('vendaVeiculo').value;
                const pesoPedreira = parseFloat(document.getElementById('vendaPesoPedreira').value);
                const pesoCliente = parseFloat(document.getElementById('vendaPesoCliente').value);
                const precoClienteM3 = parseFloat(document.getElementById('vendaPrecoClienteM3').value);
                const tipoPagamento = document.getElementById('vendaPagamento').value;
                const prazoDias = document.getElementById('vendaPrazoDias').value ? parseInt(document.getElementById('vendaPrazoDias').value) : null;
                const pedagios = parseInt(document.getElementById('vendaPedagios').value) || 0;
                const observacoes = document.getElementById('vendaObservacoes').value;
                const dataVenda = document.getElementById('vendaData').value;
                
                // Encontrar o minério e calcular valores
                const minerio = sistemData.minerios.find(m => m.tipo === material);
                if (!minerio) {
                    alert('Minério não encontrado!');
                    return;
                }
                
                const custoTotal = pesoPedreira * minerio.preco;
                const volumeCliente = pesoCliente / minerio.densidade;
                const valorVenda = volumeCliente * precoClienteM3;
                
                // Calcular data de vencimento
                let dataVencimento = null;
                if (tipoPagamento === 'a_prazo' && prazoDias) {
                    dataVencimento = new Date();
                    dataVencimento.setDate(dataVencimento.getDate() + prazoDias);
                    dataVencimento = dataVencimento.toISOString();
                }
                
                const novaVenda = {
                    id: Date.now(),
                    cliente,
                    material,
                    minerio: material, // alias para compatibilidade
                    veiculo,
                    pesoPedreira,
                    pesoCliente,
                    volumeCliente,
                    precoClienteM3,
                    custoTotal,
                    quantidade: pesoCliente, // para compatibilidade com relatórios existentes
                    toneladas: pesoCliente, // alias para compatibilidade
                    valor: valorVenda,
                    tipoPagamento,
                    prazoDias,
                    pedagios,
                    dataVencimento,
                    observacoes,
                    data: dataVenda ? new Date(dataVenda + 'T12:00:00').toISOString() : new Date().toISOString(),
                    status: 'concluida'
                };
                
                if (this.dataset.editing !== undefined) {
                    // Modo edição
                    const index = parseInt(this.dataset.editing);
                    const vendaAntiga = sistemData.vendas[index];
                    
                    // Ajustar estoque: devolver valor da venda antiga e debitar da nova
                    const minerioAntigo = sistemData.minerios.find(m => m.tipo === vendaAntiga.material);
                    if (minerioAntigo) {
                        const custoAntigo = vendaAntiga.pesoPedreira * minerioAntigo.preco;
                        adicionarMovimentacaoEstoque('credito', custoAntigo, sistemData.estoque.saldo, `Devolução por edição de venda - ${vendaAntiga.cliente}`, 'edicao_venda');
                    }
                    
                    // Debitar novo valor do estoque
                    adicionarMovimentacaoEstoque('debito', custoTotal, sistemData.estoque.saldo, `Venda editada para ${cliente} - Pedreira: ${pesoPedreira}t / Cliente: ${pesoCliente}t de ${material}`, 'venda');
                    
                    // Manter o ID original e outras informações relevantes
                    novaVenda.id = vendaAntiga.id || Date.now();
                    
                    // Atualizar venda existente
                    sistemData.vendas[index] = novaVenda;
                    
                    // Limpar flag de edição
                    delete this.dataset.editing;
                    
                    showNotification('✅ Venda atualizada com sucesso!', 'success');
                } else {
                    // Modo criação
                    // Debitar do estoque usando peso da pedreira
                    adicionarMovimentacaoEstoque('debito', custoTotal, sistemData.estoque.saldo, `Venda para ${cliente} - Pedreira: ${pesoPedreira}t / Cliente: ${pesoCliente}t de ${material}`, 'venda');
                    
                    sistemData.vendas.push(novaVenda);
                    showNotification('✅ Venda registrada com sucesso!', 'success');
                }
                
                saveData();
                showSection('vendas');
                closeVendaModal();
            });

            // Form Estoque
            document.getElementById('estoqueForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const valor = parseFloat(document.getElementById('estoqueValor').value);
                const observacoes = document.getElementById('estoqueObservacoes').value;
                
                adicionarMovimentacaoEstoque('credito', valor, sistemData.estoque.saldo, observacoes, 'credito_manual');
                
                saveData();
                showSection('estoque');
                closeEstoqueModal();
                showNotification('✅ Crédito adicionado ao estoque!', 'success');
            });

            // Form Despesas
            document.getElementById('despesaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const tipo = document.getElementById('despesaTipo').value;
                const veiculo = document.getElementById('despesaVeiculo').value || null;
                const valor = parseFloat(document.getElementById('despesaValor').value);
                const observacoes = document.getElementById('despesaObservacoes').value;
                
                const novaDespesa = {
                    id: Date.now(),
                    tipo,
                    veiculo,
                    valor,
                    observacoes,
                    data: new Date().toISOString()
                };
                
                if (this.dataset.editing !== undefined) {
                    sistemData.despesas[parseInt(this.dataset.editing)] = novaDespesa;
                } else {
                    sistemData.despesas.push(novaDespesa);
                }
                
                saveData();
                showSection('despesas');
                closeDespesaModal();
                showNotification('✅ Despesa registrada com sucesso!', 'success');
            });

            // Event listeners para cálculos automáticos com novos campos
            document.getElementById('vendaMaterial').addEventListener('change', function() {
                carregarPrecoClienteEspecifico();
                window.updateVendaCalculos();
            });
            document.getElementById('vendaPesoPedreira').addEventListener('input', window.updateVendaCalculos);
            document.getElementById('vendaPesoCliente').addEventListener('input', window.updateVendaCalculos);
            document.getElementById('vendaPrecoClienteM3').addEventListener('input', function() {
                window.updateVendaCalculos();
                // Se o usuário alterar manualmente, limpar a informação de origem
                const precoOrigemInfo = document.getElementById('precoOrigemInfo');
                if (precoOrigemInfo && !precoOrigemInfo.classList.contains('hidden')) {
                    precoOrigemInfo.textContent = '✏️ Preço alterado manualmente';
                }
            });
            document.getElementById('vendaVeiculo').addEventListener('change', updateVendaPreview);
            document.getElementById('vendaPedagios').addEventListener('change', updateVendaPreview);
            document.getElementById('vendaCliente').addEventListener('change', function() {
                carregarPrecoClienteEspecifico();
                carregarPedagiosCliente();
                updateVendaPreview();
            });
            document.getElementById('vendaData').addEventListener('change', updateVendaPreview);
            
            // Função para carregar preço específico do cliente
            function carregarPrecoClienteEspecifico() {
                const clienteSelect = document.getElementById('vendaCliente');
                const materialSelect = document.getElementById('vendaMaterial');
                const precoClienteInput = document.getElementById('vendaPrecoClienteM3');
                const precoOrigemInfo = document.getElementById('precoOrigemInfo');
                
                if (!clienteSelect.value || !materialSelect.value || !precoClienteInput) {
                    if (precoOrigemInfo) {
                        precoOrigemInfo.classList.add('hidden');
                    }
                    return;
                }
                
                // Encontrar o cliente
                const cliente = sistemData.clientes.find(c => c.empresa === clienteSelect.value);
                const minerio = sistemData.minerios.find(m => m.tipo === materialSelect.value);
                
                if (!minerio) return;
                
                if (cliente && cliente.precosEspecificos) {
                    // Verificar se existe preço específico para este material
                    const precoEspecifico = cliente.precosEspecificos[materialSelect.value];
                    if (precoEspecifico) {
                        let precoM3;
                        let infoTexto = '';
                        
                        // Se é um número (formato antigo), assume R$/t
                        if (typeof precoEspecifico === 'number') {
                            precoM3 = precoEspecifico * minerio.densidade;
                            infoTexto = `ℹ️ Preço específico: R$ ${precoEspecifico.toFixed(2)}/t → convertido para R$ ${precoM3.toFixed(2)}/m³ (densidade: ${minerio.densidade})`;
                        } else {
                            // Formato novo com unidade
                            if (precoEspecifico.unidade === 'm3') {
                                // Já está em R$/m³
                                precoM3 = precoEspecifico.preco;
                                infoTexto = `ℹ️ Preço específico definido em R$/m³: R$ ${precoM3.toFixed(2)}/m³`;
                            } else {
                                // Está em R$/t, converter para R$/m³
                                precoM3 = precoEspecifico.preco * minerio.densidade;
                                infoTexto = `ℹ️ Preço específico: R$ ${precoEspecifico.preco.toFixed(2)}/t → convertido para R$ ${precoM3.toFixed(2)}/m³ (densidade: ${minerio.densidade})`;
                            }
                        }
                        
                        precoClienteInput.value = precoM3.toFixed(2);
                        if (precoOrigemInfo) {
                            precoOrigemInfo.textContent = infoTexto;
                            precoOrigemInfo.classList.remove('hidden');
                        }
                        return;
                    }
                }
                
                // Se não há preço específico, usar preço padrão com margem configurada
                // Custo/t * densidade * margem = preço/m³
                const margemConfig = obterMargemConfigurada();
                const multiplicadorMargem = 1 + (margemConfig.padrao / 100);
                const precoM3Padrao = minerio.preco * minerio.densidade * multiplicadorMargem;
                precoClienteInput.value = precoM3Padrao.toFixed(2);
                
                if (precoOrigemInfo) {
                    precoOrigemInfo.textContent = `ℹ️ Preço padrão (custo + ${margemConfig.padrao}%): R$ ${minerio.preco.toFixed(2)}/t → R$ ${precoM3Padrao.toFixed(2)}/m³`;
                    precoOrigemInfo.classList.remove('hidden');
                }
            }
            
            // Função para carregar pedágios do cliente
            function carregarPedagiosCliente() {
                const clienteSelect = document.getElementById('vendaCliente');
                const pedagogiosSelect = document.getElementById('vendaPedagios');
                
                if (!clienteSelect.value || !pedagogiosSelect) {
                    return;
                }
                
                // Encontrar o cliente selecionado
                const cliente = sistemData.clientes.find(c => c.empresa === clienteSelect.value);
                
                if (cliente && cliente.pedagios !== undefined && cliente.pedagios !== null) {
                    // Se o cliente tem pedágios cadastrados, usar esse valor
                    const pedagogiosCliente = cliente.pedagios;
                    
                    // Verificar se a opção existe no select (máximo 4)
                    if (pedagogiosCliente >= 0 && pedagogiosCliente <= 4) {
                        pedagogiosSelect.value = pedagogiosCliente.toString();
                    } else {
                        // Se for mais que 4, usar 4 como máximo
                        pedagogiosSelect.value = '4';
                    }
                } else {
                    // Se não tem pedágios cadastrados, deixar em "Não"
                    pedagogiosSelect.value = '0';
                }
            }


            document.getElementById('vendaPagamento').addEventListener('change', function() {
                const prazoDias = document.getElementById('prazoDias');
                if (this.value === 'a_prazo') {
                    prazoDias.classList.remove('hidden');
                    document.getElementById('vendaPrazoDias').required = true;
                } else {
                    prazoDias.classList.add('hidden');
                    document.getElementById('vendaPrazoDias').required = false;
                }
            });

            // Form Cobranças
            document.getElementById('cobrancaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const cliente = document.getElementById('cobrancaCliente').value;
                const valorPago = parseFloat(document.getElementById('cobrancaValor').value);
                const observacoes = document.getElementById('cobrancaObservacoes').value;
                
                const resultado = processarPagamento(cliente, valorPago);
                
                // Registrar o pagamento
                const novoPagamento = {
                    id: Date.now(),
                    cliente,
                    valorPago,
                    observacoes,
                    data: new Date().toISOString(),
                    vendasQuitadas: resultado.vendasQuitadas,
                    valorRestante: resultado.valorRestante
                };
                
                if (!sistemData.cobrancas) sistemData.cobrancas = [];
                sistemData.cobrancas.push(novoPagamento);
                
                saveData();
                showSection('cobranca');
                closeCobrancaModal();
                
                let mensagem = `✅ Pagamento processado! ${resultado.vendasQuitadas} venda(s) quitada(s).`;
                if (resultado.valorRestante > 0) {
                    mensagem += ` Valor restante: R$ ${resultado.valorRestante.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                }
                showNotification(mensagem, 'success');
            });

            // Form Configuração de Alerta de Estoque
            document.getElementById('estoqueAlertaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const estoqueMinimo = parseFloat(document.getElementById('estoqueMinimo').value);
                const tipoAlerta = document.getElementById('tipoAlerta').value;
                const alertaObservacoes = document.getElementById('alertaObservacoes').value;
                
                // Garantir que configurações existe
                if (!sistemData.configuracoes) {
                    sistemData.configuracoes = {};
                }
                
                sistemData.configuracoes.estoqueMinimo = estoqueMinimo;
                sistemData.configuracoes.tipoAlerta = tipoAlerta;
                sistemData.configuracoes.alertaObservacoes = alertaObservacoes;
                
                saveData();
                closeEstoqueAlertaModal();
                showSection('estoque');
                
                const tipoTexto = {
                    'critico': 'Crítico',
                    'atencao': 'Atenção', 
                    'informativo': 'Informativo'
                }[tipoAlerta];
                
                showNotification(`⚙️ Alerta configurado! Mínimo: R$ ${estoqueMinimo.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${tipoTexto})`, 'success');
            });

            // Máscaras para campos
            setupMasks();

            // Inicializar dashboard
            showSection('dashboard');
            
            // Inicializar indicador de sincronização
            updateSyncIndicator();
            
            // Configurar sincronização em tempo real quando o Firebase estiver pronto
            setTimeout(() => {
                if (window.firebaseConnected) {
                    setupRealtimeSync();
                    // Carregar dados do Firebase na inicialização
                    loadFromFirebase();
                } else {
                    updateSyncIndicator();
                }
            }, 2000);
            
            // Atualizar indicador periodicamente
            setInterval(() => {
                updateSyncIndicator();
            }, 5000);
            
            // Inicializar sistema de alertas
            setTimeout(() => {
                // Primeira verificação após 5 segundos
                verificarAlertasCriticos();
                
                // Verificar alertas a cada 30 minutos
                setInterval(() => {
                    verificarAlertasCriticos();
                }, 30 * 60 * 1000); // 30 minutos
                
                // Verificar alertas ao trocar de seção (casos críticos)
                const originalShowSection = window.showSection;
                window.showSection = function(sectionName) {
                    originalShowSection(sectionName);
                    
                    // Verificação rápida para alertas críticos ao navegar
                    setTimeout(() => {
                        const agora = new Date();
                        const ultimaVerificacao = ultimaVerificacaoAlertas ? new Date(ultimaVerificacaoAlertas) : null;
                        
                        // Se passou mais de 5 minutos desde a última verificação
                        if (!ultimaVerificacao || (agora - ultimaVerificacao) > 5 * 60 * 1000) {
                            verificarAlertasCriticos();
                        }
                    }, 1000);
                };
            }, 5000);
        });

        // Função para obter margem configurada
        function obterMargemConfigurada() {
            const configuracoes = sistemData.configuracoes || {};
            const margemConfig = configuracoes.margem || {
                padrao: 30.0,
                minima: 10.0,
                maxima: 100.0
            };
            return margemConfig;
        }
        
        function calcularValorVenda() {
            updateVendaPreview();
        }

        function updateVendaPreview() {
            const material = document.getElementById('vendaMaterial').value;
            const pesoPedreira = parseFloat(document.getElementById('vendaPesoPedreira').value) || 0;
            const pesoCliente = parseFloat(document.getElementById('vendaPesoCliente').value) || 0;
            const precoClienteM3 = parseFloat(document.getElementById('vendaPrecoClienteM3').value) || 0;
            const cliente = document.getElementById('vendaCliente').value;
            const veiculo = document.getElementById('vendaVeiculo').value;
            
            let custoMaterial = 0;
            let valorVenda = 0;
            let lucro = 0;
            let margem = 0;
            
            if (material && pesoPedreira > 0) {
                const minerio = sistemData.minerios.find(m => m.tipo === material);
                if (minerio) {
                    custoMaterial = minerio.preco * pesoPedreira;
                    
                    // Se não há preço cliente definido, usa margem configurada
                    if (!precoClienteM3 && document.getElementById('vendaPrecoClienteM3')) {
                        const margemConfig = obterMargemConfigurada();
                        const multiplicadorMargem = 1 + (margemConfig.padrao / 100);
                        const precoM3Sugerido = minerio.preco * minerio.densidade * multiplicadorMargem;
                        document.getElementById('vendaPrecoClienteM3').value = precoM3Sugerido.toFixed(2);
                        
                        // Atualizar info do preço
                        const precoOrigemInfo = document.getElementById('precoOrigemInfo');
                        if (precoOrigemInfo) {
                            precoOrigemInfo.textContent = `ℹ️ Preço sugerido (custo + ${margemConfig.padrao}%): R$ ${minerio.preco.toFixed(2)}/t → R$ ${precoM3Sugerido.toFixed(2)}/m³`;
                            precoOrigemInfo.classList.remove('hidden');
                        }
                    }
                }
            }
            
            if (pesoCliente > 0 && precoClienteM3 > 0 && material) {
                const minerio = sistemData.minerios.find(m => m.tipo === material);
                if (minerio) {
                    const volumeCliente = pesoCliente / minerio.densidade;
                    valorVenda = volumeCliente * precoClienteM3;
                }
            }
            
            let lucroBruto = 0;
            let lucroLiquido = 0;
            let custoPedagios = 0;
            let custoDiesel = 0;
            
            // Calcular custo dos pedágios (sempre, independente da venda)
            const pedagogios = parseInt(document.getElementById('vendaPedagios').value) || 0;
            
            // Buscar valor do pedágio nas configurações salvas
            let valorPedagio = 0;
            if (sistemData.configuracoes?.valores?.pedagio) {
                valorPedagio = sistemData.configuracoes.valores.pedagio;
            } else {
                // Fallback: tentar pegar do input se estiver disponível
                const valorPedagioInput = document.getElementById('valorPedagio');
                if (valorPedagioInput) {
                    valorPedagio = parseFloat(valorPedagioInput.value) || 0;
                }
            }
            
            custoPedagios = pedagogios * valorPedagio;
            
            // Calcular custo do diesel
            const clienteSelecionado = sistemData.clientes.find(c => c.empresa === cliente);
            const veiculoSelecionado = sistemData.veiculos.find(v => v.placa === veiculo);
            
            if (clienteSelecionado && veiculoSelecionado && clienteSelecionado.distancia && veiculoSelecionado.consumo) {
                // Buscar preço do diesel nas configurações salvas
                let precoDiesel = 0;
                if (sistemData.configuracoes?.valores?.diesel) {
                    precoDiesel = sistemData.configuracoes.valores.diesel;
                } else {
                    // Fallback: tentar pegar do input se estiver disponível
                    const precoDieselInput = document.getElementById('precoDiesel');
                    if (precoDieselInput) {
                        precoDiesel = parseFloat(precoDieselInput.value) || 0;
                    }
                }
                
                // Cálculo: (Distância ida e volta / Consumo) * Preço do Diesel
                const distanciaTotal = clienteSelecionado.distancia * 2; // ida e volta
                const litrosNecessarios = distanciaTotal / veiculoSelecionado.consumo;
                custoDiesel = litrosNecessarios * precoDiesel;
            }
            
            if (valorVenda > 0 && custoMaterial > 0) {
                lucroBruto = valorVenda - custoMaterial;
                lucroLiquido = lucroBruto - custoPedagios - custoDiesel;
                margem = (lucroLiquido / valorVenda) * 100;
                
                // Manter compatibilidade com código existente
                lucro = lucroLiquido;
            }
            
            // Atualizar preview com formatação monetária correta
            if (document.getElementById('previewValorVenda')) {
                document.getElementById('previewValorVenda').textContent = 
                    `R$ ${(valorVenda || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (document.getElementById('previewCustoMaterial')) {
                document.getElementById('previewCustoMaterial').textContent = 
                    `R$ ${custoMaterial.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (document.getElementById('previewCustoPedagios')) {
                document.getElementById('previewCustoPedagios').textContent = 
                    `R$ ${custoPedagios.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (document.getElementById('previewCustoDiesel')) {
                document.getElementById('previewCustoDiesel').textContent = 
                    `R$ ${custoDiesel.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (document.getElementById('previewLucroBruto')) {
                document.getElementById('previewLucroBruto').textContent = 
                    `R$ ${lucroBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (document.getElementById('previewLucroLiquido')) {
                document.getElementById('previewLucroLiquido').textContent = 
                    `R$ ${lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            if (document.getElementById('previewMargem')) {
                document.getElementById('previewMargem').textContent = 
                    `${margem.toFixed(1)}%`;
            }
            if (document.getElementById('previewCliente')) {
                document.getElementById('previewCliente').textContent = cliente || '-';
            }
            if (document.getElementById('previewVeiculo')) {
                document.getElementById('previewVeiculo').textContent = veiculo || '-';
            }
            if (document.getElementById('previewDataVenda')) {
                const dataVenda = document.getElementById('vendaData')?.value;
                if (dataVenda) {
                    const data = new Date(dataVenda);
                    document.getElementById('previewDataVenda').textContent = data.toLocaleDateString('pt-BR');
                } else {
                    document.getElementById('previewDataVenda').textContent = '-';
                }
            }
                
            // Cores baseadas na margem líquida
            const margemElement = document.getElementById('previewMargem');
            if (margemElement) {
                if (margem >= 20) {
                    margemElement.className = 'text-xl font-bold text-green-300';
                } else if (margem >= 10) {
                    margemElement.className = 'text-xl font-bold text-yellow-300';
                } else {
                    margemElement.className = 'text-xl font-bold text-red-300';
                }
            }
            
            // Cores para lucro líquido
            const lucroLiquidoElement = document.getElementById('previewLucroLiquido');
            if (lucroLiquidoElement) {
                if (lucroLiquido > 0) {
                    lucroLiquidoElement.className = 'text-sm font-bold text-green-300';
                } else if (lucroLiquido === 0) {
                    lucroLiquidoElement.className = 'text-sm font-bold text-yellow-300';
                } else {
                    lucroLiquidoElement.className = 'text-sm font-bold text-red-300';
                }
            }
        }

        function adicionarMovimentacaoEstoque(tipo, valor, saldoAnterior, observacoes, origem) {
            const novoSaldo = tipo === 'credito' ? saldoAnterior + valor : saldoAnterior - valor;
            
            const movimentacao = {
                id: Date.now(),
                tipo,
                valor,
                saldoAnterior,
                saldoNovo: novoSaldo,
                data: new Date().toISOString(),
                observacoes,
                origem
            };
            
            sistemData.estoque.movimentacoes.push(movimentacao);
            sistemData.estoque.saldo = novoSaldo;
        }

        function setupMasks() {
            // Máscara CNPJ
            const cnpjInputs = document.querySelectorAll('#clienteCnpj');
            cnpjInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1/$2');
                    value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
                    e.target.value = value;
                });
            });

            // Máscara CPF
            const cpfInputs = document.querySelectorAll('#motoristaCpf');
            cpfInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    e.target.value = value;
                });
            });

            // Máscara Telefone
            const telefoneInputs = document.querySelectorAll('#clienteTelefone, #motoristaTelefone');
            telefoneInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/(\d{2})(\d)/, '($1) $2');
                    value = value.replace(/(\d{4,5})(\d{4})$/, '$1-$2');
                    e.target.value = value;
                });
            });

            // Máscara Placa
            const placaInputs = document.querySelectorAll('#veiculoPlaca');
            placaInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                    if (value.length > 3) {
                        value = value.substring(0, 3) + '-' + value.substring(3, 7);
                    }
                    e.target.value = value;
                });
            });
        }

        // Filtros para vendas
        function filterVendas() {
            const searchTerm = document.getElementById('vendaSearch').value.toLowerCase();
            const filterPagamento = document.getElementById('vendaFilterPagamento').value;
            
            let vendasFiltradas = sistemData.vendas;
            
            if (searchTerm) {
                vendasFiltradas = vendasFiltradas.filter(venda => 
                    venda.cliente.toLowerCase().includes(searchTerm) ||
                    venda.material.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filterPagamento) {
                vendasFiltradas = vendasFiltradas.filter(venda => venda.tipoPagamento === filterPagamento);
            }
            
            // Atualizar tabela
            const tbody = document.getElementById('vendasTableBody');
            if (tbody) {
                if (vendasFiltradas.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                        Nenhuma venda encontrada com os filtros aplicados.
                    </td></tr>`;
                } else {
                    tbody.innerHTML = vendasFiltradas.map((venda, index) => `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-300 px-4 py-2">${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                            <td class="border border-gray-300 px-4 py-2">${venda.cliente}</td>
                            <td class="border border-gray-300 px-4 py-2">${venda.material}</td>
                            <td class="border border-gray-300 px-4 py-2">${venda.quantidade} m³</td>
                            <td class="border border-gray-300 px-4 py-2 font-semibold text-green-600">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td class="border border-gray-300 px-4 py-2">${getPagamentoLabel(venda.tipoPagamento)}</td>
                            <td class="border border-gray-300 px-4 py-2 font-mono text-sm">${venda.veiculo}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">
                                <button onclick="deleteVenda(${sistemData.vendas.indexOf(venda)})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                                    🗑️ Excluir
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        // ===== FUNÇÕES DE BACKUP NA NUVEM (GOOGLE DRIVE E ONEDRIVE) =====
        
        // Variáveis de estado da nuvem
        let cloudService = localStorage.getItem('cloudService') || null; // 'google' ou 'onedrive'
        let cloudToken = null;
        let cloudUserInfo = null;
        let gapiLoaded = false;
        let msalInstance = null;
        
        // Configurar serviço de nuvem selecionado
        window.toggleCloudService = function(service) {
            cloudService = service;
            localStorage.setItem('cloudService', service);
            
            // Verificar se elementos existem antes de atualizar UI
            const googleCard = document.getElementById('googleDriveCard');
            const onedriveCard = document.getElementById('oneDriveCard');
            const googleCheck = document.getElementById('googleCheckmark');
            const onedriveCheck = document.getElementById('onedriveCheckmark');
            
            if (!googleCard || !onedriveCard || !googleCheck || !onedriveCheck) {
                console.log('Elementos de UI ainda não carregados, serviço será configurado quando disponível');
                return;
            }
            
            // Atualizar UI
            googleCard.classList.remove('border-blue-600', 'bg-blue-50');
            onedriveCard.classList.remove('border-blue-600', 'bg-blue-50');
            googleCheck.classList.add('hidden');
            onedriveCheck.classList.add('hidden');
            
            if (service === 'google') {
                googleCard.classList.add('border-blue-600', 'bg-blue-50');
                googleCheck.classList.remove('hidden');
            } else if (service === 'onedrive') {
                onedriveCard.classList.add('border-blue-600', 'bg-blue-50');
                onedriveCheck.classList.remove('hidden');
            }
        };
        
        // Carregar Google API
        function loadGoogleAPI() {
            console.log('=== loadGoogleAPI iniciado ===');
            return new Promise((resolve, reject) => {
                try {
                    console.log('gapiLoaded:', gapiLoaded);
                    console.log('typeof gapi:', typeof gapi);
                    
                    if (gapiLoaded && typeof gapi !== 'undefined' && gapi.auth2) {
                        console.log('Google API já carregada, retornando...');
                        resolve();
                        return;
                    }
                    
                    // Verificar se já existe script do Google
                    if (typeof gapi !== 'undefined') {
                        console.log('gapi já existe, carregando client:auth2...');
                        gapi.load('client:auth2', async () => {
                            console.log('client:auth2 carregado, inicializando...');
                            try {
                                await gapi.client.init({
                                    apiKey: 'AIzaSyB_pkucTTm7_jRzTsePHVnyK5Rl8Ieslco',
                                    clientId: '888288553170-8hi5cvj9j8ej0b3h9qhs2q3djk9te0ph.apps.googleusercontent.com',
                                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                                    scope: 'https://www.googleapis.com/auth/drive.file'
                                });
                                gapiLoaded = true;
                                console.log('Google Drive API inicializada com sucesso');
                                resolve();
                            } catch (error) {
                                console.error('Erro ao inicializar Google API:', error);
                                reject(error);
                            }
                        });
                        return;
                    }
                    
                    // Carregar script do Google se ainda não existe
                    console.log('gapi não existe, carregando script...');
                    const existingScript = document.querySelector('script[src*="apis.google.com"]');
                    if (existingScript) {
                        console.log('Removendo script antigo...');
                        existingScript.remove();
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.async = true;
                    script.defer = true;
                    
                    script.onload = () => {
                        console.log('Google API script carregado');
                        try {
                            gapi.load('client:auth2', async () => {
                                try {
                                    console.log('Inicializando Google Client...');
                                    await gapi.client.init({
                                        apiKey: 'AIzaSyB_pkucTTm7_jRzTsePHVnyK5Rl8Ieslco',
                                        clientId: '888288553170-8hi5cvj9j8ej0b3h9qhs2q3djk9te0ph.apps.googleusercontent.com',
                                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                                        scope: 'https://www.googleapis.com/auth/drive.file'
                                    });
                                    gapiLoaded = true;
                                    console.log('✅ Google Drive API inicializada com sucesso!');
                                    resolve();
                                } catch (error) {
                                    console.error('❌ Erro ao inicializar Google API:', error);
                                    reject(error);
                                }
                            });
                        } catch (error) {
                            console.error('❌ Erro ao carregar client:auth2:', error);
                            reject(error);
                        }
                    };
                    
                    script.onerror = (error) => {
                        console.error('❌ Erro ao carregar script do Google:', error);
                        reject(new Error('Falha ao carregar Google API'));
                    };
                    
                    console.log('Adicionando script do Google ao head...');
                    document.head.appendChild(script);
                    console.log('Script adicionado, aguardando onload...');
                } catch (error) {
                    console.error('Erro geral em loadGoogleAPI:', error);
                    reject(error);
                }
            });
        }
        
        // Carregar Microsoft MSAL (OneDrive)
        function loadMSAL() {
            return new Promise((resolve, reject) => {
                if (msalInstance) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js';
                script.onload = () => {
                    const msalConfig = {
                        auth: {
                            clientId: 'YOUR_ONEDRIVE_CLIENT_ID', // Substituir por Client ID real
                            authority: 'https://login.microsoftonline.com/common',
                            redirectUri: window.location.origin
                        }
                    };
                    msalInstance = new msal.PublicClientApplication(msalConfig);
                    console.log('OneDrive API carregada');
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Login na nuvem
        window.loginToCloud = async function(event) {
            console.log('=== loginToCloud chamado ===');
            console.log('cloudService:', cloudService);
            
            if (!cloudService) {
                showNotification('⚠️ Selecione Google Drive ou OneDrive primeiro!', 'warning');
                return;
            }
            
            // Desabilitar botão durante o login (se evento disponível)
            let loginBtn = null;
            let originalText = '';
            
            if (event && event.target) {
                loginBtn = event.target;
                originalText = loginBtn.innerHTML;
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="animate-spin inline-block">⏳</span> Conectando...';
                loginBtn.classList.add('opacity-75', 'cursor-not-allowed');
            }
            
            try {
                updateBackupStatus('🔑 Conectando...', 'info');
                
                if (cloudService === 'google') {
                    await loginToGoogleDrive();
                } else if (cloudService === 'onedrive') {
                    await loginToOneDrive();
                }
            } catch (error) {
                console.error('Erro no login:', error);
                updateBackupStatus('❌ Erro ao conectar', 'error');
                
                // Não mostrar notificação se usuário cancelou
                if (error.error !== 'popup_closed_by_user' && error.error !== 'access_denied') {
                    showNotification('❌ Erro ao conectar. Tente novamente.', 'error');
                }
                
                // Restaurar botão (se foi desabilitado)
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = originalText;
                    loginBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }
        }
        
        // Login Google Drive
        async function loginToGoogleDrive() {
            try {
                console.log('=== loginToGoogleDrive chamado ===');
                console.log('Iniciando login no Google Drive...');
                updateBackupStatus('🔄 Carregando Google API...', 'info');
                
                console.log('Chamando loadGoogleAPI()...');
                await loadGoogleAPI();
                console.log('loadGoogleAPI() completado');
                
                console.log('Google API carregada, obtendo instância de autenticação...');
                const auth = gapi.auth2.getAuthInstance();
                
                if (!auth) {
                    throw new Error('Não foi possível obter instância de autenticação');
                }
                
                updateBackupStatus('🔑 Abrindo janela de login...', 'info');
                
                // Pegar email digitado pelo usuário (se houver)
                const emailInput = document.getElementById('cloudEmail');
                const userEmail = emailInput ? emailInput.value.trim() : '';
                
                if (!auth.isSignedIn.get()) {
                    console.log('Usuário não está logado, abrindo popup...');
                    
                    // Opções de login com hint de email
                    const loginOptions = {};
                    
                    if (userEmail) {
                        loginOptions.login_hint = userEmail;
                        console.log(`Usando login_hint: ${userEmail}`);
                        updateBackupStatus(`🔑 Conectando com ${userEmail}...`, 'info');
                    }
                    
                    await auth.signIn(loginOptions);
                } else {
                    console.log('Usuário já está logado');
                    
                    // Verificar se o email logado é o mesmo digitado
                    const currentUser = auth.currentUser.get();
                    const currentProfile = currentUser.getBasicProfile();
                    const currentEmail = currentProfile.getEmail();
                    
                    if (userEmail && userEmail.toLowerCase() !== currentEmail.toLowerCase()) {
                        console.log(`Email atual (${currentEmail}) diferente do solicitado (${userEmail}). Fazendo logout...`);
                        showNotification(`⚠️ Você está conectado com ${currentEmail}. Desconectando para trocar de conta...`, 'warning');
                        
                        await auth.signOut();
                        
                        // Fazer login com o email correto
                        const loginOptions = { login_hint: userEmail };
                        await auth.signIn(loginOptions);
                    }
                }
                
                const user = auth.currentUser.get();
                if (!user) {
                    throw new Error('Não foi possível obter usuário atual');
                }
                
                const profile = user.getBasicProfile();
                cloudToken = user.getAuthResponse().access_token;
                cloudUserInfo = {
                    name: profile.getName(),
                    email: profile.getEmail(),
                    photo: profile.getImageUrl()
                };
                
                console.log('✅ Login bem-sucedido:', cloudUserInfo);
                
                // Salvar email conectado no campo
                if (emailInput && !emailInput.value) {
                    emailInput.value = cloudUserInfo.email;
                }
                
                updateCloudStatus(true);
                showNotification(`✅ Conectado ao Google Drive como ${cloudUserInfo.name}`, 'success');
                
            } catch (error) {
                console.error('❌ Erro no login do Google Drive:', error);
                updateBackupStatus('❌ Erro ao conectar com Google Drive', 'error');
                
                // Mensagem de erro mais amigável
                if (error.error === 'popup_closed_by_user') {
                    showNotification('⚠️ Login cancelado pelo usuário', 'warning');
                } else if (error.error === 'access_denied') {
                    showNotification('❌ Acesso negado. Por favor, autorize o aplicativo.', 'error');
                } else {
                    showNotification(`❌ Erro: ${error.message || 'Falha na conexão'}`, 'error');
                }
                throw error;
            }
        }
        
        // Login OneDrive
        async function loginToOneDrive() {
            try {
                console.log('Iniciando login no OneDrive...');
                updateBackupStatus('🔄 Carregando OneDrive API...', 'info');
                
                // Como o OneDrive requer configuração de Client ID específico,
                // vamos usar uma abordagem alternativa por enquanto
                showNotification('⚠️ OneDrive em breve! Use Google Drive ou Backup Local.', 'warning');
                updateBackupStatus('⚠️ OneDrive requer configuração adicional', 'warning');
                
                // Código para quando o Client ID for configurado:
                /*
                await loadMSAL();
                
                const loginRequest = {
                    scopes: ['Files.ReadWrite']
                };
                
                updateBackupStatus('🔑 Abrindo janela de login...', 'info');
                const response = await msalInstance.loginPopup(loginRequest);
                cloudToken = response.accessToken;
                cloudUserInfo = {
                    name: response.account.name,
                    email: response.account.username
                };
                
                console.log('✅ Login OneDrive bem-sucedido:', cloudUserInfo);
                updateCloudStatus(true);
                showNotification(`✅ Conectado ao OneDrive como ${cloudUserInfo.name}`, 'success');
                */
                
            } catch (error) {
                console.error('❌ Erro no login do OneDrive:', error);
                updateBackupStatus('❌ Erro ao conectar com OneDrive', 'error');
                showNotification(`❌ Erro: ${error.message || 'Falha na conexão'}`, 'error');
                throw error;
            }
        }
        
        // Atualizar status da conexão na UI
        function updateCloudStatus(connected) {
            const accountInfo = document.getElementById('cloudAccountInfo');
            const statusDot = document.getElementById('cloudStatusDot');
            const loginSection = document.getElementById('loginSection');
            const backupActions = document.getElementById('backupActions');
            const lastBackupInfo = document.getElementById('lastBackupInfo');
            
            // Verificar se elementos existem
            if (!accountInfo || !statusDot || !loginSection || !backupActions || !lastBackupInfo) {
                console.log('Elementos de status ainda não disponíveis');
                return;
            }
            
            if (connected && cloudUserInfo) {
                accountInfo.innerHTML = `
                    <div class="font-medium text-green-600">✅ Conectado</div>
                    <div class="text-sm text-gray-600">${cloudUserInfo.name}</div>
                    <div class="text-xs text-gray-500">${cloudUserInfo.email}</div>
                `;
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                loginSection.classList.add('hidden');
                backupActions.classList.remove('hidden');
                lastBackupInfo.classList.remove('hidden');
                
                // Carregar informações do último backup
                loadLastBackupInfo();
            } else {
                accountInfo.innerHTML = '<div class="text-gray-500">Nenhuma conta conectada</div>';
                statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
                loginSection.classList.remove('hidden');
                backupActions.classList.add('hidden');
                lastBackupInfo.classList.add('hidden');
            }
        }
        
        // Fazer backup na nuvem
        window.backupToCloud = async function() {
            if (!cloudToken) {
                showNotification('⚠️ Faça login primeiro!', 'warning');
                return;
            }
            
            try {
                updateBackupStatus('☁️ Fazendo backup...', 'info');
                
                // Preparar dados do backup
                const backupData = {
                    ...sistemData,
                    backupDate: new Date().toISOString(),
                    version: '1.0',
                    appName: 'Rei da Caçambinha'
                };
                
                const fileName = `rei-da-cacambinha-backup-${new Date().toISOString().split('T')[0]}.json`;
                const fileContent = JSON.stringify(backupData, null, 2);
                
                if (cloudService === 'google') {
                    await uploadToGoogleDrive(fileName, fileContent);
                } else if (cloudService === 'onedrive') {
                    await uploadToOneDrive(fileName, fileContent);
                }
                
                // Salvar informação do último backup
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                loadLastBackupInfo();
                
                updateBackupStatus('✅ Backup concluído com sucesso!', 'success');
                showNotification('✅ Backup salvo na nuvem com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no backup:', error);
                updateBackupStatus('❌ Erro ao fazer backup', 'error');
                showNotification('❌ Erro ao fazer backup na nuvem', 'error');
            }
        };
        
        // Upload para Google Drive
        async function uploadToGoogleDrive(fileName, content) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            
            const metadata = {
                name: fileName,
                mimeType: 'application/json',
                description: 'Backup automático do Sistema Rei da Caçambinha'
            };
            
            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                content +
                close_delim;
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${cloudToken}`,
                    'Content-Type': `multipart/related; boundary="${boundary}"`
                },
                body: multipartRequestBody
            });
            
            if (!response.ok) {
                throw new Error('Erro ao fazer upload no Google Drive');
            }
            
            return await response.json();
        }
        
        // Upload para OneDrive
        async function uploadToOneDrive(fileName, content) {
            const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${fileName}:/content`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${cloudToken}`,
                    'Content-Type': 'application/json'
                },
                body: content
            });
            
            if (!response.ok) {
                throw new Error('Erro ao fazer upload no OneDrive');
            }
            
            return await response.json();
        }
        
        // Restaurar backup da nuvem
        window.restoreFromCloud = async function() {
            if (!cloudToken) {
                showNotification('⚠️ Faça login primeiro!', 'warning');
                return;
            }
            
            try {
                updateBackupStatus('🔍 Buscando backups...', 'info');
                
                let files = [];
                
                if (cloudService === 'google') {
                    files = await listGoogleDriveBackups();
                } else if (cloudService === 'onedrive') {
                    files = await listOneDriveBackups();
                }
                
                if (files.length === 0) {
                    showNotification('⚠️ Nenhum backup encontrado na nuvem', 'warning');
                    updateBackupStatus('⚠️ Nenhum backup encontrado', 'warning');
                    return;
                }
                
                // Usar o backup mais recente
                const latestFile = files[0];
                const fileDate = new Date(latestFile.modifiedTime).toLocaleString('pt-BR');
                
                if (confirm(`Deseja restaurar o backup "${latestFile.name}" de ${fileDate}?\n\n⚠️ Todos os dados atuais serão substituídos!`)) {
                    let fileContent;
                    
                    if (cloudService === 'google') {
                        fileContent = await downloadFromGoogleDrive(latestFile.id);
                    } else if (cloudService === 'onedrive') {
                        fileContent = await downloadFromOneDrive(latestFile.id);
                    }
                    
                    const backupData = JSON.parse(fileContent);
                    
                    // Validar backup
                    if (!backupData.vendas || !backupData.clientes) {
                        throw new Error('Backup inválido');
                    }
                    
                    // Restaurar dados
                    sistemData = { ...backupData };
                    sistemData.lastUpdated = new Date().toISOString();
                    localStorage.setItem('reiDaCacambinha', JSON.stringify(sistemData));
                    
                    // Sincronizar com Firebase
                    if (window.firebaseConnected) {
                        await saveToFirebase();
                    }
                    
                    updateBackupStatus('✅ Backup restaurado!', 'success');
                    showNotification('✅ Backup restaurado! Recarregando...', 'success');
                    
                    setTimeout(() => location.reload(), 1500);
                }
                
            } catch (error) {
                console.error('Erro ao restaurar backup:', error);
                updateBackupStatus('❌ Erro ao restaurar backup', 'error');
                showNotification('❌ Erro ao restaurar backup', 'error');
            }
        };
        
        // Listar backups do Google Drive
        async function listGoogleDriveBackups() {
            const response = await gapi.client.drive.files.list({
                q: "name contains 'rei-da-cacambinha-backup' and mimeType='application/json'",
                orderBy: 'modifiedTime desc',
                pageSize: 10,
                fields: 'files(id, name, modifiedTime)'
            });
            
            return response.result.files;
        }
        
        // Listar backups do OneDrive
        async function listOneDriveBackups() {
            const response = await fetch(
                'https://graph.microsoft.com/v1.0/me/drive/root/children?$filter=contains(name,\'rei-da-cacambinha-backup\')',
                {
                    headers: {
                        'Authorization': `Bearer ${cloudToken}`
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error('Erro ao listar backups do OneDrive');
            }
            
            const data = await response.json();
            return data.value.map(file => ({
                id: file.id,
                name: file.name,
                modifiedTime: file.lastModifiedDateTime
            }));
        }
        
        // Download do Google Drive
        async function downloadFromGoogleDrive(fileId) {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            return JSON.stringify(response.result);
        }
        
        // Download do OneDrive
        async function downloadFromOneDrive(fileId) {
            const response = await fetch(
                `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`,
                {
                    headers: {
                        'Authorization': `Bearer ${cloudToken}`
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error('Erro ao baixar do OneDrive');
            }
            
            return await response.text();
        }
        
        // Ver todos os backups
        window.viewCloudBackups = async function() {
            if (!cloudToken) {
                showNotification('⚠️ Faça login primeiro!', 'warning');
                return;
            }
            
            try {
                updateBackupStatus('🔍 Buscando backups...', 'info');
                
                let files = [];
                
                if (cloudService === 'google') {
                    files = await listGoogleDriveBackups();
                } else if (cloudService === 'onedrive') {
                    files = await listOneDriveBackups();
                }
                
                if (files.length === 0) {
                    showNotification('Nenhum backup encontrado', 'info');
                    return;
                }
                
                let message = `📁 Backups encontrados (${files.length}):\n\n`;
                files.slice(0, 5).forEach((file, index) => {
                    const date = new Date(file.modifiedTime).toLocaleString('pt-BR');
                    message += `${index + 1}. ${file.name}\n   ${date}\n\n`;
                });
                
                alert(message);
                updateBackupStatus(`📁 ${files.length} backup(s) encontrado(s)`, 'success');
            } catch (error) {
                console.error('Erro ao listar backups:', error);
                showNotification('❌ Erro ao listar backups', 'error');
            }
        };
        
        // Desconectar da nuvem
        window.disconnectCloud = async function() {
            if (confirm('Deseja desconectar sua conta da nuvem?')) {
                try {
                    if (cloudService === 'google' && gapiLoaded) {
                        const auth = gapi.auth2.getAuthInstance();
                        if (auth.isSignedIn.get()) {
                            await auth.signOut();
                        }
                    } else if (cloudService === 'onedrive' && msalInstance) {
                        const accounts = msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            await msalInstance.logout({ account: accounts[0] });
                        }
                    }
                    
                    cloudToken = null;
                    cloudUserInfo = null;
                    updateCloudStatus(false);
                    updateBackupStatus('', 'info');
                    showNotification('🚪 Conta desconectada', 'info');
                } catch (error) {
                    console.error('Erro ao desconectar:', error);
                    showNotification('❌ Erro ao desconectar', 'error');
                }
            }
        };
        
        // Carregar info do último backup
        function loadLastBackupInfo() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                const date = new Date(lastBackup);
                document.getElementById('lastBackupDate').textContent = date.toLocaleString('pt-BR');
            }
        }
        
        // Inicializar status do serviço selecionado ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Aguardar um pouco para garantir que elementos foram renderizados
                setTimeout(() => {
                    try {
                        if (cloudService) {
                            toggleCloudService(cloudService);
                        }
                    } catch (error) {
                        console.log('Erro ao aplicar toggle inicial:', error);
                    }
                    
                    // NÃO pré-carregar Google API para evitar erros
                    // Será carregado apenas quando usuário clicar em "Conectar"
                }, 500);
            } catch (error) {
                console.log('Erro na inicialização do cloud service:', error);
            }
        });
        

        
        // Download de backup local
        window.downloadLocalBackup = function() {
            try {
                const backupData = {
                    ...sistemData,
                    backupDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rei-da-cacambinha-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                updateBackupStatus('✅ Backup local baixado com sucesso!', 'success');
                showNotification('💾 Backup baixado! Salve este arquivo em lugar seguro.', 'success');
            } catch (error) {
                console.error('Erro ao baixar backup:', error);
                showNotification('❌ Erro ao baixar backup', 'error');
            }
        };
        
        // Upload e restauração de backup local
        window.uploadLocalBackup = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                try {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const backupData = JSON.parse(event.target.result);
                            
                            // Validar estrutura do backup
                            if (!backupData.vendas || !backupData.clientes) {
                                throw new Error('Arquivo de backup inválido');
                            }
                            
                            if (confirm(`Deseja restaurar o backup de ${new Date(backupData.backupDate || backupData.lastUpdated).toLocaleString('pt-BR')}? Todos os dados atuais serão substituídos!`)) {
                                // Restaurar dados
                                sistemData = { ...backupData };
                                sistemData.lastUpdated = new Date().toISOString();
                                localStorage.setItem('reiDaCacambinha', JSON.stringify(sistemData));
                                
                                // Sincronizar com Firebase se conectado
                                if (window.firebaseConnected) {
                                    await saveToFirebase();
                                }
                                
                                updateBackupStatus('✅ Backup restaurado com sucesso!', 'success');
                                showNotification('✅ Backup restaurado! A página será recarregada.', 'success');
                                
                                // Recarregar interface
                                setTimeout(() => location.reload(), 1500);
                            }
                        } catch (error) {
                            console.error('Erro ao processar backup:', error);
                            showNotification('❌ Erro ao processar arquivo de backup', 'error');
                        }
                    };
                    reader.readAsText(file);
                } catch (error) {
                    console.error('Erro ao ler arquivo:', error);
                    showNotification('❌ Erro ao ler arquivo de backup', 'error');
                }
            };
            
            input.click();
        };
        
        // Atualizar status do backup na interface
        function updateBackupStatus(message, type) {
            const statusElement = document.getElementById('backupStatus');
            if (statusElement) {
                const colors = {
                    success: 'text-green-600',
                    error: 'text-red-600',
                    warning: 'text-yellow-600',
                    info: 'text-blue-600'
                };
                statusElement.innerHTML = `
                    <div class="flex items-center gap-2 ${colors[type] || 'text-gray-600'}">
                        <span>${message}</span>
                        <span class="text-xs opacity-75">${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                `;
            }
        }
        
        // ===== FUNÇÕES DE SINCRONIZAÇÃO FIREBASE =====
        
        // Função para salvar dados localmente e sincronizar
        function saveData() {
            sistemData.lastUpdated = new Date().toISOString();
            localStorage.setItem('reiDaCacambinha', JSON.stringify(sistemData));
            
            // Sincronizar com Firebase se conectado
            if (window.firebaseConnected && !syncInProgress) {
                saveToFirebase();
            }
        }
        
        // Salvar dados no Firebase
        window.saveToFirebase = function() {
            if (!window.firebaseConnected || syncInProgress) return;
            
            syncInProgress = true;
            const dataRef = window.firebaseRef(window.firebaseDB, 'reiDaCacambinha');
            
            sistemData.syncStatus = 'syncing';
            sistemData.lastUpdated = new Date().toISOString();
            updateSyncIndicator();
            
            window.firebaseSet(dataRef, sistemData)
                .then(() => {
                    sistemData.syncStatus = 'synced';
                    lastSyncTime = new Date().toISOString();
                    updateSyncStatus('✅ Dados sincronizados com sucesso!', 'success');
                    updateSyncIndicator();
                    console.log('Dados salvos no Firebase com sucesso!');
                })
                .catch((error) => {
                    sistemData.syncStatus = 'error';
                    updateSyncStatus('❌ Erro na sincronização', 'error');
                    updateSyncIndicator();
                    console.error('Erro ao salvar no Firebase:', error);
                })
                .finally(() => {
                    syncInProgress = false;
                    localStorage.setItem('reiDaCacambinha', JSON.stringify(sistemData));
                });
        };
        
        // Carregar dados do Firebase
        window.loadFromFirebase = function() {
            if (!window.firebaseConnected || syncInProgress) return;
            
            syncInProgress = true;
            sistemData.syncStatus = 'syncing';
            updateSyncStatus('🔄 Carregando dados...', 'info');
            updateSyncIndicator();
            
            const dataRef = window.firebaseRef(window.firebaseDB, 'reiDaCacambinha');
            
            window.firebaseGet(dataRef)
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        const localLastUpdated = new Date(sistemData.lastUpdated || 0);
                        const firebaseLastUpdated = new Date(firebaseData.lastUpdated || 0);
                        
                        // Verificar qual versão é mais recente
                        if (firebaseLastUpdated > localLastUpdated) {
                            sistemData = { ...firebaseData, syncStatus: 'synced' };
                            localStorage.setItem('reiDaCacambinha', JSON.stringify(sistemData));
                            lastSyncTime = new Date().toISOString();
                            updateSyncStatus('✅ Dados atualizados do servidor', 'success');
                            updateSyncIndicator();
                            
                            // Atualizar a interface se estiver na dashboard
                            if (document.querySelector('[data-section="dashboard"]')?.classList.contains('active')) {
                                showSection('dashboard');
                            }
                        } else {
                            sistemData.syncStatus = 'synced';
                            updateSyncStatus('ℹ️ Dados locais estão atualizados', 'info');
                            updateSyncIndicator();
                        }
                    } else {
                        // Não há dados no Firebase, fazer upload dos dados locais
                        saveToFirebase();
                    }
                })
                .catch((error) => {
                    sistemData.syncStatus = 'error';
                    updateSyncStatus('❌ Erro ao carregar dados', 'error');
                    updateSyncIndicator();
                    console.error('Erro ao carregar do Firebase:', error);
                })
                .finally(() => {
                    syncInProgress = false;
                });
        };
        
        // Configurar sincronização em tempo real
        window.setupRealtimeSync = function() {
            if (!window.firebaseConnected) return;
            
            const dataRef = window.firebaseRef(window.firebaseDB, 'reiDaCacambinha');
            
            window.firebaseOnValue(dataRef, (snapshot) => {
                if (snapshot.exists() && !syncInProgress) {
                    const firebaseData = snapshot.val();
                    const localLastUpdated = new Date(sistemData.lastUpdated || 0);
                    const firebaseLastUpdated = new Date(firebaseData.lastUpdated || 0);
                    
                    // Só atualizar se os dados do Firebase são mais recentes
                    if (firebaseLastUpdated > localLastUpdated) {
                        sistemData = { ...firebaseData, syncStatus: 'synced' };
                        localStorage.setItem('reiDaCacambinha', JSON.stringify(sistemData));
                        updateSyncStatus('🔄 Dados atualizados automaticamente', 'success');
                        updateSyncIndicator();
                        
                        // Atualizar interface se necessário
                        const activeSection = document.querySelector('.sidebar-item.active')?.dataset.section;
                        if (activeSection) {
                            showSection(activeSection);
                        }
                    }
                }
            });
        };
        
        // Função para forçar sincronização
        window.forceSyncData = function() {
            if (!window.firebaseConnected) {
                showNotification('❌ Firebase não conectado!', 'error');
                return;
            }
            
            updateSyncStatus('🔄 Sincronizando...', 'info');
            loadFromFirebase();
        };
        
        // Função para resetar dados do Firebase
        window.resetFirebaseData = function() {
            if (!window.firebaseConnected) {
                showNotification('❌ Firebase não conectado!', 'error');
                return;
            }
            
            if (confirm('⚠️ ATENÇÃO: Isso apagará TODOS os dados do servidor. Esta ação não pode ser desfeita. Continuar?')) {
                if (confirm('Última chance! Confirma que deseja apagar os dados do servidor?')) {
                    const dataRef = window.firebaseRef(window.firebaseDB, 'reiDaCacambinha');
                    
                    window.firebaseRemove(dataRef)
                        .then(() => {
                            updateSyncStatus('🗑️ Dados do servidor removidos', 'success');
                            showNotification('🗑️ Dados do Firebase removidos com sucesso!', 'success');
                        })
                        .catch((error) => {
                            updateSyncStatus('❌ Erro ao remover dados', 'error');
                            console.error('Erro ao remover dados do Firebase:', error);
                        });
                }
            }
        };
        
        // Atualizar status de sincronização na interface
        function updateSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    <div class="flex items-center gap-2 text-sm ${getStatusColor(type)}">
                        <span>${message}</span>
                        <span class="text-xs opacity-75">${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>
                    </div>
                `;
            }
            
            // Atualizar indicador visual
            updateSyncIndicator();
        }
        
        // Atualizar indicador visual de sincronização
        function updateSyncIndicator() {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            const indicator = document.getElementById('syncIndicator');
            
            if (!dot || !text || !indicator) return;
            
            const status = getConnectivityStatus();
            
            // Atualizar aparência baseada no status
            switch(status.status) {
                case 'synced':
                    dot.className = 'w-3 h-3 rounded-full bg-green-500 transition-all duration-300 animate-pulse';
                    text.textContent = 'Online';
                    text.className = 'text-green-700 font-medium';
                    indicator.className = 'fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-white rounded-full shadow-lg border border-green-200 px-3 py-2 text-sm transition-all duration-300';
                    break;
                    
                case 'syncing':
                    dot.className = 'w-3 h-3 rounded-full bg-yellow-500 transition-all duration-300 animate-spin';
                    text.textContent = 'Sincronizando...';
                    text.className = 'text-yellow-700 font-medium';
                    indicator.className = 'fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-white rounded-full shadow-lg border border-yellow-200 px-3 py-2 text-sm transition-all duration-300';
                    break;
                    
                case 'error':
                    dot.className = 'w-3 h-3 rounded-full bg-red-500 transition-all duration-300 animate-pulse';
                    text.textContent = 'Erro';
                    text.className = 'text-red-700 font-medium';
                    indicator.className = 'fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-white rounded-full shadow-lg border border-red-200 px-3 py-2 text-sm transition-all duration-300';
                    break;
                    
                case 'offline':
                default:
                    dot.className = 'w-3 h-3 rounded-full bg-gray-400 transition-all duration-300';
                    text.textContent = 'Offline';
                    text.className = 'text-gray-600 font-medium';
                    indicator.className = 'fixed bottom-4 right-4 z-50 flex items-center gap-2 bg-white rounded-full shadow-lg border border-gray-200 px-3 py-2 text-sm transition-all duration-300';
                    break;
            }
        }
        
        function getStatusColor(type) {
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };
            return colors[type] || 'text-gray-600';
        }
        
        // Verificar status de conectividade
        function getConnectivityStatus() {
            if (!window.firebaseConnected) {
                return { status: 'offline', message: '🔴 Offline - Apenas dados locais', color: 'text-red-600' };
            }
            
            if (syncInProgress) {
                return { status: 'syncing', message: '🟡 Sincronizando...', color: 'text-yellow-600' };
            }
            
            switch (sistemData.syncStatus) {
                case 'synced':
                    return { status: 'synced', message: '🟢 Sincronizado', color: 'text-green-600' };
                case 'error':
                    return { status: 'error', message: '🔴 Erro na sincronização', color: 'text-red-600' };
                default:
                    return { status: 'local', message: '🟡 Apenas local', color: 'text-yellow-600' };
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Adicionar tooltip e click no indicador de sincronização
        window.setupSyncIndicatorEvents = function() {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.addEventListener('click', function() {
                    const status = getConnectivityStatus();
                    let message = '';
                    
                    switch(status.status) {
                        case 'synced':
                            message = `✅ Conectado e sincronizado\nÚltima sincronização: ${lastSyncTime ? new Date(lastSyncTime).toLocaleTimeString('pt-BR') : 'Agora'}`;
                            break;
                        case 'syncing':
                            message = '🔄 Sincronizando dados com o servidor...';
                            break;
                        case 'error':
                            message = '❌ Erro na sincronização\nClique para tentar novamente';
                            forceSyncData();
                            break;
                        case 'offline':
                        default:
                            message = '🔴 Offline\nOs dados estão sendo salvos apenas localmente';
                            break;
                    }
                    
                    showNotification(message, status.status === 'synced' ? 'success' : status.status === 'error' ? 'error' : 'info');
                });
                
                // Adicionar título para tooltip
                indicator.title = 'Status da sincronização - Clique para mais informações';
            }
        };
        
        // Chamar setup após a inicialização
        setTimeout(() => {
            setupSyncIndicatorEvents();
        }, 1000);

        // Fechar modais ao clicar fora
        document.addEventListener('click', function(e) {
            const modals = ['minerioModal', 'clienteModal', 'motoristaModal', 'veiculoModal', 'vendaModal', 'estoqueModal', 'despesaModal', 'cobrancaModal', 'estoqueAlertaModal'];
            modals.forEach(modalId => {
                if (e.target.id === modalId) {
                    document.getElementById(modalId).classList.add('hidden');
                    document.getElementById(modalId).classList.remove('flex');
                }
            });
        });

        // Funções de Cobranças
        window.openCobrancaModal = function() {
            const clienteSelect = document.getElementById('cobrancaCliente');
            clienteSelect.innerHTML = '<option value="">Selecione o cliente...</option>';
            
            // Adicionar apenas clientes com vendas pendentes
            const clientesPendentes = [...new Set(
                sistemData.vendas
                    .filter(v => v.tipoPagamento === 'a_prazo' && !v.pago)
                    .map(v => v.cliente)
            )];
            
            clientesPendentes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                option.textContent = cliente;
                clienteSelect.appendChild(option);
            });
            
            document.getElementById('cobrancaModal').classList.remove('hidden');
            document.getElementById('cobrancaModal').classList.add('flex');
            document.getElementById('cobrancaForm').reset();
        };

        window.closeCobrancaModal = function() {
            document.getElementById('cobrancaModal').classList.add('hidden');
            document.getElementById('cobrancaModal').classList.remove('flex');
        };

        window.marcarComoPago = function(index) {
            if (confirm('Confirma o pagamento desta venda?')) {
                sistemData.vendas[index].pago = true;
                sistemData.vendas[index].dataPagamento = new Date().toISOString();
                saveData();
                showSection('cobranca');
                showNotification('✅ Pagamento confirmado!', 'success');
            }
        };

        function processarPagamento(cliente, valorPago) {
            const vendasPendentes = sistemData.vendas
                .filter(v => v.cliente === cliente && v.tipoPagamento === 'a_prazo' && !v.pago)
                .sort((a, b) => new Date(a.data) - new Date(b.data)); // Mais antigas primeiro
            
            let valorRestante = valorPago;
            let vendasQuitadas = 0;
            
            for (let venda of vendasPendentes) {
                if (valorRestante >= venda.valor) {
                    // Quita a venda inteira
                    venda.pago = true;
                    venda.dataPagamento = new Date().toISOString();
                    valorRestante -= venda.valor;
                    vendasQuitadas++;
                } else if (valorRestante > 0) {
                    // Pagamento parcial - criar nova venda com o restante
                    const novaVenda = { ...venda };
                    novaVenda.id = Date.now();
                    novaVenda.valor = venda.valor - valorRestante;
                    
                    venda.valor = valorRestante;
                    venda.pago = true;
                    venda.dataPagamento = new Date().toISOString();
                    
                    sistemData.vendas.push(novaVenda);
                    valorRestante = 0;
                    vendasQuitadas++;
                    break;
                }
            }
            
            return { vendasQuitadas, valorRestante };
        }

        // Funções de Relatórios
        window.gerarRelatorioVendas = function() {
            // Filtrar vendas pelo período selecionado
            const vendasFiltradas = filtrarDadosPorPeriodo(sistemData.vendas);
            const receitaFiltrada = vendasFiltradas.reduce((total, v) => total + v.valor, 0);
            const ticketMedio = vendasFiltradas.length > 0 ? receitaFiltrada / vendasFiltradas.length : 0;
            
            // Obter informações do período
            const filtro = window.filtroRelatorioAtual || { tipo: 'todos' };
            let textoPeriodo = 'Todos os períodos';
            
            if (filtro.tipo !== 'todos') {
                const datas = getDatasFiltroRelatorio();
                if (datas) {
                    const inicio = datas.inicio.toLocaleDateString('pt-BR');
                    const fim = datas.fim.toLocaleDateString('pt-BR');
                    textoPeriodo = `${inicio} até ${fim}`;
                }
            }
            
            const content = document.getElementById('relatorioContent');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    📊 Relatório de Vendas
                    <span class="ml-3 text-sm font-normal bg-blue-100 text-blue-800 px-3 py-1 rounded-full">${textoPeriodo}</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800">Total de Vendas</h4>
                        <p class="text-2xl font-bold text-blue-900">${vendasFiltradas.length}</p>
                        <p class="text-xs text-blue-600">Período selecionado</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800">Receita Total</h4>
                        <p class="text-2xl font-bold text-green-900">R$ ${receitaFiltrada.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        <p class="text-xs text-green-600">Período selecionado</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800">Ticket Médio</h4>
                        <p class="text-2xl font-bold text-purple-900">R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        <p class="text-xs text-purple-600">Período selecionado</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg border p-4">
                    <h4 class="font-semibold mb-2">Vendas por Material (Período)</h4>
                    ${getVendasPorMaterialFiltradas(vendasFiltradas)}
                </div>
                <div class="bg-white rounded-lg border p-4 mt-4">
                    <h4 class="font-semibold mb-2">Detalhes das Vendas</h4>
                    ${getDetalheVendasFiltradas(vendasFiltradas)}
                </div>
            `;
        };

        window.gerarRelatorioFinanceiro = function() {
            // Filtrar dados pelo período selecionado
            const vendasFiltradas = filtrarDadosPorPeriodo(sistemData.vendas);
            const despesasFiltradas = filtrarDadosPorPeriodo(sistemData.despesas);
            
            const receitas = vendasFiltradas.reduce((total, v) => total + v.valor, 0);
            const despesas = despesasFiltradas.reduce((total, d) => total + d.valor, 0);
            const lucro = receitas - despesas;
            
            // Obter informações do período
            const filtro = window.filtroRelatorioAtual || { tipo: 'todos' };
            let textoPeriodo = 'Todos os períodos';
            
            if (filtro.tipo !== 'todos') {
                const datas = getDatasFiltroRelatorio();
                if (datas) {
                    const inicio = datas.inicio.toLocaleDateString('pt-BR');
                    const fim = datas.fim.toLocaleDateString('pt-BR');
                    textoPeriodo = `${inicio} até ${fim}`;
                }
            }
            
            const content = document.getElementById('relatorioContent');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    💰 Relatório Financeiro (DRE)
                    <span class="ml-3 text-sm font-normal bg-green-100 text-green-800 px-3 py-1 rounded-full">${textoPeriodo}</span>
                </h3>
                <div class="bg-white rounded-lg border p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">RECEITAS</span>
                            <span class="font-bold text-green-600">R$ ${receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="font-semibold">DESPESAS OPERACIONAIS</span>
                            <span class="font-bold text-red-600">R$ ${despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between border-b pb-2 text-lg">
                            <span class="font-bold">RESULTADO</span>
                            <span class="font-bold ${lucro >= 0 ? 'text-green-600' : 'text-red-600'}">R$ ${lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">MARGEM</span>
                            <span class="font-bold">${receitas > 0 ? ((lucro / receitas) * 100).toFixed(1) : 0}%</span>
                        </div>
                    </div>
                </div>
            `;
        };

        window.gerarRelatorioClientes = function() {
            const content = document.getElementById('relatorioContent');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4">👥 Relatório de Clientes</h3>
                
                <!-- Seletor de Cliente -->
                <div class="bg-white rounded-lg border p-4 mb-6">
                    <div class="flex items-center gap-4 mb-4">
                        <label class="font-semibold text-gray-700">Filtrar por cliente:</label>
                        <select id="clienteRelatorioSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 min-w-[200px]">
                            <option value="">📊 Todos os clientes</option>
                            ${sistemData.clientes.map(cliente => 
                                `<option value="${cliente.empresa}">${cliente.empresa}</option>`
                            ).join('')}
                        </select>
                        <button onclick="atualizarRelatorioCliente()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                            🔄 Atualizar
                        </button>
                    </div>
                </div>
                
                <div id="relatorioClienteContent" class="bg-white rounded-lg border p-4">
                    ${getRelatorioClientes()}
                </div>
            `;
            
            // Adicionar event listeners
            document.getElementById('clienteRelatorioSelect').addEventListener('change', atualizarRelatorioCliente);
            
            // Event listener para filtro de período
            const periodoSelect = document.getElementById('periodoRelatorioSelect');
            const periodoPersonalizadoDiv = document.getElementById('periodoPersonalizadoDiv');
            
            if (periodoSelect) {
                periodoSelect.addEventListener('change', function() {
                    if (periodoPersonalizadoDiv) {
                        if (this.value === 'personalizado') {
                            periodoPersonalizadoDiv.classList.remove('hidden');
                        } else {
                            periodoPersonalizadoDiv.classList.add('hidden');
                        }
                    }
                });
            }
        };

        window.gerarRelatorioDespesas = function() {
            const content = document.getElementById('relatorioContent');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4">💸 Relatório de Despesas</h3>
                <div class="bg-white rounded-lg border p-4">
                    ${getRelatorioDespesas()}
                </div>
            `;
        };

        window.gerarRelatorioEstoque = function() {
            const content = document.getElementById('relatorioContent');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4">📦 Relatório de Estoque por Quantidade</h3>
                <div class="bg-white rounded-lg border p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800">Saldo Financeiro</h4>
                            <p class="text-2xl font-bold text-blue-900">R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800">Estoque Brita 5/8</h4>
                            <p class="text-2xl font-bold text-green-900">${calcularEstoqueBrita().toFixed(1)} t</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-purple-800">Estoque Total</h4>
                            <p class="text-2xl font-bold text-purple-900">${calcularPesoEstoque().toFixed(1)} t</p>
                        </div>
                        <div class="bg-orange-100 p-4 rounded-lg">
                            <h4 class="font-semibold text-orange-800">Movimentações</h4>
                            <p class="text-2xl font-bold text-orange-900">${sistemData.estoque.movimentacoes.length}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold mb-4">📊 Distribuição por Material</h4>
                            ${getDistribuicaoMateriais()}
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-4">📈 Movimentação por Quantidade</h4>
                            ${getMovimentacaoQuantidade()}
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="font-semibold mb-4">🔄 Últimas Movimentações (Quantidade)</h4>
                        ${getUltimasMovimentacoesQuantidade()}
                    </div>
                </div>
            `;
        };

        window.gerarRelatorioCompleto = function() {
            const content = document.getElementById('relatorioContent');
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-4">📋 Relatório Completo</h3>
                <div class="space-y-6">
                    <div class="bg-white rounded-lg border p-4">
                        <h4 class="font-semibold mb-2">Resumo Geral</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <div class="text-sm text-gray-600">Vendas</div>
                                <div class="text-xl font-bold">${sistemData.vendas.length}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Clientes</div>
                                <div class="text-xl font-bold">${sistemData.clientes.length}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Veículos</div>
                                <div class="text-xl font-bold">${sistemData.veiculos.length}</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Motoristas</div>
                                <div class="text-xl font-bold">${sistemData.motoristas.length}</div>
                            </div>
                        </div>
                    </div>
                    ${getRelatorioCompleto()}
                </div>
            `;
        };

        // Funções auxiliares para relatórios
        function getVendasPorMaterial() {
            const materiais = {};
            sistemData.vendas.forEach(venda => {
                if (!materiais[venda.material]) {
                    materiais[venda.material] = { quantidade: 0, valor: 0, vendas: 0 };
                }
                materiais[venda.material].quantidade += venda.quantidade;
                materiais[venda.material].valor += venda.valor;
                materiais[venda.material].vendas += 1;
            });
            
            return Object.entries(materiais).map(([material, dados]) => `
                <div class="flex justify-between items-center py-2 border-b">
                    <div>
                        <span class="font-medium">${material}</span>
                        <span class="text-sm text-gray-600 ml-2">(${dados.vendas} vendas)</span>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        <div class="text-sm text-gray-600">${dados.quantidade.toFixed(1)} t</div>
                    </div>
                </div>
            `).join('');
        }

        function getRelatorioClientes(clienteSelecionado = null, periodoFiltro = 'todos', dataInicio = null, dataFim = null) {
            if (clienteSelecionado) {
                return getRelatorioClienteEspecifico(clienteSelecionado, periodoFiltro, dataInicio, dataFim);
            }
            
            // Filtrar vendas por período
            let vendasFiltradas = sistemData.vendas;
            
            if (periodoFiltro !== 'todos') {
                const hoje = new Date();
                let inicioFiltroPeriodo, fimFiltroPeriodo;
                
                switch (periodoFiltro) {
                    case 'hoje':
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);
                        break;
                    case 'semana':
                        const inicioSemana = hoje.getDate() - hoje.getDay();
                        inicioFiltroPeriodo = new Date(hoje.setDate(inicioSemana));
                        inicioFiltroPeriodo.setHours(0, 0, 0, 0);
                        fimFiltroPeriodo = new Date(inicioFiltroPeriodo);
                        fimFiltroPeriodo.setDate(inicioFiltroPeriodo.getDate() + 6);
                        fimFiltroPeriodo.setHours(23, 59, 59);
                        break;
                    case 'mes':
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0, 23, 59, 59);
                        break;
                    case 'trimestre':
                        const mesAtual = hoje.getMonth();
                        const inicioTrimestre = Math.floor(mesAtual / 3) * 3;
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), inicioTrimestre, 1);
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), inicioTrimestre + 3, 0, 23, 59, 59);
                        break;
                    case 'ano':
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), 0, 1);
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), 11, 31, 23, 59, 59);
                        break;
                    case 'personalizado':
                        if (dataInicio && dataFim) {
                            inicioFiltroPeriodo = new Date(dataInicio);
                            fimFiltroPeriodo = new Date(dataFim);
                            fimFiltroPeriodo.setHours(23, 59, 59);
                        } else {
                            inicioFiltroPeriodo = null;
                            fimFiltroPeriodo = null;
                        }
                        break;
                }
                
                if (inicioFiltroPeriodo && fimFiltroPeriodo) {
                    vendasFiltradas = sistemData.vendas.filter(venda => {
                        const dataVenda = new Date(venda.data);
                        return dataVenda >= inicioFiltroPeriodo && dataVenda <= fimFiltroPeriodo;
                    });
                }
            }
            
            const clientes = {};
            vendasFiltradas.forEach(venda => {
                if (!clientes[venda.cliente]) {
                    clientes[venda.cliente] = { valor: 0, vendas: 0, ultimaCompra: venda.data };
                }
                clientes[venda.cliente].valor += venda.valor;
                clientes[venda.cliente].vendas += 1;
                if (new Date(venda.data) > new Date(clientes[venda.cliente].ultimaCompra)) {
                    clientes[venda.cliente].ultimaCompra = venda.data;
                }
            });
            
            // Texto do período para exibição
            let textoPerido = 'Todos os períodos';
            if (periodoFiltro !== 'todos') {
                switch (periodoFiltro) {
                    case 'hoje': textoPerido = 'Hoje'; break;
                    case 'semana': textoPerido = 'Esta semana'; break;
                    case 'mes': textoPerido = 'Este mês'; break;
                    case 'trimestre': textoPerido = 'Este trimestre'; break;
                    case 'ano': textoPerido = 'Este ano'; break;
                    case 'personalizado': 
                        if (dataInicio && dataFim) {
                            textoPerido = `${new Date(dataInicio).toLocaleDateString('pt-BR')} até ${new Date(dataFim).toLocaleDateString('pt-BR')}`;
                        }
                        break;
                }
            }
            
            if (Object.keys(clientes).length === 0) {
                return `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">👥</div>
                        <div class="font-semibold mb-2">Nenhuma venda registrada</div>
                        <div class="text-sm">Não há dados de clientes para exibir</div>
                    </div>
                `;
            }
            
            return `
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">📈 Ranking de Clientes por Faturamento</h4>
                    <div class="text-sm text-gray-600">Período: ${textoPerido}</div>
                </div>
                <div class="space-y-2">
                    ${Object.entries(clientes)
                        .sort((a, b) => b[1].valor - a[1].valor)
                        .map(([cliente, dados], index) => `
                            <div class="flex justify-between items-center py-3 px-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="selecionarClienteRelatorio('${cliente}')">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <span class="font-medium text-gray-900">${cliente}</span>
                                        <div class="text-sm text-gray-600">${dados.vendas} compra(s) • Última: ${new Date(dados.ultimaCompra).toLocaleDateString('pt-BR')}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-green-600 text-lg">R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                    <div class="text-sm text-gray-600">Faturamento total</div>
                                </div>
                            </div>
                        `).join('')}
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <div class="flex items-center text-blue-800">
                        <span class="text-xl mr-2">💡</span>
                        <span class="font-semibold">Dica:</span>
                    </div>
                    <p class="text-blue-700 text-sm mt-1">Clique em qualquer cliente acima para ver o relatório detalhado individual.</p>
                </div>
            `;
        }
        
        function getRelatorioClienteEspecifico(nomeCliente, periodoFiltro = 'todos', dataInicio = null, dataFim = null) {
            const cliente = sistemData.clientes.find(c => c.empresa === nomeCliente);
            let vendasCliente = sistemData.vendas.filter(v => v.cliente === nomeCliente);
            
            // Filtrar vendas por período
            if (periodoFiltro !== 'todos') {
                const hoje = new Date();
                let inicioFiltroPeriodo, fimFiltroPeriodo;
                
                switch (periodoFiltro) {
                    case 'hoje':
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59);
                        break;
                    case 'semana':
                        const inicioSemana = hoje.getDate() - hoje.getDay();
                        inicioFiltroPeriodo = new Date(hoje.setDate(inicioSemana));
                        inicioFiltroPeriodo.setHours(0, 0, 0, 0);
                        fimFiltroPeriodo = new Date(inicioFiltroPeriodo);
                        fimFiltroPeriodo.setDate(inicioFiltroPeriodo.getDate() + 6);
                        fimFiltroPeriodo.setHours(23, 59, 59);
                        break;
                    case 'mes':
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0, 23, 59, 59);
                        break;
                    case 'trimestre':
                        const mesAtual = hoje.getMonth();
                        const inicioTrimestre = Math.floor(mesAtual / 3) * 3;
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), inicioTrimestre, 1);
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), inicioTrimestre + 3, 0, 23, 59, 59);
                        break;
                    case 'ano':
                        inicioFiltroPeriodo = new Date(hoje.getFullYear(), 0, 1);
                        fimFiltroPeriodo = new Date(hoje.getFullYear(), 11, 31, 23, 59, 59);
                        break;
                    case 'personalizado':
                        if (dataInicio && dataFim) {
                            inicioFiltroPeriodo = new Date(dataInicio);
                            fimFiltroPeriodo = new Date(dataFim);
                            fimFiltroPeriodo.setHours(23, 59, 59);
                        } else {
                            inicioFiltroPeriodo = null;
                            fimFiltroPeriodo = null;
                        }
                        break;
                }
                
                if (inicioFiltroPeriodo && fimFiltroPeriodo) {
                    vendasCliente = vendasCliente.filter(venda => {
                        const dataVenda = new Date(venda.data);
                        return dataVenda >= inicioFiltroPeriodo && dataVenda <= fimFiltroPeriodo;
                    });
                }
            }
            
            if (!cliente && vendasCliente.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-3">❓</div>
                        <div class="font-semibold mb-2">Cliente não encontrado</div>
                        <div class="text-sm">Nenhum dado disponível para este cliente</div>
                    </div>
                `;
            }
            
            // Calcular estatísticas
            const totalCompras = vendasCliente.length;
            const valorTotal = vendasCliente.reduce((total, v) => total + v.valor, 0);
            const quantidadeTotal = vendasCliente.reduce((total, v) => total + v.quantidade, 0);
            const ticketMedio = totalCompras > 0 ? valorTotal / totalCompras : 0;
            const primeiraCompra = vendasCliente.length > 0 ? Math.min(...vendasCliente.map(v => new Date(v.data))) : null;
            const ultimaCompra = vendasCliente.length > 0 ? Math.max(...vendasCliente.map(v => new Date(v.data))) : null;
            
            // Materiais mais comprados
            const materiais = {};
            vendasCliente.forEach(venda => {
                if (!materiais[venda.material]) {
                    materiais[venda.material] = { quantidade: 0, valor: 0, compras: 0 };
                }
                materiais[venda.material].quantidade += venda.quantidade;
                materiais[venda.material].valor += venda.valor;
                materiais[venda.material].compras += 1;
            });
            
            // Vendas pendentes
            const vendasPendentes = vendasCliente.filter(v => v.tipoPagamento === 'a_prazo' && !v.pago);
            const valorPendente = vendasPendentes.reduce((total, v) => total + v.valor, 0);
            
            return `
                <div class="space-y-6">
                    <!-- Header do Cliente -->
                    <div class="flex items-center justify-between border-b pb-4">
                        <div class="flex items-center">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                ${nomeCliente.substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <h4 class="text-2xl font-bold text-gray-900">${nomeCliente}</h4>
                                ${cliente ? `
                                    <div class="text-sm text-gray-600">
                                        📞 ${cliente.telefone} • 📍 ${cliente.bairro} • 🚚 ${cliente.distancia} km
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        CNPJ: ${cliente.cnpj} • Cadastrado: ${new Date(cliente.dataCadastro).toLocaleDateString('pt-BR')}
                                    </div>
                                ` : '<div class="text-sm text-gray-500">Dados cadastrais não disponíveis</div>'}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="gerarRelatorioClientes()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                ← Voltar
                            </button>
                            <button onclick="imprimirRelatorioClienteIndividual('${nomeCliente}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                📄 Imprimir PDF
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas do Cliente -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-r from-green-100 to-emerald-100 p-4 rounded-lg border border-green-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-green-800 font-semibold text-sm">💰 Faturamento</div>
                                    <div class="text-2xl font-bold text-green-900">R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                </div>
                                <div class="text-3xl">📈</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-100 to-cyan-100 p-4 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-blue-800 font-semibold text-sm">🛒 Compras</div>
                                    <div class="text-2xl font-bold text-blue-900">${totalCompras}</div>
                                </div>
                                <div class="text-3xl">📦</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-100 to-indigo-100 p-4 rounded-lg border border-purple-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-purple-800 font-semibold text-sm">🎯 Ticket Médio</div>
                                    <div class="text-2xl font-bold text-purple-900">R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                </div>
                                <div class="text-3xl">💎</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-100 to-yellow-100 p-4 rounded-lg border border-orange-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-orange-800 font-semibold text-sm">⚖️ Quantidade</div>
                                    <div class="text-2xl font-bold text-orange-900">${quantidadeTotal.toFixed(1)} t</div>
                                </div>
                                <div class="text-3xl">🏗️</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status de Pagamento -->
                    ${valorPendente > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <span class="text-red-600 text-xl mr-2">⚠️</span>
                                <div>
                                    <div class="font-semibold text-red-800">Pendências Financeiras</div>
                                    <div class="text-red-700">
                                        R$ ${valorPendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})} em ${vendasPendentes.length} venda(s) pendente(s)
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <span class="text-green-600 text-xl mr-2">✅</span>
                                <div class="font-semibold text-green-800">Cliente em dia com os pagamentos</div>
                            </div>
                        </div>
                    `}
                    
                    <!-- Informações Temporais -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white border rounded-lg p-4">
                            <h5 class="font-semibold text-gray-800 mb-3">📅 Histórico de Relacionamento</h5>
                            <div class="space-y-2 text-sm">
                                ${primeiraCompra ? `<div><span class="text-gray-600">Primeira compra:</span> <span class="font-medium">${new Date(primeiraCompra).toLocaleDateString('pt-BR')}</span></div>` : ''}
                                ${ultimaCompra ? `<div><span class="text-gray-600">Última compra:</span> <span class="font-medium">${new Date(ultimaCompra).toLocaleDateString('pt-BR')}</span></div>` : ''}
                                ${primeiraCompra && ultimaCompra ? `<div><span class="text-gray-600">Tempo de relacionamento:</span> <span class="font-medium">${Math.floor((ultimaCompra - primeiraCompra) / (1000 * 60 * 60 * 24))} dias</span></div>` : ''}
                                <div><span class="text-gray-600">Frequência média:</span> <span class="font-medium">${totalCompras > 1 && primeiraCompra && ultimaCompra ? Math.floor((ultimaCompra - primeiraCompra) / (1000 * 60 * 60 * 24) / (totalCompras - 1)) : 'N/A'} dias entre compras</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-white border rounded-lg p-4">
                            <h5 class="font-semibold text-gray-800 mb-3">🎯 Materiais Preferidos</h5>
                            <div class="space-y-2">
                                ${Object.entries(materiais)
                                    .sort((a, b) => b[1].valor - a[1].valor)
                                    .slice(0, 3)
                                    .map(([material, dados]) => `
                                        <div class="flex justify-between items-center py-1">
                                            <span class="text-sm font-medium">${material}</span>
                                            <div class="text-right">
                                                <div class="text-sm font-semibold text-green-600">R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                                                <div class="text-xs text-gray-500">${dados.quantidade.toFixed(1)} t • ${dados.compras}x</div>
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Histórico de Vendas -->
                    <div class="bg-white border rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-4">📋 Histórico de Vendas</h5>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Data</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Material</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Quantidade</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Valor</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Pagamento</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-700">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${vendasCliente
                                        .sort((a, b) => new Date(b.data) - new Date(a.data))
                                        .map(venda => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-3 py-2">${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                                                <td class="px-3 py-2">${venda.material}</td>
                                                <td class="px-3 py-2">${venda.quantidade.toFixed(1)} t</td>
                                                <td class="px-3 py-2 font-semibold text-green-600">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                                <td class="px-3 py-2">${getPagamentoLabel(venda.tipoPagamento)}</td>
                                                <td class="px-3 py-2">
                                                    ${venda.pago ? 
                                                        '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ Pago</span>' :
                                                        venda.tipoPagamento === 'a_prazo' ?
                                                            (venda.dataVencimento && new Date(venda.dataVencimento) < new Date() ?
                                                                '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">🚨 Vencido</span>' :
                                                                '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">⏰ Pendente</span>'
                                                            ) :
                                                            '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">✅ Pago</span>'
                                                    }
                                                </td>
                                            </tr>
                                        `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getRelatorioDespesas() {
            const tipos = {};
            sistemData.despesas.forEach(despesa => {
                if (!tipos[despesa.tipo]) {
                    tipos[despesa.tipo] = { valor: 0, quantidade: 0 };
                }
                tipos[despesa.tipo].valor += despesa.valor;
                tipos[despesa.tipo].quantidade += 1;
            });
            
            return Object.entries(tipos)
                .sort((a, b) => b[1].valor - a[1].valor)
                .map(([tipo, dados]) => `
                    <div class="flex justify-between items-center py-2 border-b">
                        <div>
                            <span class="font-medium">${getTipoLabel(tipo)}</span>
                            <span class="text-sm text-gray-600 ml-2">(${dados.quantidade} lançamentos)</span>
                        </div>
                        <div class="font-semibold text-red-600">R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </div>
                `).join('');
        }

        function getUltimasMovimentacoes() {
            return sistemData.estoque.movimentacoes
                .slice(-10)
                .reverse()
                .map(mov => `
                    <div class="flex justify-between items-center py-2 border-b">
                        <div>
                            <span class="font-medium">${mov.tipo === 'credito' ? '💰 Crédito' : '💸 Débito'}</span>
                            <span class="text-sm text-gray-600 ml-2">${new Date(mov.data).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold ${mov.tipo === 'credito' ? 'text-green-600' : 'text-red-600'}">
                                ${mov.tipo === 'credito' ? '+' : '-'} R$ ${mov.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        // Funções específicas para relatório de estoque por quantidade
        function calcularEstoqueBrita() {
            // Considera que a maior parte do estoque é Brita 5/8 (R$ 91,50/t)
            const precoBrita = 91.50;
            return sistemData.estoque.saldo / precoBrita;
        }

        function calcularEstoqueTotal() {
            // Retorna o estoque total em toneladas
            return calcularEstoqueBrita();
        }

        function calcularPesoEstoque() {
            // Agora retorna o mesmo que o estoque total já que trabalhamos em toneladas
            return calcularEstoqueTotal();
        }

        function getDistribuicaoMateriais() {
            const materiais = {};
            let totalQuantidade = 0;
            
            sistemData.vendas.forEach(venda => {
                if (!materiais[venda.material]) {
                    materiais[venda.material] = { quantidade: 0, vendas: 0 };
                }
                materiais[venda.material].quantidade += venda.quantidade;
                materiais[venda.material].vendas += 1;
                totalQuantidade += venda.quantidade;
            });
            
            if (Object.keys(materiais).length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhuma venda registrada ainda</p>';
            }
            
            return Object.entries(materiais)
                .sort((a, b) => b[1].quantidade - a[1].quantidade)
                .map(([material, dados]) => {
                    const percentual = totalQuantidade > 0 ? (dados.quantidade / totalQuantidade * 100).toFixed(1) : 0;
                    return `
                        <div class="flex justify-between items-center py-3 border-b">
                            <div>
                                <span class="font-medium">${material}</span>
                                <div class="text-sm text-gray-600">${dados.vendas} vendas</div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-blue-600">${dados.quantidade.toFixed(1)} t</div>
                                <div class="text-sm text-gray-600">${percentual}%</div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function getMovimentacaoQuantidade() {
            const movimentacoesPorMes = {};
            
            sistemData.vendas.forEach(venda => {
                const mes = new Date(venda.data).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                if (!movimentacoesPorMes[mes]) {
                    movimentacoesPorMes[mes] = { vendido: 0, vendas: 0 };
                }
                movimentacoesPorMes[mes].vendido += venda.quantidade;
                movimentacoesPorMes[mes].vendas += 1;
            });
            
            const meses = Object.keys(movimentacoesPorMes).slice(-6); // Últimos 6 meses
            
            if (meses.length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhuma movimentação registrada</p>';
            }
            
            return meses.map(mes => {
                const dados = movimentacoesPorMes[mes];
                return `
                    <div class="flex justify-between items-center py-3 border-b">
                        <div>
                            <span class="font-medium">${mes}</span>
                            <div class="text-sm text-gray-600">${dados.vendas} vendas</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-orange-600">${dados.vendido.toFixed(1)} m³</div>
                            <div class="text-sm text-gray-600">Vendido</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getUltimasMovimentacoesQuantidade() {
            const movimentacoes = [];
            
            // Adicionar vendas como saídas
            sistemData.vendas.slice(-10).forEach(venda => {
                movimentacoes.push({
                    data: venda.data,
                    tipo: 'saida',
                    descricao: `Venda - ${venda.material}`,
                    cliente: venda.cliente,
                    quantidade: venda.quantidade,
                    peso: venda.quantidade, // Agora já está em toneladas
                    valor: venda.valor
                });
            });
            
            // Adicionar créditos de estoque como entradas estimadas
            sistemData.estoque.movimentacoes
                .filter(mov => mov.tipo === 'credito' && mov.origem === 'credito_manual')
                .slice(-5)
                .forEach(mov => {
                    const quantidadeEstimada = mov.valor / 91.50; // Estima baseado no preço da brita por tonelada
                    
                    movimentacoes.push({
                        data: mov.data,
                        tipo: 'entrada',
                        descricao: 'Entrada de Material',
                        cliente: 'Estoque',
                        quantidade: quantidadeEstimada,
                        peso: quantidadeEstimada, // Já está em toneladas
                        valor: mov.valor
                    });
                });
            
            // Ordenar por data (mais recentes primeiro)
            movimentacoes.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            if (movimentacoes.length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhuma movimentação encontrada</p>';
            }
            
            return movimentacoes.slice(0, 10).map(mov => `
                <div class="flex justify-between items-center py-3 border-b">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <span class="font-medium ${mov.tipo === 'entrada' ? 'text-green-600' : 'text-red-600'}">
                                ${mov.tipo === 'entrada' ? '📥 Entrada' : '📤 Saída'}
                            </span>
                            <span class="text-sm text-gray-600 ml-2">${new Date(mov.data).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div class="text-sm text-gray-700">${mov.descricao}</div>
                        <div class="text-xs text-gray-500">${mov.cliente}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold ${mov.tipo === 'entrada' ? 'text-green-600' : 'text-red-600'}">
                            ${mov.tipo === 'entrada' ? '+' : '-'} ${mov.quantidade.toFixed(1)} t
                        </div>
                        <div class="text-xs text-gray-500">R$ ${mov.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </div>
                </div>
            `).join('');
        }

        function getRelatorioCompleto() {
            return `
                <div class="bg-white rounded-lg border p-4">
                    <h4 class="font-semibold mb-2">Performance Financeira</h4>
                    <div class="text-sm">
                        Receita Total: R$ ${getTotalReceita().toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                        Despesas Total: R$ ${getTotalDespesas().toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                        Lucro: R$ ${(getTotalReceita() - getTotalDespesas()).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                        Saldo Estoque: R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </div>
                </div>
            `;
        }

        // Funções de Configurações
        window.exportarDados = function() {
            const dataStr = JSON.stringify(sistemData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rei-cacambinha-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('📤 Dados exportados com sucesso!', 'success');
        };

        window.importarDados = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (confirm('Isso substituirá todos os dados atuais. Continuar?')) {
                                sistemData = dados;
                                saveData();
                                showNotification('📥 Dados importados com sucesso!', 'success');
                                showSection('dashboard');
                            }
                        } catch (error) {
                            alert('Erro ao importar dados: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        window.limparDados = function() {
            if (confirm('ATENÇÃO: Isso apagará TODOS os dados do sistema. Esta ação não pode ser desfeita. Continuar?')) {
                if (confirm('Última chance! Tem certeza que deseja apagar tudo?')) {
                    localStorage.removeItem('reiDaCacambinha');
                    location.reload();
                }
            }
        };

        window.resetarSistema = function() {
            if (confirm('Isso resetará o sistema para as configurações padrão. Continuar?')) {
                sistemData = {
                    vendas: [],
                    clientes: [],
                    minerios: [],
                    motoristas: [],
                    veiculos: [],
                    estoque: { saldo: 0, movimentacoes: [] },
                    despesas: [],
                    cobrancas: [],
                    configuracoes: {},
                    lastUpdated: new Date().toISOString(),
                    syncStatus: 'local'
                };
                saveData();
                showNotification('🔄 Sistema resetado!', 'success');
                showSection('dashboard');
            }
        };

        // Funções para Relatório de Clientes
        window.atualizarRelatorioCliente = function() {
            const clienteSelecionado = document.getElementById('clienteRelatorioSelect').value;
            const content = document.getElementById('relatorioClienteContent');
            if (content) {
                content.innerHTML = getRelatorioClientes(clienteSelecionado);
            }
        };
        
        window.selecionarClienteRelatorio = function(nomeCliente) {
            const select = document.getElementById('clienteRelatorioSelect');
            if (select) {
                select.value = nomeCliente;
                atualizarRelatorioCliente();
            }
        };

        // ===== FUNÇÕES DE IMPRESSÃO PDF =====
        
        // Configurações globais do PDF
        const pdfConfig = {
            empresa: {
                nome: 'REI DA CAÇAMBINHA',
                subtitulo: 'Transportadora de Minérios',
                endereco: 'Cidade - Estado',
                telefone: '(00) 00000-0000'
            },
            margens: {
                top: 20,
                left: 20,
                right: 20,
                bottom: 20
            },
            cores: {
                primaria: [33, 150, 243], // Azul
                secundaria: [76, 175, 80], // Verde
                texto: [33, 33, 33], // Cinza escuro
                linha: [200, 200, 200] // Cinza claro
            }
        };

        // Função para criar cabeçalho do PDF
        function criarCabecalhoPDF(doc, titulo, subtitulo = '') {
            const { empresa, margens, cores } = pdfConfig;
            
            // Logo/Título da empresa
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...cores.primaria);
            doc.text(empresa.nome, margens.left, margens.top + 10);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...cores.texto);
            doc.text(empresa.subtitulo, margens.left, margens.top + 18);
            
            // Data e hora
            const agora = new Date();
            const dataHora = `${agora.toLocaleDateString('pt-BR')} às ${agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
            doc.text(`Gerado em: ${dataHora}`, 210 - margens.right - 60, margens.top + 10, { align: 'right' });
            
            // Linha separadora
            doc.setDrawColor(...cores.linha);
            doc.line(margens.left, margens.top + 25, 210 - margens.right, margens.top + 25);
            
            // Título do relatório
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...cores.primaria);
            doc.text(titulo, margens.left, margens.top + 35);
            
            if (subtitulo) {
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...cores.texto);
                doc.text(subtitulo, margens.left, margens.top + 45);
                return margens.top + 55;
            }
            
            return margens.top + 45;
        }

        // Função para criar rodapé do PDF
        function criarRodapePDF(doc, numeroPagina = 1) {
            const { margens, cores } = pdfConfig;
            
            doc.setDrawColor(...cores.linha);
            doc.line(margens.left, 280, 210 - margens.right, 280);
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...cores.texto);
            doc.text('Sistema de Gestão - Rei da Caçambinha v3.0', margens.left, 285);
            doc.text(`Página ${numeroPagina}`, 210 - margens.right - 20, 285, { align: 'right' });
        }

        // Função para adicionar tabela ao PDF
        function adicionarTabelaPDF(doc, headers, rows, startY, config = {}) {
            const { margens, cores } = pdfConfig;
            const defaultConfig = {
                startX: margens.left,
                columnWidths: [],
                headerHeight: 8,
                rowHeight: 6,
                fontSize: 8
            };
            
            const tableConfig = { ...defaultConfig, ...config };
            let currentY = startY;
            
            // Calcular larguras das colunas se não especificadas
            if (tableConfig.columnWidths.length === 0) {
                const tableWidth = 210 - margens.left - margens.right;
                const columnWidth = tableWidth / headers.length;
                tableConfig.columnWidths = new Array(headers.length).fill(columnWidth);
            }
            
            doc.setFontSize(tableConfig.fontSize);
            
            // Cabeçalho da tabela
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(...cores.primaria);
            doc.setTextColor(255, 255, 255);
            
            let currentX = tableConfig.startX;
            headers.forEach((header, index) => {
                doc.rect(currentX, currentY, tableConfig.columnWidths[index], tableConfig.headerHeight, 'F');
                doc.text(header, currentX + 2, currentY + 5);
                currentX += tableConfig.columnWidths[index];
            });
            
            currentY += tableConfig.headerHeight;
            
            // Linhas da tabela
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...cores.texto);
            
            rows.forEach((row, rowIndex) => {
                if (currentY > 270) { // Nova página se necessário
                    doc.addPage();
                    criarCabecalhoPDF(doc, 'Continuação...', '');
                    currentY = margens.top + 60;
                }
                
                currentX = tableConfig.startX;
                
                // Alternar cor de fundo das linhas
                if (rowIndex % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(tableConfig.startX, currentY, tableConfig.columnWidths.reduce((a, b) => a + b, 0), tableConfig.rowHeight, 'F');
                }
                
                row.forEach((cell, cellIndex) => {
                    const cellText = String(cell || '');
                    doc.text(cellText, currentX + 2, currentY + 4);
                    currentX += tableConfig.columnWidths[cellIndex];
                });
                
                currentY += tableConfig.rowHeight;
            });
            
            return currentY;
        }

        // Relatório de Vendas PDF
        window.imprimirRelatorioVendas = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO DE VENDAS', 'Análise completa das transações comerciais');
            
            // Métricas principais
            const totalVendas = sistemData.vendas.length;
            const receitaTotal = getTotalReceita();
            const ticketMedio = getTicketMedio();
            const quantidadeTotal = getTotalQuantidade();
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO EXECUTIVO:', 20, yPosition);
            
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Total de Vendas: ${totalVendas}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Receita Total: R$ ${receitaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Ticket Médio: R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Quantidade Total: ${quantidadeTotal.toFixed(1)} toneladas`, 25, yPosition);
            
            yPosition += 15;
            
            // Tabela de vendas
            if (sistemData.vendas.length > 0) {
                const headers = ['Data', 'Cliente', 'Material', 'Qtd (t)', 'Valor', 'Pagamento'];
                const rows = sistemData.vendas.slice(-15).map(venda => [
                    new Date(venda.data).toLocaleDateString('pt-BR'),
                    venda.cliente.substring(0, 20) + (venda.cliente.length > 20 ? '...' : ''),
                    venda.material.substring(0, 15) + (venda.material.length > 15 ? '...' : ''),
                    venda.quantidade.toFixed(1),
                    `R$ ${venda.valor.toLocaleString('pt-BR')}`,
                    getPagamentoLabel(venda.tipoPagamento)
                ]);
                
                doc.setFont('helvetica', 'bold');
                doc.text('ÚLTIMAS 15 VENDAS:', 20, yPosition);
                yPosition += 8;
                
                adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [25, 45, 35, 20, 30, 25]
                });
            }
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-vendas-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('📄 Relatório de Vendas exportado em PDF!', 'success');
        };

        // Relatório Financeiro PDF
        window.imprimirRelatorioFinanceiro = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO FINANCEIRO (DRE)', 'Demonstração do Resultado do Exercício');
            
            const receitas = getTotalReceita();
            const despesas = getTotalDespesas();
            const custoMateriais = sistemData.vendas.reduce((total, v) => {
                const minerio = sistemData.minerios.find(m => m.tipo === v.material);
                return total + (minerio ? minerio.preco * v.quantidade : 0);
            }, 0);
            const lucroLiquido = receitas - despesas - custoMateriais;
            const margemLucro = receitas > 0 ? (lucroLiquido / receitas) * 100 : 0;
            
            yPosition += 15;
            
            // DRE
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('DEMONSTRAÇÃO DO RESULTADO:', 20, yPosition);
            
            yPosition += 15;
            doc.setFontSize(10);
            
            // Linha de receitas
            doc.setFont('helvetica', 'bold');
            doc.text('RECEITAS OPERACIONAIS', 25, yPosition);
            doc.text(`R$ ${receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            doc.line(25, yPosition + 2, 180, yPosition + 2);
            
            yPosition += 10;
            doc.setFont('helvetica', 'normal');
            doc.text('(-) Vendas de Materiais', 30, yPosition);
            doc.text(`R$ ${receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            
            yPosition += 15;
            doc.setFont('helvetica', 'bold');
            doc.text('(-) CUSTOS DOS MATERIAIS VENDIDOS', 25, yPosition);
            doc.text(`R$ ${custoMateriais.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            
            yPosition += 15;
            const lucroOperacional = receitas - custoMateriais;
            doc.text('= LUCRO OPERACIONAL BRUTO', 25, yPosition);
            doc.text(`R$ ${lucroOperacional.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            doc.line(25, yPosition + 2, 180, yPosition + 2);
            
            yPosition += 15;
            doc.text('(-) DESPESAS OPERACIONAIS', 25, yPosition);
            doc.text(`R$ ${despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            
            yPosition += 10;
            doc.setFont('helvetica', 'normal');
            const despesasCombustivel = getDespesasPorTipo('combustivel');
            const despesasManutencao = getDespesasPorTipo('manutencao');
            const outrasSpesas = despesas - despesasCombustivel - despesasManutencao;
            
            doc.text('• Combustível', 30, yPosition);
            doc.text(`R$ ${despesasCombustivel.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            yPosition += 6;
            doc.text('• Manutenção', 30, yPosition);
            doc.text(`R$ ${despesasManutencao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            yPosition += 6;
            doc.text('• Outras Despesas', 30, yPosition);
            doc.text(`R$ ${outrasSpesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            
            yPosition += 15;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('= RESULTADO LÍQUIDO', 25, yPosition);
            doc.text(`R$ ${lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 150, yPosition);
            doc.line(25, yPosition - 3, 180, yPosition - 3);
            doc.line(25, yPosition + 2, 180, yPosition + 2);
            
            yPosition += 15;
            doc.setFontSize(10);
            doc.text('MARGEM DE LUCRO', 25, yPosition);
            doc.text(`${margemLucro.toFixed(2)}%`, 150, yPosition);
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-financeiro-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('📄 Relatório Financeiro exportado em PDF!', 'success');
        };

        // Relatório de Clientes PDF
        window.imprimirRelatorioClientes = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO DE CLIENTES', 'Análise do relacionamento comercial');
            
            // Calcular dados dos clientes
            const clientes = {};
            sistemData.vendas.forEach(venda => {
                if (!clientes[venda.cliente]) {
                    clientes[venda.cliente] = { valor: 0, vendas: 0, ultimaCompra: venda.data, quantidade: 0 };
                }
                clientes[venda.cliente].valor += venda.valor;
                clientes[venda.cliente].vendas += 1;
                clientes[venda.cliente].quantidade += venda.quantidade;
                if (new Date(venda.data) > new Date(clientes[venda.cliente].ultimaCompra)) {
                    clientes[venda.cliente].ultimaCompra = venda.data;
                }
            });
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO GERAL:', 20, yPosition);
            
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Total de Clientes Cadastrados: ${sistemData.clientes.length}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Clientes com Compras: ${Object.keys(clientes).length}`, 25, yPosition);
            yPosition += 6;
            const distanciaMedia = sistemData.clientes.length > 0 ? 
                (sistemData.clientes.reduce((sum, c) => sum + c.distancia, 0) / sistemData.clientes.length).toFixed(1) : 0;
            doc.text(`• Distância Média: ${distanciaMedia} km`, 25, yPosition);
            
            yPosition += 15;
            
            // Ranking de clientes
            if (Object.keys(clientes).length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('RANKING DE CLIENTES POR FATURAMENTO:', 20, yPosition);
                yPosition += 8;
                
                const headers = ['Pos.', 'Cliente', 'Compras', 'Quantidade (t)', 'Faturamento', 'Última Compra'];
                const rows = Object.entries(clientes)
                    .sort((a, b) => b[1].valor - a[1].valor)
                    .slice(0, 15)
                    .map(([cliente, dados], index) => [
                        (index + 1).toString(),
                        cliente.substring(0, 25) + (cliente.length > 25 ? '...' : ''),
                        dados.vendas.toString(),
                        dados.quantidade.toFixed(1),
                        `R$ ${dados.valor.toLocaleString('pt-BR')}`,
                        new Date(dados.ultimaCompra).toLocaleDateString('pt-BR')
                    ]);
                
                adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [15, 50, 20, 25, 35, 25]
                });
            }
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-clientes-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('📄 Relatório de Clientes exportado em PDF!', 'success');
        };

        // Relatório de Despesas PDF
        window.imprimirRelatorioDespesas = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO DE DESPESAS', 'Análise detalhada dos custos operacionais');
            
            // Calcular despesas por categoria
            const tipos = {};
            sistemData.despesas.forEach(despesa => {
                if (!tipos[despesa.tipo]) {
                    tipos[despesa.tipo] = { valor: 0, quantidade: 0 };
                }
                tipos[despesa.tipo].valor += despesa.valor;
                tipos[despesa.tipo].quantidade += 1;
            });
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO EXECUTIVO:', 20, yPosition);
            
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Total de Despesas: R$ ${getTotalDespesas().toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Número de Lançamentos: ${sistemData.despesas.length}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Despesas deste Mês: R$ ${getDespesasMes().toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            
            yPosition += 15;
            
            // Despesas por categoria
            if (Object.keys(tipos).length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('DESPESAS POR CATEGORIA:', 20, yPosition);
                yPosition += 8;
                
                const headers = ['Categoria', 'Quantidade', 'Valor Total', '% do Total'];
                const totalDespesas = getTotalDespesas();
                const rows = Object.entries(tipos)
                    .sort((a, b) => b[1].valor - a[1].valor)
                    .map(([tipo, dados]) => [
                        getTipoLabel(tipo),
                        dados.quantidade.toString(),
                        `R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        `${((dados.valor / totalDespesas) * 100).toFixed(1)}%`
                    ]);
                
                yPosition = adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [60, 30, 45, 25]
                });
            }
            
            yPosition += 10;
            
            // Últimas despesas
            if (sistemData.despesas.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('ÚLTIMAS 10 DESPESAS:', 20, yPosition);
                yPosition += 8;
                
                const headers = ['Data', 'Tipo', 'Veículo', 'Valor'];
                const rows = sistemData.despesas.slice(-10).reverse().map(despesa => [
                    new Date(despesa.data).toLocaleDateString('pt-BR'),
                    getTipoLabel(despesa.tipo).substring(0, 25),
                    despesa.veiculo || 'Geral',
                    `R$ ${despesa.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                ]);
                
                adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [25, 60, 30, 35]
                });
            }
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-despesas-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('📄 Relatório de Despesas exportado em PDF!', 'success');
        };

        // Relatório de Estoque PDF
        window.imprimirRelatorioEstoque = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO DE ESTOQUE', 'Controle de movimentações por quantidade');
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('SITUAÇÃO ATUAL:', 20, yPosition);
            
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Saldo Financeiro: R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Estoque Estimado (Brita 5/8): ${calcularEstoqueBrita().toFixed(1)} toneladas`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Total de Movimentações: ${sistemData.estoque.movimentacoes.length}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Total de Créditos: R$ ${getTotalCreditos().toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Total de Débitos: R$ ${getTotalDebitos().toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            
            yPosition += 15;
            
            // Movimentações recentes
            if (sistemData.estoque.movimentacoes.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('ÚLTIMAS 15 MOVIMENTAÇÕES:', 20, yPosition);
                yPosition += 8;
                
                const headers = ['Data', 'Tipo', 'Valor', 'Saldo Anterior', 'Saldo Novo'];
                const rows = sistemData.estoque.movimentacoes.slice(-15).reverse().map(mov => [
                    new Date(mov.data).toLocaleDateString('pt-BR'),
                    mov.tipo === 'credito' ? 'Crédito' : 'Débito',
                    `${mov.tipo === 'credito' ? '+' : '-'} R$ ${mov.valor.toLocaleString('pt-BR')}`,
                    `R$ ${mov.saldoAnterior.toLocaleString('pt-BR')}`,
                    `R$ ${mov.saldoNovo.toLocaleString('pt-BR')}`
                ]);
                
                adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [25, 25, 35, 35, 35]
                });
            }
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-estoque-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('📄 Relatório de Estoque exportado em PDF!', 'success');
        };

        // Relatório Individual de Cliente PDF
        window.imprimirRelatorioClienteIndividual = function(nomeCliente) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO INDIVIDUAL DE CLIENTE', `Análise detalhada - ${nomeCliente}`);
            
            const cliente = sistemData.clientes.find(c => c.empresa === nomeCliente);
            const vendasCliente = sistemData.vendas.filter(v => v.cliente === nomeCliente);
            
            if (!cliente && vendasCliente.length === 0) {
                doc.setFont('helvetica', 'normal');
                doc.text('Cliente não encontrado ou sem dados disponíveis.', 20, yPosition + 20);
                criarRodapePDF(doc, 1);
                doc.save(`relatorio-cliente-${nomeCliente.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.pdf`);
                return;
            }
            
            // Calcular estatísticas
            const totalCompras = vendasCliente.length;
            const valorTotal = vendasCliente.reduce((total, v) => total + v.valor, 0);
            const quantidadeTotal = vendasCliente.reduce((total, v) => total + v.quantidade, 0);
            const ticketMedio = totalCompras > 0 ? valorTotal / totalCompras : 0;
            const primeiraCompra = vendasCliente.length > 0 ? Math.min(...vendasCliente.map(v => new Date(v.data))) : null;
            const ultimaCompra = vendasCliente.length > 0 ? Math.max(...vendasCliente.map(v => new Date(v.data))) : null;
            
            yPosition += 15;
            
            // Dados do Cliente
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('DADOS DO CLIENTE:', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            if (cliente) {
                doc.text(`Empresa: ${cliente.empresa}`, 25, yPosition);
                yPosition += 6;
                doc.text(`CNPJ: ${cliente.cnpj}`, 25, yPosition);
                yPosition += 6;
                doc.text(`Telefone: ${cliente.telefone}`, 25, yPosition);
                yPosition += 6;
                doc.text(`Endereço: ${cliente.bairro}`, 25, yPosition);
                yPosition += 6;
                doc.text(`Distância: ${cliente.distancia} km`, 25, yPosition);
                yPosition += 6;
                doc.text(`Data de Cadastro: ${new Date(cliente.dataCadastro).toLocaleDateString('pt-BR')}`, 25, yPosition);
            } else {
                doc.text(`Empresa: ${nomeCliente}`, 25, yPosition);
                yPosition += 6;
                doc.text('Demais dados cadastrais não disponíveis', 25, yPosition);
            }
            
            yPosition += 15;
            
            // Resumo de Compras
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO DE COMPRAS:', 20, yPosition);
            
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Total de Compras: ${totalCompras}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Valor Total Comprado: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Quantidade Total: ${quantidadeTotal.toFixed(1)} toneladas`, 25, yPosition);
            yPosition += 6;
            doc.text(`• Valor Médio por Compra: R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
            
            if (primeiraCompra && ultimaCompra) {
                yPosition += 6;
                doc.text(`• Primeira Compra: ${new Date(primeiraCompra).toLocaleDateString('pt-BR')}`, 25, yPosition);
                yPosition += 6;
                doc.text(`• Última Compra: ${new Date(ultimaCompra).toLocaleDateString('pt-BR')}`, 25, yPosition);
                yPosition += 6;
                const diasRelacionamento = Math.floor((ultimaCompra - primeiraCompra) / (1000 * 60 * 60 * 24));
                doc.text(`• Tempo de Relacionamento: ${diasRelacionamento} dias`, 25, yPosition);
            }
            
            yPosition += 15;
            
            // Materiais Comprados
            const materiais = {};
            vendasCliente.forEach(venda => {
                if (!materiais[venda.material]) {
                    materiais[venda.material] = { quantidade: 0, valor: 0, compras: 0 };
                }
                materiais[venda.material].quantidade += venda.quantidade;
                materiais[venda.material].valor += venda.valor;
                materiais[venda.material].compras += 1;
            });
            
            if (Object.keys(materiais).length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('MATERIAIS COMPRADOS:', 20, yPosition);
                yPosition += 8;
                
                const headers = ['Material', 'Quantidade (t)', 'Compras', 'Valor Total'];
                const rows = Object.entries(materiais)
                    .sort((a, b) => b[1].valor - a[1].valor)
                    .map(([material, dados]) => [
                        material.substring(0, 30) + (material.length > 30 ? '...' : ''),
                        dados.quantidade.toFixed(1),
                        dados.compras.toString(),
                        `R$ ${dados.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                    ]);
                
                yPosition = adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [50, 30, 25, 35]
                });
            }
            
            yPosition += 15;
            
            // Histórico de Compras (últimas 15)
            if (vendasCliente.length > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text(`HISTÓRICO DE COMPRAS (${Math.min(vendasCliente.length, 15)} mais recentes):`, 20, yPosition);
                yPosition += 8;
                
                const headers = ['Data', 'Material', 'Quantidade (t)', 'Valor', 'Pagamento', 'Status'];
                const rows = vendasCliente
                    .sort((a, b) => new Date(b.data) - new Date(a.data))
                    .slice(0, 15)
                    .map(venda => [
                        new Date(venda.data).toLocaleDateString('pt-BR'),
                        venda.material.substring(0, 20) + (venda.material.length > 20 ? '...' : ''),
                        venda.quantidade.toFixed(1),
                        `R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
                        getPagamentoLabel(venda.tipoPagamento),
                        venda.pago ? 'Pago' : (venda.tipoPagamento === 'a_prazo' ? 
                            (venda.dataVencimento && new Date(venda.dataVencimento) < new Date() ? 'Vencido' : 'Pendente') : 'Pago')
                    ]);
                
                yPosition = adicionarTabelaPDF(doc, headers, rows, yPosition, {
                    columnWidths: [20, 35, 20, 25, 20, 20]
                });
            }
            
            yPosition += 10;
            
            // Situação Financeira (apenas pendências)
            const vendasPendentes = vendasCliente.filter(v => v.tipoPagamento === 'a_prazo' && !v.pago);
            const valorPendente = vendasPendentes.reduce((total, v) => total + v.valor, 0);
            
            if (valorPendente > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('SITUAÇÃO FINANCEIRA:', 20, yPosition);
                yPosition += 8;
                doc.setFont('helvetica', 'normal');
                doc.text(`• Valor Pendente: R$ ${valorPendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
                yPosition += 6;
                doc.text(`• Vendas Pendentes: ${vendasPendentes.length}`, 25, yPosition);
                
                // Listar vendas vencidas
                const vendasVencidas = vendasPendentes.filter(v => v.dataVencimento && new Date(v.dataVencimento) < new Date());
                if (vendasVencidas.length > 0) {
                    yPosition += 6;
                    doc.text(`• Vendas Vencidas: ${vendasVencidas.length}`, 25, yPosition);
                    yPosition += 6;
                    const valorVencido = vendasVencidas.reduce((total, v) => total + v.valor, 0);
                    doc.text(`• Valor Vencido: R$ ${valorVencido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, yPosition);
                }
            } else {
                doc.setFont('helvetica', 'bold');
                doc.text('SITUAÇÃO FINANCEIRA:', 20, yPosition);
                yPosition += 8;
                doc.setFont('helvetica', 'normal');
                doc.text('• Cliente em dia com os pagamentos', 25, yPosition);
            }
            
            // Rodapé com informações adicionais
            yPosition += 20;
            if (yPosition < 250) {
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text('Este relatório foi gerado exclusivamente para uso do cliente mencionado.', 20, yPosition);
                yPosition += 4;
                doc.text('Informações confidenciais - uso restrito.', 20, yPosition);
            }
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-cliente-${nomeCliente.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification(`📄 Relatório individual de ${nomeCliente} exportado em PDF!`, 'success');
        };

        // Relatório Completo PDF
        window.imprimirRelatorioCompleto = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = criarCabecalhoPDF(doc, 'RELATÓRIO EXECUTIVO COMPLETO', 'Visão geral de todas as operações');
            
            const receitas = getTotalReceita();
            const despesas = getTotalDespesas();
            const lucro = receitas - despesas;
            const margemLucro = receitas > 0 ? (lucro / receitas) * 100 : 0;
            
            yPosition += 10;
            
            // Resumo Executivo
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO EXECUTIVO', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Performance Financeira
            doc.setFont('helvetica', 'bold');
            doc.text('PERFORMANCE FINANCEIRA:', 25, yPosition);
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Receita Total: R$ ${receitas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Despesas Totais: R$ ${despesas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Resultado Líquido: R$ ${lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Margem de Lucro: ${margemLucro.toFixed(1)}%`, 30, yPosition);
            
            yPosition += 15;
            
            // Indicadores Operacionais
            doc.setFont('helvetica', 'bold');
            doc.text('INDICADORES OPERACIONAIS:', 25, yPosition);
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Total de Vendas: ${sistemData.vendas.length}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Clientes Ativos: ${sistemData.clientes.length}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Frota de Veículos: ${sistemData.veiculos.length}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Equipe de Motoristas: ${sistemData.motoristas.length}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Quantidade Vendida: ${getTotalQuantidade().toFixed(1)} toneladas`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Ticket Médio: R$ ${getTicketMedio().toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
            
            yPosition += 15;
            
            // Situação do Estoque
            doc.setFont('helvetica', 'bold');
            doc.text('SITUAÇÃO DO ESTOQUE:', 25, yPosition);
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            doc.text(`• Saldo Financeiro: R$ ${sistemData.estoque.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
            yPosition += 6;
            doc.text(`• Estoque Estimado: ${calcularEstoqueBrita().toFixed(1)} toneladas`, 30, yPosition);
            yPosition += 6;
            const estoqueStatus = sistemData.estoque.saldo >= (sistemData.configuracoes?.estoqueMinimo || 10000) ? 'Adequado' : 'Abaixo do mínimo';
            doc.text(`• Status: ${estoqueStatus}`, 30, yPosition);
            
            yPosition += 15;
            
            // Análise de Cobranças
            const totalPendente = getTotalPendente();
            const quantidadePendente = getQuantidadePendente();
            const totalAtrasado = getTotalAtrasado();
            
            if (totalPendente > 0 || totalAtrasado > 0) {
                doc.setFont('helvetica', 'bold');
                doc.text('SITUAÇÃO DE COBRANÇAS:', 25, yPosition);
                yPosition += 8;
                doc.setFont('helvetica', 'normal');
                doc.text(`• Valores a Receber: R$ ${totalPendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
                yPosition += 6;
                doc.text(`• Vendas Pendentes: ${quantidadePendente}`, 30, yPosition);
                yPosition += 6;
                if (totalAtrasado > 0) {
                    doc.text(`• Valores em Atraso: R$ ${totalAtrasado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 30, yPosition);
                    yPosition += 6;
                }
            }
            
            yPosition += 10;
            
            // Recomendações
            doc.setFont('helvetica', 'bold');
            doc.text('RECOMENDAÇÕES:', 25, yPosition);
            yPosition += 8;
            doc.setFont('helvetica', 'normal');
            
            if (margemLucro < 10) {
                doc.text(`• Revisar preços de venda para melhorar margem de lucro`, 30, yPosition);
                yPosition += 6;
            }
            
            if (sistemData.estoque.saldo < (sistemData.configuracoes?.estoqueMinimo || 10000)) {
                doc.text(`• Reabastecer estoque urgentemente`, 30, yPosition);
                yPosition += 6;
            }
            
            if (totalAtrasado > 0) {
                doc.text(`• Intensificar cobrança de valores em atraso`, 30, yPosition);
                yPosition += 6;
            }
            
            if (sistemData.vendas.length > 0 && getTotalQuantidade() > 0) {
                const vendaMediaDiaria = sistemData.vendas.length / 30; // Aproximação
                if (vendaMediaDiaria < 1) {
                    doc.text(`• Desenvolver estratégias para aumentar volume de vendas`, 30, yPosition);
                    yPosition += 6;
                }
            }
            
            doc.text(`• Manter monitoramento constante dos indicadores`, 30, yPosition);
            
            criarRodapePDF(doc, 1);
            doc.save(`relatorio-executivo-completo-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('📄 Relatório Executivo Completo exportado em PDF!', 'success');
        };

        // Função para mostrar modal de orçamento
        window.showOrcamentoModal = function() {
            // Popular select de clientes
            const clienteSelect = document.getElementById('orcamentoCliente');
            clienteSelect.innerHTML = '<option value="">Selecione o cliente...</option>';
            sistemData.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome;
                option.textContent = cliente.nome;
                clienteSelect.appendChild(option);
            });
            
            // Popular select de minérios
            const minerioSelect = document.getElementById('orcamentoMinerio');
            minerioSelect.innerHTML = '<option value="">Selecione o minério...</option>';
            sistemData.minerios.forEach(minerio => {
                const option = document.createElement('option');
                option.value = minerio.id;
                option.textContent = `${minerio.tipo} - R$ ${minerio.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/ton`;
                minerioSelect.appendChild(option);
            });
            
            document.getElementById('orcamentoModal').classList.remove('hidden');
            document.getElementById('orcamentoModal').classList.add('flex');
        };
        
        // Função para fechar modal de orçamento
        window.closeOrcamentoModal = function() {
            document.getElementById('orcamentoModal').classList.add('hidden');
            document.getElementById('orcamentoModal').classList.remove('flex');
            document.getElementById('orcamentoForm').reset();
        };
        
        // Função para gerar orçamento
        window.gerarOrcamento = function() {
            const cliente = document.getElementById('orcamentoCliente').value;
            const minerio = document.getElementById('orcamentoMinerio').value;
            const quantidade = parseFloat(document.getElementById('orcamentoQuantidade').value);
            const observacoes = document.getElementById('orcamentoObservacoes').value;
            
            if (!cliente || !minerio || !quantidade) {
                showNotification('⚠️ Preencha todos os campos obrigatórios!', 'error');
                return;
            }
            
            const minerioData = sistemData.minerios.find(m => m.id === minerio);
            if (!minerioData) {
                showNotification('⚠️ Minério não encontrado!', 'error');
                return;
            }
            
            // Calcular preço
            const custoMaterial = minerioData.preco * quantidade;
            const margemConfig = sistemData.configuracoes?.margem || { padrao: 30.0 };
            const precoVenda = custoMaterial * (1 + margemConfig.padrao / 100);
            
            // Criar PDF do orçamento
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabeçalho
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('ORÇAMENTO', 105, 30, { align: 'center' });
            
            // Informações da empresa
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Rei da Caçambinha', 25, 50);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Data: ' + new Date().toLocaleDateString('pt-BR'), 25, 60);
            doc.text('Validade: 30 dias', 25, 67);
            
            // Dados do cliente
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('CLIENTE:', 25, 85);
            doc.setFont('helvetica', 'normal');
            doc.text(cliente, 25, 95);
            
            // Detalhes do orçamento
            doc.setFont('helvetica', 'bold');
            doc.text('DETALHES:', 25, 115);
            doc.setFont('helvetica', 'normal');
            doc.text(`Minério: ${minerioData.tipo}`, 25, 125);
            doc.text(`Quantidade: ${quantidade.toFixed(1)} toneladas`, 25, 132);
            doc.text(`Preço unitário: R$ ${minerioData.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}/tonelada`, 25, 139);
            doc.text(`Custo do material: R$ ${custoMaterial.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, 146);
            doc.text(`Margem aplicada: ${margemConfig.padrao}%`, 25, 153);
            
            // Valor total
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(`VALOR TOTAL: R$ ${precoVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 25, 170);
            
            // Observações
            if (observacoes) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('OBSERVAÇÕES:', 25, 190);
                doc.setFont('helvetica', 'normal');
                doc.text(observacoes, 25, 200);
            }
            
            // Termos
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.text('Este orçamento tem validade de 30 dias. Preços sujeitos a alteração sem aviso prévio.', 25, 250);
            doc.text('Para confirmar o pedido, entre em contato conosco.', 25, 257);
            
            // Salvar PDF
            doc.save(`orcamento-${cliente.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.pdf`);
            
            closeOrcamentoModal();
            showNotification('📄 Orçamento gerado com sucesso!', 'success');
        };
        
        // Função para mostrar modal de configuração de valores
        window.openConfigValoresModal = function() {
            // Carregar valores atuais se existirem
            if (sistemData.configuracoes?.valores) {
                const valores = sistemData.configuracoes.valores;
                if (valores.pedagio) {
                    document.getElementById('valorPedagio').value = valores.pedagio;
                }
                if (valores.diesel) {
                    document.getElementById('precoDiesel').value = valores.diesel;
                }
            }
            
            document.getElementById('configValoresModal').classList.remove('hidden');
            document.getElementById('configValoresModal').classList.add('flex');
        };
        
        // Função para fechar modal de configuração de valores
        window.closeConfigValoresModal = function() {
            document.getElementById('configValoresModal').classList.add('hidden');
            document.getElementById('configValoresModal').classList.remove('flex');
            document.getElementById('configValoresForm').reset();
        };
        
        // Função para salvar configurações de valores
        window.salvarConfigValores = function() {
            const valorPedagio = parseFloat(document.getElementById('valorPedagio').value);
            const precoDiesel = parseFloat(document.getElementById('precoDiesel').value);
            
            if (!valorPedagio || !precoDiesel) {
                showNotification('⚠️ Preencha todos os campos!', 'error');
                return;
            }
            
            if (valorPedagio <= 0 || precoDiesel <= 0) {
                showNotification('⚠️ Os valores devem ser maiores que zero!', 'error');
                return;
            }
            
            // Garantir que existe a estrutura de configurações
            if (!sistemData.configuracoes) {
                sistemData.configuracoes = {};
            }
            
            if (!sistemData.configuracoes.valores) {
                sistemData.configuracoes.valores = {};
            }
            
            // Salvar valores
            sistemData.configuracoes.valores.pedagio = valorPedagio;
            sistemData.configuracoes.valores.diesel = precoDiesel;
            sistemData.configuracoes.valores.dataAtualizacao = new Date().toISOString();
            
            // Salvar dados
            saveData();
            
            closeConfigValoresModal();
            showNotification(`⚙️ Valores atualizados! Pedágio: R$ ${valorPedagio.toFixed(2)} | Diesel: R$ ${precoDiesel.toFixed(2)}/L`, 'success');
            
            // Recarregar a seção se estiver em despesas
            const currentSection = document.querySelector('.sidebar-item.active')?.getAttribute('data-section');
            if (currentSection === 'despesas') {
                showSection('despesas');
            }
        };

        // Tornar funções globais para acesso dos botões
        window.atualizarFinanceiro = atualizarFinanceiro;
    </script>
</body>
</html>